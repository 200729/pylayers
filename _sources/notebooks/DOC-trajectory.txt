Example of a trajectory synthesis in DLR WHERE2 environment 
------------------------------------------------------------


.. code-block:: python

    from pylayers.simul.simulem import *
    from pylayers.antprop.rays import *
    from pylayers.antprop.channel import *
    from pylayers.antprop.signature import *
    import pylayers.util.pyutil as pyu
    from pylayers.gis.layout import *
    from pylayers.util.project import *
    import pylayers.signal.bsignal as bs
    from datetime import datetime
    import time
    import pdb
    import pickle
    import numpy as np
    import matplotlib.pyplot as plt 

.. parsed-literal::

    <matplotlib.figure.Figure at 0x4300650>

This function has to be moved in simulem module. It is a temporary
implementation. Signatures can be handled much more efficiently here. It
run a full simulation and returns a list of channel impulse response.


.. code-block:: python

    def evalcir(S,wav,cutoff=4):
        """
        Parameters
        ----------
    
        S 
        tx
        rx
        wav
        cutoff
    
        """
    
        crxp =-1
        ctxp =-1
        tcir = {}
        tx = S.tx.position 
        Ntx = len(tx[0])
        rx = S.rx.position
        Nrx = len(rx[0])
    
        #for kt in range(1,Ntx-1):
        #print kt+1
        kt=0
        tcir[kt+1] = {}
        t = np.array([S.tx.position[0,kt+1],S.tx.position[1,kt+1],S.tx.position[2,kt+1]])
        for kr in range(Nrx-1):
            if (mod(kr,10)==0):
                print kr+1
            r = np.array([S.rx.position[0,kr+1],S.rx.position[1,kr+1],S.rx.position[2,kr+1]])
            ctx = S.L.pt2cy(t)
            crx = S.L.pt2cy(r)
            if (ctx<>ctxp)|(crx<>crxp):
                Si  = Signatures(S.L,ctx,crx)
                ctxp = ctx
                crxp = crx
                Si.run1(cutoff=cutoff)
            r2d = Si.rays(t,r)
            #r2d.show(S.L)
    
            r3d = r2d.to3D(S.L)
            r3d.locbas(S.L)
            r3d.fillinter(S.L)
            Ct  = r3d.eval(S.fGHz)
            sca = Ct.prop2tran(S.tx.A,S.rx.A)
            cir = sca.applywavB(wav.sfg)
            tcir[kt+1][kr+1]=cir
        return(tcir)

loading the Layout
..................


.. code-block:: python

    S = Simul()
    filestr = 'DLR2'
    S.layout(filestr+'.ini','matDB.ini','slabDB.ini')
    try:
        S.L.dumpr()
    except:
        S.L.build()
        S.L.dumpw()


.. code-block:: python

    S.L.display['ednodes']=False
    S.L.display['nodes']=False
    S.L.display['title']='DLR WP4 WHERE2 measurement site'
    S.L.display['overlay']=False
    fig,ax = S.L.showGs()    

.. image:: DOC-trajectory_files/_fig_02.png

We have a list of static Anchor Nodes. Those values correspond to the
actual anchor nodes coordinates of the WHERE2 project DLR measurement
campaign.


.. code-block:: python

    AnchorNodes = {390:{'name':'MT_ACO_05','coord':[6,0.81,1.64]},
                   386:{'name':'MT_ACO_08','coord':[30.574,2.8,1.291]},
                   391:{'name':'MT_ACO_07','coord':[11.78,-5.553,1.5]},
                   385:{'name': 'MT_ACO_01','coord':[19.52,-0.69,1.446]},
                   387:{'name':'MT_ACO_03','coord':[28.606,-0.74,1.467]},
                   400:{'name':'MT_ACO_02','coord':[30.574,2.8,1.291]},
                   1:{'name':'MT_DLR_RTDSlave','coord':[0.85,0,1.18]}
                  }


.. code-block:: python

    S.tx.clear()
    S.rx.clear()
    S.tx.filant='def.vsh3'
    S.rx.filant='def.vsh3'
    da ={}
    dm ={}

Vizualization of the simulated scenario


.. code-block:: python

    fig,ax=S.L.showG('s',nodes=False)
    plt.axis('off')
    #
    # add new points in tx and rx
    #
    #for c,k in enumerate(AnchorNodes):
    c = 0 # first anchor nodes
    k = AnchorNodes.keys()[c]
    pta = array([AnchorNodes[k]['coord'][0],AnchorNodes[k]['coord'][1],AnchorNodes[k]['coord'][2]]).reshape(3,1)
    #
    # To add a point 
    #
    S.tx.point(pta,mode="add")
    da[c]=k
    plt.plot(pta[0,:],pta[1,:],'or')


.. parsed-literal::

    [<matplotlib.lines.Line2D at 0x7fa3345da7d0>]


.. image:: DOC-trajectory_files/_fig_05.png

In the following a trajectory for the receiver is defined.

``linevect`` function allows to define a linear trajectory from ``ptt``
along direction ``vec``.


.. code-block:: python

    S.rx.linevect(npt=150, step=0.2, ptt=[0, 0, 1.275], vec=[1, 0, 0], mode='subst')
    ps = S.rx.position[:,-1]
    S.rx.linevect(npt=20, step=0.2, ptt=ps,vec=[0,1,0],mode='append')

Looking what is does


.. code-block:: python

    S.L.display['ednodes']=False
    S.L.display['edges']=True
    S.L.display['nodes']=False
    S.L.display['title']='Trajectory to be simulated'
    S.show(s=20)


.. parsed-literal::

    Warning : no furniture file loaded


.. parsed-literal::

    (<matplotlib.figure.Figure at 0x49d0790>,
     <matplotlib.axes.AxesSubplot at 0x7fa335217410>)


.. image:: DOC-trajectory_files/_fig_09.png

Choosing a UWB waveform for the simulation


.. code-block:: python

    wav = wvf.Waveform(type='W1compensate')
    wav.show()

.. image:: DOC-trajectory_files/_fig_11.png

running the simulation


.. code-block:: python

    tcir = evalcir(S,wav,cutoff=3)


.. parsed-literal::

    1
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    11
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    21
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    31
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    41
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    51
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    61
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    71
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    81
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    no T interaction to evaluate
    Rays evaluation
    Rays evaluation
    91
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    101
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    111
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    121
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    131
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    141
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    151
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    161
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation
    Rays evaluation

The full trajectory simulation took **56.8s** on a Dell M6700. It is
stored as a dictionnary of 59 entries containing object from class
Usignal of length 9930 points.


.. code-block:: python

    tcir


.. parsed-literal::

    {1: {1: Usignal :  (6292,)  (6292,),
      2: Usignal :  (6324,)  (6324,),
      3: Usignal :  (6356,)  (6356,),
      4: Usignal :  (6388,)  (6388,),
      5: Usignal :  (6420,)  (6420,),
      6: Usignal :  (6453,)  (6453,),
      7: Usignal :  (6485,)  (6485,),
      8: Usignal :  (6517,)  (6517,),
      9: Usignal :  (6549,)  (6549,),
      10: Usignal :  (6582,)  (6582,),
      11: Usignal :  (6614,)  (6614,),
      12: Usignal :  (6646,)  (6646,),
      13: Usignal :  (6679,)  (6679,),
      14: Usignal :  (6711,)  (6711,),
      15: Usignal :  (6743,)  (6743,),
      16: Usignal :  (5607,)  (5607,),
      17: Usignal :  (5575,)  (5575,),
      18: Usignal :  (5605,)  (5605,),
      19: Usignal :  (5636,)  (5636,),
      20: Usignal :  (5668,)  (5668,),
      21: Usignal :  (5700,)  (5700,),
      22: Usignal :  (5732,)  (5732,),
      23: Usignal :  (5764,)  (5764,),
      24: Usignal :  (5795,)  (5795,),
      25: Usignal :  (5827,)  (5827,),
      26: Usignal :  (5859,)  (5859,),
      27: Usignal :  (5891,)  (5891,),
      28: Usignal :  (5923,)  (5923,),
      29: Usignal :  (5955,)  (5955,),
      30: Usignal :  (5987,)  (5987,),
      31: Usignal :  (6019,)  (6019,),
      32: Usignal :  (6051,)  (6051,),
      33: Usignal :  (6083,)  (6083,),
      34: Usignal :  (6115,)  (6115,),
      35: Usignal :  (6147,)  (6147,),
      36: Usignal :  (6179,)  (6179,),
      37: Usignal :  (6211,)  (6211,),
      38: Usignal :  (6243,)  (6243,),
      39: Usignal :  (6275,)  (6275,),
      40: Usignal :  (6307,)  (6307,),
      41: Usignal :  (6339,)  (6339,),
      42: Usignal :  (6371,)  (6371,),
      43: Usignal :  (4759,)  (4759,),
      44: Usignal :  (4728,)  (4728,),
      45: Usignal :  (4697,)  (4697,),
      46: Usignal :  (4666,)  (4666,),
      47: Usignal :  (4635,)  (4635,),
      48: Usignal :  (4604,)  (4604,),
      49: Usignal :  (4574,)  (4574,),
      50: Usignal :  (4543,)  (4543,),
      51: Usignal :  (4512,)  (4512,),
      52: Usignal :  (4482,)  (4482,),
      53: Usignal :  (4451,)  (4451,),
      54: Usignal :  (4390,)  (4390,),
      55: Usignal :  (4359,)  (4359,),
      56: Usignal :  (4328,)  (4328,),
      57: Usignal :  (4298,)  (4298,),
      58: Usignal :  (4267,)  (4267,),
      59: Usignal :  (4236,)  (4236,),
      60: Usignal :  (4206,)  (4206,),
      61: Usignal :  (4175,)  (4175,),
      62: Usignal :  (4145,)  (4145,),
      63: Usignal :  (4114,)  (4114,),
      64: Usignal :  (4084,)  (4084,),
      65: Usignal :  (4054,)  (4054,),
      66: Usignal :  (4024,)  (4024,),
      67: Usignal :  (3994,)  (3994,),
      68: Usignal :  (3963,)  (3963,),
      69: Usignal :  (3934,)  (3934,),
      70: Usignal :  (3904,)  (3904,),
      71: Usignal :  (3874,)  (3874,),
      72: Usignal :  (3844,)  (3844,),
      73: Usignal :  (3814,)  (3814,),
      74: Usignal :  (3785,)  (3785,),
      75: Usignal :  (3755,)  (3755,),
      76: Usignal :  (3726,)  (3726,),
      77: Usignal :  (3697,)  (3697,),
      78: Usignal :  (3668,)  (3668,),
      79: Usignal :  (3639,)  (3639,),
      80: Usignal :  (3610,)  (3610,),
      81: Usignal :  (3581,)  (3581,),
      82: Usignal :  (3552,)  (3552,),
      83: Usignal :  (3524,)  (3524,),
      84: Usignal :  (3495,)  (3495,),
      85: Usignal :  (3467,)  (3467,),
      86: Usignal :  (3439,)  (3439,),
      87: Usignal :  (3411,)  (3411,),
      88: Usignal :  (3387,)  (3387,),
      89: Usignal :  (4694,)  (4694,),
      90: Usignal :  (4678,)  (4678,),
      91: Usignal :  (4662,)  (4662,),
      92: Usignal :  (4647,)  (4647,),
      93: Usignal :  (4631,)  (4631,),
      94: Usignal :  (4616,)  (4616,),
      95: Usignal :  (4602,)  (4602,),
      96: Usignal :  (4587,)  (4587,),
      97: Usignal :  (4573,)  (4573,),
      98: Usignal :  (4560,)  (4560,),
      99: Usignal :  (4546,)  (4546,),
      100: Usignal :  (4533,)  (4533,),
      101: Usignal :  (4802,)  (4802,),
      102: Usignal :  (4804,)  (4804,),
      103: Usignal :  (4805,)  (4805,),
      104: Usignal :  (4592,)  (4592,),
      105: Usignal :  (4809,)  (4809,),
      106: Usignal :  (4812,)  (4812,),
      107: Usignal :  (4815,)  (4815,),
      108: Usignal :  (4818,)  (4818,),
      109: Usignal :  (4822,)  (4822,),
      110: Usignal :  (4825,)  (4825,),
      111: Usignal :  (4830,)  (4830,),
      112: Usignal :  (4834,)  (4834,),
      113: Usignal :  (4839,)  (4839,),
      114: Usignal :  (4844,)  (4844,),
      115: Usignal :  (4850,)  (4850,),
      116: Usignal :  (4855,)  (4855,),
      117: Usignal :  (4861,)  (4861,),
      118: Usignal :  (5253,)  (5253,),
      119: Usignal :  (5221,)  (5221,),
      120: Usignal :  (5190,)  (5190,),
      121: Usignal :  (5158,)  (5158,),
      122: Usignal :  (5126,)  (5126,),
      123: Usignal :  (5095,)  (5095,),
      124: Usignal :  (5063,)  (5063,),
      125: Usignal :  (5032,)  (5032,),
      126: Usignal :  (5000,)  (5000,),
      127: Usignal :  (4969,)  (4969,),
      128: Usignal :  (4937,)  (4937,),
      129: Usignal :  (4906,)  (4906,),
      130: Usignal :  (4874,)  (4874,),
      131: Usignal :  (4843,)  (4843,),
      132: Usignal :  (4811,)  (4811,),
      133: Usignal :  (4780,)  (4780,),
      134: Usignal :  (4749,)  (4749,),
      135: Usignal :  (4718,)  (4718,),
      136: Usignal :  (4686,)  (4686,),
      137: Usignal :  (4655,)  (4655,),
      138: Usignal :  (4624,)  (4624,),
      139: Usignal :  (4593,)  (4593,),
      140: Usignal :  (4562,)  (4562,),
      141: Usignal :  (4531,)  (4531,),
      142: Usignal :  (4500,)  (4500,),
      143: Usignal :  (4469,)  (4469,),
      144: Usignal :  (4438,)  (4438,),
      145: Usignal :  (4407,)  (4407,),
      146: Usignal :  (4376,)  (4376,),
      147: Usignal :  (4588,)  (4588,),
      148: Usignal :  (4606,)  (4606,),
      149: Usignal :  (4623,)  (4623,),
      150: Usignal :  (4623,)  (4623,),
      151: Usignal :  (4598,)  (4598,),
      152: Usignal :  (4287,)  (4287,),
      153: Usignal :  (4294,)  (4294,),
      154: Usignal :  (4297,)  (4297,),
      155: Usignal :  (4301,)  (4301,),
      156: Usignal :  (4305,)  (4305,),
      157: Usignal :  (4310,)  (4310,),
      158: Usignal :  (6310,)  (6310,),
      159: Usignal :  (6313,)  (6313,),
      160: Usignal :  (6322,)  (6322,),
      161: Usignal :  (7216,)  (7216,),
      162: Usignal :  (7219,)  (7219,),
      163: Usignal :  (7222,)  (7222,),
      164: Usignal :  (7226,)  (7226,),
      165: Usignal :  (7230,)  (7230,),
      166: Usignal :  (7234,)  (7234,),
      167: Usignal :  (7238,)  (7238,),
      168: Usignal :  (7243,)  (7243,),
      169: Usignal :  (7247,)  (7247,)}}


Saving the data in pickle format


.. code-block:: python

    file = open("tcir5.pickle","w")
    pickle.dump(tcir,file)
    file.close()

Reading the data from the above file


.. code-block:: python

    del tcir
    file=open("tcir5.pickle","r")
    tcir=pickle.load(file)
    file.close()
    #
    for i in tcir[1].keys():
        cir = tcir[1][i]
        cir.zlr(0,150)
        try:
            ttcir=np.vstack((ttcir,cir.y))
        except:
            ttcir=cir.y

Aggregated CIR along a synthetic trajectory (line in the corridor) 
...................................................................


.. code-block:: python

    figsize(10,10)
    dmax=150*0.3
    plt.imshow(20*np.log10(ttcir+1e-20),vmax=-40,vmin=-120,origin='lower',extent=[0,dmax,1,69])
    plt.xlabel(r'delay $\times$ c (meters)',fontsize=20)
    #plt.ylabel(r'distance along trajectory (meters)',fontsize=20)
    plt.ylabel(r'trajectory index number',fontsize=20)
    clb=plt.colorbar()
    clb.set_label('level (dB)',fontsize=20)
    
    plt.axis('tight')


.. parsed-literal::

    (0.0, 45.0, 1.0, 69.0)


.. image:: DOC-trajectory_files/_fig_16.png


.. code-block:: python

    figsize(10,5)
    tcir[1][1].plot()
    xlabel('Delay (ns)')
    ylabel('Level (V)')
    title('Received Waveform')


.. parsed-literal::

    <matplotlib.text.Text at 0x712cad0>


.. image:: DOC-trajectory_files/_fig_19.png


.. code-block:: python

    tcir[1][40].plot()
    xlabel('Delay (ns)')
    ylabel('Level (V)')
    title('Received Waveform')


.. parsed-literal::

    <matplotlib.text.Text at 0x70a1f90>


.. image:: DOC-trajectory_files/_fig_22.png

