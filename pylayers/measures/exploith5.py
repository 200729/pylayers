import h5py
import  pdb
import numpy as np
from pylayers.antprop.channel import *
from pylayers.util.project import *
import pylayers.util.pyutil as pyu
import ConfigParser

"""

Module to handle scanner data stored and exploited
in hdf5 format.
Authors : M.D.BALDE and B.UGUEN

.. currentmodule:: pylayers.measures.exploith5

.. autosummary::
    :toctree: generated

mesh5 Class
===========

.. autosummary::
    :toctree: generated/

    mesh5.__init__
    mesh5.__repr__
    mesh5.readcal
    mesh5.read
    mesh5.calibrate
    mesh5.saveini

"""


class mesh5(PyLayers):
    """
    """
    def __init__(self,_filename):
        """
        """
        if '.h5' not in _filename:
            _filename = _filename+'.h5'
        self._filename = _filename 
        self.filename = pyu.getlong(self._filename,pstruc['DIRMES'])
        self.calibrated = False
        #self.read()

    def __repr__(self):
        """
        """

        st = ''
        st = st + '-----------------------\n'
        st = st + '      Parameters       \n'
        st = st + '-----------------------\n'
        st = st + 'calibrated : '+ str(self.calibrated) +'\n'
        st = st + 'Repertory  : '+ str(self.filename) +'\n'
        #st = st + 'File  : '+ str(self.f) +'\n'
        return(st)

    #def readcal(self,ical=1,mode='r'):
        #""" read calibration files
        #Parameters
        #----------

        #ical : int 
            #calibration index

        #"""
        #k = "cal"+str(ical)
        #self.f  = h5py.File(self.filename,mode)
        #exp ="self.dcal={}"
        #exec(exp)
        #exp ="self.dcal['fminGHz'] =self.f['"+k+"'].attrs['fminGHz']"
        #exec(exp)
        #exp ="self.dcal['fmaxGHz'] =self.f['"+k+"'].attrs['fmaxGHz']"
        #exec(exp)
        #exp ="self.dcal['Nf'] =self.f['"+k+"'].attrs['Nf']"
        #exec(exp)
        #exp ="self.dcal['ifbHz'] =self.f['"+k+"'].attrs['ifbHz']"
        #exec(exp)
        #exp ="self.dcal['cables'] =self.f['"+k+"'].attrs['cables']"
        #exec(exp)
        #exp ="self.dcal['Navrg'] =self.f['"+k+"'].attrs['Navrg']"
        #exec(exp)
        #exp ="self.dcal['comment'] =self.f['"+k+"'].attrs['comment']"
        #exec(exp)
        #exp ="self.dcal['author'] =self.f['"+k+"'].attrs['author']"
        #exec(exp)
        #exp ="self.dcal['time'] =self.f['"+k+"'].attrs['time']"
        #exec(exp)
        #exp ="self.dcal['param'] =self.f['"+k+"'].attrs['param']"
        #exec(exp)
        #exec("fminGHz=self.dcal['fminGHz']")
        #exec("fmaxGHz=self.dcal['fmaxGHz']")
        #exec("Nf=self.dcal['Nf']")
        #self.fGHz = np.linspace(fminGHz,fmaxGHz,Nf)
        #exp ="self.cal=Tchannel(x=self.fGHz,y=np.array(self.f['"+k+"']))"
        #exec(exp)
        #self.f.close()

    def readcal(self,gcal=1,ical=1):
        """ read calibration files

        Parameters
        ----------

        gcal : int
            calibration group index
        ical : int
            calibration index

        """

        self.f  = h5py.File(self.filename,'r')
        k = "cal"+str(gcal)
        self.dcal  = dict(zip(self.f[k].attrs.keys(),self.f[k].attrs.values()))
        di = dict(zip(self.f[k][str(ical)].attrs.keys(),self.f[k][str(ical)].attrs.values()))
        self.dcal.update(di)
        fminGHz = self.dcal['fminGHz']
        fmaxGHz = self.dcal['fmaxGHz']
        Nf = self.dcal['Nf']
        self.fGHz = np.linspace(fminGHz,fmaxGHz,Nf)
        self.cal = Tchannel(x=self.fGHz,y=np.array(self.f[k][str(ical)]))
        self.f.close()
#            exec(exp)
#            self.f.close()
#
#        # MIMO case
#
#        if cmd == 'MIMO':
#            k = "mimocal"+str(imimocal)
#            self.f  = h5py.File(self.filename,mode)
#            exp ="self.dmimocal={}"
#            exec(exp)
#            exp ="self.dmimocal['fminGHz'] =self.f['"+k+"'].attrs['fminGHz']"
#            exec(exp)
#            exp ="self.dmimocal['fmaxGHz'] =self.f['"+k+"'].attrs['fmaxGHz']"
#            exec(exp)
#            exp ="self.dmimocal['Nf'] =self.f['"+k+"'].attrs['Nf']"
#            exec(exp)
#            exp ="self.dmimocal['ifbHz'] =self.f['"+k+"'].attrs['ifbHz']"
#            exec(exp)
#            exp ="self.dmimocal['cables'] =self.f['"+k+"'].attrs['cables']"
#            exec(exp)
#            exp ="self.dmimocal['Navrg'] =self.f['"+k+"'].attrs['Navrg']"
#            exec(exp)
#            exp ="self.dmimocal['comment'] =self.f['"+k+"'].attrs['comment']"
#            exec(exp)
#            exp ="self.dmimocal['author'] =self.f['"+k+"'].attrs['author']"
#            exec(exp)
#            exp ="self.dmimocal['time'] =self.f['"+k+"'].attrs['time']"
#            exec(exp)
#            exp ="self.dmimocal['param'] =self.f['"+k+"'].attrs['param']"
#            exec(exp)
#            exec("fminGHz=self.dmimocal['fminGHz']")
#            exec("fmaxGHz=self.dmimocal['fmaxGHz']")
#            exec("Nf=self.dmimocal['Nf']")
#            self.fGHz = np.linspace(fminGHz,fmaxGHz,Nf)
#            exp ="self.mimocal=Tchannel(x=self.fGHz,y=np.array(self.f['"+k+"']))"
#            exec(exp)

    #def read(self,k,kcal,mode='r',calibrate=True):
        #"""
        #Parameters
        #----------

        #k : data key to read
        #kcal : data key for calibration
        #mode : string

        #"""
        #self.readcal(kcal)
        #self.f  = h5py.File(self.filename,mode)

        #exp ="self.dmes={}"
        #exec(exp)
        #exp ="self.dmes['comment'] = self.f['"+k+"'].attrs['comment']"
        #exec(exp)
        #exp ="self.dmes['author'] = self.f['"+k+"'].attrs['author']"
        #exec(exp)
        #exp ="self.dmes['time'] = self.f['"+k+"'].attrs['time']"
        #exec(exp)
        #exp ="self.dmes['axes'] = self.f['"+k+"'].attrs['axes']"
        #exec(exp)
        #exp ="self.dmes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
        #exec(exp)
        #exp ="self.dmes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
        #exec(exp)
        #exp ="self.mes=Tchannel(x=self.fGHz,y=np.array(self.f['"+k+"']))"
        #exec(exp)
        #self.f.close()
        #if calibrate:
            #self.calibrate()

    def read(self,k,kcal,mode='r',cmd='SISO',calibrate=True):
        """ read measure

        Parameters
        ----------

        k : data key to read
        kcal : data key for calibration
        cmd  : string
            'SISO' | 'MIMO'
        mode : string

        """
        self.readcal(kcal)
        self.f  = h5py.File(self.filename,mode)

        if cmd == 'SISO':
            exp ="self.dmes={}"
            exec(exp)
            exp ="self.dmes['comment'] = self.f['"+k+"'].attrs['comment']"
            exec(exp)
            exp ="self.dmes['author'] = self.f['"+k+"'].attrs['author']"
            exec(exp)
            exp ="self.dmes['time'] = self.f['"+k+"'].attrs['time']"
            exec(exp)
            exp ="self.dmes['axes'] = self.f['"+k+"'].attrs['axes']"
            exec(exp)
            exp ="self.dmes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
            exec(exp)
            #exp ="self.dmes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
            #exec(exp)
            exp ="self.mes=Tchannel(x=self.fGHz,y=np.array(self.f['"+k+"']))"
            exec(exp)
            self.f.close()
            if calibrate:
                self.calibrate()

        if cmd == 'MIMO':
            exp ="self.dmimomes={}"
            exec(exp)
            exp ="self.dmimomes['comment'] = self.f['"+k+"'].attrs['comment']"
            exec(exp)
            exp ="self.dmimomes['author'] = self.f['"+k+"'].attrs['author']"
            exec(exp)
            exp ="self.dmimomes['time'] = self.f['"+k+"'].attrs['time']"
            exec(exp)
            exp ="self.dmimomes['axes'] = self.f['"+k+"'].attrs['axes']"
            exec(exp)
            exp ="self.dmimomes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
            exec(exp)
            #exp ="self.dmes['Nmeas'] = self.f['"+k+"'].attrs['Nmeas']"
            #exec(exp)
            exp ="self.mimomes=Tchannel(x=self.fGHz,y=np.array(self.f['"+k+"']))"
            exec(exp)
            self.f.close()
        if calibrate:
            self.calibrate()

    #def calibrate(self):
        #if 'mes' in self.__dict__:
            #if self.calibrated==False:
                #self.mes.y = self.mes.y/np.mean(self.cal.y,axis=0)
                #self.calibrated=True
            #else:
                #self.mes.y = self.mes.y*np.mean(self.cal.y,axis=0)
                #self.calibrated=False
        #else:
            #print "read data first"

    def calibrate(self,cmd='SISO'):
        """
        Parameters
        ----------

        cmd : string
            'SISO' | 'MIMO'
        """

        if cmd == 'SISO':
            if 'mes' in self.__dict__:
                if self.calibrated==False:
                    self.mes.y = self.mes.y/np.mean(self.cal.y,axis=0)
                    self.calibrated=True
                else:
                    self.mes.y = self.mes.y*np.mean(self.cal.y,axis=0)
                    self.calibrated=False
            else:
                print "read data first"


        for iR in range(self.Nr):
            for iT in range(self.Nt):
                if cmd == 'MIMO':
                    if 'mimomes' in self.__dict__:
                        if self.calibrated==False:
                            self.mimomes.y = self.mimomes.y[iR,iT,:]/np.mean(self.mimocal.y[iR,iT,:],axis=0)
                            self.calibrated=True
                        else:
                            self.mimomes.y = self.mimomes.y[iR,iT,:]*np.mean(self.mimocal.y[iR,iT,:],axis=0)
                            self.calibrated=False
                    else:
                        print "read data first"


    def open(self,mode='r'):
        """

        Parameters
        ----------

        mode : string

        """
        filename = pyu.getlong(self._filename,pstruc['DIRMES'])
        self.f  = h5py.File(filename,mode)


#    def open(self,key,mode='r'):
#        """
#        Parameters
#        ----------
#
#        key : data key to read
#        mode : string
#
#        """
#        filename = pyu.getlong(self._filename,pstruc['DIRMES'])
#        self.f  = h5py.File(filename,mode)
#        lkeys = self.f.keys()
#        for k in lkeys:
#            exp ="self.d"+k+"={}"
#            exec(exp)
#            exp ="self.d"+k+"['fminGHz'] =self.f['"+k+"'].attrs['fminGHz']"
#            exec(exp)
#            exp ="self.d"+k+"['fmaxGHz'] =self.f['"+k+"'].attrs['fmaxGHz']"
#            exec(exp)
#            exp ="self.d"+k+"['Nf'] =self.f['"+k+"'].attrs['Nf']"
#            exec(exp)
#            exp ="self.d"+k+"['ifbHz'] =self.f['"+k+"'].attrs['ifbHz']"
#            exec(exp)
#            exp ="self.d"+k+"['cables'] =self.f['"+k+"'].attrs['cables']"
#            exec(exp)
#            exp ="self.d"+k+"['Navrg'] =self.f['"+k+"'].attrs['Navrg']"
#            exec(exp)
#            exp ="self.d"+k+"['comment'] =self.f['"+k+"'].attrs['comment']"
#            exec(exp)
#            exp ="self.d"+k+"['author'] =self.f['"+k+"'].attrs['author']"
#            exec(exp)
#            exp ="self.d"+k+"['time'] =self.f['"+k+"'].attrs['time']"
#            exec(exp)
#            exp ="self.d"+k+"['param'] =self.f['"+k+"'].attrs['param']"
#            exec(exp)
#            exec('fminGHz=self.d'+k+"['fminGHz']")
#            exec('fmaxGHz=self.d'+k+"['fmaxGHz']")
#            exec('Nf=self.d'+k+"['Nf']")
#            fGHz =  np.linspace(fminGHz,fmaxGHz,Nf)
#            exp ="self."+k+"=Tchannel(x=fGHz,y=np.array(self.f['"+k+"']))"
#            exec(exp)
#
    def close(self):
        """ close h5 file
        """
        self.f.close()

    def saveini(self,_fileini='vna_config.ini'):
        """ save calibration parameters in .ini file

        Parameters
        ----------

        _fileini  : string
            calibration ini file
        ical : int
            calibration number
        """

        dcal = self.dcal
        config = ConfigParser.ConfigParser()

        # stimulus section
        config.add_section("stimulus")
        config.set("stimulus",'fminghz',dcal['fminGHz'])
        config.set("stimulus",'fmaxghz',dcal['fmaxGHz'])
        config.set("stimulus",'nf',dcal['Nf'])

        # response section
        config.add_section("response")
        config.set("response",'param',dcal['param'])
        config.set("response",'average','on')
        config.set("response",'navrg',dcal['Navrg'])
        config.set("response",'ifbhz',dcal['ifbHz'])
        config.set("response",'win',1)

        fileini = pyu.getlong(_fileini,pstruc['DIRMES'])
        fd = open(fileini,"w")
        config.write(fd)
        fd.close()

    # def showcal(self,ical=1,ncal=0):
    #     """show calibration from vna

    #     Parameters
    #     ----------

    #     ical : int
    #     ncal : int

    #     """
    #     plt.plot(np.abs(self.f['cal'+str(ical)][ncal,:]))
    #     plt.show()

if __name__=='__main__':
    doctest.testmod()
    #mesh5(sdata.h5)
