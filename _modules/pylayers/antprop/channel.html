
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pylayers.antprop.channel &mdash; Python 1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="top" title="Python 1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34943220-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </head>
  <body role="document">

    <div class="header-wrapper">
      <div class="header">
          <p class="logo"><a href="../../../index.html">
            <img src="../../../_static/pylayers.png" alt="Logo"/>
          </a>
          </p><div class="navbar">
          <ul>
            <li><a href="../../../download.html">Download</a></li>
            <li><a href="../../../notebook/TOC.html">User Guide</a></li>
            <li><a href="../../../modules/pylayers.html">Reference</a></li>
       </ul>

<div class="search_form">

<div id="cse" style="width: 100%;"></div>
<script>
  (function() {
       var cx = '004820205189002234612:sa15qzuf2ca';
           var gcse = document.createElement('script');
               gcse.type = 'text/javascript';
                   gcse.async = true;
                       gcse.src = (document.location.protocol == 'https:' ?
                           'https:' : 'http:') +
                               '//cse.google.com/cse.js?cx=' + cx;
                                   var s =
                                   document.getElementsByTagName('script')[0];
                                       s.parentNode.insertBefore(gcse, s);
                                         })();
</script>
<gcse:search></gcse:search>
</div>
</div> <!-- end navbar --></div>
    </div>

    <div class="content-wrapper">

      <div class="sphinxsidebar">
	<div class="sphinxsidebarwrapper">
	  <div class="rel">
	   
	<!-- rellinks[1:] is an ugly hack to avoid link to module
	    index  -->
	<div class="rellink">
	<a href="../../../py-modindex.html" title="Python Module Index"
	    >Modules
	    <br>
	    <span class="smallrellink">
	    Python Module...
	    </span>
	    <span class="hiddenrellink">
	    Python Module Index
	    </span>
	    
	    </a>
	</div>
	<!-- Ad a link to the 'up' page -->
	<div class="spacer">
	&nbsp;
	</div>
	<div class="rellink">
	<a href="../../index.html" title="Module code" >
	Up
	<br>
	<span class="smallrellink">
	Module code
	</span>
	<span class="hiddenrellink">
	Module code
	</span>
	
	</a>
	</div>
    </div>
    <p style="text-align: center; background-color: #BFFFFF">This documentation is

    for Python <strong>version 1</strong>
    &mdash; <a href="https://github.com/pylayers/pylayers/archive/master.zip">Other versions</a></p>
    
    <h3>Citing</h3>
    <p>If you use the software, please consider
    <a href="../../../about.html#citing-pylayers">citing pylayers</a>.</p>
    <h3>This page</h3>
	
    
    </div>
	  </div>


      <div class="content">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pylayers.antprop.channel</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*t coding:Utf-8 -*-</span>
<span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">.. currentmodule:: pylayers.antprop.channel</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated</span>

<span class="sd">TBchannel class</span>
<span class="sd">===============</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">    TBchannel.tau_Emax</span>
<span class="sd">    TBchannel.tau_moy</span>
<span class="sd">    TBchannel.tau_rms</span>
<span class="sd">    TBchannel.delays</span>
<span class="sd">    TBchannel.SalehValenzuela</span>

<span class="sd">TUchannel class</span>
<span class="sd">===============</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">    TUchannel.psd</span>
<span class="sd">    TUchannel.awgn</span>
<span class="sd">    TUchannel.Etau0</span>
<span class="sd">    TUchannel.Ewin</span>
<span class="sd">    TUchannel.Etot</span>
<span class="sd">    TUchannel.Emax</span>


<span class="sd">TUDchannel</span>
<span class="sd">==========</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">Tchannel</span>
<span class="sd">=========</span>

<span class="sd">Members</span>
<span class="sd">-------</span>

<span class="sd">    filcal : calibration file</span>
<span class="sd">    win : string type of window {&#39;rect&#39;| }</span>


<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">    Tchannel.saveh5</span>
<span class="sd">    Tchannel.loadh5</span>
<span class="sd">    Tchannel.apply</span>
<span class="sd">    Tchannel.applywavC</span>
<span class="sd">    Tchannel.chantap</span>
<span class="sd">    Tchannel.applywavB</span>
<span class="sd">    Tchannel.applywavA</span>
<span class="sd">    Tchannel.plotd</span>
<span class="sd">    Tchannel.plotad</span>
<span class="sd">    Tchannel.doadod</span>
<span class="sd">    Tchannel.energy</span>
<span class="sd">    Tchannel.wavefig</span>
<span class="sd">    Tchannel.rayfig</span>
<span class="sd">    Tchannel.rssi</span>
<span class="sd">    Tchannel.cut</span>
<span class="sd">    Tchannel.sort</span>
<span class="sd">    Tchannel.showtap</span>
<span class="sd">    Tchannel.tap</span>
<span class="sd">    Tchannel.minphas</span>
<span class="sd">    Tchannel.ifft</span>
<span class="sd">    Tchannel.totime</span>
<span class="sd">    Tchannel.iftd</span>
<span class="sd">    Tchannel.ft1</span>
<span class="sd">    Tchannel.ftau</span>
<span class="sd">    Tchannel.cir</span>
<span class="sd">    Tchannel.plot3d</span>
<span class="sd">    Tchannel.ft2</span>
<span class="sd">    Tchannel.frombuf</span>
<span class="sd">    Tchannel.capacity</span>
<span class="sd">    Tchannel.calibrate</span>
<span class="sd">    Tchannel.pdp</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">struct</span> <span class="kn">as</span> <span class="nn">stru</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="kn">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">numpy.fft</span> <span class="kn">as</span> <span class="nn">fft</span>
<span class="kn">import</span> <span class="nn">pylayers.util.pyutil</span> <span class="kn">as</span> <span class="nn">pyu</span>
<span class="kn">import</span> <span class="nn">pylayers.signal.bsignal</span> <span class="kn">as</span> <span class="nn">bs</span>
<span class="kn">import</span> <span class="nn">pylayers.util.geomutil</span> <span class="kn">as</span> <span class="nn">geu</span>
<span class="kn">import</span> <span class="nn">pylayers.antprop.antenna</span> <span class="kn">as</span> <span class="nn">ant</span>
<span class="kn">from</span> <span class="nn">pylayers.antprop.raysc</span> <span class="kn">import</span> <span class="n">GrRay3D</span>
<span class="kn">from</span> <span class="nn">pylayers.util.project</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s1">&#39;h5py is not installed: Ctilde(object cannot be saved)&#39;</span>

<span class="k">class</span> <span class="nc">TBchannel</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">TBsignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; radio channel in non uniform delay domain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">label</span><span class="o">=</span><span class="p">[]):</span>
        <span class="c1">#super(TUsignal,self).__init__(x,y,label)</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">TBsignal</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>


<div class="viewcode-block" id="TBchannel.tau_Emax"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TBchannel.tau_Emax.html#pylayers.antprop.channel.TBchannel.tau_Emax">[docs]</a>    <span class="k">def</span> <span class="nf">tau_Emax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate the delay of max energy pildeeak</span>

<span class="sd">        .. math::</span>
<span class="sd">            \max_{\tau} y^{2}(\tau)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tau_Emax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tau_Emax</span><span class="p">)</span></div>

<div class="viewcode-block" id="TBchannel.tau_moy"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TBchannel.tau_moy.html#pylayers.antprop.channel.TBchannel.tau_moy">[docs]</a>    <span class="k">def</span> <span class="nf">tau_moy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate mean excess delay starting from delay tau_0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha : float</span>
<span class="sd">        tau0 : float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>

        <span class="c1">#cdf, vary = self.ecdf()</span>

        <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">/</span><span class="n">cdf</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">]</span>

        <span class="c1">#pdb.set_trace()</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">pdf</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="n">taum</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>

        <span class="k">return</span><span class="p">(</span><span class="n">taum</span><span class="p">)</span></div>

<div class="viewcode-block" id="TBchannel.delays"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TBchannel.delays.html#pylayers.antprop.channel.TBchannel.delays">[docs]</a>    <span class="k">def</span> <span class="nf">delays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot; calculate delay parameters and orthogonality factor from cir</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        taum :</span>
<span class="sd">            mean excess delay</span>
<span class="sd">        delayspread</span>
<span class="sd">            rms delay spread</span>
<span class="sd">        of  :</span>
<span class="sd">            orthogonality factor</span>

<span class="sd">        Neelesh Metha, Andreas Molish, Lary Greenstein &quot;Orthogonality Factor in WCDMA Donlinks in Urban Macrocellular</span>
<span class="sd">        environments&quot;</span>

<span class="sd">        .. :math:</span>

<span class="sd">            \beta0 = 1 \frac{\sum_i=1^L}|\alpha_i|^4}{\left(\sum_i=1^L|\alpha_i|^2)^2}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flatteny</span><span class="p">(</span><span class="n">reversible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yf</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">yf</span>
        <span class="n">y4</span> <span class="o">=</span> <span class="n">y2</span><span class="o">*</span><span class="n">y2</span>
        <span class="n">taum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">y2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">delayspread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">taum</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">taum</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">of</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">y4</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">taum</span><span class="p">,</span><span class="n">delayspread</span><span class="p">,</span><span class="n">of</span></div>



<div class="viewcode-block" id="TBchannel.tau_rms"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TBchannel.tau_rms.html#pylayers.antprop.channel.TBchannel.tau_rms">[docs]</a>    <span class="k">def</span> <span class="nf">tau_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot; calculate root mean square delay spread starting from delay tau_0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alpha : float</span>
<span class="sd">        threshold : float</span>
<span class="sd">            ( delay interval is defined between :math:`\tau(\alpha)` and :math:`\tau(1 -\alpha)` )</span>
<span class="sd">        tau0 : float</span>
<span class="sd">            argument for specifying the delay start</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        .. math::</span>

<span class="sd">            \sqrt{\frac{\int_{\tau(\alpha)}^{\tau(1-\alpha)} (\tau-\tau_m)^{2} PDP(\tau) d\tau} {\int_{\tau(\alpha)}^{\tau(1-\alpha)} PDP(\tau) d\tau}}</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.measures.mesuwb import *</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; M = UWBMeasure(1)</span>
<span class="sd">            &gt;&gt;&gt; ch4 = M.tdd.ch4</span>
<span class="sd">            &gt;&gt;&gt; f1,a1=ch4.plot(color=&#39;k&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tit0 = plt.title(&quot;WHERE1 M1 UWB Channel impulse response&quot;)</span>
<span class="sd">            &gt;&gt;&gt; f2,a2=ch4.plot(color=&#39;k&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tit1= plt.title(&quot;WHERE1 M1 UWB Channel impulse response (Zoom 1)&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ax1=plt.axis([10,160,-90,-50])</span>
<span class="sd">            &gt;&gt;&gt; f3,a3=ch4.plot(color=&#39;k&#39;)</span>
<span class="sd">            &gt;&gt;&gt; tit2 = plt.title(&quot;WHERE1 M1 UWB Channel impulse response (Zoom 2)&quot;)</span>
<span class="sd">            &gt;&gt;&gt; ax2=plt.axis([20,120,-80,-50])</span>
<span class="sd">            &gt;&gt;&gt; plt.show()</span>
<span class="sd">            &gt;&gt;&gt; tau_moy = ch4.tau_moy()</span>



<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        TUsignal.ecdf</span>
<span class="sd">        TUsignal.tau_moy</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="c1">#cdf, vary = self.ecdf()</span>
        <span class="c1">#pdp = np.diff(cdf.y)</span>

        <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">/</span><span class="n">cdf</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">]</span>

        <span class="n">taum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_moy</span><span class="p">(</span><span class="n">tau0</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">pdp</span> <span class="o">=</span> <span class="n">pdp</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pdp</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pdp</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">taum</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">taum</span><span class="p">))</span>
        <span class="n">taurms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">taurms</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">toFD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fGHz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">256</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot; Transform to Frequency domain</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        H : Tchannel</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mi">1j</span><span class="o">*</span><span class="n">fGHz</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span><span class="bp">None</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">Tchannel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">fGHz</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">z</span><span class="p">,</span><span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">H</span>

<div class="viewcode-block" id="TBchannel.SalehValenzuela"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TBchannel.SalehValenzuela.html#pylayers.antprop.channel.TBchannel.SalehValenzuela">[docs]</a>    <span class="k">def</span> <span class="nf">SalehValenzuela</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generic Saleh and Valenzuela Model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Lam : clusters Poisson Process parameter (ns)</span>
<span class="sd">        lam : rays Poisson Process parameter (ns)</span>
<span class="sd">        Gam : clusters exponential decay factor</span>
<span class="sd">        gam : rays exponential decay factor</span>
<span class="sd">        T   : observation duration</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.antprop.channel import *</span>
<span class="sd">        &gt;&gt;&gt; C=TBchannel()</span>
<span class="sd">        &gt;&gt;&gt; C.SalehValenzuela()</span>
<span class="sd">        &gt;&gt;&gt; C.stem()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;Lam&#39;</span> <span class="p">:</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;lam&#39;</span> <span class="p">:</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span>
                     <span class="s1">&#39;Gam&#39;</span> <span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                     <span class="s1">&#39;gam&#39;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">,</span>
                     <span class="s1">&#39;T&#39;</span>   <span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">Lam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Lam&#39;</span><span class="p">]</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lam&#39;</span><span class="p">]</span>
        <span class="n">Gam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Gam&#39;</span><span class="p">]</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;gam&#39;</span><span class="p">]</span>
        <span class="n">T</span>   <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">Nr</span>  <span class="o">=</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">T</span><span class="o">/</span><span class="n">Lam</span>
        <span class="n">Nc</span>  <span class="o">=</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">T</span><span class="o">/</span><span class="n">lam</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">expon</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">Lam</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">expon</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">lam</span><span class="p">)</span>

        <span class="c1"># cluster time of arrival</span>
        <span class="n">tc</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">Nr</span><span class="p">))</span>
        <span class="n">tc</span>   <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tc</span><span class="o">&lt;</span><span class="n">T</span><span class="p">)]</span>
        <span class="n">Nc</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span>
        <span class="n">tauc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">Nr</span><span class="p">)))[</span><span class="mi">0</span><span class="p">,:]</span>

        <span class="c1"># rays time of arrival</span>
        <span class="n">taur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">Nr</span><span class="p">,</span><span class="n">Nc</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># exponential decays of cluster and rays</span>
        <span class="n">etc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tauc</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">Gam</span><span class="p">))</span>
        <span class="n">etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">taur</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">gam</span><span class="p">))</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">etc</span><span class="o">*</span><span class="n">etr</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tauc</span><span class="o">+</span><span class="n">taur</span>

        <span class="c1"># filtering &lt; T and reordering in delay domain</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tau</span><span class="o">&lt;</span><span class="n">T</span><span class="p">)]</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">et</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tau</span><span class="o">&lt;</span><span class="n">T</span><span class="p">)]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">taus</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="n">ets</span>  <span class="o">=</span> <span class="n">et</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># delays and amplitudes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">taus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ets</span></div>

<span class="k">class</span> <span class="nc">TUchannel</span><span class="p">(</span><span class="n">TBchannel</span><span class="p">,</span><span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Uniform channel in delay domain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">label</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TBchannel</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">toa_max2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival max2 method</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">THRE</span> <span class="o">=</span> <span class="n">array</span><span class="p">([])</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">array</span><span class="p">([])</span>
        <span class="n">VL</span> <span class="o">=</span> <span class="n">array</span><span class="p">([])</span>

        <span class="n">M</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">M</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">thre</span> <span class="o">=</span> <span class="n">M</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">THRE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">THRE</span><span class="p">,</span> <span class="n">thre</span><span class="p">))</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">V</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">VL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">VL</span><span class="p">,</span> <span class="n">vl</span><span class="p">))</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="mf">1e2</span>
        <span class="n">thre</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">step</span>

    <span class="c1">#       while thre &gt; M/1e2:</span>
        <span class="k">while</span> <span class="n">vl</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
    <span class="c1">#       while v &lt; 50:</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">thre</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">nbint</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">vl</span> <span class="o">=</span> <span class="n">nbint</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">THRE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">THRE</span><span class="p">,</span> <span class="n">thre</span><span class="p">))</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">V</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">VL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">VL</span><span class="p">,</span> <span class="n">vl</span><span class="p">))</span>

            <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">-</span> <span class="n">step</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">THRE</span> <span class="o">/</span> <span class="n">M</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interval number&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">THRE</span> <span class="o">/</span> <span class="n">M</span><span class="p">,</span> <span class="n">VL</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;interval(Left) number&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Gamma/Vmax&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">#       ylabel(&#39;Interval Number&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">toa_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; estimate time of arrival (new method)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">Max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">Max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nmax</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Max</span> <span class="o">/</span> <span class="mf">1e2</span>
        <span class="n">thre</span> <span class="o">=</span> <span class="n">Max</span> <span class="o">-</span> <span class="n">step</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nint</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">Max</span> <span class="o">/</span> <span class="mf">1e2</span><span class="p">:</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">thre</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">hr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nmax</span> <span class="o">&gt;=</span> <span class="mi">6000</span><span class="p">:</span>
            <span class="c1">#set the fenetre=6000*0.005=30ns</span>
                <span class="n">hl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">6000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">hl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">g</span>

            <span class="n">n_int</span> <span class="o">=</span> <span class="n">nbint</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">n_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">step</span>
                <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="c1">#print N</span>

            <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">-</span> <span class="n">step</span>
            <span class="k">if</span> <span class="n">thre</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">toa_win</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calulate time of arrival (window method)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        w : parameter between 0 and 100</span>
<span class="sd">        Lei takes w = 9</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">maxbruit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">])</span>
        <span class="n">Max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">Max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nmax</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">Max</span> <span class="o">/</span> <span class="mf">1e2</span>
        <span class="n">thre</span> <span class="o">=</span> <span class="n">Max</span> <span class="o">-</span> <span class="n">step</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nint</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="c1"># tant delta est plus grande que w% du Max</span>
        <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">w</span> <span class="o">*</span> <span class="n">Max</span> <span class="o">/</span> <span class="mf">1e2</span><span class="p">:</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">thre</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">hr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nmax</span> <span class="o">&gt;=</span> <span class="mi">6000</span><span class="p">:</span>
            <span class="c1">#set the fenetre=6000*0.005=30ns</span>
                <span class="n">hl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="n">nmax</span> <span class="o">-</span> <span class="mi">6000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">hl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">g</span>

            <span class="n">n_int</span> <span class="o">=</span> <span class="n">nbint</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">n_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">-</span> <span class="n">step</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="n">Max</span> <span class="o">-</span> <span class="n">maxbruit</span> <span class="o">-</span> <span class="n">d</span> <span class="o">-</span> <span class="n">step</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">step</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">-</span> <span class="n">step</span>

            <span class="k">if</span> <span class="n">thre</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">toa_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        descendant threshold based toa estimation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        nint : integer</span>
<span class="sd">            number of intervals</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># seek fot the maximum value of the signal</span>
        <span class="c1">#</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="mf">1e2</span>
    <span class="c1">#       plot(self.x,self.y)</span>
        <span class="n">thre</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="n">step</span>
        <span class="k">while</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="n">M</span> <span class="o">/</span> <span class="mf">1e5</span><span class="p">:</span>
    <span class="c1">#          axhline(y=thre,color=&#39;green&#39;)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">thre</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># nbint : number of contiguous intervals</span>
            <span class="k">if</span> <span class="n">pyu</span><span class="o">.</span><span class="n">nbint</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nint</span><span class="p">:</span>
            <span class="c1"># down</span>
                <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">-</span> <span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
            <span class="c1"># up + step reduction</span>
                <span class="n">thre</span> <span class="o">=</span> <span class="n">thre</span> <span class="o">+</span> <span class="n">step</span>
                <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="c1">#       plt.show()</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">toa_th</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thlos</span><span class="p">,</span> <span class="n">thnlos</span><span class="p">,</span> <span class="n">visibility</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        threshold based toa estimation using energy peak</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#  ( ) ^2</span>
        <span class="c1">#</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="k">if</span> <span class="n">visibility</span> <span class="o">==</span> <span class="s1">&#39;LOS&#39;</span><span class="p">:</span>
            <span class="n">th</span> <span class="o">=</span> <span class="n">thlos</span> <span class="o">*</span> <span class="n">maxy2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th</span> <span class="o">=</span> <span class="n">thnlos</span> <span class="o">*</span> <span class="n">maxy2</span>
        <span class="c1">#</span>
        <span class="c1">#In the W1-M1 measurement</span>
        <span class="c1">#thlos=0.05   thnlos=0.15</span>
        <span class="c1">#</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_cum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">th</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        threshold based toa estimation using cumulative energy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">cdf</span><span class="p">,</span> <span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecdf</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1">#In the W1-M1 measurement th=0.15</span>
        <span class="c1">#</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_th_tmtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Etot</span><span class="p">())</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Emax</span><span class="p">()))</span> <span class="o">/</span>  \
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Etot</span><span class="p">())</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Emax</span><span class="p">()))</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">maxy2</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_th_tm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Emax</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Etot</span><span class="p">())</span>
        <span class="k">print</span> <span class="n">alpha</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">maxy2</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_th_tmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Etot</span><span class="p">(</span>
        <span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Emax</span><span class="p">()))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Etot</span><span class="p">())</span>
        <span class="k">print</span> <span class="n">alpha</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">maxy2</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">&gt;=</span> <span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_cum_tm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cdf</span><span class="p">,</span> <span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecdf</span><span class="p">()</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_cum_tmtm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cdf</span><span class="p">,</span> <span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecdf</span><span class="p">()</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>

    <span class="k">def</span> <span class="nf">toa_cum_tmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate time of arrival</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cdf</span><span class="p">,</span> <span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecdf</span><span class="p">()</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">cdf</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">cdf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">toa</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">toa</span>



<div class="viewcode-block" id="TUchannel.psd"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.psd.html#pylayers.antprop.channel.TUchannel.psd">[docs]</a>    <span class="k">def</span> <span class="nf">psd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tpns</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">periodic</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate power spectral density</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        R    : Resistance (default 50 Ohms)</span>
<span class="sd">            Ohms</span>
<span class="sd">        Tpns : real</span>
<span class="sd">            Signal period PRP (default 100 ns)</span>

<span class="sd">        .. note::</span>

<span class="sd">            Notice this interesting property that if time is represented in ns</span>
<span class="sd">            the resulting PSD is expressed in dBm/MHz because there is the</span>
<span class="sd">            same scale factor 1e-9 between second and nanosecond as between</span>
<span class="sd">            dBW/Hz and dBm/MHz</span>

<span class="sd">            If periodic is False the signal duration is taken as period.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esd</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;unilateral&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">periodic</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">Tpns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">P</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">y</span><span class="o">/</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">P</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">P</span><span class="p">)</span></div>

<div class="viewcode-block" id="TUchannel.awgn"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.awgn.html#pylayers.antprop.channel.TUchannel.awgn">[docs]</a>    <span class="k">def</span> <span class="nf">awgn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">PSDdBmpHz</span><span class="o">=-</span><span class="mi">174</span><span class="p">,</span><span class="n">snr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;psd&#39;</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add a white Gaussian noise</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        PSDdBmpHz : float</span>
<span class="sd">        snr : float</span>
<span class="sd">        seed : float</span>
<span class="sd">        typ : string</span>
<span class="sd">            &#39;psd&#39; | &#39;snr&#39;</span>
<span class="sd">        R : float</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        n</span>
<span class="sd">        sn</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        bsignal.Noise</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tsns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fsGHz</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">tsns</span>

        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;snr&#39;</span><span class="p">:</span>
            <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="n">tf</span><span class="o">-</span><span class="n">ti</span><span class="p">))</span>
            <span class="n">PW</span> <span class="o">=</span> <span class="n">Ps</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">snr</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span>
            <span class="n">pWpHz</span> <span class="o">=</span> <span class="n">PW</span><span class="o">/</span><span class="p">(</span><span class="n">fsGHz</span><span class="o">*</span><span class="mf">1e9</span><span class="p">)</span>
            <span class="n">pmWpHz</span> <span class="o">=</span> <span class="n">pWpHz</span><span class="o">*</span><span class="mf">1e3</span>
            <span class="n">PSDdBmpHz</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pmWpHz</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">Noise</span><span class="p">(</span><span class="n">ti</span> <span class="o">=</span> <span class="n">ti</span><span class="p">,</span>
                  <span class="n">tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">+</span><span class="n">tsns</span><span class="p">,</span>
                  <span class="n">fsGHz</span> <span class="o">=</span> <span class="n">fsGHz</span><span class="p">,</span>
                  <span class="n">PSDdBmpHz</span> <span class="o">=</span> <span class="n">PSDdBmpHz</span><span class="p">,</span>
                  <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">,</span>
                  <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>

        <span class="n">sn</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)]</span>
        <span class="n">sn</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="k">return</span> <span class="n">sn</span><span class="p">,</span><span class="n">n</span></div>

<div class="viewcode-block" id="TUchannel.Etau0"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.Etau0.html#pylayers.antprop.channel.TUchannel.Etau0">[docs]</a>    <span class="k">def</span> <span class="nf">Etau0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">Tint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate energy around delay tau0</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tau0  : (ns)            (0)</span>
<span class="sd">        Tint  : Integration time (ns)   (1) include the system error</span>
<span class="sd">        sym   : symetrie factor 0.5 = symetric (0.25)</span>
<span class="sd">        dB    : logscale indicator (True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#u  = nonzero((tau0 + Tint*(1-sym) &gt; self.x) &amp; (self.x &gt; tau0 - Tint*sym))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">nonzero</span><span class="p">((</span><span class="n">tau0</span> <span class="o">+</span> <span class="n">Tint</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">tau0</span><span class="p">))</span>
        <span class="n">etau0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">etau0</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">etau0</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">etau0</span><span class="p">)</span></div>

<div class="viewcode-block" id="TUchannel.Ewin"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.Ewin.html#pylayers.antprop.channel.TUchannel.Ewin">[docs]</a>    <span class="k">def</span> <span class="nf">Ewin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Tint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  integrate energy around delay tau</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tau   : (ns)            (0)</span>
<span class="sd">        Tint  : Integration time (ns)   (1) include the system error</span>
<span class="sd">        sym   : symetrie factor 0.5 = symetric (0.25)</span>
<span class="sd">        dB    : logscale indicator (True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">Tint</span> <span class="o">*</span> <span class="n">sym</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">Tint</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sym</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">tstart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">tstop</span><span class="p">))</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span></div>

<div class="viewcode-block" id="TUchannel.Etot"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.Etot.html#pylayers.antprop.channel.TUchannel.Etot">[docs]</a>    <span class="k">def</span> <span class="nf">Etot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">taumax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Etot  calculate the energy of the signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tau0 : start value for integration</span>
<span class="sd">        dB   : (False default) if True value in dB</span>

<span class="sd">        usage  :</span>

<span class="sd">            s.Etot(tau0=10,dB=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">tau0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">taumax</span><span class="p">)</span>
        <span class="n">etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">etot</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">Efirst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toa</span><span class="p">,</span> <span class="n">Tint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate the energy of the first path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        toa  : float</span>
<span class="sd">            delay value</span>
<span class="sd">        Tint : float</span>
<span class="sd">            duration value (1)</span>
<span class="sd">        sym : float</span>
<span class="sd">            symmetry around delay value ( 0.25)</span>
<span class="sd">        dB : Boolean</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Efirst : Energy amount in the window (in dB if dB)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">toa</span> <span class="o">+</span> <span class="n">Tint</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">toa</span><span class="p">))</span>
        <span class="n">efirst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">efirst</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">efirst</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">efirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Efirst_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">Sx</span><span class="p">,</span> <span class="n">Sy</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate Efirst utilizing the correlation of signal emission et reponse impulsionnelle</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       tau0</span>
<span class="sd">       Sx</span>
<span class="sd">       Sy</span>
<span class="sd">       dB</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">E0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Sy</span> <span class="o">*</span> <span class="n">Sy</span><span class="p">)</span> <span class="o">*</span> <span class="n">te</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tau0</span> <span class="o">/</span> <span class="n">te</span><span class="p">))</span>
        <span class="n">Correlation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">Sy</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
        <span class="n">seuil</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Correlation</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Sx</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">200</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Correlation</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">200</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">seuil</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">seuil</span> <span class="o">/</span> <span class="n">E0</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Correlation</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">200</span><span class="p">:][</span><span class="n">v</span><span class="p">])</span> <span class="o">/</span> <span class="n">E0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Correlation</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">Sx</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">200</span><span class="p">:][</span><span class="n">vv</span><span class="p">])</span> <span class="o">/</span> <span class="n">E0</span>

        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">Ef</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">Ef</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Efirst_toath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau0</span><span class="p">,</span> <span class="n">Tint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate Efirst</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tau0   : Time of flight</span>
<span class="sd">        Tint</span>
<span class="sd">        sym</span>
<span class="sd">        dB   : if True return value in dBnJ</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tau0</span> <span class="o">/</span> <span class="n">te</span><span class="p">))</span>
        <span class="n">seuil</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">seuil</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">toa</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">te</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:][</span><span class="n">v</span><span class="p">])</span>
                <span class="n">toa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">te</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">:][</span><span class="n">vv</span><span class="p">])</span>
                <span class="n">toa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">te</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">toa</span> <span class="o">+</span> <span class="n">Tint</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sym</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">toa</span> <span class="o">-</span> <span class="n">Tint</span> <span class="o">*</span> <span class="n">sym</span><span class="p">))</span>
        <span class="n">efirst</span> <span class="o">=</span> <span class="n">te</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="n">efirst</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">efirst</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">efirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Epercent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return N percentile delay of a cdf</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        N : 10</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cdf</span><span class="p">,</span> <span class="n">vary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecdf</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">x</span>
        <span class="n">Cdf</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">y</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Cdf</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pc</span><span class="p">,</span> <span class="n">tp</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>

<div class="viewcode-block" id="TUchannel.Emax"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.TUchannel.Emax.html#pylayers.antprop.channel.TUchannel.Emax">[docs]</a>    <span class="k">def</span> <span class="nf">Emax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dB</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate the maximum of Energy integrated over a duration Tint</span>

<span class="sd">        A symetry of sym around the max value of the squared signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tint: float</span>
<span class="sd">            Integration time (ns) default 1</span>
<span class="sd">        sym : float</span>
<span class="sd">            Symmetry factor (default 0.5)</span>
<span class="sd">        dB  : boolean</span>
<span class="sd">            default False</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        W1-M1</span>
<span class="sd">        te     = 0.005 ns</span>
<span class="sd">        left  = 12</span>
<span class="sd">        Nright = 33</span>
<span class="sd">        Tint   = 45*te = 0.225 ns</span>
<span class="sd">        sym    = 0.25</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#  ( ) ^2</span>
        <span class="c1">#</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1">#</span>
        <span class="c1"># determine time of maximum value of ()^2</span>
        <span class="c1">#</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>

        <span class="n">Npt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Tint</span> <span class="o">/</span> <span class="n">te</span><span class="p">))</span>
        <span class="n">Nleft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sym</span> <span class="o">*</span> <span class="n">Npt</span><span class="p">))</span>
        <span class="n">Nright</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sym</span><span class="p">)</span> <span class="o">*</span> <span class="n">Npt</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="c1">#  Integration around the maximum value of E^2</span>
        <span class="c1">#  In the W1_M1 measurement</span>
        <span class="c1">#  te     = 0.005 ns</span>
        <span class="c1">#  Nleft  = 12</span>
        <span class="c1">#  Nright = 33</span>
        <span class="c1">#  Tint   = 45*te = 0.225 ns</span>
        <span class="c1">#  sym    = 0.25</span>
        <span class="c1">#</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">u</span> <span class="o">-</span> <span class="n">Nleft</span><span class="p">:</span><span class="n">u</span> <span class="o">+</span> <span class="n">Nright</span><span class="p">]</span>
        <span class="n">cumY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">maxY</span> <span class="o">=</span> <span class="n">cumY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Emax</span> <span class="o">=</span> <span class="n">maxY</span> <span class="o">*</span> <span class="n">te</span>
        <span class="k">if</span> <span class="n">dB</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">tau_Emax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate the delay of max energy peak</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">maxy2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y2</span> <span class="o">==</span> <span class="n">maxy2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tau_Emax</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tau_Emax</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">aggcir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alphak</span><span class="p">,</span><span class="n">tauk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; aggregation of CIR from (alphak,tauk)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        alphak : ndarray</span>
<span class="sd">            CIR path amplitude</span>
<span class="sd">        tauk : ndarray</span>
<span class="sd">            CIR delay values</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.signal.bsignal import *</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; alphak = 10*np.random.rand(7)</span>
<span class="sd">            &gt;&gt;&gt; tauk = 100*np.random.rand(7)</span>
<span class="sd">            &gt;&gt;&gt; tau = np.arange(0,150,0.1)</span>
<span class="sd">            &gt;&gt;&gt; y = np.zeros(len(tau))</span>
<span class="sd">            &gt;&gt;&gt; CIR = TUsignal(tau,y)</span>
<span class="sd">            &gt;&gt;&gt; CIR.aggcir(alphak,tauk)</span>
<span class="sd">            &gt;&gt;&gt; f,a =CIR.plot(typ=[&#39;v&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="n">t</span><span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="n">t</span><span class="o">+</span><span class="n">eps</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">tauk</span><span class="p">)</span>
        <span class="n">ynew</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">ynew</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphak</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shy</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">ynew</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ynew</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>


    <span class="k">def</span> <span class="nf">readcir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">outdir</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; read channel impulse response</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            long file name if outdir is []</span>
<span class="sd">            short file name is outdir is &lt;&gt; []</span>
<span class="sd">        outdir : string</span>
<span class="sd">            output directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">&lt;&gt;</span> <span class="p">[]:</span>
            <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;output/&#39;</span><span class="o">+</span><span class="n">outdir</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">getlong</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>

        <span class="n">cir</span> <span class="o">=</span> <span class="n">ios</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">cir</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">cir</span><span class="p">[</span><span class="s1">&#39;cir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">readuwb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; read  Waveform from Matlab file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        _filename : file name with extension (.mat)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="s1">&#39;output/&#39;</span><span class="o">+</span><span class="n">outdir</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span> <span class="n">outdir</span><span class="p">)</span>
        <span class="n">wfm</span> <span class="o">=</span> <span class="n">ios</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">wfm</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">T0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e-9</span>
        <span class="n">Tres</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Tres</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e-9</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">WformOut1</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span> <span class="n">T0</span> <span class="o">+</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Tres</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ecdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tnoise</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rem_noise</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">in_positivity</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate energy cumulative density function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tnoise     :</span>
<span class="sd">            Time duration of noise only portion (default=5ns)</span>
<span class="sd">        rem_noise  :</span>
<span class="sd">            remove noise if True</span>
<span class="sd">        in_positivity :</span>
<span class="sd">            inforce positivity if True</span>
<span class="sd">        normalize  :</span>
<span class="sd">            normalize if True (Not implemented)</span>
<span class="sd">        display    :</span>
<span class="sd">            display ecdf if True</span>
<span class="sd">        delay      :</span>
<span class="sd">            give a delay for vizualization</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ecdf , vary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#  ( ) ^2</span>
        <span class="c1">#</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="c1">#</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="n">te</span>
        <span class="c1"># retrieve the noise only portion at the beginning of TUsignal</span>
        <span class="c1">#</span>
        <span class="n">Nnoise</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Tnoise</span> <span class="o">/</span> <span class="n">te</span><span class="p">))</span>
        <span class="n">tn</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nnoise</span><span class="p">]</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">f1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nnoise</span><span class="p">]</span>
        <span class="n">stdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nnoise</span><span class="p">])</span>
        <span class="n">vary</span> <span class="o">=</span> <span class="n">stdy</span> <span class="o">*</span> <span class="n">stdy</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">vary</span>
        <span class="c1">#</span>
        <span class="c1"># y : linear interpolation of noise ecdf  (over whole time base)</span>
        <span class="c1">#</span>
        <span class="c1">#(ar,br)= polyfit(tn,fn,1)</span>
        <span class="c1">#print ar</span>
        <span class="c1">#y  = polyval([ar,br],t)</span>
        <span class="k">if</span> <span class="n">rem_noise</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">-</span> <span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span>

        <span class="c1">#</span>
        <span class="c1"># inforce positivity</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">in_positivity</span><span class="p">:</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">pdf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pdf</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ecdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ecdf</span> <span class="o">=</span> <span class="n">f</span>
        <span class="c1">#</span>
        <span class="c1"># Normalization step</span>
        <span class="c1">#</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">ecdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#print E</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">ecdf</span> <span class="o">=</span> <span class="n">ecdf</span> <span class="o">/</span> <span class="n">E</span>
        <span class="c1">#</span>
        <span class="c1"># Resizing</span>
        <span class="c1">#</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">Necdf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecdf</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Nt</span><span class="p">,</span> <span class="n">Necdf</span><span class="p">)</span>
        <span class="n">ecdf</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">],</span> <span class="n">ecdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N</span><span class="p">])</span>
        <span class="c1">#</span>
        <span class="c1"># Display</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
            <span class="n">ecdf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vary</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vary</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">vary</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">vary</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ecdf</span><span class="p">,</span> <span class="n">vary</span>

<span class="k">class</span> <span class="nc">TUDchannel</span><span class="p">(</span><span class="n">TUchannel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Uniform channel in Time domain with delay</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    x   : ndarray</span>
<span class="sd">    y   : ndarray</span>
<span class="sd">    taud : ndarray</span>
<span class="sd">        direct delay</span>
<span class="sd">    taue : ndarray</span>
<span class="sd">        excess delay</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">taud</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">taue</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TUDchannel</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="c1">#TUsignal.__init__(self, x, y)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">=</span> <span class="n">taud</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taue</span> <span class="o">=</span> <span class="n">taue</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="s2">&quot;Time domain channel with delay </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">TUchannel</span><span class="o">.</span><span class="n">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s1</span><span class="o">+</span><span class="n">s</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot a figure of the N first signals</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        N : int</span>
<span class="sd">            number of y signal to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="nb">max</span> <span class="o">-</span> <span class="nb">min</span>
        <span class="n">ecmax</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">Nmax</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">N1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">Nmax</span><span class="p">))</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="n">N1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ecmax</span>
        <span class="n">yN1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">N1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">gk</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gk</span><span class="p">)</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yN1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])</span>

           <span class="c1">#r.plot(x, yN1, main=&#39;Ray response&#39;, xlab=&#39;Time (ns)&#39;, ylab=&#39;y&#39;, type=&#39;l&#39;, col=&#39;black&#39; ,frame=&#39;False&#39;,  ylim=r.range(y1,yN1) )</span>
           <span class="c1">#for i in range(N1-1):</span>
           <span class="c1">#    yi = self.y[i+1,:] + (N1-i)*ecmax</span>
           <span class="c1">#    r.lines(x,yi,col=&#39;black&#39;)</span>

<span class="k">class</span> <span class="nc">Mchannel</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handle the measured channel</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">x</span> <span class="p">,</span>
                <span class="n">y</span> <span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; class constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x  :  , nfreq</span>
<span class="sd">            frequency GHz</span>
<span class="sd">        y  :  Nm x Nr x Nt x Nf </span>
<span class="sd">            measured channel </span>

<span class="sd">        &quot;&quot;&quot;</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nm</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nr</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nt</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nf</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mchannel&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="p">[],</span><span class="n">ax</span><span class="o">=</span><span class="p">[],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span><span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>  
        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span><span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
            <span class="n">cir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">ffts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">cir</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cir</span><span class="o">.</span><span class="n">x</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>    

        <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">my</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="c1"># TD centered      ; TDc.shape : (85, 4, 8, 801)</span>

        <span class="n">yc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># square of TD centered     ; TDc2.shape : (85, 4, 8, 801)</span>
        <span class="n">vary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yc2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#variance of TD  ; varTD.shape : (4, 8, 801)</span>
        
        

        <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nr</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nt</span><span class="p">):</span>
                <span class="c1">#cpt=cpt+1</span>
                <span class="c1">#ax = plt.subplot(self.Nr,self.Nt,cpt)</span>
                <span class="c1">#l1, = ax.plot(self.x,np.sqrt(vary[r,t,:]),color=&#39;k&#39;,linewidth=1,alpha=1)</span>
                <span class="c1">#l1, = ax.plot(self.x,np.sqrt(vary[r,t,:]),linewidth=1,alpha=1)</span>
                <span class="c1">#l2, = ax.plot(self.x,my[r,t,:],color=&#39;r&#39;,linewidth=1,alpha=1)</span>
                <span class="n">l2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">my</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">t</span><span class="p">,:],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                <span class="n">ticksx</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span>
                <span class="n">ticksy</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ticksx</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ticksy</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1">#l1, = ax.plot(self.x,np.sqrt(vary[r,t,:]),color=&#39;k&#39;,label=&#39;sd&#39;,linewidth=1,alpha=1)</span>
                    <span class="n">l2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">my</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">t</span><span class="p">,:]),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ticksx</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.2</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ticksy</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">r&#39;Evolution of the mean and the standard deviation of $\mathbf{H}(f)$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Amplitude (linear scale $\in [0,1]$)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                


<span class="k">class</span> <span class="nc">Tchannel</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handle the transmission channel</span>

<span class="sd">    The transmission channel TChannel is obtained through combination of the propagation</span>
<span class="sd">    channel and the antenna transfer functions from both transmitter and receiver.</span>

<span class="sd">    Members</span>
<span class="sd">    -------</span>

<span class="sd">        ray transfer functions  (nray,nfreq)</span>
<span class="sd">    dod  :</span>
<span class="sd">        direction of depature (rad) [theta_t,phi_t]  nray x 2</span>
<span class="sd">    doa  :</span>
<span class="sd">        direction of arrival (rad)  [theta_r,phi_r]  nray x 2</span>
<span class="sd">    tauk :</span>
<span class="sd">        delay ray k in ns</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    imshow()</span>
<span class="sd">    apply(W)</span>
<span class="sd">    applywavB(Wgam)</span>
<span class="sd">    applywavC(Wgam)</span>
<span class="sd">    chantap(fcGHz,WGHz,Ntap)</span>
<span class="sd">    doddoa()</span>
<span class="sd">    wavefig(w,Nray)</span>
<span class="sd">    rayfig(w,Nray)</span>
<span class="sd">    rssi(ufreq)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pylayers.antprop.Ctilde.prop2tran</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">tau</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([],)),</span>
                <span class="n">dod</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([[],[]]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">doa</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([[],[]]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; class constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        x  :  , nfreq</span>
<span class="sd">            frequency GHz</span>
<span class="sd">        y  :  nray x nfreq</span>
<span class="sd">            path amplitude</span>
<span class="sd">        tau   :  1 x nray</span>
<span class="sd">            path delay (ns)</span>
<span class="sd">        dod   :  direction of departure (nray x 2)</span>
<span class="sd">        doa   :  direction of arrival   (nray x 2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="c1"># FUDsignal.__init__(self, x, y,taud)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dod</span>  <span class="o">=</span> <span class="n">dod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doa</span>  <span class="o">=</span> <span class="n">doa</span>
        <span class="c1"># , Nf</span>
        <span class="c1"># Nd x Nf x Np x Nu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="s1">&#39;rect&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isFriis</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filcal</span><span class="o">=</span><span class="s2">&quot;calibration.mat&quot;</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;Tchannel : Ray transfer function (Nray x Nr x Nt x Nf)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39;-----------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;freq : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;shape  : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;tau (min, max) : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;dist (min,max) : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFriis</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;Friis factor -j c/(4 pi f) has been applied&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> calibrated : Yes</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> calibrated : No</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowed</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39; windowed : Yes</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">win</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">+</span><span class="s1">&#39; windowed : No</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">return</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>


<div class="viewcode-block" id="Tchannel.saveh5"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.saveh5.html#pylayers.antprop.channel.Tchannel.saveh5">[docs]</a>    <span class="k">def</span> <span class="nf">saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Lfilename</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">Ta</span><span class="p">,</span><span class="n">Tb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save Ctilde object in hdf5 format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Lfilename  : string</span>
<span class="sd">            Layout filename</span>
<span class="sd">        Tilde</span>
<span class="sd">            file identifier number</span>
<span class="sd">        a : np.ndarray</span>
<span class="sd">            postion of point a (transmitter)</span>
<span class="sd">        b : np.ndarray</span>
<span class="sd">            postion of point b (receiver)</span>
<span class="sd">        Ta : np.ndarray</span>
<span class="sd">            rotation matrice of antenna a</span>
<span class="sd">        Tb : np.ndarray</span>
<span class="sd">            rotation matrice of antenna b</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_Lfilename</span><span class="o">=</span><span class="n">Lfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filename</span><span class="o">=</span> <span class="n">_Lfilename</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>
        <span class="n">filenameh5</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRH&#39;</span><span class="p">])</span>

        <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">a</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">b</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Ta</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Tb&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Tb</span>
            <span class="c1"># keys not saved as attribute of h5py file</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">va</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="n">va</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel Tchannel: issue when writting h5py file&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.loadh5"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.loadh5.html#pylayers.antprop.channel.Tchannel.loadh5">[docs]</a>    <span class="k">def</span> <span class="nf">loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Lfilename</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load Ctilde object in hdf5 format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Lfilename  : string</span>
<span class="sd">            Layout filename</span>
<span class="sd">        idx : int</span>
<span class="sd">            file identifier number</span>
<span class="sd">        output : bool</span>
<span class="sd">            return an output precised in return</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        if output:</span>
<span class="sd">        (a,b,Ta,Tb)</span>

<span class="sd">        with</span>
<span class="sd">            a = np.ndarray</span>
<span class="sd">                postion of point a (transmitter)</span>
<span class="sd">            b = np.ndarray</span>
<span class="sd">                postion of point b (receiver)</span>
<span class="sd">            Ta = np.ndarray</span>
<span class="sd">                rotation matrice of antenna a</span>
<span class="sd">            Tb = np.ndarray</span>
<span class="sd">                rotation matrice of antenna b</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Lfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>
        <span class="n">filenameh5</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRH&#39;</span><span class="p">])</span>

        <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># keys not saved as attribute of h5py file</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># if k != &#39;tau1&#39;:</span>
                <span class="c1">#     setattr(self,str(k),va[:])</span>
                <span class="c1"># else :</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">va</span><span class="p">)</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
            <span class="n">Ta</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Ta&#39;</span><span class="p">]</span>
            <span class="n">Tb</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Tb&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">Ta</span><span class="p">,</span><span class="n">Tb</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel Tchannel: issue when reading h5py file&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save Tchannel object in hdf5 format compliant with Link Class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5  : str</span>
<span class="sd">            file name of h5py file Link format</span>
<span class="sd">        grpname  : int</span>
<span class="sd">            groupname in filenameh5</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grpname</span> <span class="ow">in</span> <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">grpname</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Warning : H/&#39;</span><span class="o">+</span><span class="n">grpname</span> <span class="o">+</span><span class="s1">&#39;already exists in &#39;</span><span class="o">+</span><span class="n">filenameh5</span>
            <span class="n">f</span><span class="o">=</span><span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;H/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1">#print k,va</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">va</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="n">va</span><span class="p">)</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel Tchannel: issue when writting h5py file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load H object in hdf5 format compliant with Link Class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5  : str</span>
<span class="sd">            file name of h5py file Link format</span>
<span class="sd">        grpname  : int</span>
<span class="sd">            groupname in filenameh5</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;H/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="c1"># keys not saved as attribute of h5py file</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span><span class="s1">&#39;isFriis&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">va</span><span class="p">[:])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">va</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">va</span><span class="p">)</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel Tchannel: issue when reading h5py file&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Tchannel.apply"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.apply.html#pylayers.antprop.channel.Tchannel.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply FUsignal W to the Tchannel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        W :  Bsignal.FUsignal</span>

<span class="sd">        It exploits multigrid convolution from Bsignal.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        mport ipdb</span>
<span class="sd">        V : FUDAsignal</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Returns :math:`W(f) H_k(f)`</span>

<span class="sd">            + W may have a more important number of points and a smaller frequency band.</span>
<span class="sd">            + If the frequency band of the waveform exceeds the one of the</span>
<span class="sd">            Transmission Channel, a warning is sent.</span>
<span class="sd">            + W is a FUsignal whose shape doesn&#39;t need to be homogeneous with FUChannel H</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="bp">self</span> 
        <span class="n">V</span> <span class="o">=</span> <span class="n">Tchannel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">,</span> <span class="n">dod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">,</span> <span class="n">doa</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">V</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">applywav</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Wgam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply waveform (time domain ) to obtain the</span>
<span class="sd">            rays impulses response</span>

<span class="sd">            this is the 2015 vectorized method for applying </span>
<span class="sd">            wav on Tchannel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Wgam : waveform</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        rir  : array, </span>
<span class="sd">            impulse response for each ray separately</span>
<span class="sd">            the size of the array is (nb_rays, support_length)</span>
<span class="sd">            support_length is calculated in regard of the </span>
<span class="sd">            delays of the channel</span>

<span class="sd">            </span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>

<span class="sd">            The overall received signal is built in time domain</span>

<span class="sd">            Wgam is applied on each Ray Transfer function</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.channel.rir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># product in frequency domain between Channel (self) and waveform</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Wgam</span><span class="p">)</span>
        <span class="c1"># back in time domain</span>
        <span class="n">rir</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">rir</span><span class="p">(</span><span class="n">Nz</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">ffts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rir</span>


    <span class="k">def</span> <span class="nf">get_cir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Wgam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get Channel impulse response of the channel </span>
<span class="sd">            for a given waveform</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Wgam : waveform</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ri  : TUsignal</span>

<span class="sd">            impulse response for each ray separately</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">applywav</span><span class="p">(</span><span class="n">Wgam</span><span class="p">)</span>
        <span class="n">cir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rir</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">rir</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">cir</span><span class="p">)</span>
        

<div class="viewcode-block" id="Tchannel.applywavC"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.applywavC.html#pylayers.antprop.channel.Tchannel.applywavC">[docs]</a>    <span class="k">def</span> <span class="nf">applywavC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dxw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply waveform method C</span>
<span class="sd">        DEPRECATED</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        w :</span>
<span class="sd">            waveform</span>
<span class="sd">        dxw :</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        The overall received signal is built in time domain</span>
<span class="sd">        w is apply on the overall CIR</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="ne">DeprecationWarning</span><span class="p">(</span>
            <span class="s1">&#39;WARNING : Tchannel.applywavC is going to be replaced by Tchannel.applywav&#39;</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ft1</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dxh</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dxh</span> <span class="o">-</span> <span class="n">dxw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dxh</span> <span class="o">&lt;</span> <span class="n">dxw</span><span class="p">):</span>
                <span class="c1"># reinterpolate w</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">w</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dxh</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y_new</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reinterpolate h</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dxw</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y_new</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">)</span>

        <span class="n">ri</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.chantap"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.chantap.html#pylayers.antprop.channel.Tchannel.chantap">[docs]</a>    <span class="k">def</span> <span class="nf">chantap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; channel tap</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fcGHz :</span>
<span class="sd">            WGHz  :</span>
<span class="sd">        Ntap  : int</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fcGHz&#39;</span><span class="p">:</span><span class="mf">4.5</span><span class="p">,</span>
                    <span class="s1">&#39;WGHz&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;Ntap&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">Tchannel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">)</span>
        <span class="n">htap</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">chantap</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">htap</span></div>

<div class="viewcode-block" id="Tchannel.applywavB"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.applywavB.html#pylayers.antprop.channel.Tchannel.applywavB">[docs]</a>    <span class="k">def</span> <span class="nf">applywavB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Wgam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply waveform method B (time domain )</span>

<span class="sd">        DEPRECATED</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Wgam : waveform</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ri  : TUDsignal</span>

<span class="sd">            impulse response for each ray separately</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>

<span class="sd">            The overall received signal is built in time domain</span>

<span class="sd">            Wgam is applied on each Ray Transfer function</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal.TUDsignal.ft1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">print</span> <span class="ne">DeprecationWarning</span><span class="p">(</span>
            <span class="s1">&#39;WARNING : Tchannel.applywavB is going to be replaced by Tchannel.applywav&#39;</span><span class="p">)</span>

        <span class="c1"># product in frequency domain between Channel (self) and waveform</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Wgam</span><span class="p">)</span>
        <span class="c1"># back in time domain</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">ft1</span><span class="p">(</span><span class="n">Nz</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">ffts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.applywavA"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.applywavA.html#pylayers.antprop.channel.Tchannel.applywavA">[docs]</a>    <span class="k">def</span> <span class="nf">applywavA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Wgam</span><span class="p">,</span> <span class="n">Tw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; apply waveform method A</span>

<span class="sd">        DEPRECATED</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Wgam :</span>
<span class="sd">        Tw   :</span>

<span class="sd">        The overall received signal is built in frequency domain</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="ne">DeprecationWarning</span><span class="p">(</span>
            <span class="s1">&#39;WARNING : Tchannel.applywavA is going to be replaced by Tchannel.applywav&#39;</span><span class="p">)</span>
        <span class="n">Hab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">ft2</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">HabW</span> <span class="o">=</span> <span class="n">Hab</span> <span class="o">*</span> <span class="n">Wgam</span>
        <span class="n">RI</span> <span class="o">=</span> <span class="n">HabW</span><span class="o">.</span><span class="n">symHz</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">RI</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;natural&#39;</span><span class="p">)</span>
        <span class="n">ri</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">Tw</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ri</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tchannel.plotd"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.plotd.html#pylayers.antprop.channel.Tchannel.plotd">[docs]</a>    <span class="k">def</span> <span class="nf">plotd</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;plot direction of arrival and departure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        d: &#39;doa&#39; | &#39;dod&#39;</span>
<span class="sd">            display direction of departure | arrival</span>
<span class="sd">        fig : plt.figure</span>
<span class="sd">        ax : plt.axis</span>
<span class="sd">        phi: tuple (-180, 180)</span>
<span class="sd">            phi angle</span>
<span class="sd">        normalize: bool</span>
<span class="sd">            energy normalized</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            inverse theta and phi represenation</span>
<span class="sd">        polar : bool</span>
<span class="sd">            polar representation</span>
<span class="sd">        cmap: matplotlib.cmap</span>
<span class="sd">        mode: &#39;center&#39; | &#39;mean&#39; | &#39;in&#39;</span>
<span class="sd">            see bsignal.energy</span>
<span class="sd">        s : float</span>
<span class="sd">            scatter dot size</span>
<span class="sd">        fontsize: float</span>
<span class="sd">        edgecolors: bool</span>
<span class="sd">        colorbar: bool</span>
<span class="sd">        title : bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;phi&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
                    <span class="s1">&#39;normalize&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;reverse&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;polar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;colorbar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;xa&#39;</span><span class="p">:[],</span>
                    <span class="s1">&#39;xb&#39;</span><span class="p">:[]</span>
                    <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


        <span class="n">di</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;doa&#39;</span><span class="p">)</span>


        <span class="c1"># remove non plt.scatter kwargs</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>
        <span class="n">the</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fontsize&#39;</span><span class="p">)</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fig&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ax&#39;</span><span class="p">)</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colorbar&#39;</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xa&#39;</span><span class="p">)</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>


        <span class="n">Etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-15</span>


        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot</span> <span class="o">/</span> <span class="n">Emax</span>
        <span class="c1">#</span>
        <span class="c1"># col  = 1 - (10*log10(Etot)-Emin)/(Emax-Emin)</span>
        <span class="c1"># WARNING polar plot require radian angles</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">polar</span> <span class="p">:</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">alb</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="n">phi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">the</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">the</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reverse</span> <span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">alb</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">col</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;len(col):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;len(di):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reverse</span> <span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">di</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">alb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\phi(^{\circ})$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta_t(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">di</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">alb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta_t(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\phi(^{\circ})$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;dB&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Path Loss (dB)&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tchannel.plotad"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.plotad.html#pylayers.antprop.channel.Tchannel.plotad">[docs]</a>    <span class="k">def</span> <span class="nf">plotad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;plot angular delays</span>

<span class="sd">         Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        d: &#39;doa&#39; | &#39;dod&#39;</span>
<span class="sd">            display direction of departure | arrival</span>
<span class="sd">        typ : &#39;ns&#39; | &#39;m&#39;</span>
<span class="sd">            display delays in nano seconds ( ns) or meter (m)</span>
<span class="sd">        fig : plt.figure</span>
<span class="sd">        ax : plt.axis</span>
<span class="sd">        a : str</span>
<span class="sd">            angle &#39;theta&#39; | &#39;phi&#39;</span>
<span class="sd">        normalize: bool</span>
<span class="sd">            energy normalized</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            inverse theta and phi represenation</span>
<span class="sd">        polar : bool</span>
<span class="sd">            polar representation</span>
<span class="sd">        cmap: matplotlib.cmap</span>
<span class="sd">        mode: &#39;center&#39; | &#39;mean&#39; | &#39;in&#39;</span>
<span class="sd">            see bsignal.energy</span>
<span class="sd">        s : float</span>
<span class="sd">            scatter dot size</span>
<span class="sd">        fontsize: float</span>
<span class="sd">        edgecolors: bool</span>
<span class="sd">        colorbar: bool</span>
<span class="sd">        titel : bool</span>
<span class="sd">        &#39;clipval&#39;: float</span>
<span class="sd">            remove values below clipval in dB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;normalize&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;polar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;colorbar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;taumin&#39;</span><span class="p">:[],</span>
                    <span class="s1">&#39;taumax&#39;</span><span class="p">:[],</span>
                    <span class="s1">&#39;typ&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;clipval&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2500</span><span class="p">,</span>
                    <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="s1">&#39;doa&#39;</span>
                    <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


        <span class="c1"># remove non plt.scatter kwargs</span>

        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fontsize&#39;</span><span class="p">)</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fig&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ax&#39;</span><span class="p">)</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colorbar&#39;</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;taumin&#39;</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;taumax&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;typ&#39;</span><span class="p">)</span>
        <span class="n">clipval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clipval&#39;</span><span class="p">)</span>
        <span class="n">do</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">do</span><span class="o">==</span><span class="s1">&#39;doa&#39;</span><span class="p">:</span>
            <span class="n">di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span>
        <span class="k">elif</span> <span class="n">do</span><span class="o">==</span><span class="s1">&#39;dod&#39;</span><span class="p">:</span>
            <span class="n">di</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span>

        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">))</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span><span class="o">*</span><span class="mf">0.3</span>

        <span class="k">if</span> <span class="n">dmin</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="c1">#min(delay)</span>
        <span class="k">if</span> <span class="n">dmax</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">dmax</span><span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFriis</span> <span class="p">:</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-15</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-15</span>


        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot</span> <span class="o">/</span> <span class="n">Emax</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># col  = 1 - (10*log10(Etot)-Emin)/(Emax-Emin)</span>
        <span class="c1"># WARNING polar plot require radian angles</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">polar</span> <span class="p">:</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">else</span> <span class="p">:</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>


        <span class="n">col</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span> <span class="o">&gt;=</span> <span class="n">clipval</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">cv</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;len(col):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;len(di):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;phi&#39;</span><span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="n">cv</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">delay</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">ang</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ang</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;$\phi(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span> <span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;distance (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;$\phi(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="n">cv</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">delay</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">ang</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ang</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dmin</span><span class="p">,</span><span class="n">dmax</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">r&quot;$</span><span class="se">\\</span><span class="s2">theta_t(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span> <span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;distance (m)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">r&quot;$\phi(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title</span> <span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;DoA vs delay (ns)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="n">b</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;dB&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Path Loss (dB)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tchannel.doadod"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.doadod.html#pylayers.antprop.channel.Tchannel.doadod">[docs]</a>    <span class="k">def</span> <span class="nf">doadod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; doadod scatter plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        phi: tuple (-180, 180)</span>
<span class="sd">            phi angle</span>
<span class="sd">        normalize: bool</span>
<span class="sd">            energy normalized</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            inverse theta and phi represenation</span>
<span class="sd">        polar : bool</span>
<span class="sd">            polar representation</span>
<span class="sd">        cmap: matplotlib.cmap</span>
<span class="sd">        mode: &#39;center&#39; | &#39;mean&#39; | &#39;in&#39;</span>
<span class="sd">            see bsignal.energy</span>
<span class="sd">        s : float</span>
<span class="sd">            scatter dot size</span>
<span class="sd">        fontsize: float</span>
<span class="sd">        edgecolors: bool</span>
<span class="sd">        colorbar bool</span>

<span class="sd">        Summary</span>
<span class="sd">        --------</span>

<span class="sd">        scatter plot of the DoA-DoD channel structure</span>
<span class="sd">        the energy is colorcoded over all couples of DoA-DoD</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;phi&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
                    <span class="s1">&#39;normalize&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;reverse&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;polar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;xa&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;xb&#39;</span><span class="p">:</span><span class="mi">0</span>
                    <span class="p">}</span>


        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">ax1</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span><span class="n">polar</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;polar&#39;</span><span class="p">])</span>
        <span class="n">ax2</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span><span class="n">polar</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;polar&#39;</span><span class="p">])</span>


        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xa&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xb&#39;</span><span class="p">]:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;dod&#39;</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;dod&#39;</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span></div>

    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tau</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
        <span class="n">fGHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,:]</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mi">1j</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">E</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#f = bs.FUsignal(x=self.x,y=np.sum(F,axis=0))</span>
        <span class="c1">#return(f)</span>


<div class="viewcode-block" id="Tchannel.energy"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.energy.html#pylayers.antprop.channel.Tchannel.energy">[docs]</a>    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">sumray</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculates channel energy including antennas spatial filtering</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        mode : string</span>
<span class="sd">            center | mean | integ    (different manner to get the value)</span>
<span class="sd">        Friis : boolean</span>
<span class="sd">            apply the Frris coeff(2/(4p pi f)</span>
<span class="sd">        sumray: boolean</span>
<span class="sd">            ray energy cummulation indicator</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#  r x f</span>
        <span class="c1">#  axis 1 : ray</span>
        <span class="c1">#  axis 1 : frequency</span>
        <span class="c1">#</span>
        <span class="n">Etot</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="n">Friis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sumray</span><span class="p">:</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Etot</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Etot</span></div>

<div class="viewcode-block" id="Tchannel.wavefig"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.wavefig.html#pylayers.antprop.channel.Tchannel.wavefig">[docs]</a>    <span class="k">def</span> <span class="nf">wavefig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">Nray</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; display</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        w      :  waveform</span>
<span class="sd">        Nray   :  int</span>
<span class="sd">            number of rays to be displayed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construire W</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">ft</span><span class="p">()</span>
        <span class="c1"># Appliquer W</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
        <span class="c1"># r.require(&#39;graphics&#39;)</span>
        <span class="c1"># r.postscript(&#39;fig.eps&#39;)</span>
        <span class="c1"># r(&#39;par(mfrow=c(2,2))&#39;)</span>
        <span class="c1"># Y.fig(Nray)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">iftd</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">fig</span><span class="p">(</span><span class="n">Nray</span><span class="p">)</span></div>
        <span class="c1"># r.dev_off()</span>
        <span class="c1"># os.system(&quot;gv fig.eps &quot;)</span>
        <span class="c1"># y.fidec()</span>
        <span class="c1"># Sur le FUsignal retourn</span>
        <span class="c1"># A gauche afficher le signal sur chaque rayon</span>
        <span class="c1"># A droite le meme signal decal</span>
        <span class="c1"># En bas a droite le signal resultant</span>

<div class="viewcode-block" id="Tchannel.rayfig"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.rayfig.html#pylayers.antprop.channel.Tchannel.rayfig">[docs]</a>    <span class="k">def</span> <span class="nf">rayfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build a figure with rays</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        k : ray index</span>
<span class="sd">        W : waveform    (FUsignal)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        W is apply on k-th ray and the received signal is built in time domain</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the kth Ray  Transfer function</span>
        <span class="n">Hk</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUDsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>

        <span class="n">dxh</span> <span class="o">=</span> <span class="n">Hk</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">dxw</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># fmin W</span>
        <span class="n">hk0</span> <span class="o">=</span> <span class="n">Hk</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># fmin Hk</span>

        <span class="c1"># on s&#39;arrange pour que hk0 soit egal a w0 (ou hk0 soit legerement inferieur a w0)</span>
        <span class="k">if</span> <span class="n">w0</span> <span class="o">&lt;</span> <span class="n">hk0</span><span class="p">:</span>
            <span class="n">np</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">((</span><span class="n">hk0</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span> <span class="o">/</span> <span class="n">dxh</span><span class="p">)</span>
            <span class="n">hk0_new</span> <span class="o">=</span> <span class="n">hk0</span> <span class="o">-</span> <span class="n">np</span> <span class="o">*</span> <span class="n">dxh</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">hk0_new</span><span class="p">,</span> <span class="n">hk0</span> <span class="o">+</span> <span class="n">dxh</span><span class="p">,</span> <span class="n">dxh</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Hk</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">Hk</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="n">Hk</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="p">),</span> <span class="n">Hk</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dxh</span> <span class="o">-</span> <span class="n">dxw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dxh</span> <span class="o">&lt;</span> <span class="n">dxw</span><span class="p">):</span>
                <span class="c1"># reinterpolate w</span>
                <span class="k">print</span> <span class="s2">&quot; resampling w&quot;</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">W</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dxh</span><span class="p">,</span> <span class="n">dxh</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Wk</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">dxh</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reinterpolate h</span>
                <span class="k">print</span> <span class="s2">&quot; resampling h&quot;</span>
                <span class="n">x_new</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">Hk</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Hk</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dxw</span><span class="p">,</span> <span class="n">dxw</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Hk</span> <span class="o">=</span> <span class="n">Hk</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">dxw</span>
                <span class="n">Wk</span> <span class="o">=</span> <span class="n">W</span></div>

        <span class="c1"># qHk.x[0]==Wk.x[0]</span>

<div class="viewcode-block" id="Tchannel.rssi"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.rssi.html#pylayers.antprop.channel.Tchannel.rssi">[docs]</a>    <span class="k">def</span> <span class="nf">rssi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ufreq</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Compute RSSI value for a frequency index</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ufreq : int</span>
<span class="sd">            index in the frequency range</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        RSSI: float</span>
<span class="sd">        RSSI value in dB</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This function will be deprecated by energy function</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Ak</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span> <span class="n">ufreq</span><span class="p">]</span>
        <span class="n">Pr</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ak</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Ak</span><span class="p">))</span>
        <span class="n">akp</span>   <span class="o">=</span> <span class="n">Ak</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mi">1j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ufreq</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">)</span>
        <span class="n">Prp</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">akp</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">PrdB</span>  <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Pr</span><span class="p">)</span>
        <span class="n">PrpdB</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Prp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PrdB</span><span class="p">,</span><span class="n">PrpdB</span></div>

<div class="viewcode-block" id="Tchannel.cut"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.cut.html#pylayers.antprop.channel.Tchannel.cut">[docs]</a>    <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; cut the signal at an Energy threshold level</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        threshold : float</span>
<span class="sd">            default 0.99</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eprfl</span><span class="p">()</span>
        <span class="n">cumE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumE</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="c1">#self.tau = self.tau[v]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span></div>

<div class="viewcode-block" id="Tchannel.sort"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.sort.html#pylayers.antprop.channel.Tchannel.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;tau&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sort FUD signal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        typ  : string</span>
<span class="sd">            which parameter to sort &#39;</span>
<span class="sd">                tau : (default)</span>
<span class="sd">                energy</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;energy&#39;</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eprfl</span><span class="p">()</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">u</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.showtap"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.showtap.html#pylayers.antprop.channel.Tchannel.showtap">[docs]</a>    <span class="k">def</span> <span class="nf">showtap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; show tap</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        same as tap</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        tap</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># f x s  x m x tap</span>

        <span class="n">htap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tap</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># sum over time m</span>
        <span class="n">Et_htap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">htap</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">htap</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">Nm</span>
        <span class="c1"># sum over s</span>
        <span class="n">Er_htap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">htap</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Ns</span>
        <span class="n">corrtap</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">Er_htap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Er_htap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]))</span></div>

<div class="viewcode-block" id="Tchannel.tap"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.tap.html#pylayers.antprop.channel.Tchannel.tap">[docs]</a>    <span class="k">def</span> <span class="nf">tap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate channel tap</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fcGHz : float</span>
<span class="sd">            center frequency</span>
<span class="sd">        WMHz : float</span>
<span class="sd">            bandwidth</span>
<span class="sd">        Ntap : int</span>
<span class="sd">            number of taps (related to bandwith)</span>
<span class="sd">            as the bandwith increases the potential number of taps increases</span>
<span class="sd">        Ns : int</span>
<span class="sd">            number of spatial realizations</span>
<span class="sd">        Nm : int</span>
<span class="sd">            number of time samples</span>
<span class="sd">            the channel is sampled along a distance of half a wavelength</span>
<span class="sd">        Va : velocity of link termination a</span>
<span class="sd">        Vb : velocity of link termination b</span>
<span class="sd">        theta_va : float</span>
<span class="sd">            theta velocity termination a (in radians)</span>
<span class="sd">        phi_va  :</span>
<span class="sd">            phi  velocity termination a (in radians)</span>
<span class="sd">        theta_vb:</span>
<span class="sd">            theta velocity termination b (in radians)</span>
<span class="sd">        phi_vb  :</span>
<span class="sd">            phi velocity termination b (in radians)</span>


<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.signal.bsignal import *</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fcGHz&#39;</span><span class="p">:</span><span class="mf">4.5</span><span class="p">,</span>
                    <span class="s1">&#39;WMHz&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;Ntap&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;Ns&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                    <span class="s1">&#39;Nm&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;Va&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>  <span class="c1">#meter/s</span>
                    <span class="s1">&#39;Vb&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>  <span class="c1">#meter/s</span>
                    <span class="s1">&#39;theta_va&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;phi_va&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;theta_vb&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;phi_vb&#39;</span><span class="p">:</span><span class="mi">0</span> <span class="p">}</span>


        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">fcGHz</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fcGHz&#39;</span><span class="p">]</span>
        <span class="n">WMHz</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;WMHz&#39;</span><span class="p">]</span>
        <span class="n">Ntap</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Ntap&#39;</span><span class="p">]</span>
        <span class="n">Ns</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Ns&#39;</span><span class="p">]</span>
        <span class="n">Nm</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Nm&#39;</span><span class="p">]</span>
        <span class="n">Va</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Va&#39;</span><span class="p">]</span>
        <span class="n">Vb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Vb&#39;</span><span class="p">]</span>
        <span class="c1"># direction of link termination velocity vectors</span>
        <span class="n">theta_va</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;theta_va&#39;</span><span class="p">]</span>
        <span class="n">theta_vb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;theta_vb&#39;</span><span class="p">]</span>
        <span class="n">phi_va</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;phi_va&#39;</span><span class="p">]</span>
        <span class="n">phi_vb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;phi_vb&#39;</span><span class="p">]</span>

        <span class="n">Nf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="n">mmax</span> <span class="o">=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">WMHz</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fcGHz</span><span class="o">*</span><span class="p">(</span><span class="n">Va</span><span class="o">+</span><span class="n">Vb</span><span class="p">))</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="mf">0.3</span><span class="o">/</span><span class="n">fcGHz</span>
        <span class="n">lamo2</span> <span class="o">=</span> <span class="n">lam</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">fmaHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">Va</span><span class="o">/</span><span class="mf">0.3</span><span class="p">)</span><span class="o">*</span><span class="n">fcGHz</span>
        <span class="n">fmbHz</span> <span class="o">=</span> <span class="p">(</span><span class="n">Vb</span><span class="o">/</span><span class="mf">0.3</span><span class="p">)</span><span class="o">*</span><span class="n">fcGHz</span>
        <span class="c1"># Coherence Time</span>
        <span class="n">Tca</span> <span class="o">=</span> <span class="mi">9</span><span class="o">/</span><span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">fmaHz</span><span class="p">)</span>
        <span class="n">Tcb</span> <span class="o">=</span> <span class="mi">9</span><span class="o">/</span><span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">fmbHz</span><span class="p">)</span>
        <span class="n">Tc</span>  <span class="o">=</span> <span class="mi">9</span><span class="o">/</span><span class="p">(</span><span class="mi">14</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">fmaHz</span><span class="o">+</span><span class="n">fmbHz</span><span class="p">))</span>

        <span class="c1"># DoD DoA</span>

        <span class="n">theta_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dod</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">theta_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phi_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doa</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># 3 x r</span>
        <span class="n">ska</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_a</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_a</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_a</span><span class="p">)])</span>
        <span class="n">skb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_b</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_b</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_b</span><span class="p">)])</span>

        <span class="c1"># Monte Carlo for spatial realization</span>
        <span class="c1"># s x m x tap</span>
        <span class="n">ua0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_va</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">va0</span> <span class="o">=</span>  <span class="n">phi_va</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">ub0</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_vb</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">vb0</span> <span class="o">=</span>  <span class="n">phi_vb</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="c1"># standard deviation of  velocity vector orientation is inversely</span>
        <span class="c1"># proportional to velocity magnitude</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Va</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">+</span><span class="n">ua0</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">va</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Va</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">+</span><span class="n">va0</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Vb</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">+</span><span class="n">ub0</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">vb</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">Vb</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">+</span><span class="n">vb0</span><span class="p">)</span><span class="o">%</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="c1"># uniform sampling over the sphere</span>
        <span class="n">tha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">va</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">ua</span>
        <span class="n">thb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">vb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phb</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">ub</span>

        <span class="n">vax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tha</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha</span><span class="p">)</span>
        <span class="n">vay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tha</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pha</span><span class="p">)</span>
        <span class="n">vaz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tha</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">vaxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vax</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">vay</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]])</span>
        <span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vaxy</span><span class="p">,</span><span class="n">vaz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]])</span>

        <span class="n">vbx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thb</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phb</span><span class="p">)</span>
        <span class="n">vby</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thb</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phb</span><span class="p">)</span>
        <span class="n">vbz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thb</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phb</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">vbxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vbx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">vby</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]])</span>

        <span class="c1"># 3 x r x f x s x m x tap</span>
        <span class="n">vb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vbxy</span><span class="p">,</span><span class="n">vbz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]])</span>

        <span class="c1"># beta : r x f x s x m x tap</span>
        <span class="n">betaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ska</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">va</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">betab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skb</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">vb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


        <span class="c1"># m discrete time axis</span>
        <span class="c1"># r x f x s x m x tap</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mmax</span><span class="p">,</span><span class="n">Nm</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># r x f x s x m x tap</span>
        <span class="n">l</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ntap</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
        <span class="c1"># l : r x f x s x m x tap</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">+</span> \
              <span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">ba</span>  <span class="o">=</span> <span class="n">betaa</span><span class="o">*</span><span class="n">Va</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="n">WMHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">bb</span>  <span class="o">=</span> <span class="n">betab</span><span class="o">*</span><span class="n">Vb</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="n">WMHz</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">ba</span> <span class="o">+</span> <span class="n">bb</span>
        <span class="c1"># S : r x f x s x m x tap (form 2.34 [D. Tse])</span>
        <span class="n">S</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">tau2</span><span class="o">*</span><span class="n">WMHz</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>
        <span class="c1"># sum over r :  f x s  x m x tap</span>
        <span class="n">htap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="mi">1j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">fcGHz</span><span class="o">*</span><span class="n">tau2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># f x s  x m x tap</span>
        <span class="n">htap</span>  <span class="o">=</span> <span class="n">htap</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Nf</span><span class="p">,</span><span class="n">Ns</span><span class="p">,</span><span class="n">Nm</span><span class="p">,</span><span class="n">Ntap</span><span class="p">)</span>
        <span class="n">Et_htap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">htap</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">htap</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">Nm</span>
        <span class="n">Er_htap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">htap</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Ns</span>
        <span class="n">corrtap</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">Er_htap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Er_htap</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">htap</span><span class="p">,</span><span class="n">Et_htap</span><span class="p">,</span><span class="n">Er_htap</span><span class="p">,</span><span class="n">corrtap</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.minphas"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.minphas.html#pylayers.antprop.channel.Tchannel.minphas">[docs]</a>    <span class="k">def</span> <span class="nf">minphas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; construct a minimal phase FUsignal</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        - Evaluate slope of the phase</span>
<span class="sd">        - deduce delay</span>
<span class="sd">        - update delay of FUDSignal</span>
<span class="sd">        - Compensation of phase slope to obtain minimal phase</span>

<span class="sd">        This methods updates the excess delay `taue` member.</span>

<span class="sd">        The samplinf frequency step should be</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.signal.bsignal import *</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; fGHz = np.arange(2,11,0.1)</span>
<span class="sd">            &gt;&gt;&gt; tau1 = np.array([1,2,3])[:,np.newaxis]</span>
<span class="sd">            &gt;&gt;&gt; y = np.exp(-2*1j*np.pi*fGHz[np.newaxis,:]*tau1)/fGHz[np.newaxis,:]</span>
<span class="sd">            &gt;&gt;&gt; H = Tchannel(x=fGHz,y=y,taud=np.array([15,17,18]))</span>
<span class="sd">            &gt;&gt;&gt; f,a = H.plot(typ=[&#39;ru&#39;],xlabels=[&#39;Frequency GHz&#39;])</span>
<span class="sd">            &gt;&gt;&gt; t1 = plt.suptitle(&#39;Before minimal phase compensation&#39;)</span>
<span class="sd">            &gt;&gt;&gt; H.minphas()</span>
<span class="sd">            &gt;&gt;&gt; H.taue</span>
<span class="sd">            array([ 1.,  2.,  3.])</span>
<span class="sd">            &gt;&gt;&gt; f,a = H.plot(typ=[&#39;ru&#39;],xlabels=[&#39;Frequency GHz&#39;])</span>
<span class="sd">            &gt;&gt;&gt; t2 = plt.suptitle(&#39;After minimal phase compensation&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">dphi</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phase</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">dphi</span> <span class="o">/</span> <span class="n">df</span>
        <span class="c1">#if slope &gt;0:</span>
        <span class="c1">#   print &#39;m  inphas Warning : non causal FUSignal&#39;</span>
        <span class="c1">#phi0      = +1j*slope*(f[-1]+f[0]/2)</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">slope</span><span class="p">)</span>
        <span class="c1">#E   = exp(-1j*slope*f+phi0)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1j</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="n">F</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">E</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taue</span> <span class="o">=</span> <span class="o">-</span><span class="n">slope</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span></div>
        <span class="c1"># update total delay</span>
        <span class="c1">#self.tau = self.tau+self.taue</span>

<div class="viewcode-block" id="Tchannel.ifft"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.ifft.html#pylayers.antprop.channel.Tchannel.ifft">[docs]</a>    <span class="k">def</span> <span class="nf">ifft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; inverse Fourier Transform</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.simul.link import *</span>
<span class="sd">        &gt;&gt;&gt; L = DLink(verbose=False)</span>
<span class="sd">        &gt;&gt;&gt; aktk = L.eval()</span>
<span class="sd">        &gt;&gt;&gt; L.H.cut()</span>
<span class="sd">        &gt;&gt;&gt; T1 = L.H.totime()</span>
<span class="sd">        &gt;&gt;&gt; f,a = T1.plot(typ=&#39;v&#39;)</span>
<span class="sd">        &gt;&gt;&gt; L.H.minphas()</span>
<span class="sd">        &gt;&gt;&gt; T2 = L.H.totime()</span>
<span class="sd">        &gt;&gt;&gt; f,a = T2.plot(typ=&#39;v&#39;)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">TUDchannel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tchannel.totime"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.totime.html#pylayers.antprop.channel.Tchannel.totime">[docs]</a>    <span class="k">def</span> <span class="nf">totime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ffts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; transform to TUDchannel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">            Nz : int</span>
<span class="sd">                Number of zeros for zero padding</span>
<span class="sd">            ffts : nt</span>
<span class="sd">                fftshift indicator (default 0 )</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.simul.link import *</span>
<span class="sd">        &gt;&gt;&gt; L = DLink(verbose=False)</span>
<span class="sd">        &gt;&gt;&gt; aktk = L.eval()</span>
<span class="sd">        &gt;&gt;&gt; L.H.cut()</span>
<span class="sd">        &gt;&gt;&gt; T1 = L.H.totime()</span>
<span class="sd">        &gt;&gt;&gt; f,a = T1.plot(typ=&#39;v&#39;)</span>
<span class="sd">        &gt;&gt;&gt; L.H.minphas()</span>
<span class="sd">        &gt;&gt;&gt; T2 = L.H.totime()</span>
<span class="sd">        &gt;&gt;&gt; f,a = T2.plot(typ=&#39;v&#39;)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        FUsignal.ift</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Nray</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="p">)</span>
        <span class="n">sy_shifted</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">axes</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">TUDchannel</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sy_shifted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>



<div class="viewcode-block" id="Tchannel.iftd"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.iftd.html#pylayers.antprop.channel.Tchannel.iftd">[docs]</a>    <span class="k">def</span> <span class="nf">iftd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tstart</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">tstop</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ffts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; time pasting</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Nz : int</span>
<span class="sd">            Number of zeros</span>
<span class="sd">        tstart : float</span>
<span class="sd">        tstop  : float</span>
<span class="sd">        ffts   : int</span>
<span class="sd">            fftshift indicator</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        rf : TUsignal (1,N)</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        TUsignal.translate</span>


<span class="sd">        Examples</span>
<span class="sd">        --------</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span>
        <span class="n">Nray</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dx</span><span class="p">()</span>
        <span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">yini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nray</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_new</span><span class="p">)))</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">yini</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># initializes a void signal</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nray</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_new</span><span class="p">)))</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">si</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">si</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">y</span>
        <span class="k">return</span> <span class="n">rf</span></div>

    <span class="k">def</span> <span class="nf">rir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  construct ray impulse response</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Nz   : number of zeros for zero padding</span>
<span class="sd">        ffts : fftshift indicator</span>
<span class="sd">            0  no fftshift</span>
<span class="sd">            1  apply fftshift</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>


<span class="sd">        rir : TUsignal</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">taue</span>
        <span class="n">taumin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> 
        <span class="n">taumax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">dtau</span> <span class="o">=</span> <span class="p">(</span><span class="n">taumax</span><span class="o">-</span><span class="n">taumin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
       

        <span class="n">shy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Delta Tau + Npoints</span>
        <span class="n">N</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dtau</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">+</span><span class="n">shy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># convert tau in an integer offset</span>
        <span class="c1"># taumin ray is not shifted</span>
        <span class="n">itau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">tau</span><span class="o">-</span><span class="n">taumin</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">shy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">shy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">CU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1">#-1 to start @ value 0 </span>

        <span class="n">rir</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">shy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">N</span><span class="p">))</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span><span class="n">shy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">col2</span> <span class="o">=</span> <span class="p">(</span><span class="n">CU</span><span class="o">+</span><span class="n">itau</span><span class="p">[:,</span><span class="bp">None</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">col1</span><span class="p">,</span><span class="n">col2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    
        <span class="n">rir</span><span class="p">[</span><span class="n">index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">index</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t0</span><span class="o">+</span><span class="n">taumin</span><span class="p">,</span><span class="n">te</span><span class="o">+</span><span class="n">taumax</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rir</span><span class="p">)</span>


<div class="viewcode-block" id="Tchannel.ft1"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.ft1.html#pylayers.antprop.channel.Tchannel.ft1">[docs]</a>    <span class="k">def</span> <span class="nf">ft1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  construct CIR from ifft(RTF)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Nz   : number of zeros for zero padding</span>
<span class="sd">        ffts : fftshift indicator</span>
<span class="sd">            0  no fftshift</span>
<span class="sd">            1  apply fftshift</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        r : TUsignal</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">taue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tau</span><span class="p">)):</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">si</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">si</span>
            <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Tchannel.ftau"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.ftau.html#pylayers.antprop.channel.Tchannel.ftau">[docs]</a>    <span class="k">def</span> <span class="nf">ftau</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ffts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; time superposition</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Nz  : number of zeros for zero padding</span>
<span class="sd">        k   : starting index</span>
<span class="sd">        ffts = 0  no fftshift</span>
<span class="sd">        ffts = 1  apply fftshift</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        r : TUsignal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">taue</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">Nz</span><span class="p">,</span> <span class="n">ffts</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">x</span>
        <span class="n">r</span>  <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">TUsignal</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">si</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">si</span>
        <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="Tchannel.plot3d"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.plot3d.html#pylayers.antprop.channel.Tchannel.plot3d">[docs]</a>    <span class="k">def</span> <span class="nf">plot3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="p">[],</span><span class="n">ax</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; plot in 3D</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.signal.bsignal import *</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; N = 20</span>
<span class="sd">            &gt;&gt;&gt; fGHz = np.arange(1,3,1)</span>
<span class="sd">            &gt;&gt;&gt; taud = np.sort(np.random.rand(N))</span>
<span class="sd">            &gt;&gt;&gt; alpha = np.random.rand(N,len(fGHz))</span>
<span class="sd">            &gt;&gt;&gt; s = Tchannel(x=fGHz,y=alpha,taud=taud)</span>
<span class="sd">            &gt;&gt;&gt; s.plot3d()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ntau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Nf</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fig</span><span class="o">==</span><span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="n">k</span><span class="p">])):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">],[</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">color</span><span class="o">=</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Delay (ns)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (fGHz)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">powermin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">powermax</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Power (linear)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim3d</span><span class="p">(</span><span class="n">powermin</span><span class="p">,</span><span class="n">powermax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Tchannel.ft2"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.ft2.html#pylayers.antprop.channel.Tchannel.ft2">[docs]</a>    <span class="k">def</span> <span class="nf">ft2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build channel transfer function (frequency domain)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        df : float</span>
<span class="sd">            frequency step (default 0.01)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        1. get  fmin and fmax</span>
<span class="sd">        2. build a new base with frequency step df</span>
<span class="sd">        3. Initialize a FUsignal with the new frequency base</span>
<span class="sd">        4. build  matrix tau * f  (Nray x Nf)</span>
<span class="sd">        5. buildl matrix E= exp(-2 j pi f tau)</span>
<span class="sd">        6. resampling of FUDsignal according to f --&gt; S</span>
<span class="sd">        7. apply the element wise product E .* S</span>
<span class="sd">        8. add all rays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taud</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">taue</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>

        <span class="n">TAUF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">TAUF</span><span class="p">)</span>

        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">ES</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">S</span><span class="o">.</span><span class="n">y</span>
        <span class="n">V</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">U</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">V</span>

        <span class="k">return</span> <span class="n">U</span></div>

<div class="viewcode-block" id="Tchannel.frombuf"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.frombuf.html#pylayers.antprop.channel.Tchannel.frombuf">[docs]</a>    <span class="k">def</span> <span class="nf">frombuf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">sign</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load a buffer from vna</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        S : buffer</span>
<span class="sd">        sign : int (+1 |-1)  for complex reconstruction</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">S21</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+</span><span class="n">sign</span><span class="o">*</span><span class="mi">1j</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">v</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">S21</span></div>

<div class="viewcode-block" id="Tchannel.capacity"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.capacity.html#pylayers.antprop.channel.Tchannel.capacity">[docs]</a>    <span class="k">def</span> <span class="nf">capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Pt</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="mi">290</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;blast&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;  calculates channel Shannon capacity (no csi)</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>

<span class="sd">            Pt : Power transmitted</span>
<span class="sd">            T : Temperrature Kelvin</span>
<span class="sd">            mode : string</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>

<span class="sd">            C : Channel capacity (bit/s)</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">kB</span> <span class="o">=</span> <span class="mf">1.3806488e-23</span>
            <span class="n">N0</span> <span class="o">=</span> <span class="n">kB</span><span class="o">*</span><span class="n">T</span>
            <span class="n">dfGHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">BGHz</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Pb</span> <span class="o">=</span> <span class="n">N0</span><span class="o">*</span><span class="n">BGHz</span><span class="o">*</span><span class="mf">1e9</span>
            <span class="n">H2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="n">Pt</span><span class="p">[:,</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">H2</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span><span class="o">/</span><span class="n">Pb</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">snr</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dfGHz</span>
            <span class="n">SNR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dfGHz</span>

            <span class="k">return</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">SNR</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tchannel.calibrate"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.calibrate.html#pylayers.antprop.channel.Tchannel.calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filecal</span><span class="o">=</span><span class="s1">&#39;calibration.mat&#39;</span><span class="p">,</span><span class="n">conjugate</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calibrate</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filecal : string</span>
<span class="sd">            calibration file name  &quot;calibration.mat&quot;</span>
<span class="sd">        conjugate : boolean</span>
<span class="sd">            default False</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filecal</span> <span class="o">=</span> <span class="n">filecal</span>
        <span class="n">Hcal</span> <span class="o">=</span> <span class="n">Tchannel</span><span class="p">()</span>
        <span class="n">Hcal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filecal</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hcal</span><span class="o">.</span><span class="n">x</span><span class="p">)),</span><span class="s2">&quot;calibration file has not the same number of points&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">conjugate</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">/</span><span class="n">Hcal</span><span class="o">.</span><span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Hcal</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">conjugate</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">Hcal</span><span class="o">.</span><span class="n">y</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Hcal</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span></div>

<div class="viewcode-block" id="Tchannel.pdp"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.channel.Tchannel.pdp.html#pylayers.antprop.channel.Tchannel.pdp">[docs]</a>    <span class="k">def</span> <span class="nf">pdp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">win</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span><span class="n">calibrate</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculates power delay profile</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        win : string</span>
<span class="sd">            window name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">win</span>
        <span class="k">if</span> <span class="n">calibrate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calibrate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="n">win</span><span class="p">)</span>

        <span class="c1"># inverse Fourier transform</span>

        <span class="n">pdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ift</span><span class="p">(</span><span class="n">ffts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pdp</span></div>

<span class="k">class</span> <span class="nc">Ctilde</span><span class="p">(</span><span class="n">PyLayers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; container for the 4 components of the polarimetric ray channel</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    Ctt : bsignal.FUsignal</span>
<span class="sd">    Ctp : bsignal.FUsignal</span>
<span class="sd">    Cpt : bsignal.FUsignal</span>
<span class="sd">    Cpp : bsignal.FUsignal</span>

<span class="sd">    tauk : ndarray delays</span>
<span class="sd">    tang : ndarray angles of departure</span>
<span class="sd">    rang : ndarray angles of arrival</span>
<span class="sd">    tangl : ndarray angles of departure (local)</span>
<span class="sd">    rangl : ndarray angles of arrival (local)</span>

<span class="sd">    fGHz : np.array</span>
<span class="sd">        frequency array</span>
<span class="sd">    nfreq : int</span>
<span class="sd">        number of frequency point</span>
<span class="sd">    nray  : int</span>
<span class="sd">        number of rays</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    choose</span>
<span class="sd">    load</span>
<span class="sd">    mobility</span>
<span class="sd">    doadod</span>
<span class="sd">    show</span>
<span class="sd">    energy</span>
<span class="sd">    sort</span>
<span class="sd">    prop2tran</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; class constructor</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        transpose == False   (r,f)</span>
<span class="sd">        transpose == True    (f,r)</span>

<span class="sd">        A Ctilde object can be :</span>
<span class="sd">            + returned from eval method of a Rays object.</span>
<span class="sd">            + generated from a statistical model of the propagation channel</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Ctilde : Ray Propagation Channel Matrices&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Cpp&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nray&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;Nray : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;fmin(GHz) : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;fmax(GHz): &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;Nfreq : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    


    <span class="k">def</span> <span class="nf">saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Lfilename</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save Ctilde object in hdf5 format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Lfilename  : string</span>
<span class="sd">            Layout filename</span>
<span class="sd">        idx : int</span>
<span class="sd">            file identifier number</span>
<span class="sd">        a : np.ndarray</span>
<span class="sd">            postion of point a (transmitter)</span>
<span class="sd">        b : np.ndarray</span>
<span class="sd">            postion of point b (receiver)</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Lfilename</span><span class="o">=</span><span class="n">Lfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_filename</span><span class="o">=</span> <span class="n">Lfilename</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRCT&#39;</span><span class="p">])</span>

        <span class="c1"># save channel in global basis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locbas</span><span class="p">(</span><span class="n">b2g</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Tt&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Tr&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;tang&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;rang&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;tauk&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;fGHz&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>


            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Ctt_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Cpp_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Cpt_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Ctp_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Tx&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Rx&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel.Ctilde: issue when writting h5py file&#39;</span><span class="p">)</span>




    <span class="k">def</span> <span class="nf">loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Lfilename</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load Ctilde object in hdf5 format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Lfilename  : string</span>
<span class="sd">            Layout filename</span>
<span class="sd">        idx : int</span>
<span class="sd">            file identifier number</span>
<span class="sd">        output : bool</span>
<span class="sd">            return an output precised in return</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        if output:</span>
<span class="sd">        (Layout filename , Tx position, Rx position)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_Lfilename</span><span class="o">=</span><span class="n">Lfilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_filename</span><span class="o">=</span> <span class="n">_Lfilename</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRCT&#39;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;fGHz&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tang&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;rang&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tauk&#39;</span><span class="p">][:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Tt&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Tr&#39;</span><span class="p">][:]</span>

            <span class="n">Ctt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Ctt_y&#39;</span><span class="p">][:]</span>
            <span class="n">Cpp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Cpp_y&#39;</span><span class="p">][:]</span>
            <span class="n">Ctp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Ctp_y&#39;</span><span class="p">][:]</span>
            <span class="n">Cpt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Cpt_y&#39;</span><span class="p">][:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cpt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cpp</span><span class="p">)</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Tx&#39;</span><span class="p">][:]</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Rx&#39;</span><span class="p">][:]</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel.Ctilde: issue when reading h5py file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">Lfilename</span> <span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">rx</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save Ctilde object in hdf5 format compliant with Link Class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5  : str</span>
<span class="sd">            file name of h5py file Link format</span>
<span class="sd">        grpname  : int</span>
<span class="sd">            groupname in filenameh5</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locbas</span><span class="p">(</span><span class="n">b2g</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grpname</span> <span class="ow">in</span> <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;Ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;Ct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">grpname</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Warning : Ct/&#39;</span><span class="o">+</span><span class="n">grpname</span> <span class="o">+</span><span class="s1">&#39;already exists in &#39;</span><span class="o">+</span><span class="n">filenameh5</span>
            <span class="n">f</span><span class="o">=</span><span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;Ct/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="c1"># save channel in global basis</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Tt&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Tr&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;tang&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;rang&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;tauk&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;fGHz&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>


            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Ctt_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Cpp_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Cpt_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Ctp_y&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel.Ctilde: issue when writting h5py file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">los</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pa</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">fGHz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">2.4</span><span class="p">],</span><span class="n">tang</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="mf">1.57</span><span class="p">,</span><span class="mf">3.14</span><span class="p">]],</span><span class="n">rang</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="mf">1.57</span><span class="p">,</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="sd">&quot;&quot;&quot; Line of site channel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        d(m)</span>
<span class="sd">        fGHz (,Nf)</span>
<span class="sd">        tang (1x2)</span>
<span class="sd">        rang (1x2)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span> <span class="o">=</span> <span class="n">fGHz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-</span><span class="n">pa</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span><span class="o">*</span><span class="n">si</span><span class="p">))]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="mf">0.3</span>
        <span class="n">tht</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">pht</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">thr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">phr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tht</span><span class="p">,</span><span class="n">pht</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">thr</span><span class="p">,</span><span class="n">phr</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span><span class="o">/</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load Ctilde object in hdf5 format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5  : str</span>
<span class="sd">            file name of h5py file Link format</span>
<span class="sd">        grpname  : int</span>
<span class="sd">            groupname in filenameh5</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;Ct/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;fGHz&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tang&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;rang&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tauk&#39;</span><span class="p">][:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Tt&#39;</span><span class="p">][:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Tr&#39;</span><span class="p">][:]</span>
            <span class="n">Ctt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Ctt_y&#39;</span><span class="p">][:]</span>
            <span class="n">Cpp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Cpp_y&#39;</span><span class="p">][:]</span>
            <span class="n">Ctp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Ctp_y&#39;</span><span class="p">][:]</span>
            <span class="n">Cpt</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Cpt_y&#39;</span><span class="p">][:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cpt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cpp</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel.Ctilde: issue when reading h5py file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filefield</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load a Ctilde from a .field file</span>

<span class="sd">        Load the three files .tauk .tang .rang which contain respectively</span>
<span class="sd">        delay , angle of departure , angle of arrival.</span>
<span class="sd">maicher</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filefield  : string</span>
<span class="sd">        transpose  : boolean</span>
<span class="sd">            default False</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.antprop.channel import *</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.simul.simulem import *</span>
<span class="sd">        &gt;&gt;&gt; S = Simul()</span>
<span class="sd">        &gt;&gt;&gt; S.load(&#39;default.ini&#39;)</span>
<span class="sd">        &gt;&gt;&gt; C = Ctilde()</span>
<span class="sd">        &gt;&gt;&gt; out = C.load(pyu.getlong(S.dtud[1][1],&#39;output&#39;))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filetauk</span> <span class="o">=</span> <span class="n">filefield</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.field&#39;</span><span class="p">,</span> <span class="s1">&#39;.tauk&#39;</span><span class="p">)</span>
        <span class="n">filetang</span> <span class="o">=</span> <span class="n">filefield</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.field&#39;</span><span class="p">,</span> <span class="s1">&#39;.tang&#39;</span><span class="p">)</span>
        <span class="n">filerang</span> <span class="o">=</span> <span class="n">filefield</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.field&#39;</span><span class="p">,</span> <span class="s1">&#39;.rang&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filefield</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span> <span class="s2">&quot;file &quot;</span> <span class="o">+</span> <span class="n">filefield</span> <span class="o">+</span> <span class="s2">&quot; is unreachable&quot;</span><span class="p">)</span>

        <span class="c1"># decode filename (*.field file obtained from evalfield simulation)</span>
        <span class="n">nray</span> <span class="o">=</span> <span class="n">stru</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nfreq</span> <span class="o">=</span> <span class="n">stru</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nfreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot; Error : incorrect number of frequency points in .field&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">nray</span> <span class="o">*</span> <span class="n">nfreq</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">CMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="nb">buffer</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">c11</span> <span class="o">=</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>
        <span class="n">c12</span> <span class="o">=</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>
        <span class="n">c21</span> <span class="o">=</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">CMat</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="mi">1j</span>

        <span class="n">c11</span> <span class="o">=</span> <span class="n">c11</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">)</span>
        <span class="n">c12</span> <span class="o">=</span> <span class="n">c12</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">)</span>
        <span class="n">c21</span> <span class="o">=</span> <span class="n">c21</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">)</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="n">c22</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
            <span class="n">c11</span> <span class="o">=</span> <span class="n">c11</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">c12</span> <span class="o">=</span> <span class="n">c12</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">c21</span> <span class="o">=</span> <span class="n">c21</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">c22</span> <span class="o">=</span> <span class="n">c22</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Temporary freq --&gt; read filefreq</span>
        <span class="c1">#</span>
        <span class="n">fGHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">nfreq</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c21</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c22</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span> <span class="o">=</span> <span class="n">nfreq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="n">nray</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetauk</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span> <span class="s2">&quot;file &quot;</span><span class="p">,</span> <span class="n">filetauk</span><span class="p">,</span> <span class="s2">&quot; is unreachable&quot;</span>
        <span class="c1"># decode filetauk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
            <span class="n">nray_tauk</span> <span class="o">=</span> <span class="n">stru</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#print &quot;nb rays in .tauk file: &quot;, nray_tauk</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">nray</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span>
            <span class="c1">#print &quot;nb rays 2: &quot;, nray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">nray</span><span class="p">,</span> <span class="nb">buffer</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
            <span class="c1">#if nray_tauk != nray:</span>
            <span class="c1">#    print nray_tauk - nray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span>

        <span class="c1"># decode the angular files (.tang and .rang)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filetang</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span> <span class="s2">&quot;file &quot;</span><span class="p">,</span> <span class="n">filetang</span><span class="p">,</span> <span class="s2">&quot; is unreachable&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
            <span class="n">nray_tang</span> <span class="o">=</span> <span class="n">stru</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># coorectif Bug evalfield</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nray_tang</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">buffer</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nray</span><span class="p">,:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filerang</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span> <span class="s2">&quot;file &quot;</span><span class="p">,</span> <span class="n">filerang</span><span class="p">,</span> <span class="s2">&quot; is unreachable&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
            <span class="n">nray_rang</span> <span class="o">=</span> <span class="n">stru</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># corectif Bug evalfield</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nray_rang</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">buffer</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nray</span><span class="p">,:]</span>

    <span class="k">def</span> <span class="nf">mobility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; modify channel for uniform mobility</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        v  : float</span>
<span class="sd">            velocity (m/s)</span>
<span class="sd">        dt : float</span>
<span class="sd">            delta t (s)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Calculate a channel field from Ctilde and v(terminal vitese)</span>
<span class="sd">        and dt(time of deplacement)</span>

<span class="sd">        dt en s  (observation time between 2 Rx position)</span>
<span class="sd">        v en m/s (vitesse de changement de Rx)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        tau : modified Ctilde</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># m/ns celerity of light</span>
        <span class="n">tauk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span>
        <span class="n">tang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tang</span>
        <span class="n">rang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rang</span>

        <span class="n">rk</span> <span class="o">=</span> <span class="n">tauk</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">rk_mod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rk</span><span class="p">)</span>
        <span class="n">sk_ch</span> <span class="o">=</span> <span class="n">rk</span> <span class="o">/</span> <span class="n">rk_mod</span>

        <span class="c1"># cos_alph =dot(v/abs(v),sk_ch)</span>

        <span class="n">cos_alph</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">sk_ch</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_alph</span> <span class="o">=</span> <span class="n">cos_alph</span>
        <span class="n">rk_ch</span> <span class="o">=</span> <span class="n">rk_mod</span> <span class="o">*</span> <span class="n">cos_alph</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">sk_ch_ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">rk</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rk_ch</span> <span class="o">+</span> <span class="n">cos_alph</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">tauk_ch</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rk_ch</span><span class="p">)</span> <span class="o">*</span> <span class="n">sk_ch_ch</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span>

        <span class="k">return</span><span class="p">(</span><span class="n">tauk_ch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plotd</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot direction of arrival/departure</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        d: string</span>
<span class="sd">            &#39;doa&#39; | &#39;dod&#39;</span>
<span class="sd">            display direction of departure | arrival</span>
<span class="sd">        fig : plt.figure</span>
<span class="sd">        ax : plt.axis</span>
<span class="sd">        phi: tuple (-180, 180)</span>
<span class="sd">            phi angle</span>
<span class="sd">        normalize: bool</span>
<span class="sd">            energy normalized</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            inverse theta and phi represenation</span>
<span class="sd">        polar : bool</span>
<span class="sd">            polar representation</span>
<span class="sd">        cmap: matplotlib.cmap</span>
<span class="sd">        mode: &#39;center&#39; | &#39;mean&#39; | &#39;in&#39;</span>
<span class="sd">            see bsignal.energy</span>
<span class="sd">        s : float</span>
<span class="sd">            scatter dot size</span>
<span class="sd">        fontsize: float</span>
<span class="sd">        edgecolors: bool</span>
<span class="sd">        colorbar: bool</span>
<span class="sd">        title : bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;phi&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
                    <span class="s1">&#39;normalize&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;reverse&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;polar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;colorbar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;title&#39;</span> <span class="p">:</span> <span class="bp">False</span>
                    <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span><span class="s1">&#39;dod&#39;</span><span class="p">:</span>
            <span class="n">tit</span> <span class="o">=</span> <span class="s1">&#39;DOD : A&#39;</span>
            <span class="n">di</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tang&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;doa&#39;</span><span class="p">:</span>
            <span class="n">tit</span> <span class="o">=</span> <span class="s1">&#39;DOA : B&#39;</span>
            <span class="n">di</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;rang&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;d attribute can only be doa or dod&#39;</span><span class="p">)</span>


        <span class="c1"># remove non plt.scatter kwargs</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>
        <span class="n">the</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">180</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fontsize&#39;</span><span class="p">)</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fig&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ax&#39;</span><span class="p">)</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colorbar&#39;</span><span class="p">)</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
        <span class="n">normalize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalize&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>


        <span class="n">Ett</span><span class="p">,</span> <span class="n">Epp</span><span class="p">,</span> <span class="n">Etp</span><span class="p">,</span> <span class="n">Ept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Etot</span> <span class="o">=</span> <span class="n">Ett</span><span class="o">+</span><span class="n">Epp</span><span class="o">+</span><span class="n">Etp</span><span class="o">+</span><span class="n">Ept</span> <span class="o">+</span> <span class="mf">1e-15</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">Emax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Etot</span> <span class="o">/</span> <span class="n">Emax</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># col  = 1 - (10*log10(Etot)-Emin)/(Emax-Emin)</span>
        <span class="c1"># WARNING polar plot require radian angles</span>
        <span class="k">if</span> <span class="n">polar</span> <span class="p">:</span>
            <span class="n">al</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">alb</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="n">phi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
            <span class="n">the</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">the</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reverse</span> <span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
                <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">al</span>  <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">alb</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">col</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;len(col):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">print</span> <span class="s2">&quot;len(di):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span><span class="o">=</span><span class="n">polar</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reverse</span> <span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">di</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">alb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\phi(^{\circ})$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta_t(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">di</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">al</span><span class="p">,</span> <span class="n">di</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">alb</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">the</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">the</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta_t(^{\circ})$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\phi(^{\circ})$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">tit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ll</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span><span class="o">+</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
            <span class="c1">#divider = make_axes_locatable(ax)</span>
            <span class="c1">#cax = divider.append_axes(&quot;right&quot;,size=&quot;5%&quot;,pad=0.05)</span>
            <span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;dB&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Path Loss (dB)&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">clb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">doadod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; doadod scatter plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        phi : tuple (-180, 180)</span>
<span class="sd">            phi angle</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            energy normalized</span>
<span class="sd">        reverse : bool</span>
<span class="sd">            inverse theta and phi representation</span>
<span class="sd">        polar : bool</span>
<span class="sd">            polar representation</span>
<span class="sd">        cmap : matplotlib.cmap</span>
<span class="sd">        mode : string</span>
<span class="sd">            &#39;center&#39; | &#39;mean&#39; | &#39;in&#39;</span>
<span class="sd">        s : float</span>
<span class="sd">            scatter dot size</span>
<span class="sd">        fontsize : float</span>
<span class="sd">        edgecolors : bool</span>
<span class="sd">        colorbar : bool</span>
<span class="sd">        xa :</span>
<span class="sd">        xb :</span>

<span class="sd">        Summary</span>
<span class="sd">        --------</span>

<span class="sd">        scatter plot of the DoA-DoD channel structure</span>
<span class="sd">        the energy is color coded over all couples of DoA-DoD</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.antprop.channel import *</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal.energy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;phi&#39;</span><span class="p">:(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>
                    <span class="s1">&#39;normalize&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;reverse&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;polar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;colorbar&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;xa&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;xb&#39;</span><span class="p">:</span><span class="mi">1</span>
                    <span class="p">}</span>


        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">xa</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xa&#39;</span><span class="p">)</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;xb&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>


        <span class="n">ax1</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span><span class="n">polar</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;polar&#39;</span><span class="p">])</span>
        <span class="n">ax2</span>  <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span><span class="n">polar</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;polar&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">xa</span><span class="o">&lt;</span><span class="n">xb</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;dod&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;doa&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotd</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;dod&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,[</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">locbas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tt</span><span class="o">=</span><span class="p">[],</span> <span class="n">Tr</span><span class="o">=</span><span class="p">[],</span><span class="n">b2g</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; global reference frame to local reference frame</span>

<span class="sd">        If Tt and Tr are [] the global channel is  retrieved</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tt  : Tx rotation matrix 3x3</span>
<span class="sd">            default []</span>
<span class="sd">        Tr  : Rx rotation matrix 3x3</span>
<span class="sd">            default []</span>
<span class="sd">        b2g: bool</span>
<span class="sd">            back to global reference frame</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Cl : Ctilde local/global</span>
<span class="sd">            depends on self.islocal boolean value</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get Ctilde frequency axes</span>

        <span class="n">fGHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span>
        <span class="c1"># if rot matrices are passed</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Tt</span> <span class="o">!=</span> <span class="p">[])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Tr</span> <span class="o">!=</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Tt&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Tr&#39;</span><span class="p">)):</span>
                    <span class="c1"># run locbas to return to global basis</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">locbas</span><span class="p">(</span><span class="n">b2g</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Channel has no self.Tt or self.Tr&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="n">Tt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="n">Tr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># if a return to global is requested</span>
        <span class="k">elif</span> <span class="n">b2g</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span> <span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Tt&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Tr&#39;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">islocal</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span> <span class="p">(</span><span class="s1">&#39;self.Tt and self.Tr should exist&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;nothing to do to return in global basis&quot;</span>
                <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># if Tt and Tr == []</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># get angular axes</span>
        <span class="c1"># Rt (2x2)</span>
        <span class="c1"># Rr (2x2)</span>
        <span class="c1">#</span>
        <span class="c1"># tang : r x 2</span>
        <span class="c1"># rang : r x 2</span>
        <span class="c1">#</span>
        <span class="c1"># Rt : 2 x 2 x r</span>
        <span class="c1"># Rr : 2 x 2 x r</span>
        <span class="c1">#</span>
        <span class="c1"># tangl : r x 2</span>
        <span class="c1"># rangl : r x 2</span>
        <span class="c1">#</span>


        <span class="n">Rt</span><span class="p">,</span> <span class="n">tangl</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">BTB_tx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">)</span>
        <span class="n">Rr</span><span class="p">,</span> <span class="n">rangl</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">BTB_rx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># update direction of departure and arrival</span>
        <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tangl</span> <span class="o">=</span> <span class="n">tangl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rangl</span> <span class="o">=</span> <span class="n">rangl</span>

        <span class="c1">#uf = np.ones(self.nfreq)</span>

        <span class="c1">#</span>
        <span class="c1"># r0 : r x 1(f)</span>
        <span class="c1">#</span>

        <span class="c1">#r0 = np.outer(Rr[0, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rr[0, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">t00</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span>
        <span class="n">t01</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span>

        <span class="c1">#r0 = np.outer(Rr[1, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rr[1, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">t10</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span>

        <span class="c1">#r0 = np.outer(Rt[0, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rt[1, 0,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">Cttl</span> <span class="o">=</span> <span class="n">t00</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t01</span> <span class="o">*</span> <span class="n">r1</span>
        <span class="n">Cptl</span> <span class="o">=</span> <span class="n">t10</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t11</span> <span class="o">*</span> <span class="n">r1</span>

        <span class="c1">#r0 = np.outer(Rt[0, 1,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rt[1, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">Ctpl</span> <span class="o">=</span> <span class="n">t00</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t01</span> <span class="o">*</span> <span class="n">r1</span>
        <span class="n">Cppl</span> <span class="o">=</span> <span class="n">t10</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t11</span> <span class="o">*</span> <span class="n">r1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cttl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctpl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cptl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cppl</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">Cg2Cl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tt</span><span class="o">=</span><span class="p">[],</span> <span class="n">Tr</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; global reference frame to local reference frame</span>

<span class="sd">        If Tt and Tr are [] the global channel is  retrieved</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tt  : Tx rotation matrix 3x3</span>
<span class="sd">            default []</span>
<span class="sd">        Tr  : Rx rotation matrix 3x3</span>
<span class="sd">            default []</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Cl : Ctilde local</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get frequency axes</span>

        <span class="n">fGHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Tt</span> <span class="o">!=</span><span class="p">[])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Tr</span><span class="o">!=</span><span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="n">Tt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="n">Tr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;Tt&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Tr&#39;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># get angular axes</span>
        <span class="c1"># Rt (2x2)</span>
        <span class="c1"># Rr (2x2)</span>
        <span class="c1">#</span>
        <span class="c1"># tang : r x 2</span>
        <span class="c1"># rang : r x 2</span>
        <span class="c1">#</span>
        <span class="c1"># Rt : 2 x 2 x r</span>
        <span class="c1"># Rr : 2 x 2 x r</span>
        <span class="c1">#</span>
        <span class="c1"># tangl : r x 2</span>
        <span class="c1"># rangl : r x 2</span>
        <span class="c1">#</span>

        <span class="n">Rt</span><span class="p">,</span> <span class="n">tangl</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">BTB_tx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tt</span><span class="p">)</span>
        <span class="n">Rr</span><span class="p">,</span> <span class="n">rangl</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">BTB_rx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tr</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># update direction of departure and arrival</span>
        <span class="c1">#</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">tangl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">rangl</span>

        <span class="c1">#uf = np.ones(self.nfreq)</span>

        <span class="c1">#</span>
        <span class="c1"># r0 : r x 1(f)</span>
        <span class="c1">#</span>

        <span class="c1">#r0 = np.outer(Rr[0, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rr[0, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">t00</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span>
        <span class="n">t01</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span>

        <span class="c1">#r0 = np.outer(Rr[1, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rr[1, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">t10</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span>
        <span class="n">t11</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span>

        <span class="c1">#r0 = np.outer(Rt[0, 0,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rt[1, 0,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">Cttl</span> <span class="o">=</span> <span class="n">t00</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t01</span> <span class="o">*</span> <span class="n">r1</span>
        <span class="n">Cptl</span> <span class="o">=</span> <span class="n">t10</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t11</span> <span class="o">*</span> <span class="n">r1</span>

        <span class="c1">#r0 = np.outer(Rt[0, 1,:], uf)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1">#r1 = np.outer(Rt[1, 1,:], uf)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">Rt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">Ctpl</span> <span class="o">=</span> <span class="n">t00</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t01</span> <span class="o">*</span> <span class="n">r1</span>
        <span class="n">Cppl</span> <span class="o">=</span> <span class="n">t10</span> <span class="o">*</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">t11</span> <span class="o">*</span> <span class="n">r1</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cttl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Ctpl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cptl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">Cppl</span><span class="p">)</span>



        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; show the propagation channel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        typ   : &#39;m&#39;, &#39;l20&#39; , &#39;r&#39;</span>
<span class="sd">        cmap  : colormap</span>
<span class="sd">            default hot</span>
<span class="sd">        fontsize : int</span>
<span class="sd">            default 14</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;typ&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot</span><span class="p">,</span>
                    <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">14</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>


        <span class="n">ax1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">u&#39;$C_{</span><span class="se">\\</span><span class="s1">theta</span><span class="se">\\</span><span class="s1">theta}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">u&#39;$C_{</span><span class="se">\\</span><span class="s1">theta\phi}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>

        <span class="n">ax3</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">u&#39;$C_{\phi</span><span class="se">\\</span><span class="s1">theta}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>

        <span class="n">ax4</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">u&#39;$C_{\phi\phi}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_reciprocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check channel reciprocity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        C : Ctilde</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This is not properly implemented</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">issue</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">tauk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">r</span><span class="p">,:],</span> <span class="n">C</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">r</span><span class="p">,:]):</span>
                <span class="n">issue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;Channel is reciprocal&quot;</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">print</span> <span class="s2">&quot;WARNING Reciprocity issue WARNING&quot;</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">issue</span><span class="p">),</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">,</span> <span class="s1">&#39;rays are not reciprocal,&#39;</span>
            <span class="k">print</span> <span class="s2">&quot;rays number with an issue :&quot;</span><span class="p">,</span><span class="n">issue</span>

        <span class="c1"># assert np.allclose(self.tang,C.rang)</span>
        <span class="c1"># assert np.allclose(self.rang,C.tang)</span>


    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">sumray</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculates energy on each channel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        mode : string</span>
<span class="sd">            &#39;mean&#39;</span>
<span class="sd">        Friis: boolean</span>
<span class="sd">            True</span>
<span class="sd">        sumray: boolean</span>
<span class="sd">            False</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        ECtt  : Energy on co channel    tt</span>
<span class="sd">        ECpp  : Energy on co channel    pp</span>
<span class="sd">        ECtp  : Energy on co channel    tp</span>
<span class="sd">        ECpt  : Energy on co channel    pt</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.signal.bsignal.FUsignal.energy</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        r x f+</span>
<span class="sd">          axis 0 : ray</span>
<span class="sd">          axis 1 : frequency</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#</span>
        <span class="c1">#  r x f</span>
        <span class="c1">#  axis 0 : ray</span>
        <span class="c1">#  axis 1 : frequency</span>
        <span class="c1">#</span>

        <span class="n">ECtt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="n">Friis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ECtp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="n">Friis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ECpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="n">Friis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">ECpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Friis</span><span class="o">=</span><span class="n">Friis</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sumray</span><span class="p">:</span>
            <span class="n">ECtt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ECtt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ECtp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ECtp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ECpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ECpt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ECpp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ECpp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ECtt</span><span class="p">,</span> <span class="n">ECpp</span><span class="p">,</span> <span class="n">ECtp</span><span class="p">,</span> <span class="n">ECpt</span>

    <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; cut rays from a energy threshold</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        threshold : float</span>
<span class="sd">            default 0.99</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ett</span><span class="p">,</span> <span class="n">Epp</span><span class="p">,</span> <span class="n">Etp</span><span class="p">,</span> <span class="n">Ept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>
        <span class="n">Etot</span> <span class="o">=</span> <span class="n">Ett</span><span class="o">+</span><span class="n">Epp</span><span class="o">+</span><span class="n">Etp</span><span class="o">+</span><span class="n">Ept</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="n">cumE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumE</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">v</span><span class="p">,:]</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;tauk&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sort Ctilde with respect to typ (default tauk)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        typ  : string</span>
<span class="sd">            sort w.r.t</span>
<span class="sd">                &#39;tauk&#39;   : delay (default)</span>
<span class="sd">                &#39;att&#39;    : theta Tx</span>
<span class="sd">                &#39;atp&#39;    : phi Tx</span>
<span class="sd">                &#39;art&#39;    : theta Rx</span>
<span class="sd">                &#39;arp&#39;    : phi Rx</span>
<span class="sd">                &#39;energy&#39; : energy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;tauk&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;att&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;atp&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;art&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;arp&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;energy&#39;</span><span class="p">:</span>
            <span class="n">Ett</span><span class="p">,</span> <span class="n">Epp</span><span class="p">,</span> <span class="n">Etp</span><span class="p">,</span> <span class="n">Ept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span>
            <span class="n">Etot</span> <span class="o">=</span> <span class="n">Ett</span><span class="o">+</span><span class="n">Epp</span><span class="o">+</span><span class="n">Etp</span><span class="o">+</span><span class="n">Ept</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">Etot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">,:]</span>

    <span class="k">def</span> <span class="nf">prop2tran</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="p">[],</span><span class="n">b</span><span class="o">=</span><span class="p">[],</span><span class="n">Friis</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">r&quot;&quot;&quot; transform propagation channel into transmission channel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        a : antenna or array a</span>
<span class="sd">        b : antenna or array b</span>

<span class="sd">        Ta : np.array(3x3)</span>
<span class="sd">           unitary matrice for antenna orientation</span>
<span class="sd">        Tb : np.array(3x3)</span>
<span class="sd">           unitary matrice for antenna orientation</span>
<span class="sd">        Friis : boolean</span>
<span class="sd">            if True scale with :math:`-j\frac{\lambda}{f}`</span>
<span class="sd">        debug : boolean</span>
<span class="sd">            if True the antenna gain for each ray is stored</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        H : Tchannel(bs.FUsignal)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">freq</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span>
        <span class="n">nfreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfreq</span>
        <span class="n">nray</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nray</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># select default antennas</span>
        <span class="c1"># omni polar theta &#39;t&#39; &lt;=&gt; vertical polarization</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span><span class="p">[]:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">ant</span><span class="o">.</span><span class="n">Antenna</span><span class="p">(</span><span class="s1">&#39;Omni&#39;</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pol&#39;</span><span class="p">:</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;GmaxdB&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span><span class="n">fGHz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">==</span><span class="p">[]:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">ant</span><span class="o">.</span><span class="n">Antenna</span><span class="p">(</span><span class="s1">&#39;Omni&#39;</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pol&#39;</span><span class="p">:</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;GmaxdB&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span><span class="n">fGHz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">th</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tangl</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tangl</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">Fat</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">Ft</span><span class="p">)</span>
        <span class="n">Fap</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">Fp</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">th</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rangl</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rangl</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">Fbt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">Ft</span><span class="p">)</span>
        <span class="n">Fbp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">Fp</span><span class="p">)</span>

        <span class="c1"># Cg2cl should be applied here</span>
        <span class="c1">#</span>

        <span class="c1">#</span>
        <span class="c1">#  C  = 2 x 2 x r x f</span>
        <span class="c1">#  Ctt : r x f</span>
        <span class="c1">#  Fa = 2 x r x f</span>
        <span class="c1">#  Fb = 2 x r x f</span>
        <span class="c1">#</span>
        <span class="c1">#  (r x f ) (r x Nt x f )</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">*</span> <span class="n">Fat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">*</span> <span class="n">Fap</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">*</span> <span class="n">Fat</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">*</span> <span class="n">Fap</span>

        <span class="c1"># depending on siso or mimo case</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">T1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:,:]</span>
            <span class="n">T2</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="n">T2</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">FBt</span> <span class="o">=</span> <span class="n">Fbt</span><span class="o">.</span><span class="n">y</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="n">FBp</span> <span class="o">=</span> <span class="n">Fbp</span><span class="o">.</span><span class="n">y</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FBt</span> <span class="o">=</span> <span class="n">Fbt</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="n">FBp</span> <span class="o">=</span> <span class="n">Fbp</span><span class="o">.</span><span class="n">y</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,:]</span>

        <span class="c1"># determine the common interval on frequency axis</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">x</span><span class="o">!=</span><span class="n">Fbt</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">t1x_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">Fbtx_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">t1x_int</span><span class="p">,</span><span class="n">Fbtx_int</span><span class="p">)</span>
            <span class="n">ut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">t1x_int</span><span class="p">,</span><span class="n">inter</span><span class="p">)</span>
            <span class="n">uf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">Fbtx_int</span><span class="p">,</span><span class="n">inter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="n">uf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ut</span><span class="p">])</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">uf</span><span class="p">])),</span><span class="s2">&quot;problem in common index plage calculation&quot;</span>

        <span class="n">alpha1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ljkm,lkim-&gt;ljim&#39;</span><span class="p">,</span><span class="n">FBt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">uf</span><span class="p">],</span><span class="n">T1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ut</span><span class="p">])</span>
        <span class="n">alpha2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ljkm,lkim-&gt;ljim&#39;</span><span class="p">,</span><span class="n">FBp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">uf</span><span class="p">],</span><span class="n">T2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">ut</span><span class="p">])</span>

        <span class="c1">#alpha = t1 * Fbt + t2 * Fbp</span>
        <span class="c1"># Nd x Nr x Nt x Nf</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha1</span> <span class="o">+</span> <span class="n">alpha2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ut</span><span class="p">]</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">Tchannel</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span>
                     <span class="n">y</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span>
                     <span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tauk</span><span class="p">,</span>
                     <span class="n">dod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tang</span><span class="p">,</span>
                     <span class="n">doa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rang</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="p">:</span>
            <span class="n">H</span><span class="o">.</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Fat</span><span class="o">=</span><span class="n">Fat</span><span class="o">.</span><span class="n">y</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Fap</span><span class="o">=</span><span class="n">Fap</span><span class="o">.</span><span class="n">y</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Fbt</span><span class="o">=</span><span class="n">Fbt</span><span class="o">.</span><span class="n">y</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Fbp</span><span class="o">=</span><span class="n">Fbp</span><span class="o">.</span><span class="n">y</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Gat</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fat</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fat</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Fat</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Gap</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fap</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fap</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Fap</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Gbt</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Fbt</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="n">H</span><span class="o">.</span><span class="n">Gbp</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fbp</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fbp</span><span class="o">.</span><span class="n">y</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Fbp</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">Friis</span><span class="p">:</span>
            <span class="n">H</span><span class="o">.</span><span class="n">applyFriis</span><span class="p">()</span>

        <span class="c1"># average w.r.t frequency</span>
        <span class="n">Nf</span>   <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">H</span><span class="o">.</span><span class="n">ak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">Nf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">H</span><span class="o">.</span><span class="n">tk</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">taud</span>

        <span class="k">return</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
        <div class="clearer"></div>
      </div>
    </div>
  

    <div class="footer">
        &copy; 2015, PyLayers developer team.
      Last updated on avril 26, 2016.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.5. Design by <a href="http://desgrana.es">Desgrana</a>.
    </div>
     <div class="rel">
    
    <div class="buttonPrevious">
      <a href="../../../py-modindex.html">
        Previous
      </a>  
    </div>
    
     </div>
     <script type="text/javascript">
       $("div.buttonNext, div.buttonPrevious").hover(
           function () {
               $(this).css('background-color', '#AFFFFF');
           },
           function () {
               $(this).css('background-color', '#AFFFFF');
           }
       );
     </script>
  </body>
</html>