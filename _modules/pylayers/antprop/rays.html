<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pylayers.antprop.rays &mdash; PyLayers</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="PyLayers" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
<div style="color: black;background-color: white; font-size: 3.2em; text-align: left; padding: 15px 10px 10px 15px">
    PyLayers
<!--
<a href="../../../index.html"><img src="../../../_static/logo.png" height="200" border="0"
    alt="pylayers"/></a>
-->
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyLayers Home </a> |&nbsp;</li>
        <li><a href="../../../notebook/index.html">Documentation </a> |&nbsp;</li>
        <li><a href="../../../download.html">Download </a> |&nbsp; </li>
        <li><a href="https://github.com/pylayers/">Developer (Github)</a> </li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pylayers.antprop.rays</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: latin1 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">Class Rays</span>
<span class="sd">==========</span>

<span class="sd">This modules contains Rays class</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated</span>

<span class="sd">    Rays.__init__</span>
<span class="sd">    Rays.__len__</span>
<span class="sd">    Rays.__repr__</span>
<span class="sd">    Rays.sort</span>
<span class="sd">    Rays.extract</span>
<span class="sd">    Rays.mirror</span>
<span class="sd">    Rays.to3D</span>
<span class="sd">    Rays.locbas</span>
<span class="sd">    Rays.fillinter</span>
<span class="sd">    Rays.length</span>
<span class="sd">    Rays.eval</span>
<span class="sd">    Rays.ray</span>
<span class="sd">    Rays.typ</span>
<span class="sd">    Rays.info</span>
<span class="sd">    Rays.signature</span>
<span class="sd">    Rays.show</span>
<span class="sd">    Rays.show3d</span>
<span class="sd">    Rays._show3</span>
<span class="sd">    Rays.reciprocal</span>
<span class="sd">    Rays.check_reciprocity</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">struct</span> <span class="kn">as</span> <span class="nn">stru</span>
<span class="kn">import</span> <span class="nn">pylayers.util.geomutil</span> <span class="kn">as</span> <span class="nn">geu</span>
<span class="kn">import</span> <span class="nn">pylayers.util.pyutil</span> <span class="kn">as</span> <span class="nn">pyu</span>
<span class="kn">from</span> <span class="nn">pylayers.util.project</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pylayers.antprop.interactions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pylayers.antprop.slab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pylayers.antprop.channel</span> <span class="kn">import</span> <span class="n">Ctilde</span>
<span class="kn">from</span> <span class="nn">pylayers.gis.layout</span> <span class="kn">import</span> <span class="n">Layout</span>
<span class="kn">import</span> <span class="nn">pylayers.signal.bsignal</span> <span class="kn">as</span> <span class="nn">bs</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tvtk.api</span> <span class="kn">import</span> <span class="n">tvtk</span>
    <span class="kn">from</span> <span class="nn">mayavi.sources.vtk_data_source</span> <span class="kn">import</span> <span class="n">VTKDataSource</span>
    <span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&#39;Layout:Mayavi is not installed&#39;</span>

<span class="k">class</span> <span class="nc">Rays</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A set af rays</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    rays   :</span>
<span class="sd">    nbrays :</span>
<span class="sd">    rayidx :</span>
<span class="sd">    sig    :</span>
<span class="sd">    pt     :</span>
<span class="sd">    alpha  :</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    to3D(H=3,N=1)</span>
<span class="sd">        for k in self:   # for all interaction group k</span>
<span class="sd">        for k in self:   # for all interaction group k</span>
<span class="sd">    locbas(L)</span>
<span class="sd">    fillinter(L)</span>
<span class="sd">    eval</span>
<span class="sd">    show(L)</span>
<span class="sd">    mirror(H=3,N=1)</span>
<span class="sd">    ray</span>
<span class="sd">    typ</span>
<span class="sd">    info</span>
<span class="sd">    to3D</span>
<span class="sd">    signature(L)</span>
<span class="sd">    show3d(ray,bdis,bbas,bstruc,col,id,linewidth)</span>
<span class="sd">    show3()</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The Rays object is obtained from a signature.</span>
<span class="sd">    It is a container for a set of rays between a source</span>
<span class="sd">    and a target point defining a radio link.</span>

<span class="sd">    Once a Rays object has been obtained in 2D, it is transform</span>
<span class="sd">    in 3D via the **to3D** method. This method has two parameters :</span>
<span class="sd">    the height from floor to ceil, and the number N of</span>
<span class="sd">    multiple reflections to take into account.</span>

<span class="sd">    Once the 3d rays have been calculated, the </span>
<span class="sd">    the local basis are evaluated along those rays. This is</span>
<span class="sd">    done through the **locbas** method</span>

<span class="sd">    Once the local basis have been calculated the different</span>
<span class="sd">    interactions along rays can be informed via the **fillinter**</span>
<span class="sd">    method.</span>

<span class="sd">    Once the interaction are informed the field along rays can</span>
<span class="sd">    be evaluated via the **eval** method</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Rays.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.__init__.html#pylayers.antprop.rays.Rays.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pTx</span><span class="p">,</span> <span class="n">pRx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span> <span class="o">=</span> <span class="n">pTx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span> <span class="o">=</span> <span class="n">pRx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raypt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="o">=</span><span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span><span class="o">=</span><span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isbased</span><span class="o">=</span><span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span> <span class="o">=</span> <span class="bp">False</span>
       </div>
<div class="viewcode-block" id="Rays.__len__"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.__len__.html#pylayers.antprop.rays.Rays.__len__">[docs]</a>    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Nray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">])</span>
            <span class="n">Nray</span> <span class="o">=</span> <span class="n">Nray</span><span class="o">+</span><span class="n">sh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Nray</span>

</div>
<div class="viewcode-block" id="Rays.__repr__"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.__repr__.html#pylayers.antprop.rays.Rays.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;3D</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;----------&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span>
                    <span class="n">nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; / &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span><span class="o">+</span> <span class="s">&#39; : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">ni</span> <span class="o">=</span> <span class="n">ni</span> <span class="o">+</span> <span class="n">nr</span><span class="o">*</span><span class="n">k</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">nl</span> <span class="o">+</span> <span class="n">nr</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;-----&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">+</span><span class="s">&#39;ni : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">+</span><span class="s">&#39;nl : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;2D</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;----------&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

                <span class="n">nray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;N2Drays : &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nray</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;from &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_origin_sig</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; signatures</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;#Rays/#Sig: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nb_origin_sig</span><span class="p">)</span> <span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">pTx : &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">pRx : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="c">#sk = np.shape(self[k][&#39;sig&#39;])[2]</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="c">#s = s + str(sk) + &#39;rays with&#39; + str(k) + &#39; interactions&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;problem&quot;</span>
            <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save rays </span>
<span class="sd">            pyh5 format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> 
        <span class="n">filenameh5</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;.h5&#39;</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRR3D&#39;</span><span class="p">])</span>
        
        
        
        <span class="c"># try/except to avoid loosing the h5 file if </span>
        <span class="c"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="c"># keys not saved as attribute of h5py file</span>
            <span class="n">notattr</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="s">&#39;B0&#39;</span><span class="p">,</span><span class="s">&#39;delays&#39;</span><span class="p">,</span><span class="s">&#39;dis&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notattr</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">kk</span> <span class="o">==</span> <span class="s">&#39;sig2d&#39;</span><span class="p">:</span>
                        <span class="c"># Need to find an efficient way to save the signatures</span>
                        <span class="c"># 2d which have created the rays</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">kk</span> <span class="o">==</span> <span class="s">&#39;nbrays&#39;</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]]))</span>
                    <span class="k">else</span><span class="p">:</span>    
                        <span class="n">f</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Rays: issue when writting h5py file&#39;</span><span class="p">)</span>
        
        

    <span class="k">def</span> <span class="nf">loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="p">[],</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save rays </span>
<span class="sd">            pyh5 format</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">filenameh5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;.h5&#39;</span> 
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">filenameh5</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRR3D&#39;</span><span class="p">])</span>

        
        <span class="c"># try/except to avoid loosing the h5 file if </span>
        <span class="c"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):{}})</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kk</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">kk</span><span class="p">)][:]})</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">va</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Rays: issue when reading h5py file&#39;</span><span class="p">)</span>
            
        <span class="c"># fill if save was filled</span>

        <span class="c"># temporary solution in order to avoir </span>
        <span class="c"># creating save for Interactions classes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
            <span class="n">Lname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.ini&#39;</span>
            <span class="n">L</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">Lname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillinter</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save rays h5py format compliant with Links Class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5 : string</span>
<span class="sd">            filename of the h5py file (from Links Class)</span>
<span class="sd">        grpname : string </span>
<span class="sd">            groupname of the h5py file (from Links Class)</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.simul.links</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filenameh5</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="c"># try/except to avoid loosing the h5 file if </span>
        <span class="c"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grpname</span> <span class="ow">in</span> <span class="n">fh5</span><span class="p">[</span><span class="s">&#39;ray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
                <span class="n">fh5</span><span class="p">[</span><span class="s">&#39;ray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">grpname</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;ray/&#39;</span><span class="o">+</span><span class="n">grpname</span> <span class="o">+</span><span class="s">&#39;already exists in &#39;</span><span class="o">+</span><span class="n">filenameh5</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fh5</span><span class="p">[</span><span class="s">&#39;ray/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>
            <span class="c"># keys not saved as attribute of h5py file</span>
            <span class="n">notattr</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="s">&#39;B0&#39;</span><span class="p">,</span><span class="s">&#39;delays&#39;</span><span class="p">,</span><span class="s">&#39;dis&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notattr</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">kk</span> <span class="o">==</span> <span class="s">&#39;sig2d&#39;</span><span class="p">:</span>
                        <span class="c"># Need to find an efficient way to save the signatures</span>
                        <span class="c"># 2d which have created the rays</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">kk</span> <span class="o">==</span> <span class="s">&#39;nbrays&#39;</span><span class="p">:</span>
                        <span class="n">f</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]]))</span>
                    <span class="k">else</span><span class="p">:</span>    
                        <span class="n">f</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">])</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Rays: issue when writting h5py file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load rays  h5py format compliant with Links Class</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5 : string</span>
<span class="sd">            filename of the h5py file (from Links Class)</span>
<span class="sd">        grpname : string </span>
<span class="sd">            groupname of the h5py file (from Links Class)</span>
<span class="sd">        </span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.simul.links</span>

<span class="sd">        &quot;&quot;&quot;</span>
                

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="c"># try/except to avoid loosing the h5 file if </span>
        <span class="c"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fh5</span><span class="p">[</span><span class="s">&#39;ray/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):{}})</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">kk</span><span class="p">:</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">kk</span><span class="p">)][:]})</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">va</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">va</span><span class="p">)</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Rays: issue when reading h5py file&#39;</span><span class="p">)</span>
            
        <span class="c"># fill if save was filled</span>

        <span class="c"># temporary solution in order to avoir </span>
        <span class="c"># creating save for Interactions classes</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span><span class="p">:</span>
            <span class="n">L</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">Lfilename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillinter</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="p">)</span> 


<div class="viewcode-block" id="Rays.reciprocal"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.reciprocal.html#pylayers.antprop.rays.Rays.reciprocal">[docs]</a>    <span class="k">def</span> <span class="nf">reciprocal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; switch tx and rx</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">r</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span>
        <span class="n">r</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nray</span>
        <span class="n">r</span><span class="o">.</span><span class="n">nb_origin_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb_origin_sig</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Rays.check_reciprocity"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.check_reciprocity.html#pylayers.antprop.rays.Rays.check_reciprocity">[docs]</a>    <span class="k">def</span> <span class="nf">check_reciprocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check ray reciprocity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        r : Rays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="o">==</span><span class="n">r</span><span class="o">.</span><span class="n">pRx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="o">==</span><span class="n">r</span><span class="o">.</span><span class="n">pTx</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">isbased</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">isbased</span><span class="p">):</span>
                <span class="c">#assert (np.allclose(self[k][&#39;nstrwall&#39;],r[k][&#39;nstrwall&#39;][:,::-1,:]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="c">#assert ((np.mod(self[k][&#39;aoa&#39;]-r[k][&#39;aod&#39;],2*np.pi)==0).all())</span>
                <span class="c">#assert ((np.mod(self[k][&#39;aod&#39;]-r[k][&#39;aoa&#39;],2*np.pi)==0).all())</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo0&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;BiN&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;BiN&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo0&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">],</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;scpr&#39;</span><span class="p">]),</span><span class="nb">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;scpr&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;theta&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;theta&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bi&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo&#39;</span><span class="p">][:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bi&#39;</span><span class="p">][:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]))</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">],</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">][:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span> <span class="p">:</span>

            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">):</span>

                <span class="n">iint1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>
                <span class="n">iint2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">ray</span><span class="p">(</span><span class="n">ir</span><span class="p">)</span>

                <span class="c"># check Interactions</span>
                <span class="n">A1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">iint1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">A2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">iint2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span><span class="n">A2</span><span class="p">),</span><span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

                <span class="c"># check bases</span>
                <span class="c">#  ray 1 : B0   | B[0]   | B[1] | B[2] | B[3] | B[4]</span>
                <span class="c">#  ray 2 : B[4] | B[3]  | B[2]  | B[1] | B[0] | B0</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B0</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ir</span><span class="p">,:,:],</span><span class="n">r</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iint2</span><span class="p">,:,:][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">B0</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ir</span><span class="p">,:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iint1</span><span class="p">,:,:][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iint1</span><span class="p">,:,:][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">r</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">iint2</span><span class="p">,:,:][:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>


</div>
<div class="viewcode-block" id="Rays.sort"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.sort.html#pylayers.antprop.rays.Rays.sort">[docs]</a>    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sort rays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Rays.extract"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.extract.html#pylayers.antprop.rays.Rays.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ni</span><span class="p">,</span><span class="n">nr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extract a single ray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ni : group of interactions</span>
<span class="sd">        nr : ray index in group of interactions</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">r</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">is3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is3D</span>
        <span class="n">r</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tab</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tab</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">nr</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">r</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="s">&#39;nrays&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Rays.show"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.show.html#pylayers.antprop.rays.Rays.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  plot 2D rays within the simulated environment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        i : list or -1 (default = all groups)</span>
<span class="sd">            list of interaction group numbers</span>
<span class="sd">        r : list or -1 (default = all rays)</span>
<span class="sd">            list of indices of ray in interaction group</span>
<span class="sd">        graph : type of graph to be displayed</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;i&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="s">&#39;r&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="s">&#39;fig&#39;</span><span class="p">:[],</span>
                   <span class="s">&#39;ax&#39;</span><span class="p">:[],</span>
                   <span class="s">&#39;graph&#39;</span><span class="p">:</span><span class="s">&#39;s&#39;</span><span class="p">,</span>
                    <span class="s">&#39;color&#39;</span><span class="p">:</span><span class="s">&#39;black&#39;</span><span class="p">,</span>
                    <span class="s">&#39;alpharay&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">&#39;widthray&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="s">&#39;colray&#39;</span><span class="p">:</span><span class="s">&#39;black&#39;</span><span class="p">,</span>
                    <span class="s">&#39;ms&#39;</span><span class="p">:</span><span class="mi">5</span>
                   <span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c">#if kwargs[&#39;fig&#39;] ==[]:</span>
        <span class="c">#    fig = plt.figure()</span>
        <span class="c">#if kwargs[&#39;ax&#39;] ==[]:   </span>
        <span class="c">#    ax = fig.add_subplot(111)</span>

        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;or&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;ms&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;og&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;ms&#39;</span><span class="p">])</span>
        <span class="c"># i=-1 all rays</span>
        <span class="c"># else block of interactions i</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lgrint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgrint</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;i&#39;</span><span class="p">]]</span>
           

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lgrint</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">lray</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;rays index :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lray</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lray</span><span class="p">:</span>
                <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
                                 <span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;alpharay&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;colray&#39;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;widthray&#39;</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;rays index :&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">][</span><span class="n">lray</span><span class="p">]))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">)</span>      
</div>
<div class="viewcode-block" id="Rays.mirror"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.mirror.html#pylayers.antprop.rays.Rays.mirror">[docs]</a>    <span class="k">def</span> <span class="nf">mirror</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; mirror</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        H : float</span>
<span class="sd">            ceil height (default 3m)</span>

<span class="sd">        N : int</span>
<span class="sd">            handle the number of mirror reflexions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        d : dict</span>
<span class="sd">            k : zm  v: alpham</span>
<span class="sd">            k : zp  v: alphap</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">       </span>
<span class="sd">        &gt;&gt;&gt; ptx = np.array([1,1,1.5])</span>
<span class="sd">        &gt;&gt;&gt; prx = np.array([2,2,1.2])</span>
<span class="sd">        &gt;&gt;&gt; r = Rays(ptx,prx)</span>
<span class="sd">        &gt;&gt;&gt; d = r.mirror()</span>
<span class="sd">        &gt;&gt;&gt; d[-1.5]</span>
<span class="sd">        array([ 0.55555556])</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">kp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># heights of transmitter and receiver</span>
        <span class="c">#</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">hr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">zkp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">kp</span><span class="o">*</span><span class="n">H</span> <span class="o">+</span> <span class="n">ht</span>
        <span class="n">zkm</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">km</span><span class="o">*</span><span class="n">H</span> <span class="o">-</span> <span class="n">ht</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">zm</span> <span class="ow">in</span> <span class="n">zkm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bup</span> <span class="o">=</span> <span class="n">H</span>
                <span class="n">pas</span> <span class="o">=</span> <span class="n">H</span>
                <span class="n">km</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">zm</span><span class="o">/</span><span class="n">H</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bup</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pas</span> <span class="o">=</span> <span class="o">-</span><span class="n">H</span>
                <span class="n">km</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">zm</span><span class="o">/</span><span class="n">H</span><span class="p">))</span>
            <span class="n">thrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">km</span><span class="o">*</span><span class="n">H</span><span class="p">,</span> <span class="n">bup</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">zm</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thrm</span><span class="o">-</span><span class="n">zm</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">hr</span><span class="o">-</span><span class="n">zm</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">zp</span> <span class="ow">in</span> <span class="n">zkp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bup</span> <span class="o">=</span> <span class="n">H</span>
                <span class="n">pas</span> <span class="o">=</span> <span class="n">H</span>
                <span class="n">kp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">zp</span><span class="o">/</span><span class="n">H</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bup</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pas</span> <span class="o">=</span> <span class="o">-</span><span class="n">H</span>
                <span class="n">kp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">zp</span><span class="o">/</span><span class="n">H</span><span class="p">))</span>
            <span class="n">thrp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">kp</span><span class="o">*</span><span class="n">H</span><span class="p">,</span> <span class="n">bup</span><span class="p">,</span> <span class="n">pas</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">zp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thrp</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">hr</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span>
            <span class="c"># print &quot;zp&quot;,zp</span>
            <span class="c"># print &quot;kp&quot;,kp</span>
            <span class="c"># print &quot;thrp&quot;,thrp</span>
            <span class="c"># print &quot;alphap&quot;,d[zp]</span>

        <span class="k">return</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Rays.to3D"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.to3D.html#pylayers.antprop.rays.Rays.to3D">[docs]</a>    <span class="k">def</span> <span class="nf">to3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">H</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; transform 2D ray to 3D ray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout object</span>

<span class="sd">        H : float</span>
<span class="sd">            ceil height (default 3m)</span>

<span class="sd">        N : int</span>
<span class="sd">            number of mirror reflexions</span>

<span class="sd">        returns</span>
<span class="sd">        -------</span>

<span class="sd">        r3d : Rays</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        1.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span>
        
        <span class="c">#</span>
        <span class="c"># Phase 1 : calculate Tx images height and parameterization in the</span>
        <span class="c"># vertical plane</span>
        <span class="c">#</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

        <span class="c">#</span>
        <span class="c"># Phase 2 : calculate 2D parameterization in the horizontal plane</span>
        <span class="c">#</span>
       
        <span class="c"># for all group of interactions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>

            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
            <span class="c"># broadcasting of t and r</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])))</span>
            <span class="c"># append t and r to interaction points in 2D </span>
            <span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="n">r</span><span class="p">))))</span>
            <span class="n">si1</span> <span class="o">=</span> <span class="n">pts1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pts1</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c"># array of all ray segments distances</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si1</span> <span class="o">*</span> <span class="n">si1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="c"># array of cumulative distance of 2D ray</span>
            <span class="n">al1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># initialize parameterization parameter alpha</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">si</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])):</span>
                <span class="c"># get alpha</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> \
                        <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c"># get z coordinate</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> \
                    <span class="o">*</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c">#</span>
        <span class="c">#  Phase 3 : Initialize 3D rays dictionnary</span>
        <span class="c">#</span>
        <span class="n">r3d</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">)</span>
        <span class="n">r3d</span><span class="o">.</span><span class="n">los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span>
        <span class="n">r3d</span><span class="o">.</span><span class="n">is3D</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c">#</span>
        <span class="c"># Phase 4 : Fill 3D rays information</span>
        <span class="c">#</span>
        <span class="c"># Two nested loops</span>
        <span class="c">#</span>
        <span class="c">#      for all interaction group</span>
        <span class="c">#          for all type of 3D rays</span>
        <span class="c">#             1) extension</span>
        <span class="c">#             2) sort</span>
        <span class="c">#             3) coordinates as a function of parameter</span>
        <span class="c">#</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>   <span class="c"># for all interaction group k</span>
            <span class="c"># k = int(k)</span>
            <span class="c"># Number of rays in interaction group k</span>
            <span class="n">Nrayk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># get  2D horizontal parameterization</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;alpha&#39;</span><span class="p">]</span>         

            <span class="c">#if (k==1):</span>
            <span class="c">#    pdb.set_trace()</span>
            <span class="c"># get  2D signature</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>           
            <span class="c">#print &quot;signatures 2D &quot;,sig</span>
            <span class="c">#print &quot;----&quot;</span>
            <span class="n">sigsave</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
            <span class="c"># add parameterization of tx and rx (0,1)</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">)),</span> <span class="n">a1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">))))</span>

            <span class="c"># reshape signature in adding tx and rx</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                             <span class="n">sig</span><span class="p">,</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)))</span>  <span class="c"># add signature of Tx and Rx (0,0))</span>
            <span class="c"># broadcast tx and rx</span>
            <span class="n">Tx</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">))</span>
            <span class="n">Rx</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">))</span>

            <span class="c"># pte is the sequence of point in 3D ndim =3   ( ndim x k x Nrayk)</span>
            <span class="n">pte</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span>

            <span class="c"># ndim x k+2 x Nrayk</span>
            <span class="n">pte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Tx</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">Rx</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>                     <span class="c"># for each vertical pattern (C,F,CF,FC,....)</span>
                <span class="c">#print k,l,d[l]</span>
                <span class="n">Nint</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>            <span class="c"># number of additional interaction</span>
                <span class="c">#if ((k==1) &amp; (l==5.0)):</span>
                <span class="c">#    pdb.set_trace()</span>
                <span class="k">if</span> <span class="n">Nint</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                <span class="c"># if new interaction ==&gt; need extension</span>
                    <span class="c"># a1e : extended horizontal+vertical parameterization</span>
                    <span class="n">a1e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">l</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">))))</span>
                    <span class="c"># get sorted indices</span>
                    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a1e</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c"># a1es : extended sorted horizontal + vertical parameterization</span>
                    <span class="n">a1es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">a1e</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c"># #### Check if it exist same parameter value  in horizontal plane</span>
                    <span class="c"># #### and vertical plane. Move parameter is so.</span>
                    <span class="n">da1es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">a1es</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">pda1es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da1es</span><span class="o">&lt;</span><span class="mf">1e-10</span><span class="p">)</span>
                    <span class="n">a1es</span><span class="p">[</span><span class="n">pda1es</span><span class="p">]</span><span class="o">=</span><span class="n">a1es</span><span class="p">[</span><span class="n">pda1es</span><span class="p">]</span><span class="o">-</span><span class="mf">1e-3</span>


                    <span class="c"># prepare an extended sequence of points ( ndim x  (Nint+k+2) x Nrayk )</span>
                    <span class="n">ptee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">Nint</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">))))</span>

                    <span class="c">#</span>
                    <span class="c"># Boolean ceil/floor detector</span>
                    <span class="c">#</span>
                    <span class="c"># u is 4 (floor interaction )</span>
                    <span class="c">#      5 (ceil interaction )</span>
                    <span class="c">#  depending on the vertical pattern l.</span>
                    <span class="c">#</span>
                    <span class="c">#  l &lt;0 corresponds to last reflexion on floor</span>
                    <span class="c">#  l &gt;0 corresponds to last reflexion on ceil</span>
                    <span class="c">#</span>
                    <span class="c"># u =0 (floor) or 1 (ceil)</span>
                    <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nint</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nint</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="c">#   </span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="mi">4</span>   
                    <span class="c">#</span>
                    <span class="c"># At that point we introduce the signature of the new</span>
                    <span class="c"># introced points on the ceil and/or floor.</span>
                    <span class="c">#</span>
                    <span class="c"># A signature is compose of two lines</span>
                    <span class="c"># esigs sup line : interaction number</span>
                    <span class="c"># esigi inf line : interaction type</span>
                    <span class="c">#</span>
                    <span class="n">esigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nint</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">esigi</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nint</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nrayk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                    <span class="c"># esig : extension of the signature              </span>
                    <span class="n">esig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">esigs</span><span class="p">,</span> <span class="n">esigi</span><span class="p">))</span>
                    <span class="c"># sige : signature extended  ( 2 x (Nint+k+2) x Nrayk )</span>
                    <span class="n">sige</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">sig</span><span class="p">,</span> <span class="n">esig</span><span class="p">))</span>
                   
                    <span class="c">#</span>
                    <span class="c"># 2 x (Nint+k+2) x Nrayk</span>
                    <span class="c">#</span>
                    <span class="c"># Now comes the time to sort extended sequence of points</span>
                    <span class="c"># and extended sequence of signatures with the sorting</span>
                    <span class="c"># index ks obtained from argsort of merge parametization </span>
                    <span class="c">#</span>
                    <span class="c"># sequence of extended sorted points</span>
                    <span class="c">#</span>
                    <span class="n">ptees</span> <span class="o">=</span> <span class="n">ptee</span><span class="p">[:,</span> <span class="n">ks</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrayk</span><span class="p">)]</span>    
                    <span class="n">siges</span> <span class="o">=</span> <span class="n">sige</span><span class="p">[:,</span> <span class="n">ks</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrayk</span><span class="p">)]</span>  
                    <span class="c"># extended and sorted signature</span>
                    <span class="n">iint_f</span><span class="p">,</span> <span class="n">iray_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">siges</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>  <span class="c"># floor interaction</span>
                    <span class="n">iint_c</span><span class="p">,</span> <span class="n">iray_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">siges</span><span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>  <span class="c"># ceil interaction</span>
                    <span class="c">#print siges    </span>
                    <span class="c">#</span>
                    <span class="c"># find the list of the previous and next point around the</span>
                    <span class="c"># new ceil or floor point. The case of successive ceil or</span>
                    <span class="c"># floor reflexion make</span>
                    <span class="c">#</span>
                    <span class="c"># Tous les points prÃ©cÃ©dents qui ne sont pas des Ceils ou</span>
                    <span class="c"># des floors et tous les points suivants qui ne sont pas</span>
                    <span class="c"># des points de rÃ©flexion ceil ou floor</span>
                    <span class="c">#</span>
                    <span class="c"># Afin de tenir compte du rayon et du groupe d&#39;interaction</span>
                    <span class="c"># concernÃ©, il faut passer un tuple qui concatÃ¨ne la valeur</span>
                    <span class="c"># de l&#39;indice d&#39;interaction floor ou ceil et l&#39;indice de</span>
                    <span class="c"># rayons du groupe associÃ© (d&#39;ou le zip)</span>
                    <span class="c">#</span>
                    <span class="c"># Cette sÃ©quence d&#39;instruction fixe le bug #133</span>
                    <span class="c">#</span>
                    <span class="c"># AntÃ©rieurement il y avait une hypothÃ¨se de succession</span>
                    <span class="c"># immediate d&#39;un point 2D renseignÃ©.</span>
                    <span class="c">#</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">iintm_f</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iint_f</span><span class="p">,</span><span class="n">iray_f</span><span class="p">))</span>
                        <span class="n">iintp_f</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iint_f</span><span class="p">,</span><span class="n">iray_f</span><span class="p">))</span>
                        <span class="n">iintm_c</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iint_c</span><span class="p">,</span><span class="n">iray_c</span><span class="p">))</span>
                        <span class="n">iintp_c</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">&lt;&gt;</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iint_c</span><span class="p">,</span><span class="n">iray_c</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

                    <span class="c"># Update coordinate in the horizontal plane</span>
                    <span class="c">#</span>
                    <span class="c">#</span>
                    <span class="c"># The new interaction ceil or floor has no coordinates in</span>
                    <span class="c"># the horizontal plane.</span>
                    <span class="c"># Those coordinates are evaluated first by finding a sub</span>
                    <span class="c"># parameterization of the point with respect to the two</span>
                    <span class="c"># known adjascent interaction point j-1 and j+1 (Thales)</span>
                    <span class="c">#</span>

                    <span class="c">#iintm_f = iint_f - 1</span>
                    <span class="c">#iintp_f = iint_f + 1</span>

                    <span class="c">#iintm_c = iint_c - 1</span>
                    <span class="c">#iintp_c = iint_c + 1</span>


                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iint_f</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">a1esm_f</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iintm_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span>
                        <span class="n">a1esc_f</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iint_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span>
                        <span class="n">a1esp_f</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iintp_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span>


                        <span class="n">pteesm_f</span> <span class="o">=</span> <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iintm_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span>
                        <span class="n">pteesp_f</span> <span class="o">=</span> <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iintp_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span>

                        <span class="n">coeff_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1esc_f</span><span class="o">-</span><span class="n">a1esm_f</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a1esp_f</span><span class="o">-</span><span class="n">a1esm_f</span><span class="p">)</span>
                        <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iint_f</span><span class="p">,</span> <span class="n">iray_f</span><span class="p">]</span> <span class="o">=</span> <span class="n">pteesm_f</span> <span class="o">+</span> <span class="n">coeff_f</span><span class="o">*</span><span class="p">(</span><span class="n">pteesp_f</span><span class="o">-</span><span class="n">pteesm_f</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iint_c</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">a1esm_c</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iintm_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span>
                        <span class="n">a1esc_c</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iint_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span>
                        <span class="n">a1esp_c</span> <span class="o">=</span> <span class="n">a1es</span><span class="p">[</span><span class="n">iintp_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span>

                        <span class="n">pteesm_c</span> <span class="o">=</span> <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iintm_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span>
                        <span class="n">pteesp_c</span> <span class="o">=</span> <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iintp_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span>

                        <span class="n">coeff_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1esc_c</span><span class="o">-</span><span class="n">a1esm_c</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a1esp_c</span><span class="o">-</span><span class="n">a1esm_c</span><span class="p">)</span>
                        <span class="n">ptees</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">iint_c</span><span class="p">,</span> <span class="n">iray_c</span><span class="p">]</span> <span class="o">=</span> <span class="n">pteesm_c</span> <span class="o">+</span> <span class="n">coeff_c</span><span class="o">*</span><span class="p">(</span><span class="n">pteesp_c</span><span class="o">-</span><span class="n">pteesm_c</span><span class="p">)</span>


                    <span class="c">#    a1es[iint_f+1, iray_f]-a1es[iint_f-1, iray_f])</span>
                    <span class="c">#coeff_f = (a1es[iint_f, iray_f]-a1es[iint_f-1, iray_f])/(</span>
                    <span class="c">#    a1es[iint_f+1, iray_f]-a1es[iint_f-1, iray_f])</span>

                    <span class="c">#coeff_c = (a1es[iint_c, iray_c]-a1es[iint_c-1, iray_c])/(</span>
                    <span class="c">#    a1es[iint_c+1, iray_c]-a1es[iint_c-1, iray_c])</span>
                    <span class="c">#</span>
                    <span class="c"># Update coordinate in the horizontal plane</span>
                    <span class="c">#</span>
                    <span class="c">#</span>
                    <span class="c">#ptees[0:2, iint_f, iray_f] = ptees[0:2, iint_f-1, iray_f] + coeff_f*(</span>
                    <span class="c">#    ptees[0:2, iint_f+1, iray_f]-ptees[0:2, iint_f-1, iray_f])</span>
                    <span class="c">#ptees[0:2, iint_c, iray_c] = ptees[0:2, iint_c-1, iray_c] + coeff_c*(</span>
                    <span class="c">#    ptees[0:2, iint_c+1, iray_c]-ptees[0:2, iint_c-1, iray_c])</span>


                    <span class="c"># vertical plane</span>
                    <span class="c"># WARNING !!</span>
                    <span class="c">#</span>
                    <span class="c"># ptees[2,iint_f,iray_f]   = 0</span>
                    <span class="c"># ptees[2,iint_c,iray_c]   = H</span>
                    <span class="c">#</span>
                    <span class="n">z</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">a1es</span><span class="o">*</span><span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="p">),</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="p">)</span>
                    <span class="n">pz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">H</span><span class="p">)</span>
                    <span class="n">z</span><span class="p">[</span><span class="n">pz</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">pz</span><span class="p">]</span>
                    <span class="n">ptees</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">z</span>
                <span class="c"># recopy old 2D parameterization (no extension)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a1es</span> <span class="o">=</span> <span class="n">a1</span>
                    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a1es</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ptees</span> <span class="o">=</span> <span class="n">pte</span>
                    <span class="c"># fixing bug</span>
                    <span class="n">siges</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                    <span class="c">#print siges</span>

                <span class="c">#---------------------------------</span>
                <span class="c"># handling subsegments (if any)</span>
                <span class="c">#---------------------------------</span>
                <span class="c">#</span>
                <span class="c">#   ptes (3 x i+2 x r )</span>
                <span class="k">if</span> <span class="n">L</span><span class="o">.</span><span class="n">Nss</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c"># lsss[k] = n means subsegment k belongs to segment n</span>
                    <span class="c"># a same segment n can have several subsegments</span>
                    <span class="c"># (multi-subsegment case) that is the reason of unique</span>
                    <span class="n">lsss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">lsss</span><span class="p">))</span>

                    <span class="c"># index of signature which corresponds to subsegment</span>
                    <span class="n">u</span>   <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">siges</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">==</span><span class="n">x</span><span class="p">)),</span><span class="n">lsss</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c"># dimension extension of index u for :</span>
                    <span class="c">#    z coordinate extraction (append line 2 on dimension 0)</span>
                    <span class="c">#    0 signature extraction  (append line 0 on  dimension 0)</span>

                    <span class="c"># v : index 2 is for getting z coordinate</span>
                    <span class="c"># w : index 0 is for getting segment number (first line of</span>
                    <span class="c"># siges)</span>
                    <span class="n">v</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)]</span><span class="o">+</span><span class="n">u</span>
                    <span class="n">w</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)]</span><span class="o">+</span><span class="n">u</span>

                    <span class="c"># zss : height of interactions on subsegments</span>
                    <span class="n">zss</span> <span class="o">=</span> <span class="n">ptees</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="c">#if k==1:</span>
                    <span class="c">#    print &quot;l&quot;,l</span>
                    <span class="c">#    print &quot;ptees : &quot;,ptees</span>
                    <span class="c">#    print &quot;u &quot;,u</span>
                    <span class="c">#    print &quot;v &quot;,v</span>
                    <span class="c">#    print &quot;w &quot;,w</span>
                    <span class="c"># structure index of corresponding subsegments</span>

                    <span class="c"># nstrs = [ 1 , 1 , 1 , 1, 1 , 1]</span>
                    <span class="n">nstrs</span> <span class="o">=</span> <span class="n">siges</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>

                    <span class="c">#if k==1:</span>
                    <span class="c">#    print &quot;nstrs: &quot;,nstrs</span>
                    <span class="c">#    print &quot;zss:&quot;,zss</span>
                    <span class="c">#</span>
                    <span class="c"># Determine which subsegment has been intersected</span>
                    <span class="c"># k = 0 : no subsegment intersected</span>
                    <span class="n">zinterval</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s">&#39;ss_z&#39;</span><span class="p">],</span><span class="n">nstrs</span><span class="p">)</span>


                    <span class="c"># Example</span>
                    <span class="c">#</span>
                    <span class="c"># zinterval = [[(0.0, 2.4), (2.7, 2.8), (2.8, 3)],</span>
                    <span class="c">#              [(0.0, 2.4), (2.7, 2.8), (2.8, 3)],</span>
                    <span class="c">#              [(0.0, 2.4), (2.7, 2.8), (2.8, 3)],</span>
                    <span class="c">#              [(0 .0, 2.4), (2.7, 2.8), (2.8, 3)],</span>
                    <span class="c">#              [(0.0, 2.4), (2.7, 2.8), (2.8, 3)],</span>
                    <span class="c">#              [(0.0, 2.4), (2.7, 2.8), (2.8, 3)]]</span>
                    <span class="c"># zss = array([ 2.62590637,  2.62589727,  1.34152518,</span>
                    <span class="c"># 2.0221785 ,  0.23706671, 0.2378053])</span>
                    <span class="c">#</span>
                    <span class="c"># tab = [[], [], [(0.0, 2.4)], [(0.0, 2.4)], [(0.0, 2.4)], [(0.0, 2.4)], [(0.0, 2.4)]]</span>
                    <span class="c">#</span>
                    <span class="n">tab</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="p">((</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                                                           <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">zip</span><span class="p">(</span><span class="n">zinterval</span><span class="p">,</span><span class="n">zss</span><span class="p">))</span>
                    <span class="c">#print tab</span>
                    <span class="k">def</span> <span class="nf">findindex</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                            <span class="k">return</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c">#</span>
                    <span class="c"># indexss = [0, 0 , 1 , 1 ,1 ,1]</span>
                    <span class="c"># L.stridess[nstrs] = [ 9 , 9 , 9, 9 , 9 , 9 ]</span>
                    <span class="c"># indexnex = [ 9 , 9 , 10 , 10 , 10 , 10 ]</span>
                    <span class="c">#</span>
                    <span class="n">indexss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">findindex</span><span class="p">,</span><span class="nb">zip</span><span class="p">(</span><span class="n">zinterval</span><span class="p">,</span><span class="n">tab</span><span class="p">)))</span>
                    <span class="n">uw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indexss</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indexnew</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">stridess</span><span class="p">[</span><span class="n">nstrs</span><span class="p">]</span><span class="o">+</span><span class="n">indexss</span>
                    <span class="n">indexnew</span><span class="p">[</span><span class="n">uw</span><span class="p">]</span> <span class="o">=</span> <span class="n">nstrs</span><span class="p">[</span><span class="n">uw</span><span class="p">]</span>
                    <span class="c">#ind  = map(lambda x: np.where(L.lsss==x[0])+x[1],zip(nstrs,indexss))</span>
                    <span class="c">#iindexnex = L.isss[ind]</span>
                    <span class="c">#indexnew = map(lambda x: x[0] if x[1]==0 else 1000000+100*x[0]+x[1]-1,zip(nstrs,indexss))</span>
                    <span class="c">#indexnew = map(lambda x: x[0] if x[1]==0 else 1000000+100*x[0]+x[1]-1,zip(nstrs,indexss))</span>
                    <span class="c"># update signature</span>
                    <span class="n">siges</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexnew</span>
                    <span class="c">#if k==3:</span>
                    <span class="c">#    print siges</span>

                    <span class="c">#if k==1:</span>
                    <span class="c">#    print &quot;indexss:&quot;,indexss</span>
                    <span class="c">#    print &quot;indexnew:&quot;,indexnew</span>
                    <span class="c">#    print &quot;siges&quot;,siges</span>
                    <span class="c">#print siges</span>
                    <span class="c">#pdb.set_trace()</span>
                    <span class="c">#pdb.set_trace()</span>
                    <span class="c"># expand dimension add z dimension (2)</span>
                    <span class="c"># tuple concatenation doesn&#39;t work with array this is strange!!</span>
                    <span class="c">#</span>
                    <span class="c"># &gt;&gt; a = (1,2,3)</span>
                    <span class="c"># &gt;&gt; b = (3,5,6)</span>
                    <span class="c"># &gt;&gt; a+b</span>
                    <span class="c"># (1,2,3,3,5,6)</span>
                    <span class="c"># but</span>
                    <span class="c"># &gt;&gt; u = (array([1,2]),array([1,2]))</span>
                    <span class="c"># &gt;&gt; v = (array([2,2]))</span>
                    <span class="c"># &gt;&gt; u + v</span>
                    <span class="c"># array([[3,4],[3,4]])  inconsistent !</span>
                    <span class="c">#</span>
                    <span class="c">#   z --&gt; kl subseg level </span>
                    <span class="c">#   siges[0,:] --&gt; Ms + nstr *Mss + (kl)</span>
                    <span class="c">#</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># r3d[k+Nint][&#39;alpha&#39;] = np.hstack((r3d[k+Nint][&#39;alpha&#39;],a1es))</span>
                    <span class="c"># r3d[k+Nint][&#39;ks&#39;] = np.hstack((r3d[k+Nint][&#39;ks&#39;],ks))</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">],</span> <span class="n">ptees</span><span class="p">))</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">],</span> <span class="n">siges</span><span class="p">))</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;sig2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigsave</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c"># r3d[k+Nint][&#39;alpha&#39;] = a1es</span>
                    <span class="c"># r3d[k+Nint][&#39;ks&#39;] = ks</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptees</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">siges</span>
                    <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">Nint</span><span class="p">][</span><span class="s">&#39;sig2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigsave</span><span class="p">]</span>

        <span class="c">#</span>
        <span class="c"># Add Line Of Sight ray information</span>
        <span class="c">#   pt =  [tx,rx]</span>
        <span class="c">#   sig = [0,0]</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span> <span class="p">:</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;sig2d&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">tx</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">r3d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:]</span><span class="o">=</span><span class="n">rx</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="c"># r3d.nray = reduce(lambda x,y : y + np.shape(r3d[x][&#39;sig&#39;])[2],lnint)</span>
        <span class="c"># count total number of ray</span>
        <span class="c"># evaluate length of ray segment</span>
        <span class="c">#</span>
        <span class="c"># vsi</span>
        <span class="c"># si</span>
        <span class="c"># dis</span>
        <span class="c">#</span>
        <span class="n">val</span> <span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">r3d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">nrayk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrayk</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nrayk</span><span class="p">)</span><span class="o">+</span><span class="n">val</span>
            <span class="n">r3d</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="n">r3d</span><span class="o">.</span><span class="n">nray</span> <span class="o">+</span> <span class="n">nrayk</span>
            <span class="n">val</span><span class="o">=</span><span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="c"># 3 : x,y,z</span>
            <span class="c"># i : interaction index</span>
            <span class="c"># r : ray index</span>
            <span class="c">#</span>
            <span class="c"># k : group of interactions index</span>
            <span class="c">#</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">-</span><span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">rlength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lsi</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lsi</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">lsi</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lsi</span><span class="o">==</span><span class="mf">0.</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

            <span class="c">#</span>
            <span class="c"># sort rays w.r.t their length</span>
            <span class="c">#</span>

            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rlength</span><span class="p">)</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,:,</span><span class="n">u</span><span class="p">]</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][:,:,</span><span class="n">u</span><span class="p">]</span>
            <span class="c">#r3d[k][&#39;sig2d&#39;] = r3d[k][&#39;sig2d&#39;][:,:,u]</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">v</span><span class="o">/</span><span class="n">lsi</span>             <span class="c"># ndim , nint - 1 , nray</span>

            <span class="c"># vsi : 3 x (i+1) x r</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">[:,:,</span><span class="n">u</span><span class="p">]</span>

            <span class="c"># si : (i+1) x r</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;si&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">lsi</span><span class="p">[:,</span><span class="n">u</span><span class="p">]</span>
            <span class="n">r3d</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rlength</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>

        <span class="n">r3d</span><span class="o">.</span><span class="n">origin_sig_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_sig_name</span>
        <span class="n">r3d</span><span class="o">.</span><span class="n">Lfilename</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">r3d</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r3d</span><span class="o">.</span><span class="n">nray</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">r3d</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Rays.length"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.length.html#pylayers.antprop.rays.Rays.length">[docs]</a>    <span class="k">def</span> <span class="nf">length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate length of rays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>   <span class="c"># for all interaction group k</span>
            <span class="c"># 3 x Ni-1 x Nr</span>
            <span class="n">vk</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vk</span><span class="o">*</span><span class="n">vk</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">dk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d1</span>
            <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">dk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span>
        <span class="k">return</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Rays.locbas"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.locbas.html#pylayers.antprop.rays.Rays.locbas">[docs]</a>    <span class="k">def</span> <span class="nf">locbas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate ray local basis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#</span>
        <span class="c"># extract normal in np.array</span>
        <span class="c">#</span>

        <span class="c"># nsegment x 3</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">,</span> <span class="s">&#39;norm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c"># nsegment x k</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">,</span> <span class="s">&#39;norm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c"># maximum number for refering to segment</span>
        <span class="c"># not to be confused with a number of segment</span>

        <span class="n">nsmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c">#</span>
        <span class="c"># Structutre number : nstr</span>
        <span class="c">#   the structure number is &lt; 0 for points</span>
        <span class="c">#                           &gt; 0 for segments</span>
        <span class="c"># A segment can have several subsegments (until 100)</span>
        <span class="c">#  nstrs is the nstr of the segment if subsegment :</span>
        <span class="c">#  nstr  is the glabal which allows to recover the slab values</span>
        <span class="c">#</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="n">idxts</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">nbrayt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nbrayt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c">#</span>
            <span class="c"># k is the number of interactions in the block</span>
            <span class="c">#</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c"># structure number (segment or point)</span>
                <span class="c"># nstr : i x r</span>
                <span class="n">nstr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>     

                <span class="c"># ityp : i x r</span>
                <span class="n">ityp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>     
                <span class="c"># nstr of underlying segment</span>
                <span class="c"># position of interaction corresponding to a sub segment</span>
                <span class="c"># print nstr</span>
                <span class="c">#</span>
                <span class="c"># uss : index of subsegment</span>
                <span class="c"># subsegments are not nodes of Gs but have positive nst index</span>
                <span class="c">#</span>

                <span class="n">uss</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nstr</span><span class="o">&gt;</span><span class="n">nsmax</span><span class="p">)</span>

                <span class="c"># print uss</span>

                <span class="n">nstrs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">nstr</span><span class="p">)</span>
                <span class="c">#</span>
                <span class="c"># if subsegments have been found</span>
                <span class="c">#</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uss</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind</span>   <span class="o">=</span> <span class="n">nstr</span><span class="p">[</span><span class="n">uss</span><span class="p">]</span><span class="o">-</span><span class="n">nsmax</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">nstrs</span><span class="p">[</span><span class="n">uss</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">lsss</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
                <span class="c">#    print nstr</span>
                <span class="c">#print nstrs</span>
                <span class="c">#pdb.set_trace()</span>
                <span class="n">nray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nstr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">uwall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ityp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ityp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">udiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ityp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">ufloor</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ityp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">uceil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">ityp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span>

                <span class="n">nstrwall</span>  <span class="o">=</span> <span class="n">nstr</span><span class="p">[</span><span class="n">uwall</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uwall</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>   <span class="c"># nstr of walls</span>
                <span class="n">nstrswall</span> <span class="o">=</span> <span class="n">nstrs</span><span class="p">[</span><span class="n">uwall</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uwall</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>   <span class="c"># nstrs of walls</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nstrwall&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">nstrwall</span>    <span class="c"># store nstr without subsegment</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nstrswall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nstrswall</span>   <span class="c"># store nstr with subsegment</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nray</span><span class="p">))</span>   <span class="c"># 3 x int x nray</span>

                <span class="c">#</span>
                <span class="c"># Warning : The following commented line assumes that all the segment number are contiguous</span>
                <span class="c"># self[k][&#39;norm&#39;][:,uwall[0],uwall[1]] = norm[nstrwall-1,:].T</span>
                <span class="c">#</span>

                <span class="c"># norm : 3 x i x r</span>
                <span class="c"># TODO </span>
                <span class="c"># For the diffraction the norm should be replaced by the unit</span>
                <span class="c"># vector along the wedge.</span>
                <span class="c"># udiff not handled yet</span>
                <span class="c">#</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">][:,</span> <span class="n">uwall</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uwall</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">nstrswall</span><span class="p">],:]</span><span class="o">.</span><span class="n">T</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="n">ufloor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ufloor</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ufloor</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="n">uceil</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uceil</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uceil</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="n">normcheck</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">normcheck</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.99</span><span class="p">,</span><span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>


                <span class="c"># 3 : x,y,z</span>
                <span class="c"># i : interaction index</span>
                <span class="c"># r : ray index</span>
                <span class="c">#</span>
                <span class="c"># k : group of interactions index</span>
                <span class="c">#</span>
                <span class="c">#v = self[k][&#39;pt&#39;][:, 1:, :]-self[k][&#39;pt&#39;][:, 0:-1, :]</span>
                <span class="c">#lsi = np.sqrt(np.sum(v*v, axis=0))</span>
                <span class="c">#if (lsi.any()==0):</span>
                <span class="c">#    pdb.set_trace()</span>
                <span class="c">#assert(lsi.all()&gt;0)</span>
                <span class="c">#if (len(np.where(lsi==0.))==0) :</span>
                <span class="c">#    pdb.set_trace()</span>

                <span class="c">#si = v/lsi             # ndim , nint - 1 , nray</span>

                <span class="c"># si : 3 x (i+1) x r</span>
                <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">]</span>

                <span class="c"># si : (i+1) x r</span>
                <span class="c">#self[k][&#39;si&#39;] = lsi</span>
                <span class="c">#self[k][&#39;dis&#39;] = np.sum(lsi,axis=0)</span>

                <span class="c"># normal : 3 x i x r</span>
                <span class="n">vn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">]</span>
                <span class="c"># s_in : 3 x i x r</span>
                <span class="n">s_in</span> <span class="o">=</span> <span class="n">si</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c"># s_out : 3 x i x r</span>
                <span class="n">s_out</span> <span class="o">=</span> <span class="n">si</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

                <span class="c">#</span>
                <span class="c"># AOD (rad)</span>
                <span class="c">#</span>

                <span class="c"># th : ,r</span>
                <span class="n">thd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

                <span class="c"># ph : ,r</span>
                <span class="n">phd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

                <span class="c"># aod : 2 x r  (radians)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;aod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">thd</span><span class="p">,</span> <span class="n">phd</span><span class="p">))</span>

                <span class="c"># eth : 3 x r</span>
                <span class="n">eth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thd</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phd</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thd</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phd</span><span class="p">),</span>
                                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thd</span><span class="p">)])</span>
                <span class="c"># eph : 3 x r</span>
                <span class="n">eph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phd</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phd</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phd</span><span class="p">))])</span>

                <span class="c"># Bo0 : 3 x 2 x r</span>
                <span class="n">Bo0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">eth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                      <span class="n">eph</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">si</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                                 <span class="n">eth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                                 <span class="n">eph</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#</span>
                <span class="c"># scalar product si . norm</span>
                <span class="c">#</span>
                <span class="c"># vn   : 3 x i x r</span>
                <span class="c"># s_in : 3 x i x r</span>

                <span class="c">#</span>
                <span class="c"># scpr : i x r</span>
                <span class="c">#</span>
                <span class="c">#if k ==5:</span>
                <span class="c">#    pdb.set_trace()</span>
                <span class="c">#scpr = np.sum(vn*s_in, axis=0)</span>
                <span class="n">scpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vn</span><span class="o">*</span><span class="n">si</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;scpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scpr</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">scpr</span><span class="p">))</span>  <span class="c"># *180/np.pi</span>
                <span class="c">#if k ==5:</span>
                    <span class="c">#print &quot;vsi :&quot;,self[k][&#39;vsi&#39;][:,:,43]</span>
                    <span class="c">#print &quot;si :&quot;,si[:,0:-1,43]</span>
                    <span class="c">#print &quot;vn :&quot;,vn[:,:,43]</span>
                    <span class="c">#print &quot;scpr :&quot;,self[k][&#39;scpr&#39;][:,43]</span>
                    <span class="c">#print &quot;scpr :&quot;,self[k][&#39;scpr&#39;][:,43]</span>
                    <span class="c">#print &quot;theta :&quot;,self[k][&#39;scpr&#39;][:,43]</span>

                <span class="c">#</span>
                <span class="c"># Warning need to handle singular case when s_in // vn</span>
                <span class="c">#</span>
                <span class="c"># w : 3 x i x r</span>
                <span class="c">#</span>
                <span class="c"># Handling channel reciprocity s_in --&gt; -s_in</span>
                <span class="c">#</span>
                <span class="c">#w = np.cross(s_in, vn, axisa=0, axisb=0, axisc=0)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="o">-</span><span class="n">s_in</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">axisa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c"># nw : i x r</span>
                <span class="c">#</span>
                <span class="c">#</span>
                <span class="c"># to do fic the colinear bug</span>
                <span class="c">#</span>
                <span class="n">nw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nw</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">u</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.99</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
                    <span class="n">uh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">uv</span><span class="p">)</span>
                    <span class="n">w</span><span class="p">[:,</span><span class="n">uv</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">w</span><span class="p">[:,</span><span class="n">uh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                    <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="c">#assert(nw.all()&gt;0), pdb.set_trace()</span>
                <span class="n">wn</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">nw</span>
                <span class="c"># Handling channel reciprocity s_in --&gt; -s_in</span>
                <span class="c">#v = np.cross(wn, s_in, axisa=0, axisb=0, axisc=0)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="o">-</span><span class="n">s_in</span><span class="p">,</span> <span class="n">axisa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">es_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="o">-</span><span class="n">s_in</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#  Bi 3 x 2 x i x r</span>
                <span class="n">Bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ew</span><span class="p">,</span> <span class="n">ev</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c">#  self[k][&#39;Bi&#39;] 3 x 3 x i x r </span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">es_in</span><span class="p">,</span><span class="n">ew</span><span class="p">,</span><span class="n">ev</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s_out</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">axisa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">wn</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="n">s_out</span><span class="p">,</span> <span class="n">axisa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axisc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">es_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">s_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#  Bi 3 x 2 x i x r</span>
                <span class="n">Bo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ew</span><span class="p">,</span> <span class="n">ev</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c">#  self[k][&#39;Bo&#39;] 3 x 3 x i x r </span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">es_out</span><span class="p">,</span><span class="n">ew</span><span class="p">,</span><span class="n">ev</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#</span>
                <span class="c"># AOA (rad)</span>
                <span class="c">#</span>

                <span class="c"># th : ,r</span>
                <span class="c"># fix doa/dod reciprocity</span>
                <span class="c">#th = np.arccos(si[2, -1, :])</span>
                <span class="n">tha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

                <span class="c"># th : ,r</span>
                <span class="c">#ph = np.arctan2(si[1, -1, :], si[0, -1, :])</span>
                <span class="n">pha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

                <span class="c"># aoa : 2 x r  (radians)</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;aoa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tha</span><span class="p">,</span> <span class="n">pha</span><span class="p">))</span>
                <span class="n">eth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pha</span><span class="p">),</span>
                                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tha</span><span class="p">)])</span>
                <span class="n">eph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pha</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pha</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pha</span><span class="p">))])</span>
                <span class="c"># Bo0 : 3 x 2 x r</span>
                <span class="n">BiN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">eth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                                      <span class="n">eph</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;BiN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="o">-</span><span class="n">si</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span><span class="n">eth</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span>
                                                   <span class="n">eph</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c">#</span>
                <span class="c"># pasting (Bo0,B,BiN)</span>
                <span class="c">#</span>

                <span class="c"># B : 3 x 2 x i x r</span>

                <span class="n">Bo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Bo0</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Bo</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Bi</span><span class="p">,</span> <span class="n">BiN</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="c"># B : 2 x 2 x i x r</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s">&#39;xv...,xw...-&gt;vw...&#39;</span><span class="p">,</span> <span class="n">Bi</span><span class="p">,</span> <span class="n">Bo</span><span class="p">)</span>

                <span class="c">#BiN = np.array([si[:,-1,:], eth, eph])    # ndim x 3 x Nray</span>
                <span class="c">#self[k][&#39;BiN&#39;]=BiN</span>
                <span class="c"># self[k][&#39;B&#39;]=np.sum(self[k][&#39;Bi&#39;][:2,:2,np.newaxis]*self[k][&#39;Bo&#39;][np.newaxis,:2,:2],axis=1)</span>

                <span class="c">## index creation</span>
                <span class="c">##################</span>
                <span class="c"># create index for retrieving interactions</span>

                <span class="c"># integer offset : total size idx</span>

                <span class="n">idxts</span> <span class="o">=</span> <span class="n">idxts</span> <span class="o">+</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span>

                <span class="n">idx</span> <span class="o">=</span> <span class="n">idxts</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ityp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ityp</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>

                <span class="n">nbray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">idx</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbray</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbrayt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nbray</span><span class="p">)</span>

                <span class="c"># create a numpy array to relate the ray index to its corresponding</span>
                <span class="c"># number of interactions</span>

                <span class="n">ray2nbi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nbray</span><span class="p">))</span>

               
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="p">,</span><span class="n">ray2nbi</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="o">=</span><span class="n">ray2nbi</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">k</span>
                <span class="n">nbrayt</span> <span class="o">=</span> <span class="n">nbrayt</span> <span class="o">+</span> <span class="n">nbray</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raypt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raypt</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span>
            <span class="c"># if los exists</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nstrwall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;si&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">si</span><span class="p">,</span><span class="mf">0.</span><span class="p">))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">si</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">si</span><span class="p">))</span>
                <span class="n">vsi</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;vsi&#39;</span><span class="p">]</span>
                <span class="n">thd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">vsi</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">phd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vsi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vsi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;aod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">thd</span><span class="p">,</span> <span class="n">phd</span><span class="p">))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;Bo0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;scpr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="c">#</span>
                <span class="c"># The following derivation of the doa is the actual chosen angle convention</span>
                <span class="c"># Those angles are relative to natural spherical coordinates system in the gcs of the scene.</span>
                <span class="c">#</span>
                <span class="c"># for a LOS path :</span>
                <span class="c">#  tha = pi - thd</span>
                <span class="c">#  pha = phd - pi</span>
                <span class="c">#</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;aoa&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">thd</span><span class="p">,</span> <span class="n">phd</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">E</span><span class="p">,</span><span class="n">E</span><span class="p">))</span>
                <span class="n">ze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([[</span><span class="mi">0</span><span class="p">]]))</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ze</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raypt</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="o">=</span><span class="n">ze</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">isbased</span><span class="o">=</span><span class="bp">True</span>
</div>
<div class="viewcode-block" id="Rays.fillinter"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.fillinter.html#pylayers.antprop.rays.Rays.fillinter">[docs]</a>    <span class="k">def</span> <span class="nf">fillinter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">append</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  fill ray interactions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L      : Layout</span>
<span class="sd">        append : Boolean</span>
<span class="sd">            if   True append new rays to existing structure</span>
<span class="sd">            else True append new rays to existing structure</span>

<span class="sd">        &quot;&quot;&quot;</span>
      
        <span class="c"># reinitilized ray pointer if not in append mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raypt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># stacked interactions</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">Interactions</span><span class="p">()</span>

        <span class="c"># rotation basis</span>
        <span class="n">B</span>  <span class="o">=</span> <span class="n">IntB</span><span class="p">()</span>
        <span class="n">B0</span> <span class="o">=</span> <span class="n">IntB</span><span class="p">()</span>

        <span class="c"># LOS Interaction</span>
        <span class="n">Los</span> <span class="o">=</span> <span class="n">IntL</span><span class="p">()</span>

        <span class="c"># Reflexion</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">IntR</span><span class="p">()</span>

        <span class="c"># transmission</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">IntT</span><span class="p">()</span>

        <span class="c"># Diffraction</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">IntD</span><span class="p">()</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="n">idxts</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">nbrayt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxts</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nbrayt</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="c"># Transform dictionnary of slab name to array</span>
        <span class="c"># slv = nx.get_node_attributes(L.Gs, &quot;name&quot;).values()</span>
        <span class="c"># slk = nx.get_node_attributes(L.Gs, &quot;name&quot;).keys()</span>
        <span class="c"># find all material used in simulation</span>
        <span class="n">uslv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">sla</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="c">#</span>
        <span class="c"># add CEIL and FLOOR</span>
        <span class="c">#</span>
        <span class="n">uslv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">uslv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="s">&#39;CEIL&#39;</span><span class="p">,</span> <span class="s">&#39;FLOOR&#39;</span><span class="p">))))</span>

        <span class="c"># create reverse dictionnary with all material as a key</span>
        <span class="c"># and associated point/segment as a value</span>

        <span class="c">#dsla = {}</span>
        <span class="c">#for s in uslv:</span>
        <span class="c">#    dsla[s] = np.where(s == np.array(slv))[0]</span>

        <span class="n">nsmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c">#sla = np.zeros((nsmax+1), dtype=&#39;S20&#39;)</span>

        <span class="c"># array type str with more than 1 character</span>
        <span class="c"># warning use zeros instead of empty because slab zero</span>
        <span class="c"># is virtually used before assigning correct slab to ceil and floor</span>

        <span class="c">#</span>
        <span class="c"># sla is an array of string.</span>
        <span class="c"># each value of Gs node is the index of the corresponding slab</span>
        <span class="c">#</span>

        <span class="c">#sla[slk] = np.array(slv)</span>

        <span class="n">R</span><span class="o">.</span><span class="n">dusl</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">uslv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">T</span><span class="o">.</span><span class="n">dusl</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">uslv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

        <span class="n">tsl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
        <span class="n">rsl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>

        <span class="c"># loop on group of interactions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">uR</span> <span class="o">=</span> <span class="n">uT</span> <span class="o">=</span> <span class="n">uD</span> <span class="o">=</span> <span class="n">uRf</span> <span class="o">=</span> <span class="n">uRc</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="c"># structure number (segment or point)</span>
                <span class="c"># nstr : i x r</span>
                <span class="n">nstr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c"># ityp : i x r</span>
                <span class="n">ityp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c"># theta : i x r   ( related to interactions )</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;theta&#39;</span><span class="p">]</span>

                <span class="c"># (i+1) x r</span>
                <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;si&#39;</span><span class="p">]</span>

                <span class="c">## flatten information</span>
                <span class="c">######################</span>

                <span class="c"># flatten nstr (1 dimension)</span>
                <span class="c"># size1 = i x r</span>
                <span class="n">size1</span> <span class="o">=</span> <span class="n">nstr</span><span class="o">.</span><span class="n">size</span>

                <span class="c"># flatten ityp (method faster than np.ravel() )</span>
                <span class="n">nstrf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nstr</span><span class="p">,</span><span class="n">size1</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">itypf</span> <span class="o">=</span> <span class="n">ityp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size1</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">thetaf</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size1</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="c">#sif = si[0, :, :].reshape(si[0, :, :].size)</span>

                <span class="c">## index creation</span>
                <span class="c">##################</span>
                <span class="c"># create index for retrieving interactions</span>

                <span class="c"># integer offset : total size idx</span>

                <span class="n">idxts</span> <span class="o">=</span> <span class="n">idxts</span> <span class="o">+</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span>

                <span class="n">idx</span> <span class="o">=</span> <span class="n">idxts</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ityp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ityp</span><span class="p">),</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>

                <span class="n">nbray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">idx</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbray</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbrayt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nbray</span><span class="p">)</span>

                <span class="c"># create a numpy array to relate the ray index to its corresponding</span>
                <span class="c"># number of interactions</span>

                <span class="c"># ray2nbi = np.ones((nbray))</span>

                <span class="c">#try:</span>
                <span class="c">#    self.ray2nbi=np.hstack((self.ray2nbi,ray2nbi))</span>
                <span class="c">#except:</span>
                <span class="c">#    self.ray2nbi=ray2nbi</span>

                <span class="c">#self.ray2nbi[self[k][&#39;rayidx&#39;]]  = k</span>
                <span class="n">nbrayt</span> <span class="o">=</span> <span class="n">nbrayt</span> <span class="o">+</span> <span class="n">nbray</span>
                <span class="c">#self.raypt = self.raypt + self[k][&#39;nbrays&#39;]</span>

                <span class="n">idxf</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="c">#  (i+1)xr</span>
                <span class="n">size2</span> <span class="o">=</span> <span class="n">si</span><span class="p">[:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">size</span>
                <span class="c">#  ,(i+1)xr</span>
                <span class="n">sif</span> <span class="o">=</span> <span class="n">si</span><span class="p">[:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size2</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="c"># 2x2,(i+1)xr</span>

                <span class="c">#</span>
                <span class="c"># self[k][&#39;B&#39;] 2 x 2 x i x r</span>
                <span class="c">#</span>
                <span class="c"># first unitary matrix (2x2xr)</span>
                <span class="n">b0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="c"># first unitary matrix 1:</span>
                <span class="c"># dimension i and r are merged   </span>
                <span class="n">b</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;B&#39;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size2</span><span class="o">-</span><span class="n">nbray</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>

                <span class="c">## find used slab</span>
                <span class="c">##################</span>
                <span class="c"># find slab type for the rnstr</span>
                <span class="c"># nstrf is a number of slab</span>
                <span class="c"># this is a problem for handling subsegment</span>
                <span class="c">#</span>

                <span class="n">sl</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sla</span><span class="p">[</span><span class="n">nstrf</span><span class="p">]</span>

                <span class="c"># seek for interactions position</span>
                <span class="c">################################</span>

                <span class="n">uR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">itypf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">itypf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">itypf</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uRf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">itypf</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uRc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">itypf</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c"># assign floor and ceil slab</span>
                <span class="c">############################</span>

                <span class="c"># WARNING</span>
                <span class="c"># in future version floor and ceil could be different for each cycle.</span>
                <span class="c"># this information would be directly obtained from L.Gs</span>
                <span class="c"># then the two following lines would have to be  modified</span>

                <span class="n">sl</span><span class="p">[</span><span class="n">uRf</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;FLOOR&#39;</span>
                <span class="n">sl</span><span class="p">[</span><span class="n">uRc</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;CEIL&#39;</span>

                <span class="c"># Fill the used slab</span>
                <span class="c">#####################</span>

                <span class="n">tsl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">tsl</span><span class="p">,</span> <span class="n">sl</span><span class="p">[</span><span class="n">uT</span><span class="p">]))</span>
                <span class="n">rsl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rsl</span><span class="p">,</span> <span class="n">sl</span><span class="p">[</span><span class="n">uR</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="n">uRf</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="n">uRc</span><span class="p">]))</span>

    <span class="c">##            for s in uslv:</span>
    <span class="c">##</span>
    <span class="c">##                T.dusl[s]=np.hstack((T.dusl[s],len(T.idx) + np.where(sl[uT]==s)[0]))</span>
    <span class="c">##                R.dusl[s]=np.hstack((R.dusl[s],len(R.idx) + np.where(sl[uR]==s)[0]))</span>
    <span class="c">##            R.dusl[&#39;FLOOR&#39;]=np.hstack((R.dusl[&#39;FLOOR&#39;],len(R.idx)+len(uR) + np.where(sl[uRf]==&#39;FLOOR&#39;)[0]))</span>
    <span class="c"># R.dusl[&#39;CEIL&#39;]=np.hstack((R.dusl[&#39;CEIL&#39;],len(R.idx)+len(uR)+len(uRf) +</span>
    <span class="c"># np.where(sl[uRc]==&#39;CEIL&#39;)[0]))</span>

                <span class="c"># Basis</span>
                <span class="c"># Hugr issue with B index</span>
                <span class="c"># Friedman version Bs was entering in the index</span>
                <span class="c"># maybe B can have the same index that interactions</span>
                <span class="c"># but this must be managed when evaluation of CIR is made</span>

                <span class="c"># BU 10/4/2013</span>
                <span class="c"># .. todo:  This is no longer idxf the good index</span>
                <span class="c"># why the transposition b is first 2x2x(i+1)xr</span>
                <span class="c">#                             idxf is (ixr)</span>
                <span class="c">#</span>
                <span class="c"># need to check how B is used in eval()</span>
                <span class="c">#</span>
                <span class="c"># Warning</span>
                <span class="c"># -------</span>
                <span class="c"># B.idx refers to an interaction index</span>
                <span class="c"># whereas B0.idx refers to a ray number</span>

                <span class="n">B</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idxf</span><span class="p">)</span>
                <span class="n">B0</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">b0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">idx</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">])</span>

                <span class="c">### Reflexion</span>
                <span class="c">############</span>
                <span class="c">### wall reflexion</span>
                <span class="n">R</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">thetaf</span><span class="p">[</span><span class="n">uR</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uR</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uR</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">idx</span><span class="o">=</span><span class="n">idxf</span><span class="p">[</span><span class="n">uR</span><span class="p">])</span>
                <span class="c"># floor reflexion</span>
                <span class="n">R</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">thetaf</span><span class="p">[</span><span class="n">uRf</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uRf</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uRf</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">idx</span><span class="o">=</span><span class="n">idxf</span><span class="p">[</span><span class="n">uRf</span><span class="p">])</span>
                <span class="c"># ceil reflexion</span>
                <span class="n">R</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">thetaf</span><span class="p">[</span><span class="n">uRc</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uRc</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uRc</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">idx</span><span class="o">=</span><span class="n">idxf</span><span class="p">[</span><span class="n">uRc</span><span class="p">])</span>

                <span class="c">### sl[idxf[uT]]</span>
                <span class="c"># Transmision</span>
                <span class="c">############</span>
                <span class="n">T</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">thetaf</span><span class="p">[</span><span class="n">uT</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uT</span><span class="p">],</span> <span class="n">sif</span><span class="p">[</span><span class="n">uT</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idxf</span><span class="p">[</span><span class="n">uT</span><span class="p">])</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
                <span class="n">ze</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="c">#self[k][&#39;rays&#39;] = np.array(([[0]]))</span>
                <span class="c">#self[k][&#39;nbrays&#39;] = 1</span>
                <span class="c">#self[k][&#39;rayidx&#39;] = ze</span>
                <span class="c">#self.raypt = 1</span>
                <span class="c">#self.ray2nbi=ze</span>
                <span class="n">B</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:],</span> <span class="n">idx</span><span class="o">=</span><span class="n">ze</span><span class="p">)</span>
                <span class="n">B0</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:],</span><span class="n">idx</span><span class="o">=</span><span class="n">ze</span><span class="p">)</span>

        <span class="n">T</span><span class="o">.</span><span class="n">create_dusl</span><span class="p">(</span><span class="n">tsl</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">create_dusl</span><span class="p">(</span><span class="n">rsl</span><span class="p">)</span>

        <span class="c"># create interactions structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="n">I</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">])</span>
        <span class="c"># create rotation base B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">B</span>
        <span class="c"># create rotation base B0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B0</span> <span class="o">=</span> <span class="n">B0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filled</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Rays.eval"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.eval.html#pylayers.antprop.rays.Rays.eval">[docs]</a>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fGHz</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.4</span><span class="p">]),</span><span class="n">ib</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;  docstring for eval</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fGHz : array</span>
<span class="sd">            frequency in GHz array</span>
<span class="sd">        ib : list of intercation block</span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#print &#39;Rays evaluation&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fGHz</span><span class="o">=</span><span class="n">fGHz</span>
        <span class="c"># evaluation of interaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="c"># evaluation of base B  (2x2)</span>
        <span class="c"># B and B0 do no depend on frequency</span>
        <span class="c"># just an axis extension (np.newaxis)</span>
        <span class="c">#pdb.set_trace()</span>

        <span class="c"># 1 x i x 2 x 2</span>
        <span class="n">B</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        <span class="c"># 1 x r x 2 x 2</span>
        <span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B0</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="c"># Ct : f x r x 2 x 2</span>
        <span class="n">Ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="c"># delays : ,r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">))</span>

        <span class="c"># dis : ,r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">))</span>

        <span class="c">#nf : number of frequency point</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">nf</span>

        <span class="n">aod</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">))</span>
        <span class="n">aoa</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nray</span><span class="p">))</span>
        <span class="c"># loop on interaction blocks   </span>
        <span class="k">if</span> <span class="n">ib</span><span class="o">==</span><span class="p">[]:</span>
            <span class="n">ib</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">ib</span><span class="p">:</span>
            <span class="c"># ir : ray index</span>
            <span class="n">ir</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span>
            <span class="n">aoa</span><span class="p">[:,</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;aoa&#39;</span><span class="p">]</span>
            <span class="n">aod</span><span class="p">[:,</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;aod&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># l stands for the number of interactions</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;nbrays&#39;</span><span class="p">]</span>
                <span class="c"># reshape in order to have a 1D list of index</span>
                <span class="c"># reshape ray index</span>
                <span class="n">rrl</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;rays&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="c"># get the corresponding evaluated interactions</span>
                <span class="c">#</span>
                <span class="c"># reshape error can be tricky to debug.</span>
                <span class="c">#</span>
                <span class="c"># f , r , l , 2 , 2</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">I</span><span class="p">[:,</span> <span class="n">rrl</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c"># get the corresponding unitary matrix B</span>
                <span class="c"># 1 , r , l , 2 , 2</span>
                <span class="c">#Bl = B[:, rrl, :, :].reshape(self.I.nf, r, l, 2, 2,order=&#39;F&#39;)</span>
                <span class="n">Bl</span> <span class="o">=</span> <span class="n">B</span><span class="p">[:,</span> <span class="n">rrl</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c"># get the first uitary matrix B0l</span>
                <span class="n">B0l</span> <span class="o">=</span> <span class="n">B0</span><span class="p">[:,</span><span class="n">ir</span><span class="p">,:,</span> <span class="p">:]</span>
                <span class="c"># get alpha</span>
                <span class="c"># alpha = self.I.alpha[rrl].reshape(r, l,order=&#39;F&#39;)</span>
                <span class="c"># # get gamma</span>
                <span class="c"># gamma = self.I.gamma[rrl].reshape(r, l,order=&#39;F&#39;)</span>
                <span class="c"># # get si0</span>
                <span class="c"># si0 = self.I.si0[rrl].reshape(r, l,order=&#39;F&#39;)</span>
                <span class="c"># # get sout</span>
                <span class="c"># sout = self.I.sout[rrl].reshape(r, l,order=&#39;F&#39;)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">Z</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>


                <span class="c">#print &quot;\nrays&quot;,ir</span>
                <span class="c">#print &quot;-----------------------&quot;</span>
                <span class="c">## loop on all the interactions of ray with l interactions</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>


    <span class="c">############################################</span>
    <span class="c">##                # Divergence factor D</span>
    <span class="c">###                 not yet implementented</span>
    <span class="c">############################################</span>
    <span class="c">#                if i == 0:</span>
    <span class="c">#                    D0=1./si0[:,1]</span>
    <span class="c">#                    rho1=si0[:,1]*alpha[:,i]</span>
    <span class="c">#                    rho2=si0[:,1]*alpha[:,i]*gamma[:,i]</span>
    <span class="c">#                    D=np.sqrt(</span>
    <span class="c">#                     ( (rho1 ) / (rho1 + sout[:,i]) )</span>
    <span class="c">#                     *( (rho2) / (rho2 + sout[:,i])))</span>
    <span class="c">#                    D=D*D0</span>
    <span class="c">#                    rho1=rho1+(sout[:,i]*alpha[:,i])</span>
    <span class="c">#                    rho2=rho2+(sout[:,i]*alpha[:,i]*gamma[:,i])</span>

    <span class="c">##                     gerer le loss</span>
    <span class="c">#                    if np.isnan(D).any():</span>
    <span class="c">#                        p=np.nonzero(np.isnan(D))[0]</span>
    <span class="c">#                        D[p]=1./sout[p,1]</span>
    <span class="c">#                else :</span>
    <span class="c">#                    D=np.sqrt(</span>
    <span class="c">#                     ( (rho1 ) / (rho1 + sout[:,i]) )</span>
    <span class="c">#                     *( (rho2) / (rho2 + sout[:,i])))</span>

    <span class="c">#                    rho1=rho1+(sout[:,i]*alpha[:,i])</span>
    <span class="c">#                    rho2=rho2+(sout[:,i]*alpha[:,i]*gamma[:,i])</span>
    <span class="c">############################################</span>

                    <span class="c">#  A0  (X dot Y)</span>
                    <span class="c">#  |    |     |</span>
                    <span class="c">#  v    v     v</span>
                    <span class="c">##########################</span>
                    <span class="c">## B  # I  # B  # I  # B #</span>
                    <span class="c">##########################</span>
                    <span class="c">#      \_____/   \______/</span>
                    <span class="c">#         |         |</span>
                    <span class="c">#       Atmp(i)   Atmp(i+1)</span>
                    <span class="c">#</span>
                    <span class="c"># Z=Atmp(i) dot Atmp(i+1)</span>

                    <span class="c">#X = A [:, :, i, :, :]</span>
                    <span class="c">#Y = Bl[:, :, i, :, :]</span>
                    <span class="c"># pdb.set_trace()</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c">## First Basis added</span>
                        <span class="n">Atmp</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">B00</span> <span class="o">=</span> <span class="n">B0l</span><span class="p">[:,</span> <span class="p">:,</span>  <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Atmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                                  <span class="o">*</span><span class="n">B00</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Atmp</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">BB</span> <span class="o">=</span> <span class="n">Bl</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">Ztmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Atmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                                  <span class="o">*</span><span class="n">BB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>


                        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ztmp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                                  <span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">BB</span> <span class="o">=</span> <span class="n">Bl</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">BB</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                                  <span class="o">*</span><span class="n">Z</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>


                <span class="c"># fill the C tilde MDA</span>

                <span class="n">Ct</span><span class="p">[:,</span><span class="n">ir</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>

                <span class="c"># delay computation:</span>
                <span class="c"># sum the distance from antenna to first interaction si0</span>
                <span class="c"># and the sum of all outgoing segments</span>
                <span class="c">#self[l][&#39;dis&#39;] = self.I.si0[self[l][&#39;rays&#39;][0,:]] \</span>
                <span class="c">#        + np.sum(self.I.sout[self[l][&#39;rays&#39;]], axis=0)</span>

                <span class="c"># attenuation due to distance</span>
                <span class="c"># will be removed once the divergence factor will be implemented</span>
                <span class="n">Ct</span><span class="p">[:,</span><span class="n">ir</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span>
        <span class="c">#</span>
        <span class="c"># true LOS when no interaction</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="n">Ct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
            <span class="c">#self[0][&#39;dis&#39;] = self[0][&#39;si&#39;][0]</span>
            <span class="c"># Fris</span>
            <span class="n">Ct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;dis&#39;</span><span class="p">]</span>


        <span class="c"># To be corrected in a future version</span>

        <span class="n">Ct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Ct</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">c11</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c12</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c21</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="n">Ct</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>


        <span class="c">#</span>
        <span class="c"># Construction of the Ctilde channel</span>
        <span class="c">#</span>
        <span class="n">Cn</span> <span class="o">=</span> <span class="n">Ctilde</span><span class="p">()</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">Cpp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c11</span><span class="p">)</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">Cpt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c12</span><span class="p">)</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">Ctp</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c21</span><span class="p">)</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">Ctt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="n">FUsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span><span class="p">,</span> <span class="n">c22</span><span class="p">)</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">nfreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">nf</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">nray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nray</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">tauk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delays</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">fGHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span>
        <span class="c"># r x 2</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">tang</span> <span class="o">=</span> <span class="n">aod</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">tangl</span> <span class="o">=</span> <span class="n">aod</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># r x 2</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">rang</span> <span class="o">=</span> <span class="n">aoa</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Cn</span><span class="o">.</span><span class="n">rangl</span> <span class="o">=</span> <span class="n">aoa</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># add aoa and aod</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span><span class="p">(</span><span class="n">Cn</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Rays.ray"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.ray.html#pylayers.antprop.rays.Rays.ray">[docs]</a>    <span class="k">def</span> <span class="nf">ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        r : integer</span>
<span class="sd">            ray index</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Give the ray number and it returns the index of its interactions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="p">[</span><span class="n">r</span><span class="p">]][</span><span class="s">&#39;rayidx&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ray2nbi</span><span class="p">[</span><span class="n">r</span><span class="p">]][</span><span class="s">&#39;rays&#39;</span><span class="p">][:,</span><span class="n">raypos</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="Rays.typ"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.typ.html#pylayers.antprop.rays.Rays.typ">[docs]</a>    <span class="k">def</span> <span class="nf">typ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns interactions list type of a given ray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : integer</span>
<span class="sd">            ray index</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Rays.info"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.info.html#pylayers.antprop.rays.Rays.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span><span class="n">ifGHz</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            provides information for a given ray r</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : int</span>
<span class="sd">            ray index</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;-------------------------&#39;</span>
            <span class="k">print</span> <span class="s">&#39;Informations of ray #&#39;</span><span class="p">,</span> <span class="n">r</span>
            <span class="k">print</span> <span class="s">&#39;-------------------------</span><span class="se">\n</span><span class="s">&#39;</span>

            <span class="n">ray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;{0:5} , {1:4}, {2:10}, {3:7}, {4:10}, {5:10}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Index&#39;</span><span class="p">,</span>
                                                                        <span class="s">&#39;type&#39;</span><span class="p">,</span>
                                                                        <span class="s">&#39;slab&#39;</span><span class="p">,</span> <span class="s">&#39;th(rad)&#39;</span><span class="p">,</span> <span class="s">&#39;alpha&#39;</span><span class="p">,</span> <span class="s">&#39;gamma2&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;{0:5} , {1:4}, {2:10}, {3:7.2}, {4:10.2}, {5:10.2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&#39;B0&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iidx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span><span class="p">:</span>
                    <span class="n">I</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">slab</span> <span class="ow">in</span> <span class="n">I</span><span class="o">.</span><span class="n">dusl</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="c">#                    print slab</span>
                        <span class="n">midx</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">dusl</span><span class="p">[</span><span class="n">slab</span><span class="p">]</span>
    <span class="c">#                    print midx</span>
                        <span class="n">Iidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">I</span><span class="o">.</span><span class="n">idx</span><span class="p">))[</span><span class="n">midx</span><span class="p">]</span>
                        <span class="n">th</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">I</span><span class="o">.</span><span class="n">dusl</span><span class="p">[</span><span class="n">slab</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">gamma</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">gamma</span><span class="p">[</span><span class="n">midx</span><span class="p">]</span>
                        <span class="n">alpha</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">midx</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">Ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Iidx</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Ii</span> <span class="o">==</span> <span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">]:</span>
                                <span class="k">print</span> <span class="s">&#39;{0:5} , {1:4}, {2:10}, {3:7.2}, {4:10.2}, {5:10.2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Ii</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">slab</span><span class="p">,</span> <span class="n">th</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">gamma</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

                <span class="c"># else:</span>
                <span class="k">print</span> <span class="s">&#39;{0:5} , {1:4}, {2:10}, {3:7.2}, {4:10.2}, {5:10.2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">],</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
                <span class="c">#              print &#39;{0:5} , {1:4}, {2:10}, {3:7}, {4:10}, {5:10}&#39;.format(ray[iidx], i, &#39;-&#39;, &#39;-&#39;, &#39;-&#39;, &#39;-&#39;)</span>

            <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">----------------------------------------&#39;</span>
            <span class="k">print</span> <span class="s">&#39; Matrix of ray #&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s">&#39;at f=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">fGHz</span><span class="p">[</span><span class="n">ifGHz</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;----------------------------------------&#39;</span>

            <span class="k">print</span> <span class="s">&#39;rotation matrix#&#39;</span><span class="p">,</span> <span class="s">&#39;type: B0&#39;</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">B0</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">r</span><span class="p">,:,:]</span>
            <span class="k">for</span> <span class="n">iidx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;interaction #&#39;</span><span class="p">,</span> <span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">],</span> <span class="s">&#39;type:&#39;</span><span class="p">,</span> <span class="n">i</span>
                <span class="c"># f x l x 2 x 2</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">I</span><span class="p">[</span><span class="n">ifGHz</span><span class="p">,</span> <span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="k">print</span> <span class="s">&#39;rotation matrix#&#39;</span><span class="p">,[</span><span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">]],</span> <span class="s">&#39;type: B&#39;</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ray</span><span class="p">[</span><span class="n">iidx</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Rays have not been evaluated yet&#39;</span>
</div>
<div class="viewcode-block" id="Rays.signature"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.signature.html#pylayers.antprop.rays.Rays.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ni</span> <span class="p">,</span><span class="n">nr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; extract ray signature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ni : int</span>
<span class="sd">        nr : int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        sig : ndarray</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Signature of a ray is store as a member</span>

<span class="sd">        r[nint][&#39;sig&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="s">&#39;sig&#39;</span><span class="p">][:,:,</span><span class="n">nr</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Rays.show3d"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays.show3d.html#pylayers.antprop.rays.Rays.show3d">[docs]</a>    <span class="k">def</span> <span class="nf">show3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">ray</span><span class="p">,</span>
               <span class="n">bdis</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">bbas</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">bstruc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
               <span class="n">col</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
               <span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot a set of 3D rays</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ray :</span>
<span class="sd">        block : int</span>
<span class="sd">            interaction block</span>
<span class="sd">        bdis : Boolean</span>
<span class="sd">            if False return .vect filename (True)</span>
<span class="sd">        bbas : Boolean</span>
<span class="sd">            display local basis (False)</span>
<span class="sd">        bstruc : Boolean</span>
<span class="sd">            display structure (True)</span>
<span class="sd">        col  : ndarray() 1x3</span>
<span class="sd">            color of the ray  ([1,0,1])</span>
<span class="sd">        id   : Integer</span>
<span class="sd">            id of the ray (default 0)</span>
<span class="sd">        linewidth : Integer</span>
<span class="sd">            default 1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filerac</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="s">&quot;ray&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRGEOM&#39;</span><span class="p">])</span>
        <span class="n">_filerac</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getshort</span><span class="p">(</span><span class="n">filerac</span><span class="p">)</span>
        <span class="n">filename_list</span> <span class="o">=</span> <span class="n">filerac</span> <span class="o">+</span> <span class="s">&#39;.list&#39;</span>
        <span class="n">filename_vect</span> <span class="o">=</span> <span class="n">filerac</span> <span class="o">+</span> <span class="s">&#39;.vect&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_vect</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;appearance { linewidth </span><span class="si">%d</span><span class="s"> }</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">linewidth</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;VECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;1 </span><span class="si">%d</span><span class="s"> 1</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                     <span class="n">ray</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
        <span class="c"># fo.write(&quot;%d %d %d 0\n&quot; % (col[0],col[1],col[2]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="s"> </span><span class="si">%g</span><span class="s"> 0</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#</span>
        <span class="c"># Ajout des bases locales</span>
        <span class="c">#</span>


        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_list</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;LIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">filename_vect</span> <span class="o">+</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bstruc</span><span class="p">):</span>
            <span class="c"># fo.write(&quot;{&lt;strucTxRx.off}\n&quot;)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">_filestr</span> <span class="o">+</span> <span class="s">&quot;.off}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_list</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">bdis</span><span class="p">):</span>
        <span class="c">#</span>
        <span class="c"># Geomview Visualisation</span>
        <span class="c">#</span>
            <span class="n">chaine</span> <span class="o">=</span> <span class="s">&quot;geomview -nopanel -b 1 1 1 &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> \
                <span class="s">&quot; 2&gt;/dev/null &amp;&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</div>
    <span class="nd">@mlab.show</span>
<div class="viewcode-block" id="Rays._show3"><a class="viewcode-back" href="../../../modules/generated/pylayers.antprop.rays.Rays._show3.html#pylayers.antprop.rays.Rays._show3">[docs]</a>    <span class="k">def</span> <span class="nf">_show3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="p">[],</span><span class="n">ilist</span><span class="o">=</span><span class="p">[],</span><span class="n">rlist</span><span class="o">=</span><span class="p">[],</span><span class="n">newfig</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot 3D rays within the simulated environment</span>
<span class="sd">            using Mayavi</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout object</span>
<span class="sd">            Layout to be displayed</span>
<span class="sd">        ilist : list </span>
<span class="sd">            list of group of interactions</span>
<span class="sd">        rlist : list</span>
<span class="sd">            list of index rays</span>
<span class="sd">        newfig : boolean (default: False)</span>
<span class="sd">            if true create a new mayavi figure </span>
<span class="sd">            else : use the current</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">newfig</span><span class="p">:</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        
        <span class="k">if</span> <span class="n">L</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L</span><span class="o">.</span><span class="n">filename</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;L argument must be a layout object&#39;</span><span class="p">)</span>

            <span class="n">L</span><span class="o">.</span><span class="n">_show3</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ilist</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">nbi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ilist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">nbi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">ilist</span><span class="p">]))</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">nbi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">ilist</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rlist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">rlist</span><span class="o">=</span><span class="p">[</span><span class="n">rlist</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nbi</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rlist</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">])[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">rlist</span><span class="p">))</span> 
            <span class="c"># number of rays</span>
            <span class="n">nbr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> 
            <span class="c"># current number of interactions</span>
            <span class="n">cnbi</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,:,</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">cnbi</span><span class="o">*</span><span class="n">nbr</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cnbi</span><span class="o">*</span><span class="n">nbr</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cnbi</span><span class="p">,</span><span class="n">nbr</span><span class="p">)</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="n">tvtk</span><span class="o">.</span><span class="n">PolyData</span><span class="p">(</span><span class="n">points</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">polys</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">surface</span><span class="p">(</span><span class="n">mlab</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">extract_edges</span><span class="p">(</span><span class="n">mesh</span><span class="p">),</span>
                                                 <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Rays with &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;interactions&#39;</span>
</div>
    <span class="k">def</span> <span class="nf">show3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">L</span><span class="o">=</span><span class="p">[],</span>
              <span class="n">bdis</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">bstruc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">bbasi</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
              <span class="n">bbaso</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
              <span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">ilist</span><span class="o">=</span><span class="p">[],</span>
              <span class="n">raylist</span><span class="o">=</span><span class="p">[],</span><span class="n">centered</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot 3D rays within the simulated environment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        bdis : boolean</span>
<span class="sd">            True</span>
<span class="sd">        bstruc : boolean</span>
<span class="sd">            True</span>
<span class="sd">        bbasi : boolean</span>
<span class="sd">            display input basis of each interaction of rays</span>
<span class="sd">        bbaso : boolean</span>
<span class="sd">            display ouput basis of each interaction of rays</span>
<span class="sd">        id : int</span>
<span class="sd">        L : Layout object</span>
<span class="sd">            Layout to be displayed</span>
<span class="sd">        ilist : list of group of interactions</span>
<span class="sd">        raylist : list of index rays</span>
<span class="sd">        centered : boolean    </span>
<span class="sd">            if True center the layout before display</span>
<span class="sd">        </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">L</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;L argument must be a layout object&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">centered</span><span class="p">:</span>
            <span class="n">pg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">strucname</span><span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">geomfile</span><span class="p">(</span><span class="n">centered</span><span class="o">=</span><span class="n">centered</span><span class="p">)</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pg</span><span class="p">,</span><span class="mf">0.</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ilist</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ilist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">pTx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pTx</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">pg</span>
        <span class="n">pRx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pRx</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">pg</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="s">&quot;grRay&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;.list&quot;</span><span class="p">,</span> <span class="n">pstruc</span><span class="p">[</span><span class="s">&#39;DIRGEOM&#39;</span><span class="p">])</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;LIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bstruc</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span><span class="o">+</span><span class="n">strucname</span><span class="o">+</span><span class="s">&quot;.off}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbasi</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isbased</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Bases have not been computed (self.locbas(Layout)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>   
                    <span class="n">base_listi</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">Geomlist</span><span class="p">(</span><span class="s">&#39;baselisti&#39;</span><span class="p">,</span><span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">base_listi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;LIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbaso</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isbased</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;Bases have not been computed (self.locbas(Layout)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>   
                    <span class="n">base_listo</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">Geomlist</span><span class="p">(</span><span class="s">&#39;baselisto&#39;</span><span class="p">,</span><span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">base_listo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;LIST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="c"># fo.write(&quot;{&lt;strucTxRx.off}\n&quot;)</span>

            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ilist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">raylist</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">rlist</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">])[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rlist</span> <span class="o">=</span> <span class="n">raylist</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                    <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pTx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">pg</span><span class="p">,</span> <span class="n">pRx</span><span class="p">))))</span>
                    <span class="c"># ray = rays[i][&#39;pt&#39;][:,:,j]</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="c"># print ray</span>
                    <span class="n">fileray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show3d</span><span class="p">(</span><span class="n">ray</span><span class="o">=</span><span class="n">ray</span><span class="p">,</span> <span class="n">bdis</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                          <span class="n">bstruc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt; &quot;</span> <span class="o">+</span> <span class="n">fileray</span> <span class="o">+</span> <span class="s">&quot; }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bbasi</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">filebi</span> <span class="o">=</span> <span class="s">&#39;bi_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
                            <span class="n">basi</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">GeomVect</span><span class="p">(</span><span class="n">filebi</span><span class="p">)</span>
                            <span class="n">basi</span><span class="o">.</span><span class="n">geomBase</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Bi&#39;</span><span class="p">][:,:,</span><span class="n">inter</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="n">inter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">pg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">base_listi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">filebi</span> <span class="o">+</span><span class="s">&#39;.vect&#39;</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">filebi</span> <span class="o">=</span> <span class="s">&#39;bi_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inter</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">basi</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">GeomVect</span><span class="p">(</span><span class="n">filebi</span><span class="p">)</span>
                        <span class="n">basi</span><span class="o">.</span><span class="n">geomBase</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;BiN&#39;</span><span class="p">][:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">pg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">base_listi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">filebi</span> <span class="o">+</span><span class="s">&#39;.vect&#39;</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bbaso</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">filebo</span> <span class="o">=</span> <span class="s">&#39;bo_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
                            <span class="n">baso</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">GeomVect</span><span class="p">(</span><span class="n">filebo</span><span class="p">)</span>
                            <span class="n">baso</span><span class="o">.</span><span class="n">geomBase</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Bo&#39;</span><span class="p">][:,:,</span><span class="n">inter</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="n">inter</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">pg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">base_listo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">filebo</span> <span class="o">+</span><span class="s">&#39;.vect&#39;</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">filebo</span> <span class="o">=</span> <span class="s">&#39;bo_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">inter</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">baso</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">GeomVect</span><span class="p">(</span><span class="n">filebo</span><span class="p">)</span>
                        <span class="n">baso</span><span class="o">.</span><span class="n">geomBase</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;Bo0&#39;</span><span class="p">][:,:,</span><span class="n">j</span><span class="p">],</span><span class="n">pt</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;pt&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">pg</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">base_listo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;{&lt;&quot;</span> <span class="o">+</span> <span class="n">filebo</span> <span class="o">+</span><span class="s">&#39;.vect&#39;</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbasi</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt; &quot;</span> <span class="o">+</span> <span class="s">&quot;baselisti.list}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bbaso</span><span class="p">:</span>  
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{&lt; &quot;</span> <span class="o">+</span> <span class="s">&quot;baselisto.list}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bdis</span><span class="p">):</span>
            <span class="n">chaine</span> <span class="o">=</span> <span class="s">&quot;geomview &quot;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot; 2&gt;/dev/null &amp;&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
   <span class="c"># def show3(self,</span>
   <span class="c">#            bdis=True,</span>
   <span class="c">#            bstruc=True,</span>
   <span class="c">#            id=0,</span>
   <span class="c">#            strucname=&#39;defstr&#39;,</span>
   <span class="c">#            ilist=[],</span>
   <span class="c">#            raylist=[],pg=np.array([[0],[0],[0]])):</span>
   <span class="c">#      &quot;&quot;&quot; plot 3D rays within the simulated environment</span>

   <span class="c">#      Parameters</span>
   <span class="c">#      ----------</span>

   <span class="c">#      bdis : boolean</span>
   <span class="c">#          True</span>
   <span class="c">#      bstruc : boolean</span>
   <span class="c">#          True</span>
   <span class="c">#      id : int</span>
   <span class="c">#      strucname : string</span>
   <span class="c">#          &#39;defstr&#39;</span>
   <span class="c">#      ilist : list of group of interactions</span>
   <span class="c">#      raylist : list of index rays</span>
   <span class="c">#      pg : centroid of the structure</span>
        

   <span class="c">#      &quot;&quot;&quot;</span>
   <span class="c">#      if ilist == []:</span>
   <span class="c">#          ilist = self.keys()</span>
   <span class="c">#      pTx = self.pTx.reshape((3, 1))-pg</span>
   <span class="c">#      pRx = self.pRx.reshape((3, 1))-pg</span>
   <span class="c">#      filename = pyu.getlong(&quot;grRay&quot; + str(id) + &quot;.list&quot;, pstruc[&#39;DIRGEOM&#39;])</span>
   <span class="c">#      fo = open(filename, &quot;w&quot;)</span>
   <span class="c">#      fo.write(&quot;LIST\n&quot;)</span>
   <span class="c">#      if bstruc:</span>
   <span class="c">#          fo.write(&quot;{&lt;&quot;+strucname+&quot;.off}\n&quot;)</span>
   <span class="c">#          # fo.write(&quot;{&lt;strucTxRx.off}\n&quot;)</span>
   <span class="c">#          k = 0</span>
   <span class="c">#          for i in ilist:</span>
   <span class="c">#              if raylist == []:</span>
   <span class="c">#                  rlist = range(np.shape(self[i][&#39;pt&#39;])[2])</span>
   <span class="c">#              else:</span>
   <span class="c">#                  rlist = raylist</span>
   <span class="c">#              for j in rlist:</span>
   <span class="c">#                  ray = np.hstack((pTx,np.hstack((self[i][&#39;pt&#39;][:, :, j]-pg, pRx))))</span>
   <span class="c">#                  # ray = rays[i][&#39;pt&#39;][:,:,j]</span>
   <span class="c">#                  col = np.array([2, 0, 1])</span>
   <span class="c">#                  # print ray</span>
   <span class="c">#                  fileray = self.show3d(ray=ray, bdis=False,</span>
   <span class="c">#                                        bstruc=False, col=col, id=k)</span>
   <span class="c">#                  k += 1</span>
   <span class="c">#                  fo.write(&quot;{&lt; &quot; + fileray + &quot; }\n&quot;)</span>
   <span class="c">#      fo.close()</span>
   <span class="c">#      if (bdis):</span>
   <span class="c">#          chaine = &quot;geomview &quot; + filename + &quot; 2&gt;/dev/null &amp;&quot;</span>
   <span class="c">#          os.system(chaine)</span>
   <span class="c">#      else:</span>
   <span class="c">#          return(filename)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">PyLayers Home </a> |&nbsp;</li>
        <li><a href="../../../notebook/index.html">Documentation </a> |&nbsp;</li>
        <li><a href="../../../download.html">Download </a> |&nbsp; </li>
        <li><a href="https://github.com/pylayers/">Developer (Github)</a> </li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2014, PyLayers developer team.
      Last updated on mars 12, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34943220-1']);
  _gaq.push(['_setDomainName', 'pylayers.github.io']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })(); 
</script> 
 
  </body>
</html>