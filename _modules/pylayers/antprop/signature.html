

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pylayers.antprop.signature &mdash; PyLayers</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../../../about.html"/>
    <link rel="top" title="PyLayers" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Python
          

          
            
            <img src="../../../_static/pylayers.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/index.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout1.html">Loading an outdoor layout from its address</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_antenna.html">Antenna Pattern for an H plane sectoral antenna &#64; 32GHz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout2.html">Building graphs of a Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_coverage.html">Indoor Radio Coverage with Motley Keenan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_layout.html">8 Random Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exAbsGas.html">Attenuation due to atmospheric gases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exDLink.html">Evaluation of a radio link DLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_w1.html">Indoor Radio Coverage FP7 WHERE1 M1 setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLuebbers.html">UWB Ray tracing simulation  in outdoor scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_diffraction.html">Diffraction coefficient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html">1&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#classes">2&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#class-inheritance-diagram">3&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id1">4&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id2">5&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id3">6&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id4">7&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id5">8&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id6">9&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id7">10&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id8">11&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id9">12&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id10">13&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id11">14&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id12">15&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id13">16&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id14">17&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id15">18&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id16">19&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id17">20&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id18">21&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id19">22&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id20">23&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id21">24&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id22">25&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id23">26&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id24">27&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id25">28&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id26">29&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id28">30&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id29">31&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id32">32&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id33">33&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id34">34&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id35">35&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id36">36&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id37">37&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id38">38&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id39">39&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id40">40&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id41">41&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id47">42&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id54">43&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id55">44&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id56">45&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id57">46&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id58">47&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id59">48&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id60">49&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id61">50&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id92">51&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id93">52&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id100">53&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id101">54&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id102">55&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id103">56&nbsp;&nbsp;&nbsp;Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id104">57&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id105">58&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id106">59&nbsp;&nbsp;&nbsp;Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/references.html#id107">60&nbsp;&nbsp;&nbsp;Class Inheritance Diagram</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Python</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>pylayers.antprop.signature</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pylayers.antprop.signature</h1><div class="highlight"><pre>
<span></span><span class="c1">#-*- coding:Utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="c1">#import scipy as sp</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="kn">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="kn">as</span> <span class="nn">shg</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">import</span> <span class="nn">pylayers.gis.layout</span> <span class="kn">as</span> <span class="nn">layout</span>
<span class="kn">import</span> <span class="nn">pylayers.util.geomutil</span> <span class="kn">as</span> <span class="nn">geu</span>
<span class="kn">import</span> <span class="nn">pylayers.util.cone</span> <span class="kn">as</span> <span class="nn">cone</span>
<span class="c1">#import pylayers.util.graphutil as gph</span>
<span class="kn">import</span> <span class="nn">pylayers.util.pyutil</span> <span class="kn">as</span> <span class="nn">pyu</span>
<span class="kn">import</span> <span class="nn">pylayers.util.plotutil</span> <span class="kn">as</span> <span class="nn">plu</span>
<span class="kn">from</span> <span class="nn">pylayers.antprop.rays</span> <span class="kn">import</span> <span class="n">Rays</span>
<span class="kn">from</span> <span class="nn">pylayers.util.project</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="kn">as</span> <span class="nn">sh</span>
<span class="kn">import</span> <span class="nn">shapely.ops</span> <span class="kn">as</span> <span class="nn">sho</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="c1">#from numba import autojit</span>


<div class="viewcode-block" id="plot_lines"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.plot_lines.html#pylayers.antprop.signature.plot_lines">[docs]</a><span class="k">def</span> <span class="nf">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    ax : </span>
<span class="sd">    ob : </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">descartes.patch</span> <span class="kn">import</span> <span class="n">PolygonPatch</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span><span class="mi">0</span> <span class="p">:</span> 
                <span class="n">c</span> <span class="o">=</span><span class="s1">&#39;g&#39;</span>
            <span class="k">elif</span> <span class="n">ii</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span><span class="s1">&#39;r&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">=</span> <span class="s1">&#39;k&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">=</span><span class="n">color</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">xy</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="plot_poly"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.plot_poly.html#pylayers.antprop.signature.plot_poly">[docs]</a><span class="k">def</span> <span class="nf">plot_poly</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; plot polygon </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    ax : </span>
<span class="sd">    ob : </span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">descartes.patch</span> <span class="kn">import</span> <span class="n">PolygonPatch</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="showsig"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.showsig.html#pylayers.antprop.signature.showsig">[docs]</a><span class="k">def</span> <span class="nf">showsig</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tx</span><span class="o">=</span><span class="p">[],</span><span class="n">rx</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; show signature</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    L  : Layout</span>
<span class="sd">    s  :</span>
<span class="sd">    tx :</span>
<span class="sd">    rx :</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">L</span><span class="o">.</span><span class="n">display</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">showGs</span><span class="p">()</span>
    <span class="n">L</span><span class="o">.</span><span class="n">display</span><span class="p">[</span><span class="s1">&#39;thin&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">L</span><span class="o">.</span><span class="n">display</span><span class="p">[</span><span class="s1">&#39;edlabel&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">L</span><span class="o">.</span><span class="n">showGs</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">edlist</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tx</span> <span class="o">!=</span><span class="p">[]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rx</span> <span class="o">!=</span><span class="p">[]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">L</span><span class="o">.</span><span class="n">display</span><span class="p">[</span><span class="s1">&#39;edlabel&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span></div>


<div class="viewcode-block" id="gidl"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.gidl.html#pylayers.antprop.signature.gidl">[docs]</a><span class="k">def</span> <span class="nf">gidl</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gi without diffraction</span>

<span class="sd">   Returns</span>
<span class="sd">   -------</span>

<span class="sd">   gr : A graph </span>

<span class="sd">   &quot;&quot;&quot;</span>

    <span class="n">edlist</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pos</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">edlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">gr</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">edlist</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">edge</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">ke</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">keva</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="n">va</span><span class="p">)</span>
            <span class="n">keva_valid</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">keva</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">gr</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">keva_valid</span><span class="p">)</span>

    <span class="n">dpos</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">edlist</span><span class="p">}</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">pos</span><span class="o">=</span><span class="n">dpos</span>
    <span class="k">return</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span></div>

<div class="viewcode-block" id="shLtmp"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.shLtmp.html#pylayers.antprop.signature.shLtmp">[docs]</a><span class="k">def</span> <span class="nf">shLtmp</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="n">seg_connect</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">}</span>

    <span class="n">dpts</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seg_connect</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
    <span class="n">L</span><span class="o">.</span><span class="n">_shseg</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dpts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

<div class="viewcode-block" id="showsig2"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.showsig2.html#pylayers.antprop.signature.showsig2">[docs]</a><span class="k">def</span> <span class="nf">showsig2</span><span class="p">(</span><span class="n">lsig</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tahe</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lsig</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">lsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lsig</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lsig</span><span class="p">:</span>
        <span class="n">k0</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">npt</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">pta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">npt</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">phe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">npt</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">k1</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">plu</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">phe</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k1</span> <span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">plu</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">phe</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">tahe</span><span class="p">:</span>
        <span class="n">ta</span> <span class="o">=</span> <span class="n">th</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">he</span> <span class="o">=</span> <span class="n">th</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plu</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">he</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                      

    <span class="n">tahe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span> <span class="c1"># Nseg x tahe x xy </span>
    <span class="n">pta</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>  <span class="c1">#2 x Nseg</span>
    <span class="n">phe</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># 2 x Nseg </span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">lsig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span>
            <span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">):</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span> <span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># twisted = True</span>
        <span class="n">lef</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">rig</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span> <span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lef</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">rig</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="c1">#L.showG(&#39;s&#39;,labels=True)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span><span class="o">.</span><span class="n">_shseg</span><span class="p">[</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsig</span><span class="p">))</span>
    <span class="n">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span><span class="n">ob</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span><span class="n">ob</span><span class="o">=</span><span class="p">[</span><span class="n">lef</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span><span class="n">ob</span><span class="o">=</span><span class="p">[</span><span class="n">rig</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;tail&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;head&#39;</span><span class="p">)</span>
    <span class="c1">#plu.displot(vl[0].reshape(2,1),vl[1].reshape(2,1),arrow=True)</span>
    <span class="c1">#plu.displot(vr[0].reshape(2,1),vr[1].reshape(2,1),arrow=True)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>
<span class="c1">#@profile</span>
<div class="viewcode-block" id="valid"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.valid.html#pylayers.antprop.signature.valid">[docs]</a><span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">lsig</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tahe</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Check if a signature is valid.</span>
<span class="sd">    if a segment of a given signature is not in or touches the polygon</span>
<span class="sd">    described by the 1st and last segment, the signature is not valid</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    lsig : list of tuple from run  |signatures</span>
<span class="sd">    L : layout</span>
<span class="sd">    tahe : </span>
<span class="sd">        lensig , ta|he , x,y</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    inside : boolean</span>
<span class="sd">        is the signature valid ?</span>


<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">lensi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lensi</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># DEBUG</span>
    <span class="c1"># if lensi == 4:</span>
    <span class="c1">#     if np.all(lsig == np.array([[ 5,  2, 67, 58],[ 2,  2,  3,  2]]).T):</span>
    <span class="c1">#         import ipdb</span>
    <span class="c1">#         ipdb.set_trace()</span>

    <span class="c1"># ensure compatibility with Signature.run where</span>
    <span class="c1"># lsig is a list of tuple</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lsig</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">lsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lsig</span><span class="p">])</span>

    <span class="n">pta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">lensi</span><span class="p">))</span>
    <span class="n">phe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">lensi</span><span class="p">))</span>

    <span class="n">seq</span> <span class="o">=</span> <span class="n">lsig</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># upos = np.where(seq&gt;0)[0]</span>
    <span class="c1"># uneg = np.where(seq&lt;0)[0]</span>
    
    <span class="c1"># tahep = L.seg2pts(seq[upos])</span>
    <span class="c1"># tahen = np.array([L.Gs.pos[i] for i in seq[uneg]]).T</span>
    <span class="c1"># tahen = np.vstack((tahen,tahen))</span>
    <span class="c1"># tahe = np.empty((4,lensi))</span>
    <span class="c1"># tahe[:,upos]=tahep</span>
    <span class="c1"># try:</span>
    <span class="c1">#     tahe[:,uneg]=tahen</span>
    <span class="c1"># except:</span>
    <span class="c1">#     pass</span>
    <span class="c1"># pts = [k for i in seq for k in [L.Gs[i].keys()[0],L.Gs[i].keys()[1]]]</span>
    <span class="c1"># if tahe ==[]:</span>
    <span class="c1"># print &#39;run tahe\n&#39;,np.array(tahe)</span>
    <span class="c1"># if tahe == []:</span>
    <span class="c1">#     pts = [L.Gs[i].keys() for i in seq]</span>
    <span class="c1">#     tahe = np.array([[L.Gs.pos[p[0]],L.Gs.pos[p[1]]] for p in pts])</span>

    <span class="c1">#     pta[:,0] = tahe[0,0,:]</span>
    <span class="c1">#     phe[:,0] = tahe[0,1,:]</span>

    <span class="c1">#     typ = lsig[:,1]</span>
    <span class="c1">#     mirror=[]</span>
    <span class="c1">#     # lines = [L._shseg[seq[0]]]</span>
    <span class="c1">#     for i in range(1,lensi):</span>
    <span class="c1">#         # pam = pa[:,i].reshape(2,1)</span>
    <span class="c1">#         # pbm = pb[:,i].reshape(2,1)</span>
    <span class="c1">#         pam = tahe[i,0,:].reshape(2,1)</span>
    <span class="c1">#         pbm = tahe[i,1,:].reshape(2,1)</span>
    <span class="c1">#         if typ[i] == 2: # R</span>
    <span class="c1">#             for m in mirror:</span>
    <span class="c1">#                 pam = geu.mirror(pam,pta[:,m],phe[:,m])</span>
    <span class="c1">#                 pbm = geu.mirror(pbm,pta[:,m],phe[:,m])</span>
    <span class="c1">#             pta[:,i] = pam.reshape(2)</span>
    <span class="c1">#             phe[:,i] = pbm.reshape(2)</span>
    <span class="c1">#             mirror.append(i)</span>

    <span class="c1">#         elif typ[i] == 3 : # T</span>
    <span class="c1">#             for m in mirror:</span>
    <span class="c1">#                 pam = geu.mirror(pam,pta[:,m],phe[:,m])</span>
    <span class="c1">#                 pbm = geu.mirror(pbm,pta[:,m],phe[:,m])</span>
    <span class="c1">#             pta[:,i] = pam.reshape(2)</span>
    <span class="c1">#             phe[:,i] = pbm.reshape(2)</span>
    <span class="c1">#         elif typ[i] == 1 : # D</span>
    <span class="c1">#             pta[:,i] = pam.reshape(2)</span>
    <span class="c1">#             phe[:,i] = pbm.reshape(2)</span>

    <span class="c1"># else:</span>

    <span class="n">tahe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span> <span class="c1"># Nseg x tahe x xy </span>
    <span class="n">pta</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>  <span class="c1">#2 x Nseg</span>
    <span class="n">phe</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># 2 x Nseg </span>




    <span class="c1"># ### ONLY FOR TEST TO BE DELETED</span>
    <span class="c1"># pts = [L.Gs[i].keys() for i in seq]</span>
    <span class="c1"># tahetest = np.array([[L.Gs.pos[p[0]],L.Gs.pos[p[1]]] for p in pts])</span>
    <span class="c1"># ptat = np.empty((2,lensi))</span>
    <span class="c1"># phet = np.empty((2,lensi))</span>
    <span class="c1"># ptat[:,0] = tahetest[0,0,:]</span>
    <span class="c1"># phet[:,0] = tahetest[0,1,:]</span>

    <span class="c1"># typ = lsig[:,1]</span>
    <span class="c1"># mirror=[]</span>
    <span class="c1">#lines = [L._shseg[seq[0]]]</span>
    <span class="c1"># for i in range(1,lensi):</span>
    <span class="c1">#     # pam = pa[:,i].reshape(2,1)</span>
    <span class="c1">#     # pbm = pb[:,i].reshape(2,1)</span>
    <span class="c1">#     pam = tahetest[i,0,:].reshape(2,1)</span>
    <span class="c1">#     pbm = tahetest[i,1,:].reshape(2,1)</span>
    <span class="c1">#     if typ[i] == 2: # R</span>
    <span class="c1">#         for m in mirror:</span>
    <span class="c1">#             pam = geu.mirror(pam,ptat[:,m],phet[:,m])</span>
    <span class="c1">#             pbm = geu.mirror(pbm,ptat[:,m],phet[:,m])</span>
    <span class="c1">#         ptat[:,i] = pam.reshape(2)</span>
    <span class="c1">#         phet[:,i] = pbm.reshape(2)</span>
    <span class="c1">#         mirror.append(i)</span>

    <span class="c1">#     elif typ[i] == 3 : # T</span>
    <span class="c1">#         for m in mirror:</span>
    <span class="c1">#             pam = geu.mirror(pam,ptat[:,m],phet[:,m])</span>
    <span class="c1">#             pbm = geu.mirror(pbm,ptat[:,m],phet[:,m])</span>
    <span class="c1">#         ptat[:,i] = pam.reshape(2)</span>
    <span class="c1">#         phet[:,i] = pbm.reshape(2)</span>
    <span class="c1">#     elif typ[i] == 1 : # D</span>
    <span class="c1">#         ptat[:,i] = pam.reshape(2)</span>
    <span class="c1">#         phet[:,i] = pbm.reshape(2)</span>

    <span class="c1"># tahetest = np.dstack((ptat.T,phet.T)).swapaxes(1,2)</span>
    <span class="c1"># if np.sum(tahe-tahetest) != 0:</span>
    <span class="c1">#     import ipdb</span>
    <span class="c1">#     ipdb.set_trace()</span>
    
    <span class="c1"># determine the 2 side of the polygon ( top/bottom = tahe[0]/tahe[-1])</span>
    <span class="c1">#vl and vr are 2 director vector lying on the polygon side.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">^</span>
            <span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">):</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span> <span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># vr = ( pta[:,0],phe[:,-1])</span>
        <span class="c1"># vl = ( phe[:,0],pta[:,-1])</span>
        <span class="c1"># twisted = True</span>
        <span class="c1">#lef = sh.LineString((pta[:,0],pta[:,-1]))</span>
        <span class="c1">#rig = sh.LineString((phe[:,0],phe[:,-1]))</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">phe</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span> <span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># vr = ( pta[:,0],pta[:,-1])</span>
        <span class="c1"># vl = ( phe[:,0],phe[:,-1])</span>
        <span class="c1"># twisted = False</span>
        <span class="c1">#lef = sh.LineString((pta[:,0],phe[:,-1]))</span>
        <span class="c1">#rig = sh.LineString((pta[:,-1],phe[:,0]))</span>
        
       


    <span class="c1"># looking situation where Tail and head are not inside the polygon</span>
    <span class="c1"># =&gt; both tahe are left of vr and vl</span>
    <span class="c1">#=&gt;   both tahe are right of vr and vl</span>
    <span class="n">lta</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">isleft</span><span class="p">(</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="bp">None</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">])</span>
    <span class="n">rta</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">isleft</span><span class="p">(</span><span class="n">pta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="bp">None</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">])</span>
    <span class="n">lhe</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">isleft</span><span class="p">(</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="bp">None</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">])</span>
    <span class="n">rhe</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">isleft</span><span class="p">(</span><span class="n">phe</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="bp">None</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="bp">None</span><span class="p">])</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">lta</span> <span class="o">&amp;</span> <span class="n">lhe</span> <span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">rta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">rhe</span><span class="p">)</span>
    <span class="n">inside</span> <span class="o">=</span> <span class="o">~</span><span class="n">out</span>

    <span class="c1"># #debug</span>
    <span class="c1"># plt.ion()</span>
    <span class="c1"># plt.gcf()</span>
    <span class="c1"># #plt.title(str(cond))</span>
    <span class="c1"># #Ok plot_lines(ax=plt.gca(),ob=lines)</span>
    <span class="c1"># plot_lines(ax=plt.gca(),ob=[lef],color=&#39;g&#39;)</span>
    <span class="c1"># plot_lines(ax=plt.gca(),ob=[rig],color=&#39;r&#39;)</span>
    <span class="c1"># plt.scatter(pta[0,:],pta[1,:],marker=&#39;d&#39;,s=70,label=&#39;tail&#39;)</span>
    <span class="c1"># plt.scatter(phe[0,:],phe[1,:],marker=&#39;s&#39;,s=70,label=&#39;head&#39;)</span>
    <span class="c1"># plu.displot(vl[0].reshape(2,1),vl[1].reshape(2,1),arrow=True)</span>
    <span class="c1"># plu.displot(vr[0].reshape(2,1),vr[1].reshape(2,1),arrow=True)</span>
    <span class="c1"># plt.legend()</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">inside</span><span class="p">)</span></div>






<div class="viewcode-block" id="Signatures"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures">[docs]</a><span class="k">class</span> <span class="nc">Signatures</span><span class="p">(</span><span class="n">PyLayers</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; set of Signature given 2 Gt cycle (convex) indices</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    L : gis.Layout</span>
<span class="sd">    source : int</span>
<span class="sd">        source convex cycle</span>
<span class="sd">    target : int</span>
<span class="sd">        target convex cycle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; object constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        dump : int </span>
<span class="sd">        source : int</span>
<span class="sd">            cycle number</span>
<span class="sd">        target : int</span>
<span class="sd">            cycle index</span>
<span class="sd">        cutoff : int</span>
<span class="sd">            limiting depth level in graph exploration (default 3)</span>

<span class="sd">        A signature ia a dict of arrays</span>

<span class="sd">        The array is an interleaving between nstr and type of interaction </span>
<span class="sd">        typeInt = 1,2,3 (extremity,diffraction,reflexion,transmission)</span>

<span class="sd">        Si[1]</span>
<span class="sd">        np.array([5,2,19,2,26,2,72,2]) </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.sig&#39;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">fun1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;----------&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1">#s = s + str(self.__sizeof__())+&#39;\n&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;from cycle : &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; to cycle &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ldump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ldump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ldump</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># nl x 2 x nsig</span>
            
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;),&#39;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                

        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nsig</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">nsig</span> <span class="o">+=</span> <span class="n">size</span>
        <span class="k">return</span><span class="p">(</span><span class="n">nsig</span><span class="p">)</span>

<div class="viewcode-block" id="Signatures.compl"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.compl">[docs]</a>    <span class="k">def</span> <span class="nf">compl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lint</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; completion from lint </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        lint : list </span>
<span class="sd">            list of interactions</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; Si.compl([(6220,3),(6262,3),(6241,3)],DL.L)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># all group of interactions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lint</span><span class="p">):</span>
                <span class="n">Si</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
                <span class="n">Ns</span><span class="p">,</span><span class="n">Nb</span> <span class="o">=</span> <span class="n">Si</span><span class="o">.</span><span class="n">shape</span>
                <span class="c1"># all signatures form a group of interactions</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                    <span class="c1"># all interactions</span>
                    <span class="n">b1</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">for</span> <span class="n">i1</span><span class="p">,</span><span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lint</span><span class="p">):</span> 
                        <span class="k">if</span> <span class="p">((</span><span class="n">Si</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="n">i1</span><span class="p">]</span> <span class="o">==</span> <span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> 
                           <span class="p">(</span><span class="n">Si</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i1</span><span class="p">]</span> <span class="o">==</span> <span class="n">it</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                            <span class="k">pass</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">b1</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="n">b1</span><span class="p">:</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="n">Si</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
                        <span class="n">sigi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig2inter</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39; :&#39;</span><span class="p">,</span><span class="n">sigi</span><span class="p">)</span></div>
                        <span class="c1"># all </span>

<div class="viewcode-block" id="Signatures.sig2inter"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.sig2inter">[docs]</a>    <span class="k">def</span> <span class="nf">sig2inter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">lsi</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39; convert signature to corresponding list of interactions in Gi</span>

<span class="sd">            Paramaters:</span>
<span class="sd">            ----------</span>

<span class="sd">            L : Layout</span>
<span class="sd">            lsi : nd.array </span>
<span class="sd">                signature (2xnb_sig,sig_length)</span>

<span class="sd">            Examples:</span>
<span class="sd">            ---------</span>

<span class="sd">            &gt;&gt;&gt; lsi = DL.Si[3]</span>
<span class="sd">            &gt;&gt;&gt; DL.Si.sig2inter(DL.L,lsi)</span>

<span class="sd">        &quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">assert</span> <span class="n">L</span><span class="o">.</span><span class="n">isbuilt</span><span class="p">,</span>  <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Layout is not built&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsi</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>   <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Incorrect signature(s) shape&#39;</span><span class="p">)</span>

        <span class="n">tlinter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">uu</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lsi</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>

            <span class="n">si</span> <span class="o">=</span> <span class="n">lsi</span><span class="p">[</span><span class="n">uu</span><span class="p">:</span><span class="n">uu</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>


            <span class="n">lsig</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">linter</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lsig</span><span class="p">):</span>
                <span class="c1"># nstr : seg or points</span>
                <span class="n">nstr</span> <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="n">typ</span>  <span class="o">=</span> <span class="n">si</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># cycles connected to seg or point</span>
                <span class="n">seg_cy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nstr</span><span class="p">][</span><span class="s1">&#39;ncycles&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
                    <span class="n">lcy0</span> <span class="o">=</span><span class="p">[</span><span class="n">cy0</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">typ</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">typ</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">cy0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">seg_cy</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lcy0</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cy1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seg_cy</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span> <span class="n">cy0</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="p">(</span><span class="n">lsig</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">cy1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>

                <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">nstr</span><span class="p">,)</span>
                    <span class="n">lcy0</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nstr</span><span class="p">][</span><span class="s1">&#39;ncycles&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">nstr</span><span class="p">,</span><span class="n">cy0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">inter</span> <span class="o">=</span> <span class="p">(</span><span class="n">nstr</span><span class="p">,</span><span class="n">cy0</span><span class="p">,</span><span class="n">cy1</span><span class="p">)</span>
                    <span class="c1"># changing cycle</span>
                    <span class="n">lcy0</span> <span class="o">=</span> <span class="p">[</span><span class="n">cy1</span><span class="p">]</span>
                <span class="n">linter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inter</span><span class="p">)</span>
            <span class="n">tlinter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linter</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tlinter</span><span class="o">=</span><span class="n">tlinter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tlinter</span></div>


<div class="viewcode-block" id="Signatures.sig2prob"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.sig2prob">[docs]</a>    <span class="k">def</span> <span class="nf">sig2prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">lsi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get signatures probability</span>
<span class="sd">            L : Layout</span>
<span class="sd">            lsi : nd.array </span>
<span class="sd">                signature (2xnb_sig,sig_length)</span>


<span class="sd">            Returns</span>
<span class="sd">            -------</span>

<span class="sd">            tlproba : list  (nb_sig,sig_length-2)</span>
<span class="sd">                output proba of each triplet of interaction</span>



<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">slsi</span> <span class="o">=</span> <span class="n">lsi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">L</span><span class="o">.</span><span class="n">isbuilt</span><span class="p">,</span>  <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Layout is not built&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="s1">&#39;Gi&#39;</span><span class="p">),</span>  <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Layout has not Gi Graph&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">L</span><span class="o">.</span><span class="n">Gi</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Gi Graph is empty&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsi</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>   <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Incorrect signature(s) shape&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">slsi</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Proba available for signature with at least 3 interacitons&#39;</span><span class="p">)</span>

        <span class="n">linter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig2inter</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">lsi</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">linter</span><span class="o">=</span><span class="p">[</span><span class="n">linter</span><span class="p">]</span>
        <span class="n">tlproba</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">linter</span><span class="p">:</span>
            <span class="n">lproba</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">slsi</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">proba</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gi</span><span class="p">[</span><span class="n">inter</span><span class="p">[</span><span class="n">k</span><span class="p">]][</span><span class="n">inter</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="n">inter</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">lproba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proba</span><span class="p">)</span>
            <span class="n">tlproba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lproba</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tlproba</span></div>


<div class="viewcode-block" id="Signatures.num"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.num">[docs]</a>    <span class="k">def</span> <span class="nf">num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine the number of signatures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsig</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nint</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsig</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nint</span> <span class="o">+=</span> <span class="n">size</span><span class="o">*</span><span class="n">k</span></div>

<div class="viewcode-block" id="Signatures.info"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print &quot;Signatures for scenario defined by :&quot;</span>
        <span class="c1"># print &quot;Layout&quot;</span>
        <span class="c1"># print &quot;======&quot;</span>
        <span class="c1"># L = self.L.info()</span>
        <span class="c1"># print &quot;================================&quot;</span>
        <span class="c1"># print &quot;source : &quot;, self.source</span>
        <span class="c1"># print &quot;target : &quot;, self.target</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;----------&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1">#s = s + str(self.__sizeof__())+&#39;\n&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">print</span> <span class="s1">&#39;from cycle : &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; to cycle &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="s1">&#39;Reflection&#39;</span><span class="p">,</span><span class="n">pyu</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;  &#39;</span>
        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="s1">&#39;Transmission&#39;</span><span class="p">,</span><span class="n">pyu</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;  &#39;</span>
        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="s1">&#39;Diffraction&#39;</span><span class="p">,</span><span class="n">pyu</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;  </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># nl x 2 x nsig</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>

                <span class="n">nstr</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>
                <span class="n">typ</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span>
                <span class="k">print</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nstr</span><span class="p">,</span><span class="n">typ</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">pyu</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">pyu</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">pyu</span><span class="o">.</span><span class="n">printout</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">pyu</span><span class="o">.</span><span class="n">RED</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;]&#39;</span>
            <span class="k">print</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>
                <span class="c1"># s = s + &#39;   &#39;+ str(a[i,0,:]) + &#39;\n&#39;</span>

                <span class="c1"># s = s + &#39;   &#39;+ str(a[i,1,:]) + &#39;\n&#39;</span>

<div class="viewcode-block" id="Signatures.check"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check signature</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        OK : np.array</span>
<span class="sd">        KO : np.array</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">OK</span> <span class="o">=</span> <span class="n">Signatures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="n">KO</span> <span class="o">=</span> <span class="n">Signatures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        
            <span class="n">sigs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigs</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">sigs</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>

                <span class="n">ok</span> <span class="o">=</span> <span class="n">valid</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span> <span class="p">:</span>
                    <span class="k">try</span> <span class="p">:</span>
                        <span class="n">OK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">OK</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">OK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">OK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">sig</span>
                        <span class="k">pass</span>
                <span class="k">else</span> <span class="p">:</span>

                    <span class="k">try</span> <span class="p">:</span>
                        <span class="n">KO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">KO</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">KO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">KO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">sig</span>
                        <span class="k">pass</span>
        <span class="k">return</span> <span class="n">OK</span><span class="p">,</span><span class="n">KO</span></div>

<div class="viewcode-block" id="Signatures.saveh5"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.saveh5">[docs]</a>    <span class="k">def</span> <span class="nf">saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save signatures in hdf5 format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRSIG&#39;</span><span class="p">])</span>
        <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">_filename</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Signature: issue when writting h5py file&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signatures.loadh5"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.loadh5">[docs]</a>    <span class="k">def</span> <span class="nf">loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; load signatures hdf5 format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRSIG&#39;</span><span class="p">])</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][:]})</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Signature: issue when reading h5py file&#39;</span><span class="p">)</span>


        <span class="n">_fileL</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getshort</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ini&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">layout</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">_fileL</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpr</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpw</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_saveh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save in hdf5 compliant with Links</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5</span>
<span class="sd">        hrpname</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="c1"># if grpname == &#39;&#39;:</span>
        <span class="c1">#     grpname = str(self.source) +&#39;_&#39;+str(self.target) +&#39;_&#39;+ str(self.cutoff)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># file management</span>
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">grpname</span> <span class="ow">in</span> <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">grpname</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;sig/&#39;</span><span class="o">+</span><span class="n">grpname</span> <span class="o">+</span><span class="s1">&#39;already exists in &#39;</span><span class="o">+</span><span class="n">filenameh5</span><span class="p">)</span>
            <span class="n">f</span><span class="o">=</span><span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;sig/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="c1"># write data</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">_filename</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;ratio&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;sig&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Signature: issue when writting h5py file&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_loadh5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">grpname</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load signatures in hdf5 format compliant with class Links</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filenameh5 : string</span>
<span class="sd">            filename of the h5py file (from Links Class)</span>
<span class="sd">        grpname : string</span>
<span class="sd">            groupname of the h5py file (from Links Class)</span>

<span class="sd">        kwargs </span>
<span class="sd">            may contain a L: layout object</span>
<span class="sd">            if L =  [] the layout is loaded from the layout name stored</span>
<span class="sd">            into the h5 file</span>
<span class="sd">            if L = Layout the layout passed in arg is used</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.simul.links</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">filenameh5</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRLNK&#39;</span><span class="p">])</span>
        <span class="c1"># if grpname ==&#39;&#39;:</span>
        <span class="c1">#     grpname = str(self.source) +&#39;_&#39;+str(self.target) +&#39;_&#39;+ str(self.cutoff)</span>

        <span class="c1"># try/except to avoid loosing the h5 file if</span>
        <span class="c1"># read/write error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">=</span><span class="n">fh5</span><span class="p">[</span><span class="s1">&#39;sig/&#39;</span><span class="o">+</span><span class="n">grpname</span><span class="p">]</span>

            <span class="c1"># compliant with new h5 format:</span>
            <span class="k">if</span> <span class="s1">&#39;sig&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;sig&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:]})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][:]})</span>
            <span class="c1"># old h5 format</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">][:]})</span>
            <span class="n">Lname</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>
            <span class="c1"># ensure backward compatibility</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find threshold</span>
                <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> 
                                 <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">th</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fh5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Signature: issue when reading h5py file&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">layout</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">Lname</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpr</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpw</span><span class="p">()</span>


<div class="viewcode-block" id="Signatures.save"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save signatures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRSIG&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
          <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">L</span></div>

<div class="viewcode-block" id="Signatures.load"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; load signatures</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">filename</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span><span class="n">pstruc</span><span class="p">[</span><span class="s1">&#39;DIRSIG&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">sitmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span><span class="s1">&#39; does not exist&#39;</span><span class="p">)</span>


        <span class="c1"># to load a dictionary, use update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sitmp</span><span class="p">)</span>


        <span class="n">_fileL</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">getshort</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.ini&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">=</span><span class="n">layout</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">_fileL</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpr</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">dumpw</span><span class="p">()</span></div>

<div class="viewcode-block" id="Signatures.sp"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.sp">[docs]</a>    <span class="k">def</span> <span class="nf">sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; algorithm for signature determination</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        G : Graph</span>
<span class="sd">        source : tuple or int</span>
<span class="sd">        target : tuple or int</span>
<span class="sd">        cutoff : int</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.antprop.signature.run3</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">source</span><span class="p">])]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">source</span><span class="p">])):</span>
                        <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">visited</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

                    <span class="c1"># yield visited +[target]</span>
                <span class="k">elif</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">child</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#len(visited) == cutoff:</span>
                <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">source</span><span class="p">])):</span>
                        <span class="n">s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">visited</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>





<div class="viewcode-block" id="Signatures.calsig"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.calsig">[docs]</a>    <span class="k">def</span> <span class="nf">calsig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">dia</span><span class="o">=</span><span class="p">{},</span><span class="n">cutoff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculates signature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        G   : graph</span>
<span class="sd">        dia : dictionnary of interactions</span>
<span class="sd">        cutoff : integer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">di</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dia</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;Tx&#39;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;Rx&#39;</span>
        <span class="n">d</span><span class="o">=</span><span class="p">{}</span>

        <span class="n">visited</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">source</span><span class="p">])]</span>

        <span class="n">out</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
<span class="c1">#            pdb.set_trace()</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                    <span class="n">lot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lot</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lot</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
<span class="c1">#                    yield visited + [target]</span>
                <span class="k">elif</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">di</span><span class="p">[</span><span class="n">child</span><span class="p">])</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">child</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#len(visited) == cutoff:</span>
                <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
<span class="c1">#                    yield visited + [target]</span>
                    <span class="n">lot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lot</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">lot</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="n">lot</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">out</span><span class="p">)})</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Signatures.exist"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.exist">[docs]</a>    <span class="k">def</span> <span class="nf">exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; verifies if seq exists in signatures</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        seq : list of tuple </span>
<span class="sd">               [(2,2),(5,3),(7,2)]</span>
<span class="sd">        </span>
<span class="sd">        1 : Diffraction </span>
<span class="sd">        2 : Reflexion</span>
<span class="sd">        3 : Diffraction </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; DL=DLink()</span>
<span class="sd">        &gt;&gt;&gt; DL.eval()</span>
<span class="sd">        &gt;&gt;&gt; seq = [(2,3)] # transmission through segment 2 </span>
<span class="sd">        &gt;&gt;&gt; DL.Si.exist(seq)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Number of interactions </span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="c1"># signatures with N interaction</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
        <span class="c1"># Number signature with N interaction</span>
        <span class="n">Nsig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">nstr</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[::</span><span class="mi">2</span><span class="p">,:]</span>
        <span class="n">typ</span>  <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span>
        <span class="c1"># List of signat</span>
        <span class="n">lsig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nsig</span><span class="p">):</span>
            <span class="n">lint</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
                <span class="n">lint</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nstr</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">],</span><span class="n">typ</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]))</span>
            <span class="n">lsig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lint</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">lsig</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="Signatures.run"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; evaluate signatures between cycle of tx and cycle of rx</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        cutoff : int</span>
<span class="sd">            limit the exploration of all_simple_path</span>
<span class="sd">        bt : boolean</span>
<span class="sd">            backtrace (allow to visit already visited nodes in simple path algorithm)</span>
<span class="sd">        progress : boolean</span>
<span class="sd">            display the time passed in the loop</span>
<span class="sd">        diffraction : boolean </span>
<span class="sd">            activate diffraction </span>
<span class="sd">        threshold : float </span>
<span class="sd">            for reducing calculation time</span>
<span class="sd">        animations :  boolean </span>
<span class="sd">        nD : int </span>
<span class="sd">            maximum number of diffraction </span>
<span class="sd">        nR : int </span>
<span class="sd">            maximum number of reflection  </span>
<span class="sd">        nT : int </span>
<span class="sd">            maximum number of transmission   </span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.simul.link.Dlink.eval</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cutoff&#39;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
                    <span class="s1">&#39;threshold&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">&#39;delay_excess_max_ns&#39;</span><span class="p">:</span><span class="mi">400</span><span class="p">,</span>
                    <span class="s1">&#39;nD&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;nR&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;nT&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;bt&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;diffraction&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;animation&#39;</span> <span class="p">:</span> <span class="bp">False</span>
                    <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span>

        <span class="n">nD</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nD&#39;</span><span class="p">]</span>
        <span class="n">nT</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nT&#39;</span><span class="p">]</span>
        <span class="n">nR</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nR&#39;</span><span class="p">]</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bt&#39;</span><span class="p">]</span> 
        <span class="n">progress</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> 
        <span class="n">diffraction</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diffraction&#39;</span><span class="p">]</span>
        <span class="n">animation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;animation&#39;</span><span class="p">]</span> 
        <span class="n">delay_excess_max_ns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;delay_excess_max_ns&#39;</span><span class="p">]</span>
        <span class="n">dist_excess_max</span> <span class="o">=</span> <span class="n">delay_excess_max_ns</span><span class="o">*</span><span class="mf">0.3</span>
        


        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.sig&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># AIR : editable AIR separation </span>
        <span class="c1"># _AIR : constructed AIR separation </span>
        <span class="c1">#</span>
        <span class="n">lair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="s1">&#39;AIR&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="s1">&#39;_AIR&#39;</span><span class="p">]</span>

        <span class="c1"># list of interactions visible from source</span>
        <span class="n">lisR</span><span class="p">,</span><span class="n">lisT</span><span class="p">,</span><span class="n">lisD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">intercy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diffraction</span><span class="p">:</span>
            <span class="n">lis</span>  <span class="o">=</span> <span class="n">lisT</span> <span class="o">+</span> <span class="n">lisR</span> <span class="o">+</span> <span class="n">lisD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lis</span>  <span class="o">=</span> <span class="n">lisT</span> <span class="o">+</span> <span class="n">lisR</span>

        <span class="c1"># list of interactions visible from target</span>
        <span class="n">litR</span><span class="p">,</span><span class="n">litT</span><span class="p">,</span><span class="n">litD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">intercy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">diffraction</span><span class="p">:</span>
           <span class="n">lit</span>  <span class="o">=</span> <span class="n">litT</span> <span class="o">+</span> <span class="n">litR</span> <span class="o">+</span> <span class="n">litD</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">lit</span>  <span class="o">=</span> <span class="n">litT</span> <span class="o">+</span> <span class="n">litR</span>

        <span class="n">pt_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">pt_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">d_source_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pt_source</span> <span class="o">-</span> <span class="n">pt_target</span><span class="p">)</span>
        
        <span class="c1">#print &quot;source,lis :&quot;,self.source,lis</span>
        <span class="c1">#print &quot;target,lit :&quot;,self.target,lit</span>
        <span class="c1"># for u in lit: </span>
        <span class="c1">#     print u</span>
        <span class="c1"># print &quot;-------------&quot;</span>

        <span class="n">Gi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gi</span>
        <span class="n">Gi</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span>
        <span class="c1">#</span>
        <span class="c1"># remove diffractions from Gi</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diffraction</span><span class="p">:</span>
            <span class="n">Gi</span> <span class="o">=</span> <span class="n">gidl</span><span class="p">(</span><span class="n">Gi</span><span class="p">)</span>

        <span class="c1"># initialize dout dictionnary</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># progresss stuff...</span>
        <span class="n">lmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lis</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tic0</span> <span class="o">=</span> <span class="n">tic</span>
        <span class="c1">#for interaction source  in list of source interactions</span>

        <span class="n">bvisu</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># signature counter</span>
        <span class="n">cptsig</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">animation</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">aw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;ob&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Loop over all interactions seen from the source</span>
        <span class="c1">#</span>
        <span class="c1"># us : loop counter</span>
        <span class="c1"># s  : interaction tuple</span>
        <span class="c1"># s[0] : point (&lt;0) or segment (&gt;0)a</span>
        <span class="c1"># pts : list of neighbour nodes from s[0]</span>
        <span class="c1"># tahe : segment extremities or point coordinates (repeated twice)</span>
        <span class="n">lhash</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">progress</span> <span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Signatures&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">us</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lis</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">progress</span><span class="p">:</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mf">100.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lis</span><span class="p">)))</span>

            <span class="c1"># start from a segment     </span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])]</span>
            <span class="c1"># start from a point </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])]</span>

            <span class="c1"># R is a list which contains reflexion matrices (Sn) and translation matrices(vn)</span>
            <span class="c1"># for interaction mirroring </span>
            <span class="c1"># R=[[S0,v0],[S1,v1],...]</span>

            <span class="n">R</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))]</span>
            
            <span class="c1"># initialize visited list sequence with the first intercation s</span>

            <span class="n">visited</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
           
            <span class="c1"># if </span>
            <span class="c1">#   + s is in target interaction list </span>
            <span class="c1"># or</span>
            <span class="c1">#   + arrival cycle is equal to target cycle</span>
            <span class="c1"># then stack a new signature in self[len(typ)] </span>
            <span class="c1"># </span>
            <span class="c1"># TODO : It concerns self[1] : only one interaction (i.e several single reflection or diffraction)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">lit</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
                <span class="n">anstr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">visited</span><span class="p">))</span>
                <span class="n">typ</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">visited</span><span class="p">))</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)],</span><span class="n">anstr</span><span class="p">,</span><span class="n">typ</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)],</span><span class="mf">1.</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">anstr</span><span class="p">,</span><span class="n">typ</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">])</span>
                <span class="c1"># update signature counter</span>
                <span class="n">cptsig</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="c1"># stack is a list of iterators</span>
            <span class="c1">#</span>
            <span class="c1">#</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">Gi</span><span class="p">[</span><span class="n">s</span><span class="p">])]</span>
            <span class="c1"># air walls do not intervene in the number of transmission (cutoff criteria) </span>
            <span class="c1"># lawp is the list of airwall position in visited sequence</span>
            <span class="c1"># handle the case of the first segment which can be an airwall</span>
            <span class="c1"># </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">nseg</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nseg</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;_AIR&#39;</span><span class="p">)</span> <span class="ow">or</span> 
                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">nseg</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;AIR&#39;</span><span class="p">)):</span>
                    <span class="n">lawp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lawp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lawp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># while the stack of iterators is not void</span>
            <span class="n">cpt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">stack</span><span class="p">:</span> <span class="c1">#</span>
                <span class="c1"># iter_on_interactions is the last iterator in the stack</span>
                <span class="n">iter_on_interactions</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># next interaction child</span>
                <span class="n">interaction</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iter_on_interactions</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="c1">#print visited</span>
                <span class="c1">#if ((visited ==[(6236,74,91),(-213,)]) and (interaction==(-1002,))):</span>
                <span class="c1">#    print interaction </span>
                <span class="c1">#    pdb.set_trace()</span>
                <span class="c1">#if (visited ==[(6236,74,91),(-213,),(6248,99,111)]):</span>
                <span class="c1">#if (visited ==[(6236,74,91),(-213,),(6248,99,111),(6287,111,118)]):</span>
                    <span class="c1">#pdb.set_trace()</span>
                <span class="c1">#    import ipdb</span>
                <span class="c1"># cond1 : there is no more interactions</span>
                <span class="c1"># continue if True</span>
                <span class="n">cond1</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="n">interaction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
                <span class="c1"># cond2 : enable reverberation</span>
                <span class="c1">#     interaction has not been visited yet </span>
                <span class="c1">#     or </span>
                <span class="c1">#     bt : True (allow reentrance) (unconditionnaly)  </span>
                <span class="c1"># continue if True</span>
                <span class="c1">#cond2 = (interaction in visited) and bt (old) </span>
                <span class="n">cond2</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">interaction</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bt</span>
                <span class="c1"># cond3 : test the cutoff condition not get to the limit</span>
                <span class="c1"># continue if True</span>
                <span class="n">cond3</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lawp</span><span class="p">)))</span>
                <span class="n">uD</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span> <span class="p">]</span>
                <span class="n">uR</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span> <span class="p">]</span>
                <span class="n">uT</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span><span class="mi">3</span> <span class="p">]</span>
                <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span>
                    <span class="n">condD</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">condR</span> <span class="o">=</span> <span class="bp">True</span> 
                    <span class="n">condT</span> <span class="o">=</span> <span class="bp">True</span> 
                    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uD</span><span class="p">)</span><span class="o">==</span><span class="n">nD</span><span class="p">)):</span>
                        <span class="n">condD</span> <span class="o">=</span> <span class="bp">False</span> 
                    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uR</span><span class="p">)</span><span class="o">==</span><span class="n">nR</span><span class="p">)):</span>
                        <span class="n">condR</span> <span class="o">=</span> <span class="bp">False</span> 
                    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uT</span><span class="p">)</span><span class="o">==</span><span class="n">nT</span><span class="p">)):</span>
                        <span class="n">condT</span> <span class="o">=</span> <span class="bp">False</span> 

                <span class="c1">#</span>
                <span class="c1">#  animation </span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="n">animation</span> <span class="p">:</span>
                    <span class="n">cpt</span> <span class="o">=</span> <span class="n">cpt</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">edge</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">visited</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">visited</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gi</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                            <span class="n">nodelist</span><span class="o">=</span><span class="n">visited</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">node_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gi</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                            <span class="n">edgelist</span><span class="o">=</span><span class="n">edge</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="p">{},</span><span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">arrows</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./figure/&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">us</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpt</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span> <span class="ow">and</span> <span class="n">cond3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">condD</span> <span class="ow">and</span> <span class="n">condR</span> <span class="ow">and</span> <span class="n">condT</span><span class="p">):</span>
                        <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cpt</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="c1">#print(visited)</span>
                        <span class="c1"># [(44,2,7),(62,7,15),(21,15),(62,15,7),(44,7,2),(16,2)]</span>
                        <span class="c1"># if visited ==[(6236,74,91),(141,91)]:</span>
                        <span class="c1">#     import ipdb</span>
                        <span class="c1">#     ipdb.set_trace()</span>


                        <span class="c1"># update list of airwalls</span>
                        <span class="k">if</span> <span class="n">interaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lair</span><span class="p">:</span>
                            <span class="n">lawp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lawp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># update number of useful segments</span>
                        <span class="c1"># if there is airwall in visited</span>
                        <span class="n">nstr</span> <span class="o">=</span> <span class="n">interaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1">#</span>
                        <span class="c1">#</span>
                        <span class="c1">#</span>
                        <span class="c1"># Testing the type of interaction at rank -2 </span>
                        <span class="c1"># R is a list which contains a rotation matrix </span>
                        <span class="c1"># and a translation vector for doing the mirroring </span>
                        <span class="c1"># operation</span>

                        <span class="c1"># diffraction (retrieve a point)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1">#th = self.L.Gs.pos[nstr]</span>
                            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># </span>
                            <span class="c1"># l&#39;avant dernier point est une reflection </span>
                            <span class="c1">#</span>
                            <span class="n">nseg_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">[</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">ta_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                            <span class="n">he_seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="c1">#</span>
                            <span class="c1"># get reflection matrix from segment visited[-2]  </span>
                            <span class="c1">#</span>
                            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geu</span><span class="o">.</span><span class="n">axmat</span><span class="p">(</span><span class="n">ta_seg</span><span class="p">,</span><span class="n">he_seg</span><span class="p">))</span>
                            <span class="c1"># direct order</span>
                            <span class="c1">#R.append(geu.axmat(tahe[-1][0],tahe[-1][1]))</span>
                        <span class="c1"># transmission do nothing </span>
                        <span class="k">else</span> <span class="p">:</span> 
                            <span class="k">pass</span>
                        <span class="c1"># current interaction is of segment type</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">nstr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                            <span class="n">nseg_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">[</span><span class="n">nstr</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nstr</span><span class="p">]</span>
                            <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">th</span><span class="p">,</span><span class="n">th</span><span class="p">])</span>

                        <span class="c1"># current interaction is of point type (diffraction)</span>
                        <span class="c1"># apply current chain of symmetries</span>
                        <span class="c1">#</span>
                        <span class="c1"># th   is the current segment tail-head coordinates</span>
                        <span class="c1"># tahe is a list of well mirrored tail-head coordinates</span>
                        
                            <span class="c1">#tahe.append(a)</span>
                        <span class="c1">#if ((visited[0]==(104,23,17)) and (visited[1]==(1,17))):</span>
                        <span class="c1">#    print(&quot;th (avant mirror)&quot;,th)</span>
                        <span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="n">ik</span><span class="p">]</span>
                        <span class="c1">#</span>
                        <span class="c1"># dtarget :  distance between th and target</span>
                        <span class="c1">#</span>
                        <span class="n">pt_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">d_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pt_target</span><span class="o">-</span><span class="n">pt_th</span><span class="p">)</span>
                        
                        <span class="c1">#</span>
                        <span class="c1"># mirroring th until the previous point  </span>
                        <span class="c1"># </span>
                        <span class="n">th_mirror</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>     
                            <span class="n">th_mirror</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ki,ij-&gt;kj&#39;</span><span class="p">,</span><span class="n">th_mirror</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">ik</span> <span class="o">=</span> <span class="n">ik</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">r</span>  <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="n">ik</span><span class="p">]</span>

                        <span class="n">pt_mirror</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">d_source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pt_source</span><span class="o">-</span><span class="n">pt_mirror</span><span class="p">)</span>
                        <span class="n">d_excess</span> <span class="o">=</span> <span class="n">d_source</span> <span class="o">+</span> <span class="n">d_target</span> <span class="o">-</span> <span class="n">d_source_target</span>
                        <span class="c1"># if at least 2 interactions</span>
                        <span class="c1"># or previous point is a diffraction </span>

                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.0</span>
                            <span class="n">ratio2</span> <span class="o">=</span> <span class="mf">1.0</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Determine the origin of the cone </span>
                            <span class="c1"># either the transmitter (ilast =0) </span>
                            <span class="c1"># or the last diffraction point (ilast=udiff[-1] ) </span>
                            <span class="n">udiff</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span> <span class="p">]</span>
                            <span class="k">if</span> <span class="n">udiff</span><span class="o">==</span><span class="p">[]:</span>
                                <span class="n">ilast</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ilast</span><span class="o">=</span><span class="n">udiff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                            <span class="n">pta0</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[</span><span class="n">ilast</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># tail first segment  (last difraction)</span>
                            <span class="n">phe0</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[</span><span class="n">ilast</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># head first segment</span>

                            <span class="c1">#</span>
                            <span class="c1"># TODO : it would be better to replace pta_ and phe_ with the intersection </span>
                            <span class="c1"># of the previous cone with tahe[-1]</span>
                            <span class="c1">#</span>
                            <span class="n">pta_</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># tail last segment</span>
                            <span class="n">phe_</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># head last segment </span>

                            <span class="c1">#</span>
                            <span class="c1"># Calculates the left and right vector of the cone </span>
                            <span class="c1">#</span>
                            <span class="c1">#  vl left vector </span>
                            <span class="c1">#  vr right vector </span>
                            <span class="c1">#</span>
                            <span class="c1">#</span>
                            <span class="c1"># Detect situations of connected segments</span>
                            <span class="c1">#</span>
                            <span class="c1"># [(60, 2, 8), (61, 8, 11), (15, 11), (61, 11, 8), (60 ,8, 2), (44, 2, 7)]</span>
                            <span class="c1"># if visited == [(60, 2, 8), (61, 8, 11), (15, 11), (61, 11, 8), (60 ,8, 2), (44, 2, 7)]:</span>
                            <span class="c1">#     print &#39;\n&#39;,visited</span>
                            <span class="c1">#     import ipdb</span>
                            <span class="c1">#     ipdb.set_trace()</span>

                            <span class="n">connected</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">pta0</span><span class="o">==</span><span class="n">pta_</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">apex</span> <span class="o">=</span> <span class="n">pta0</span>
                                <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">v0</span><span class="o">=</span><span class="n">phe0</span><span class="o">-</span><span class="n">apex</span>
                                <span class="n">v_</span><span class="o">=</span><span class="n">phe_</span><span class="o">-</span><span class="n">apex</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">pta0</span><span class="o">==</span><span class="n">phe_</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">apex</span> <span class="o">=</span> <span class="n">pta0</span>
                                <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">v0</span><span class="o">=</span><span class="n">phe0</span><span class="o">-</span><span class="n">apex</span>
                                <span class="n">v_</span><span class="o">=</span><span class="n">pta_</span><span class="o">-</span><span class="n">apex</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">phe0</span><span class="o">==</span><span class="n">pta_</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">apex</span> <span class="o">=</span> <span class="n">phe0</span>
                                <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">v0</span><span class="o">=</span><span class="n">pta0</span><span class="o">-</span><span class="n">apex</span>
                                <span class="n">v_</span><span class="o">=</span><span class="n">phe_</span><span class="o">-</span><span class="n">apex</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">phe0</span><span class="o">==</span><span class="n">phe_</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="n">apex</span> <span class="o">=</span> <span class="n">phe0</span>    
                                <span class="n">connected</span> <span class="o">=</span> <span class="bp">True</span>
                                <span class="n">v0</span><span class="o">=</span><span class="n">pta0</span><span class="o">-</span><span class="n">apex</span>
                                <span class="n">v_</span><span class="o">=</span><span class="n">pta_</span><span class="o">-</span><span class="n">apex</span>

                            <span class="c1">#</span>
                            <span class="c1"># Does the cone is built from 2 connected segments or </span>
                            <span class="c1"># 2 unconnected segments</span>
                            <span class="c1">#     </span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">pta0</span><span class="p">,</span><span class="n">phe0</span><span class="p">,</span><span class="n">phe_</span><span class="p">)</span> <span class="o">^</span>
                                        <span class="n">geu</span><span class="o">.</span><span class="n">ccw</span><span class="p">(</span><span class="n">phe0</span><span class="p">,</span><span class="n">phe_</span><span class="p">,</span><span class="n">pta_</span><span class="p">)</span> <span class="p">):</span>
                                    <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pta0</span><span class="p">,</span><span class="n">phe_</span><span class="p">)</span>
                                    <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phe0</span><span class="p">,</span><span class="n">pta_</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>  <span class="c1"># twisted case</span>
                                    <span class="n">vr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pta0</span><span class="p">,</span><span class="n">pta_</span><span class="p">)</span>
                                    <span class="n">vl</span> <span class="o">=</span> <span class="p">(</span><span class="n">phe0</span><span class="p">,</span><span class="n">phe_</span><span class="p">)</span>

                                <span class="c1"># cone dot product </span>
                                <span class="c1"># print vr</span>
                                <span class="c1"># print vl</span>
                                <span class="n">vr_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">vl_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                
                            
                                <span class="n">vrdotvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vr_n</span><span class="p">,</span><span class="n">vl_n</span><span class="p">)</span>
                                <span class="c1"># cone angle </span>
                                <span class="n">angle_cone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">vrdotvl</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
                                <span class="c1">#angle_cone = np.arccos(vrdotvl)</span>
                                <span class="c1"># prepare lines and seg argument for intersection checking</span>
                                <span class="k">if</span> <span class="n">angle_cone</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                                    <span class="n">linel</span> <span class="o">=</span> <span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">liner</span> <span class="o">=</span> <span class="p">(</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="c1"># from origin mirrored segment to be tested </span>
                                    <span class="n">seg</span>   <span class="o">=</span> <span class="p">(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                                    <span class="c1"># apex calculation </span>
                                    <span class="n">a0u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pta0</span><span class="p">,</span><span class="n">vr_n</span><span class="p">)</span>
                                    <span class="n">a0v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pta0</span><span class="p">,</span><span class="n">vl_n</span><span class="p">)</span>
                                    <span class="n">b0u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">phe0</span><span class="p">,</span><span class="n">vr_n</span><span class="p">)</span>
                                    <span class="n">b0v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">phe0</span><span class="p">,</span><span class="n">vl_n</span><span class="p">)</span>
                                    <span class="c1">#import warnings</span>
                                    <span class="c1">#warnings.filterwarnings(&quot;error&quot;)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">kb</span>  <span class="o">=</span> <span class="p">((</span><span class="n">b0v</span><span class="o">-</span><span class="n">a0v</span><span class="p">)</span><span class="o">-</span><span class="n">vrdotvl</span><span class="o">*</span><span class="p">(</span><span class="n">b0u</span><span class="o">-</span><span class="n">a0u</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">vrdotvl</span><span class="o">*</span><span class="n">vrdotvl</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                                    <span class="n">apex</span> <span class="o">=</span> <span class="n">phe0</span> <span class="o">+</span> <span class="n">kb</span><span class="o">*</span><span class="n">vl_n</span>

        

                            <span class="k">else</span><span class="p">:</span> <span class="c1"># cone from connected segments </span>

                                <span class="n">v0n</span>  <span class="o">=</span> <span class="n">v0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
                                <span class="n">v_n</span>  <span class="o">=</span> <span class="n">v_</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_</span><span class="p">)</span>

                                <span class="c1"># import ipdb</span>
                                <span class="c1"># ipdb.set_trace()</span>
                                <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_n</span><span class="p">,</span><span class="n">v0n</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">sign</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>    
                                    <span class="n">vr_n</span> <span class="o">=</span> <span class="o">-</span><span class="n">v0n</span>
                                    <span class="n">vl_n</span> <span class="o">=</span> <span class="n">v_n</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">vr_n</span> <span class="o">=</span> <span class="n">v_n</span>
                                    <span class="n">vl_n</span> <span class="o">=</span> <span class="o">-</span><span class="n">v0n</span>
                               
                                <span class="n">vrdotvl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vr_n</span><span class="p">,</span><span class="n">vl_n</span><span class="p">)</span>
                                <span class="c1"># cone angle </span>
                                <span class="n">angle_cone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">vrdotvl</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
                           
                        
                            <span class="c1">#   </span>
                            <span class="c1"># the illuminating cone is defined</span>
                            <span class="c1"># the th_mirror to be tested with this cone are known </span>
                            <span class="c1"># </span>
                            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">angle_cone</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
                             <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">angle_cone</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="p">)</span> <span class="p">:</span> 
                                <span class="n">seg</span><span class="p">,</span><span class="n">ratio2</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">intersect_cone_seg</span><span class="p">((</span><span class="n">apex</span><span class="p">,</span><span class="n">vl_n</span><span class="p">),(</span><span class="n">apex</span><span class="p">,</span><span class="n">vr_n</span><span class="p">),(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">bvis</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="p">(</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">angle_cone</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
                                <span class="n">ratio2</span> <span class="o">=</span> <span class="mi">1</span>           
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ratio2</span> <span class="o">=</span> <span class="mi">0</span> 
                            <span class="c1">#print ratio</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">th_mirror</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">al</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vl_n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vl_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vr_n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vr_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">apex</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">apex</span><span class="p">):</span>
                                <span class="n">ratio2</span> <span class="o">=</span> <span class="mf">1.</span>
                            
                            <span class="c1"># On connecte l&#39;apex du cone courant aux extrémités du segment courant mirroré</span>
                            
                            <span class="c1"># Dans certaines circonstances par example un cone emanant d&#39;un point colinéaire </span>
                            <span class="c1"># avec le segment d&#39;arrivé&quot; (-4) (6,4) le point -4 est aligné avec le segment 6</span>
                            <span class="c1"># l&#39;ouverture du cone est nul =&gt; arret. Cela pourrait être géré dans Gi en interdisant </span>
                            <span class="c1"># la visibilité (-4) (6,4) </span>
                            
                            <span class="k">if</span> <span class="n">angle_cone</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">ratio</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>    
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">apex</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">apex</span><span class="p">):</span>
                                    <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">wseg0</span> <span class="o">=</span> <span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">apex</span>
                                    <span class="n">wseg1</span> <span class="o">=</span> <span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">apex</span>
                                    <span class="n">mod_wseg0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wseg0</span><span class="o">*</span><span class="n">wseg0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                                    <span class="n">mod_wseg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wseg1</span><span class="o">*</span><span class="n">wseg1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mod_wseg0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                                        <span class="c1">#bvisu = True </span>
                                        <span class="c1">#pdb.set_trace()#</span>
                                        <span class="k">pass</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mod_wseg1</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                                        <span class="c1">#bvisu = True </span>
                                        <span class="c1">#pdb.set_trace()#</span>
                                        <span class="k">pass</span>
                                    <span class="c1">#wseg0_n = wseg0/mod_wseg0</span>
                                    <span class="c1">#wseg1_n = wseg1/mod_wseg1</span>
                                    <span class="n">wseg0_n</span> <span class="o">=</span> <span class="n">wseg0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wseg0</span><span class="p">)</span>
                                    <span class="n">wseg1_n</span> <span class="o">=</span> <span class="n">wseg1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wseg1</span><span class="p">)</span>
                                    <span class="n">aseg0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">wseg0_n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">wseg0_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">aseg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">wseg1_n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">wseg1_n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    
                                    <span class="c1"># if al==aseg0 or al==aseg1 or ar==aseg0 or ar==aseg1:</span>
                                    <span class="c1">#     ratio = 1</span>
                                        <span class="c1">#print &quot;toto&quot;</span>
                                    <span class="c1"># else:</span>
                                    <span class="n">I</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">angle_intersection2</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="n">ar</span><span class="p">,</span><span class="n">aseg0</span><span class="p">,</span><span class="n">aseg1</span><span class="p">)</span>
                                    <span class="n">ratio</span> <span class="o">=</span> <span class="n">I</span><span class="o">/</span><span class="n">angle_cone</span>
                                    <span class="c1">#if ratio&gt;=1:</span>
                                    <span class="c1">#    pdb.set_trace()</span>

                                <span class="c1"># if connected:</span>
                                <span class="c1">#     print &quot;ratio :&quot;,ratio</span>
                                

                            <span class="c1">#if visited == [(104, 23, 17), (1, 17), (53, 17)]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">bvisu</span><span class="p">):</span>
                                <span class="n">fig</span> <span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">aw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                <span class="c1">#</span>
                                <span class="c1"># magenta : start of the cone</span>
                                <span class="c1"># cyan    :</span>
                                <span class="c1"># yellow  : last interaction</span>
                                <span class="c1">#</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">pta0</span><span class="p">,</span><span class="n">phe0</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">pta_</span><span class="p">,</span><span class="n">phe_</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                                <span class="c1"># ax = geu.linet(ax,vr[0],vr[1],al=1,color=&#39;red&#39;,linewidth=3)</span>
                                <span class="c1"># ax = geu.linet(ax,vl[0],vl[1],al=1,color=&#39;blue&#39;,linewidth=3)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">th_mirror</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gi</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">},</span>
                                        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">apex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">apex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                            <span class="c1">#if visited == [(104, 23, 17), (1, 17), (53, 17), (108, 17, 18)]:</span>
                            <span class="c1"># if visited == [(104, 23, 17), (1, 17), (53, 17)]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                                <span class="n">fig</span> <span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">aw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">pta0</span><span class="p">,</span><span class="n">phe0</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">pta_</span><span class="p">,</span><span class="n">phe_</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">vr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="c1">#ax = geu.linet(ax,seg[0],seg[1],al=1,color=&#39;k&#39;,linewidth=3)</span>
                                <span class="n">ax</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">th</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">th</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">apex</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">apex</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="c1">#else:</span>
                    <span class="c1">#    th = self.L.Gs.pos[nstr]</span>
                    <span class="c1">#    th = np.array([th,th])</span>
                    <span class="c1">#    ratio = 1</span>
                        <span class="c1">#print self.cpt,ratio,ratio2</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ratio2</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                             <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                        <span class="c1">#print d_excess,dist_excess_max</span>
                        <span class="c1">#if (ratio2 &gt; self.threshold) and (d_excess&lt;dist_excess_max):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">d_excess</span><span class="o">&lt;</span><span class="n">dist_excess_max</span><span class="p">):</span>
                        <span class="c1">#if (ratio &gt; self.threshold):</span>
                            <span class="c1">#</span>
                            <span class="c1"># Update sequence of mirrored points</span>
                            <span class="c1">#</span>
                            <span class="k">if</span> <span class="n">nstr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">tahe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">tahe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th_mirror</span><span class="p">)</span>
                            
                            <span class="c1"># </span>
                            <span class="c1"># Check if the target has been reached</span>
                            <span class="c1"># sequence is valid and last interaction is in the list of targets   </span>
                            <span class="c1">#if (interaction in lit) or (interaction[-1]==self.target):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">interaction</span> <span class="ow">in</span> <span class="n">lit</span><span class="p">):</span>
                                <span class="c1"># idea here is to produce signature without any airwalls</span>
                                <span class="c1"># lawp_tmp is a mask where 0 mean no air wall and 1 = airwall</span>
                                <span class="c1"># anstr does not contains airwalls</span>
                                <span class="c1"># lawp_tmp = [0]+lawp</span>
                                <span class="c1"># lll = [x[0] for ix,x in enumerate(visited) if lawp_tmp[ix]==1]</span>
                                <span class="c1"># print([self.L.Gs.node[x][&#39;name&#39;] for x in lll])</span>
                            
                                <span class="c1">#anstr = np.array([x[0] for ix,x in enumerate(visited) </span>
                                <span class="c1">#                                  if ((lawp[ix]!=1) or (x[0] in self.L.name[&#39;AIR&#39;]) or (x in (lit+lis)))] )</span>
                                <span class="c1">#typ  = np.array([len(x) for ix,x in enumerate(visited) </span>
                                <span class="c1">#                                  if ((lawp[ix]!=1) or (x[0] in self.L.name[&#39;AIR&#39;]) or (x in (lit+lis)))] )</span>
                                <span class="c1">#sig = np.array([anstr,typ])</span>
                                <span class="c1">#sighash = hash(str(sig))</span>
                                

                                <span class="c1"># if len(anstr) == 2:</span>
                                <span class="c1">#     if (anstr == np.array([323,351])).all():</span>
                                <span class="c1">#         import ipdb</span>
                                <span class="c1">#         ipdb.set_trace()</span>
                                <span class="n">anstr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">visited</span> <span class="p">])</span>
                                <span class="n">typ</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">])</span>
                                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">anstr</span><span class="p">,</span><span class="n">typ</span><span class="p">])</span>
                                <span class="n">sighash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">sighash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lhash</span><span class="p">:</span>
                                    <span class="n">lhash</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sighash</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)],</span><span class="n">sig</span><span class="p">))</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)],</span><span class="n">ratio</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sig</span><span class="p">))</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ratio</span><span class="p">])</span>
                                <span class="c1"># print (&#39;added&#39;,visited)</span>
                                    <span class="n">cptsig</span> <span class="o">+=</span><span class="mi">1</span>

                                <span class="k">if</span> <span class="n">animation</span><span class="p">:</span>
                                    <span class="n">Nf</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gi</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                                            <span class="n">nodelist</span><span class="o">=</span><span class="n">visited</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="p">{},</span>
                                            <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                                            <span class="n">node_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                                    <span class="n">Ef</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gi</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">Gi</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                                            <span class="n">edgelist</span><span class="o">=</span><span class="n">edge</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="p">{},</span>
                                            <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">arrows</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                                    <span class="n">cpt</span><span class="o">=</span><span class="n">cpt</span><span class="o">+</span><span class="mi">1</span>
                                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;./figure/&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">us</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpt</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Nf</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Ef</span><span class="p">)</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="k">pass</span>

                            <span class="n">outint</span> <span class="o">=</span> <span class="n">Gi</span><span class="p">[</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]][</span><span class="n">interaction</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="c1">#</span>
                            <span class="c1"># proint not used </span>
                            <span class="c1">#</span>
                            <span class="n">proint</span> <span class="o">=</span> <span class="n">Gi</span><span class="p">[</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]][</span><span class="n">interaction</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="n">nexti</span>  <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">outint</span> <span class="p">]</span>
                            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">nexti</span><span class="p">))</span>
                        <span class="c1"># 1590 ratio &lt;= threshold</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                                    <span class="n">R</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="n">last</span> <span class="o">=</span> <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="n">lawp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="c1"># 1389 condR and condT and condD</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># 1388 cond1 and cond2 and cond3  </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if at least 2 interactions </span>
                    <span class="c1"># and antepenultiem is a reflexion  </span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">R</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">visited</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="c1">#</span>
                    <span class="c1"># Poping </span>
                    <span class="c1">#      tahe </span>
                    <span class="c1">#      lawp</span>
                    <span class="c1">#      stack</span>
                    <span class="n">tahe</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lawp</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>
                    <span class="c1">#stack.pop()</span>


            
             

<div class="viewcode-block" id="Signatures.plot_cones"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.plot_cones">[docs]</a>    <span class="k">def</span> <span class="nf">plot_cones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="p">[],</span><span class="n">ax</span><span class="o">=</span><span class="p">[],</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot; display cones of an unfolded signature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        i : int</span>
<span class="sd">            the interaction block</span>
<span class="sd">        s : int</span>
<span class="sd">            the signature number in the block</span>
<span class="sd">        fig :</span>
<span class="sd">        ax  :</span>
<span class="sd">        figsize :</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ax</span> <span class="o">==</span><span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>


        <span class="n">pta</span><span class="p">,</span><span class="n">phe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># create a global array or tahe segments</span>

        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pta</span><span class="p">,</span><span class="n">phe</span><span class="p">))</span>
        <span class="n">lensi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">seg</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lensi</span><span class="p">):</span>
            <span class="n">pseg0</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[:,</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">pseg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[:,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#</span>
            <span class="c1"># create the cone seg0 seg1</span>
            <span class="c1">#</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cone</span><span class="o">.</span><span class="n">Cone</span><span class="p">()</span>
            <span class="n">cn</span><span class="o">.</span><span class="n">from2segs</span><span class="p">(</span><span class="n">pseg0</span><span class="p">,</span><span class="n">pseg1</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">cn</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Signatures.unfold"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.unfold">[docs]</a>    <span class="k">def</span> <span class="nf">unfold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; unfold a given signature</span>

<span class="sd">        return 2 np.ndarray of pta and phe &quot;aligned&quot;</span>
<span class="sd">        (reflexion interaction are mirrored)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        i : int</span>
<span class="sd">            the interaction block</span>
<span class="sd">        s : int</span>
<span class="sd">            the signature number in the block</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pta,phe</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        Signature.unfold</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">si</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][(</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">):(</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">si</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">pta</span><span class="p">,</span><span class="n">phe</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">unfold</span><span class="p">()</span>
        
        
        <span class="k">return</span> <span class="n">pta</span><span class="p">,</span><span class="n">phe</span></div>

<div class="viewcode-block" id="Signatures.pltunfold"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.pltunfold">[docs]</a>    <span class="k">def</span> <span class="nf">pltunfold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">shapely.ops</span> <span class="kn">as</span> <span class="nn">sho</span>
        <span class="kn">from</span> <span class="nn">descartes.patch</span> <span class="kn">import</span> <span class="n">PolygonPatch</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[]):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span><span class="mi">0</span> <span class="p">:</span> 
                        <span class="n">c</span> <span class="o">=</span><span class="s1">&#39;g&#39;</span>
                    <span class="k">elif</span> <span class="n">ii</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span><span class="s1">&#39;r&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">=</span> <span class="s1">&#39;k&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">color</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">xy</span>
                
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ax</span>
        <span class="k">def</span> <span class="nf">plot_poly</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[]):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">poly</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
                
                <span class="n">pp</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ax</span>
        <span class="n">pta</span><span class="p">,</span><span class="n">phe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="n">ML</span> <span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">MultiLineString</span><span class="p">([((</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]),(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_lines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">ML</span><span class="p">)</span>

        <span class="n">s0</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">([(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">s1</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">([(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="k">if</span> <span class="n">s0</span><span class="o">.</span><span class="n">crosses</span><span class="p">(</span><span class="n">s1</span><span class="p">):</span>
            <span class="n">s0</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">([(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">s1</span><span class="o">=</span><span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">([(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]),(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">MultiLineString</span><span class="p">([</span><span class="n">s0</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">ML</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ML</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">poly</span><span class="o">=</span><span class="n">sho</span><span class="o">.</span><span class="n">polygonize</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>
        <span class="c1"># ax = plot_lines(ax,cross,color=&#39;b&#39;)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_poly</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">poly</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signatures.show"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  plot signatures within the simulated environment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        i : list or -1 (default = all groups)</span>
<span class="sd">            list of interaction group numbers</span>
<span class="sd">        s : list or -1 (default = all sig)</span>
<span class="sd">            list of indices of signature in interaction group</span>
<span class="sd">        ctx : cycle of tx (optional)</span>
<span class="sd">        crx : cycle of rx (optional)</span>
<span class="sd">        graph : type of graph to be displayed</span>
<span class="sd">        color : string</span>
<span class="sd">        alphasig : float</span>
<span class="sd">        widthsig : float</span>
<span class="sd">        colsig : string</span>
<span class="sd">        ms : int</span>
<span class="sd">        ctx  : int</span>
<span class="sd">        crx :int</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="s1">&#39;fig&#39;</span><span class="p">:[],</span>
                   <span class="s1">&#39;ax&#39;</span><span class="p">:[],</span>
                   <span class="s1">&#39;graph&#39;</span><span class="p">:</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;alphasig&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;widthsig&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">&#39;colsig&#39;</span><span class="p">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                    <span class="s1">&#39;ctx&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;crx&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;aw&#39;</span><span class="p">:</span><span class="bp">True</span>
                   <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># display layout</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ctx&#39;</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Tpoly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ctx&#39;</span><span class="p">]][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
            <span class="n">Tpoly</span><span class="o">.</span><span class="n">coul</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>
            <span class="n">Tpoly</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crx&#39;</span><span class="p">]</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">Rpoly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;crx&#39;</span><span class="p">]][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
            <span class="n">Rpoly</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>

        <span class="c1"># i=-1 all rays</span>
        <span class="c1"># else block of interactions i</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lgrint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lgrint</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]]</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lgrint</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">lsig</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lsig</span> <span class="o">=</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lsig</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">])</span>
                <span class="n">siga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="c1"># sig = np.hstack((self.pTx[0:2].reshape((2, 1)),</span>
                <span class="c1">#                  np.hstack((self[i][&#39;pt&#39;][0:2, :, j],</span>
                <span class="c1">#                  self.pRx[0:2].reshape((2, 1))))</span>
                <span class="c1">#                  ))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">siga</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">siga</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;alphasig&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colsig&#39;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;widthsig&#39;</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="Signatures.showi"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.showi">[docs]</a>    <span class="k">def</span> <span class="nf">showi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">uni</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">us</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; interactive show</span>

<span class="sd">        press n to visit signatures sequentially</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        uni : index of interaction dictionnary keys</span>
<span class="sd">        us : signature index</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">nit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="n">nit</span><span class="p">[</span><span class="n">uni</span><span class="p">]</span>
        <span class="n">ust</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">polyS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
        <span class="n">cp1</span> <span class="o">=</span> <span class="n">polyS</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">xy</span>

        <span class="n">polyT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
        <span class="n">cp2</span> <span class="o">=</span> <span class="n">polyT</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">xy</span>

        <span class="n">ptx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cp1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cp1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">prx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cp2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">cp2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">st</span><span class="o">=</span><span class="s1">&#39;a&#39;</span>

        <span class="k">while</span> <span class="n">st</span> <span class="o">!=</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">inter</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">graph</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;# interaction :&#39;</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="s1">&#39;signature #&#39;</span><span class="p">,</span><span class="n">us</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">ust</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">ptx</span>
            <span class="c1"># draw terminal points (centroid of source and target cycle)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ptx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;xr&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;xb&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ni</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">print</span> <span class="s2">&quot;incorrect number of interactions&quot;</span>
            <span class="n">pos</span><span class="o">=</span><span class="p">{}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">][</span><span class="n">us</span><span class="o">*</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">u</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">u</span><span class="p">]})</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">line</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">u</span><span class="p">]))))</span>
                <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span><span class="n">nodelist</span><span class="o">=</span><span class="n">pos</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">][(</span><span class="n">us</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">inter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">inter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">inter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;signature index out of bounds of signature&quot;</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">line</span><span class="p">,</span><span class="n">prx</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">line</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="k">print</span> <span class="n">inter</span>
            <span class="n">st</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">st</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">us</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">ust</span><span class="p">:</span>
                    <span class="n">us</span><span class="o">=</span><span class="n">us</span><span class="o">+</span><span class="mi">2</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uni</span> <span class="o">=</span> <span class="n">uni</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ni</span> <span class="o">=</span> <span class="n">nit</span><span class="p">[</span><span class="n">uni</span><span class="p">]</span>
                        <span class="n">ust</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">ni</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">us</span><span class="o">=</span><span class="mi">0</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">uni</span><span class="o">=</span><span class="mi">0</span>
                        <span class="n">ni</span><span class="o">=</span><span class="n">nit</span><span class="p">[</span><span class="n">uni</span><span class="p">]</span>
                        <span class="n">us</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;press n for next signature&#39;</span></div>


<div class="viewcode-block" id="Signatures.rays"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.rays">[docs]</a>    <span class="k">def</span> <span class="nf">rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ptx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">prx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; from signatures dict to 2D rays</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ptx : numpy.array or int</span>
<span class="sd">            Tx coordinates is the center of gravity of the cycle number if</span>
<span class="sd">            type(tx)=int</span>
<span class="sd">        prx :  numpy.array or int</span>
<span class="sd">            Rx coordinates is the center of gravity of the cycle number if</span>
<span class="sd">            sigtype(rx)=int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        rays : Rays</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        In the same time the signature of the ray is stored in the Rays object</span>

<span class="sd">        Todo : Find the best memory implemntation</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        Signature.sig2ray</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">ptx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ptx</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prx</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">prx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">prx</span><span class="p">])</span>

        <span class="n">rays</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="n">ptx</span><span class="p">,</span><span class="n">prx</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># detect LOS situation</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># cycle on a line between 2 cycles</span>
        <span class="c1"># lc  = self.L.cycleinline(self.source,self.target)</span>

        <span class="c1">#</span>
        <span class="c1"># if source and target in the same merged cycle</span>
        <span class="c1"># and ptx != prx</span>
        <span class="c1">#</span>
        <span class="n">los</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">ptx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptx</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">prx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prx</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

        <span class="c1"># convex cycle of each point</span>
        <span class="n">cyptx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt2cy</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span>
        <span class="n">cyprx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt2cy</span><span class="p">(</span><span class="n">prx</span><span class="p">)</span>

        <span class="c1"># merged cycle of each point</span>
        <span class="n">polyctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">cyptx</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
        <span class="n">polycrx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">cyprx</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>

        <span class="c1">#</span>
        <span class="c1"># Handling LOS ray</span>
        <span class="c1">#</span>
        <span class="n">dtxrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ptx</span><span class="o">-</span><span class="n">prx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ptx</span><span class="o">-</span><span class="n">prx</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dtxrx</span><span class="o">&gt;</span><span class="mf">1e-15</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cyptx</span><span class="o">==</span><span class="n">cyprx</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">polyctx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">los</span><span class="p">):</span>
                    <span class="n">rays</span><span class="o">.</span><span class="n">los</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rays</span><span class="o">.</span><span class="n">los</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># k : Loop on interaction group</span>
        <span class="c1">#   l : loop on signature</span>
        <span class="c1"># ---&gt;</span>
        <span class="c1">#  this part should be a generator</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># print &#39;block#&#39;,k</span>
            <span class="c1"># if k ==3:</span>
            <span class="c1">#     import ipdb</span>
            <span class="c1">#     ipdb.set_trace()</span>
            <span class="c1"># get signature block with k interactions</span>
            <span class="n">tsig</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">shsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tsig</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shsig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">tsig</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">,:]</span>
                <span class="n">ns0</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nse</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">validtx</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">validrx</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">ns0</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">pD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ns0</span><span class="p">]</span>
                    <span class="n">TxD</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">ptx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptx</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">pD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pD</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="n">seg</span> <span class="o">=</span> <span class="n">polyctx</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">TxD</span><span class="p">)</span>
                    <span class="n">validtx</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">almost_equals</span><span class="p">(</span><span class="n">TxD</span><span class="p">,</span><span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validtx</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="c1">#print &quot;Signature.rays&quot;: ns0</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">nse</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">pD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nse</span><span class="p">]</span>
                    <span class="n">DRx</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">pD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pD</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">prx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prx</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                    <span class="n">validrx</span> <span class="o">=</span> <span class="n">polyctx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">DRx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validrx</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="c1">#print nse</span>

                <span class="k">if</span> <span class="n">validtx</span> <span class="o">&amp;</span> <span class="n">validrx</span><span class="p">:</span>
                    <span class="c1">#    print sig</span>
                    <span class="c1">#    print pD</span>
                    <span class="n">s</span>  <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="c1"># Transform signature into a ray</span>
                    <span class="c1"># --&gt; sig2ray</span>

                    <span class="n">isray</span><span class="p">,</span><span class="n">Yi</span>  <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sig2ray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="n">ptx</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">prx</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">isray</span><span class="p">:</span>
                        <span class="n">Yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">Yi</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">Yi3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Yi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))))</span>
                            <span class="n">Yi3d</span> <span class="o">=</span> <span class="n">Yi3d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span> <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pt&#39;</span><span class="p">],</span> <span class="n">Yi3d</span><span class="p">))</span>
                            <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span> <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">],</span>
                                                        <span class="n">sig</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                                       <span class="s1">&#39;sig&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)}</span>
                            <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">rays</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sig&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span>

        <span class="n">rays</span><span class="o">.</span><span class="n">nb_origin_sig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rays</span><span class="o">.</span><span class="n">origin_sig_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">return</span> <span class="n">rays</span></div>


<div class="viewcode-block" id="Signatures.raysv"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.raysv">[docs]</a>    <span class="k">def</span> <span class="nf">raysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ptx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">prx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; transform dict of signatures into 2D rays - default vectorized version</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ptx : numpy.array or int</span>
<span class="sd">            Tx coordinates is the center of gravity of the cycle ptx if</span>
<span class="sd">            type(ptx)=int</span>
<span class="sd">        prx :  numpy.array or int</span>
<span class="sd">            Rx coordinates is the center of gravity of the cycle prx if</span>
<span class="sd">            type(prx)=int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        rays : Rays</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This is a vectorized version of Signatures.rays.</span>
<span class="sd">        This implementation takes advantage of the np.ndarray</span>
<span class="sd">        and calculates images and backtrace for block of signatures.</span>
<span class="sd">        A block of signatures gathers all signatures with the same number of interactions.</span>

<span class="sd">        For mathematical details see :</span>

<span class="sd">        @phdthesis{amiot:tel-00971809,</span>
<span class="sd">          TITLE = {{Design of simulation platform joigning site specific radio propagation and human mobility for localization applications}},</span>
<span class="sd">          AUTHOR = {Amiot, Nicolas},</span>
<span class="sd">          URL = {https://tel.archives-ouvertes.fr/tel-00971809},</span>
<span class="sd">          NUMBER = {2013REN1S125},</span>
<span class="sd">          SCHOOL = {{Universit{\&#39;e} Rennes 1}},</span>
<span class="sd">          YEAR = {2013},</span>
<span class="sd">          MONTH = Dec,</span>
<span class="sd">          KEYWORDS = {Electromagnetic wave propagation simulation ; Human mobility simulation ; Wireless localization methods ; Position estimation methods in wireless networks ; Vectorized computation ; Ray-tracing ; Ultra wide band ; Simulateur de propagation {\&#39;e}lectromagn{\&#39;e}tique ; Simulateur de mobilit{\&#39;e} humaine ; M{\&#39;e}thodes de localisation sans fils ; M{\&#39;e}thodes d&#39;estimation de la position dans les r{\&#39;e}seaux sans fils ; Calcul informatique vectoris{\&#39;e} ; Outil de trac{\&#39;e} de rayons ; Ultra large bande},</span>
<span class="sd">          TYPE = {Theses},</span>
<span class="sd">          HAL_ID = {tel-00971809},</span>
<span class="sd">          HAL_VERSION = {v1},</span>
<span class="sd">        }</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        Signatures.image</span>
<span class="sd">        Signatures.backtrace</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">ptx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ptx</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">prx</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">prx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">prx</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ptx</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">ptx</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">prx</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">prx</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>

        <span class="n">rays</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="n">ptx</span><span class="p">,</span><span class="n">prx</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># detect LOS situation</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># cycle on a line between 2 cycles</span>
        <span class="c1"># lc  = self.L.cycleinline(self.source,self.target)</span>

        <span class="c1">#</span>
        <span class="c1"># if source and target are in the same merged cycle</span>
        <span class="c1"># and ptx != prx</span>
        <span class="c1">#</span>

        <span class="n">los</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">ptx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptx</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">prx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prx</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

        <span class="c1"># convex cycle of each point</span>
        <span class="n">cyptx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt2cy</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span>
        <span class="n">cyprx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt2cy</span><span class="p">(</span><span class="n">prx</span><span class="p">)</span>


        <span class="n">polyctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">cyptx</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>
        <span class="n">polycrx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gt</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">cyprx</span><span class="p">][</span><span class="s1">&#39;polyg&#39;</span><span class="p">]</span>

        <span class="c1"># The Line of sight situation is detected here </span>
        <span class="c1"># dtxtx : distance between Tx and Rx </span>
        <span class="n">dtxrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ptx</span><span class="o">-</span><span class="n">prx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ptx</span><span class="o">-</span><span class="n">prx</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dtxrx</span><span class="o">&gt;</span><span class="mf">1e-15</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">polyctx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">los</span><span class="p">):</span>
                <span class="n">rays</span><span class="o">.</span><span class="n">los</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">rays</span><span class="o">.</span><span class="n">los</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image2</span><span class="p">(</span><span class="n">ptx</span><span class="p">)</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtrace</span><span class="p">(</span><span class="n">ptx</span><span class="p">,</span><span class="n">prx</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
        <span class="c1"># </span>
        <span class="c1"># Add LOS ray in ray 2D </span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">rays</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))}</span>
        
        <span class="n">rays</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="n">rays</span><span class="o">.</span><span class="n">nb_origin_sig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">rays</span><span class="o">.</span><span class="n">origin_sig_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="c1">#pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">rays</span></div>

<div class="viewcode-block" id="Signatures.backtrace"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.backtrace">[docs]</a>    <span class="k">def</span> <span class="nf">backtrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; backtracing betwen tx and rx </span>

<span class="sd">        Warning :</span>
<span class="sd">            This is an attempt to vectorize the backtrace process.</span>
<span class="sd">            Despite it has been tested on few cases with succes,</span>
<span class="sd">            this is quite new need to be validated !!!</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>

<span class="sd">                tx : ndarray</span>
<span class="sd">                    position of tx (2,)</span>
<span class="sd">                rx : ndarray</span>
<span class="sd">                    position of tx (2,)</span>
<span class="sd">                M : dict</span>
<span class="sd">                    position of intermediate points obtained from self.image()</span>

<span class="sd">            Return</span>
<span class="sd">            -------</span>

<span class="sd">                rayp : dict</span>
<span class="sd">                key = number_of_interactions</span>
<span class="sd">                value =ndarray positions of interactions for creating rays</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>

<span class="sd">            dictionnary of intermediate coordinated :</span>
<span class="sd">            key = number_of_interactions</span>
<span class="sd">            value = nd array M with shape : (2,nb_signatures,nb_interactions)</span>
<span class="sd">            and 2 represent x and y coordinates</span>

<span class="sd">            See Also</span>
<span class="sd">            --------</span>

<span class="sd">            pylayers.antprop.signature.image</span>

<span class="sd">        &#39;&#39;&#39;</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">rx</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">rayp</span><span class="o">=</span><span class="p">{}</span>

        <span class="c1"># loop on number of interactions</span>
        <span class="k">for</span> <span class="n">ninter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">signatures</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">])</span>
            <span class="c1">#get segment ids of signature with ninter interactions</span>
            <span class="c1"># seg = self[ninter][::2]</span>
            <span class="c1"># unegseg=np.where(seg&lt;0)</span>
            <span class="c1"># uninegseg,idx = np.unique(seg[unegseg],return_inverse=True)</span>
            <span class="c1"># pneg = np.array([self.L.Gs.pos[x] for x in uninegseg])</span>

            <span class="c1"># nsig = len(seg)</span>

            <span class="c1"># # determine positions of points limiting the semgments</span>
            <span class="c1"># #1 get index in L.tahe</span>
            <span class="c1"># # 2 get associated position in L.pt</span>


            <span class="c1"># utahe = self.L.tahe[:,self.L.tgs[seg]]</span>
            <span class="c1"># # pt : (xycoord (2),pt indexes (2),nb_signatures,nb_interactions)</span>
            <span class="c1"># pt = self.L.pt[:,utahe]</span>
            

            <span class="c1"># ####WARNING BIG TRICK HERE :</span>
            <span class="c1"># #### pa and pb are not set as the same value </span>
            <span class="c1"># #### to avoid a singular matrixnext.</span>
            <span class="c1"># #### set pa =-pb has no incidence but avoid complex and vain code </span>
            <span class="c1"># #### modification for handling diffractions</span>
            <span class="c1"># try:</span>
            <span class="c1">#     pt[:,0,unegseg[0],unegseg[1]]=pneg[idx].T</span>
            <span class="c1">#     pt[:,1,unegseg[0],unegseg[1]]=-pneg[idx].T</span>
            <span class="c1"># except:</span>
            <span class="c1">#     pass</span>
            <span class="c1"># pt shape =</span>
            <span class="c1"># 0 : (x,y) coordinates x=0,y=1</span>
            <span class="c1"># 1 : 2 points (linking the semgnet) a=0,b=1</span>
            <span class="c1">#2 : nb of found signatures/segments</span>
            <span class="c1"># 3 : nb interaction</span>



            <span class="c1">################################</span>
            <span class="c1">###############################</span>
            <span class="c1">####### This part between hash has been copy/paste from self.image2</span>
            <span class="c1">###### should be considered to become a function</span>

            <span class="c1">#get segment ids of signature with ninter interactions</span>
            <span class="c1"># nid = node id</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">nsig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>


            <span class="c1"># pt shape =</span>
            <span class="c1"># 0 : (x,y) coordinates x=0,y=1</span>
            <span class="c1"># 1 : 2 points (linking the nidment) a=0,b=1</span>
            <span class="c1"># 2 : nb of found signatures/nidments</span>
            <span class="c1"># 3 : nb interactions</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">ninter</span><span class="p">))</span>


            <span class="c1"># 1 negative points</span>
            <span class="c1"># seek for diffraction </span>
            <span class="c1"># negative index points are diffraction points</span>
            <span class="n">upoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nid</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">unipoint</span><span class="p">,</span><span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nid</span><span class="p">[</span><span class="n">upoint</span><span class="p">],</span><span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1">#get their coordinates</span>
            <span class="c1">#</span>
            <span class="c1"># TO BE FIXED </span>
            <span class="c1">#</span>
            <span class="c1">#upointcoord = self.L.iupnt[-unipoint]</span>
            <span class="c1">#pointcoord = self.L.pt[:,upointcoord]</span>

            <span class="n">pointcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unipoint</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># #### WARNING BIG TRICK HERE :</span>
            <span class="c1"># #### pa and pb are not set as the same value </span>
            <span class="c1"># #### to avoid a singular matrixnext.</span>
            <span class="c1"># #### set pa =-pb has no incidence but avoid complex and vain code </span>
            <span class="c1"># #### modification for handling diffractions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">upoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pointcoord</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">pt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="n">upoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pointcoord</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


            <span class="c1"># 2 positive points</span>
            <span class="c1"># seek for segments</span>
            <span class="n">useg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># removing duplicates ( for increasing speed)</span>
            <span class="n">uniseg</span><span class="p">,</span><span class="n">idxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nid</span><span class="p">[</span><span class="n">useg</span><span class="p">],</span><span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1"># determine positions of points limiting the nidments</span>
            <span class="c1">#1 get index in L.tahe</span>
            <span class="n">utahe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tahe</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tgs</span><span class="p">[</span><span class="n">uniseg</span><span class="p">]]</span>
            <span class="n">segcoord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt</span><span class="p">[:,</span><span class="n">utahe</span><span class="p">]</span>

            <span class="n">pt</span><span class="p">[:,:,</span><span class="n">useg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">useg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">segcoord</span><span class="p">[:,:,</span><span class="n">idxp</span><span class="p">]</span>

            <span class="c1">###################################</span>
            <span class="c1">########################################</span>



            <span class="c1"># how to do this into a while loop ?</span>
            <span class="n">p</span><span class="o">=</span><span class="n">rx</span>

            <span class="c1"># creating W matrix required in eq (2.70) thesis Nicolas AMIOT</span>
            <span class="c1"># Warning W is rolled after and becomes (nsig,4,4)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">nsig</span><span class="p">))</span>
            <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsig</span><span class="p">))</span>

            <span class="n">W</span><span class="p">[:</span><span class="mi">2</span><span class="p">,:</span><span class="mi">2</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
            <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">,:</span><span class="mi">2</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>

            <span class="c1"># once rolled :</span>
            <span class="c1"># W (nsig,4,4)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">kinter</span><span class="o">=</span><span class="n">ninter</span><span class="o">-</span><span class="mi">1</span>

            <span class="n">ptr</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="n">Mr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-12</span>
            <span class="n">rayp_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">ninter</span><span class="p">))</span>
            <span class="c1"># rayp_i[:2,:,-1]=rx[:,None]</span>
            <span class="c1">#backtrace process</span>
            <span class="c1"># if ninter == 6:</span>
            <span class="c1">#     print np.where(((signatures[:,0]==42) &amp;(signatures[:,1]==-277) &amp; (signatures[:,2]==135) &amp; (signatures[:,3]==21) &amp; (signatures[:,4]==46) &amp; (signatures[:,5]==319)))</span>
            <span class="c1">#     import ipdb</span>
            <span class="c1">#     ipdb.set_trace()</span>

            <span class="k">while</span> <span class="n">kinter</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                <span class="c1">#Initilization, using the Tx position</span>
                <span class="k">if</span> <span class="n">kinter</span> <span class="o">==</span> <span class="n">ninter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">p_min_m</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">][:,:,</span><span class="n">kinter</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">p_min_m</span> <span class="o">=</span> <span class="n">pvalid</span><span class="p">[:]</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">][:,:,</span><span class="n">kinter</span><span class="p">]</span>

                <span class="n">a_min_b</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">kinter</span><span class="p">]</span><span class="o">-</span><span class="n">ptr</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,:,</span><span class="n">kinter</span><span class="p">]</span>

                <span class="c1"># Creating W from  eq (2.71)</span>
                <span class="c1"># a_min_b &lt;=&gt; a_{Lh-l}-b_{Lh-l}</span>
                <span class="c1"># p_min_m &lt;=&gt; \tilde{p}_{Lh}-\tilde{b}_{Lh-l}</span>
                <span class="c1"># W (nsig,4,4)</span>
                <span class="c1"># p_min_m (2,nsig)</span>
                <span class="c1"># a_min_b (2,nsig)</span>
                <span class="n">W</span><span class="p">[</span><span class="o">...</span><span class="p">,:</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_min_m</span><span class="o">.</span><span class="n">T</span>
                <span class="n">W</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_min_b</span><span class="o">.</span><span class="n">T</span>

                <span class="c1"># create 2nd member from eq (2.72)</span>
                <span class="k">if</span> <span class="n">kinter</span> <span class="o">==</span> <span class="n">ninter</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsig</span><span class="p">)),</span><span class="n">ptr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">kinter</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pvalid</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">ptr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,</span><span class="n">kinter</span><span class="p">]))</span>

                <span class="c1"># y once transposed :</span>
                <span class="c1"># y (nsig,4)</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">T</span>


                <span class="c1"># search and remove point with singular matrix</span>
                <span class="n">invalid_sig</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">W</span><span class="p">))</span><span class="o">&lt;</span><span class="mf">1e-15</span><span class="p">)</span>

                <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">invalid_sig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">invalid_sig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="n">invalid_sig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">],</span><span class="n">invalid_sig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">rayp_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rayp_i</span><span class="p">,</span><span class="n">invalid_sig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1">#remove signatures</span>

                <span class="n">usig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">invalid_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">usig</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">usig</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
                <span class="n">usig</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">usig</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">signatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">signatures</span><span class="p">,</span><span class="n">usig</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># detect diffrac</span>
                <span class="n">uD</span> <span class="o">=</span> <span class="n">signatures</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span><span class="n">kinter</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span>
                <span class="n">uuD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">signatures</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span><span class="n">kinter</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


                <span class="n">psolved</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

                <span class="c1">#valid ray is : 0 &lt; \alpha &lt; 1 and 0&lt; \beta &lt; 1</span>

                <span class="c1"># alpha</span>
                <span class="n">uvalidA</span> <span class="o">=</span> <span class="n">psolved</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span>
                <span class="n">uvalidB</span> <span class="o">=</span> <span class="n">psolved</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.</span>
                <span class="c1">#beta</span>
                <span class="n">uvalidC</span> <span class="o">=</span> <span class="n">psolved</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">epsilon</span>
                <span class="n">uvalidD</span> <span class="o">=</span> <span class="n">psolved</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mf">1.</span><span class="o">-</span><span class="n">epsilon</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">uvalidA</span> <span class="o">&amp;</span> <span class="n">uvalidB</span> <span class="o">&amp;</span> <span class="n">uvalidC</span> <span class="o">&amp;</span> <span class="n">uvalidD</span>
                <span class="c1"># consider valid diffraction interactions</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">|</span> <span class="n">uD</span>
                <span class="n">uvalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># re-add correct position of diffraction interations</span>
                <span class="c1">#indeed diffraction point should not been solved with linalg, </span>
                <span class="c1"># but by setting pa=-pb, no singular matrix appear</span>
                <span class="c1">#and diffraction points can be re-add thereafter.</span>
                <span class="n">psolved</span><span class="p">[</span><span class="n">uuD</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">uuD</span><span class="p">,</span><span class="n">kinter</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

                <span class="n">pvalid</span> <span class="o">=</span> <span class="n">psolved</span><span class="p">[</span><span class="n">uvalid</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span>


                <span class="c1"># keep only valid rays for ptr and Mr</span>
                <span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">]</span><span class="o">=</span><span class="n">Mr</span><span class="p">[</span><span class="n">ninter</span><span class="p">][:,</span><span class="n">uvalid</span><span class="p">,:]</span>
                <span class="n">ptr</span><span class="o">=</span><span class="n">ptr</span><span class="p">[:,:,</span><span class="n">uvalid</span><span class="p">,:]</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="n">uvalid</span><span class="p">,:,:]</span>


                <span class="c1"># remove signatures</span>
                <span class="n">usigv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">uvalid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">usigv</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">usigv</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
                <span class="n">usigv</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">usigv</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">signatures</span> <span class="o">=</span> <span class="n">signatures</span><span class="p">[</span><span class="n">usigv</span><span class="p">,:]</span>
                <span class="n">rayp_i</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span><span class="n">uvalid</span><span class="p">,</span><span class="n">kinter</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalid</span><span class="o">.</span><span class="n">T</span>
                <span class="n">rayp_i</span> <span class="o">=</span> <span class="n">rayp_i</span><span class="p">[:,</span><span class="n">uvalid</span><span class="p">,:]</span>
                <span class="c1">#if no more rays are valid , then quit block</span>
                <span class="c1"># (kinter &lt;0 is the exit while condition)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uvalid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">kinter</span><span class="o">=</span><span class="n">kinter</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">kinter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

            <span class="c1"># rayp_i[:2,:,0]=tx[:,None]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uvalid</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sir1</span><span class="o">=</span><span class="n">signatures</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ninter</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">usigv</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">sir2</span><span class="o">=</span><span class="n">signatures</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ninter</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">usigv</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">ninter</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">usigv</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">sir1</span>
                <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">sir2</span>
                <span class="n">rayp_i</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">rayp_i</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">rayp</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ninter</span><span class="p">:{</span><span class="s1">&#39;pt&#39;</span><span class="p">:</span><span class="n">rayp_i</span><span class="p">,</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span><span class="n">sig</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)}})</span>
        <span class="k">return</span> <span class="n">rayp</span></div>


<div class="viewcode-block" id="Signatures.image2"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.image2">[docs]</a>    <span class="k">def</span> <span class="nf">image2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine rays from images (second implementation)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tx : point</span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dM</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1"># loop on number of interactions</span>
        <span class="k">for</span> <span class="n">ninter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="c1">#get segment ids of signature with ninter interactions</span>
            <span class="c1"># nid = node id</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">nsig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">ninter</span><span class="p">))</span>


            <span class="c1"># pt shape =</span>
            <span class="c1"># 0 : (x,y) coordinates x=0,y=1</span>
            <span class="c1"># 1 : 2 points (linking the nidment) a=0,b=1</span>
            <span class="c1"># 2 : nb of found signatures/nidments</span>
            <span class="c1"># 3 : nb interactions</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">ninter</span><span class="p">))</span>

            <span class="c1">#1 negative points</span>
            <span class="c1"># seek for diffraction </span>
            <span class="c1"># negative index points are diffraction points</span>
            <span class="n">upoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nid</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">unipoint</span><span class="p">,</span><span class="n">idxpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nid</span><span class="p">[</span><span class="n">upoint</span><span class="p">],</span><span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1">#get their coordinates</span>
            <span class="c1">#</span>
            <span class="c1"># To be FIXED</span>
            <span class="c1">#</span>
            <span class="c1">#upointcoord = self.L.iupnt[-unipoint]</span>
            <span class="c1">#pointcoord = self.L.pt[:,upointcoord]</span>

            <span class="n">pointcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unipoint</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>
        
            <span class="c1"># try except to handle the case where there is no diffraction point</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">upoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pointcoord</span><span class="p">[:,</span><span class="n">idxpt</span><span class="p">]</span>
                <span class="n">pt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="n">upoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">upoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pointcoord</span><span class="p">[:,</span><span class="n">idxpt</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>


            <span class="c1">#2 positive points</span>
            <span class="c1">#seek for segments</span>
            <span class="n">useg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># removing duplicates ( for increasing speed)</span>
            <span class="n">uniseg</span><span class="p">,</span><span class="n">idxseg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">nid</span><span class="p">[</span><span class="n">useg</span><span class="p">],</span><span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1"># determine positions of points limiting the nidments</span>
            <span class="c1">#1 get index in L.tahe</span>
            <span class="n">utahe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tahe</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tgs</span><span class="p">[</span><span class="n">uniseg</span><span class="p">]]</span>
            <span class="n">segcoord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt</span><span class="p">[:,</span><span class="n">utahe</span><span class="p">]</span>

            <span class="n">pt</span><span class="p">[:,:,</span><span class="n">useg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">useg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">segcoord</span><span class="p">[:,:,</span><span class="n">idxseg</span><span class="p">]</span>

            <span class="c1"># check every element of pt is filled</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="c1"># TODO Upgrading layout for handling slab offsets </span>
            <span class="c1">#</span>
            <span class="c1"># uncomment those two lines when the numpy array L.norm and</span>
            <span class="c1"># L.offset exist</span>
            <span class="c1">#norm    = self.L.normal[:,utahe]</span>
            <span class="c1">#offset  = self.L.offset[:,utahe]</span>
            <span class="c1"># pt = pt + offset*norm</span>


            <span class="c1">############</span>
            <span class="c1">#formula 2.61 -&gt; 2.64 N.AMIOT PH.D thesis</span>
            <span class="c1">############</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">sx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">sy</span><span class="o">**</span><span class="mi">2</span>
            <span class="c1"># den = ((pt[0,0,:,:]-pt[0,1,:,:])**2+(pt[1,0,:,:]-pt[1,1,:,:])**2)</span>
            <span class="c1"># avoiding singularity (should not be possible)</span>
            <span class="n">uz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">den</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">den</span><span class="p">[</span><span class="n">uz</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">b</span><span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                              <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span>
                             <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                              <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span>
                             <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]))</span>
            <span class="c1"># a = ((pt[0,0,:,:]-pt[0,1,:,:])**2-(pt[1,0,:,:]-pt[1,1,:,:])**2)</span>
            <span class="c1"># a=a/(1.*den)</span>

            <span class="c1"># b = 2*(pt[0,1,:,:]-pt[0,0,:,:])*(pt[1,1,:,:]-pt[1,0,:,:])</span>
            <span class="c1"># b=b/(1.*den)</span>

            <span class="c1"># c= 2*(pt[0,0,:,:]*(pt[1,0,:,:]-pt[1,1,:,:])**2+pt[1,0,:,:]*(pt[0,1,:,:]-pt[0,0,:,:])*(pt[1,0,:,:]-pt[1,1,:,:]))</span>
            <span class="c1"># c = c/(1.*den)</span>

            <span class="c1"># d= 2*(pt[0,0,:,:]*(pt[1,0,:,:]-pt[1,1,:,:])*(pt[0,1,:,:]-pt[0,0,:,:])+pt[1,0,:,:]*(pt[0,1,:,:]-pt[0,0,:,:])**2)</span>
            <span class="c1"># d= d/(1.*den)</span>

            <span class="c1"># K=np.array([[a,-b],[-b,-a]])</span>
            <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">],[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="p">]])</span>

            <span class="c1"># translation vector v (2.60)</span>
            <span class="n">v</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]))</span>

            <span class="n">ityp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">ninter</span><span class="p">):</span>
                <span class="c1">#get segment ids of signature with ninter interactions</span>
                <span class="n">uT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">uD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="n">n</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">tx</span><span class="p">[:,</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nsig</span><span class="p">))</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">p</span><span class="o">=</span><span class="n">M</span><span class="p">[:,:,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#reflexion 0 (2.67)</span>
                <span class="n">M</span><span class="p">[:,</span><span class="n">uR</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,jk-&gt;ik&#39;</span><span class="p">,</span><span class="n">K</span><span class="p">[:,:,</span><span class="n">uR</span><span class="p">,</span><span class="n">n</span><span class="p">],</span><span class="n">p</span><span class="p">[:,</span><span class="n">uR</span><span class="p">])</span><span class="o">+</span><span class="n">v</span><span class="p">[:,</span><span class="n">uR</span><span class="p">,</span><span class="n">n</span><span class="p">]</span>
                <span class="c1">#transmission 0 (2.67)</span>
                <span class="n">M</span><span class="p">[:,</span><span class="n">uT</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span><span class="n">uT</span><span class="p">]</span>
                <span class="n">M</span><span class="p">[:,</span><span class="n">uD</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="n">uD</span><span class="p">,</span><span class="n">n</span><span class="p">]</span>

            <span class="c1"># if ninter==6:</span>
            <span class="c1">#     print np.where(((seg[:,0]==42) &amp; (seg[:,1]==-277) &amp; (seg[:,2]==135) &amp; (seg[:,3]==21)&amp;(seg[:,-1]==319)))</span>
            <span class="c1">#     import ipdb</span>
            <span class="c1">#     ipdb.set_trace()</span>

            <span class="n">dM</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ninter</span><span class="p">:</span><span class="n">M</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">dM</span></div>

<div class="viewcode-block" id="Signatures.image"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signatures.html#pylayers.antprop.signature.Signatures.image">[docs]</a>    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.7</span><span class="p">,</span><span class="mf">12.5</span><span class="p">])):</span>
        <span class="sd">&#39;&#39;&#39; Warning :</span>
<span class="sd">            This is an attempt to vectorize the image process.</span>
<span class="sd">            Despite it has been tested on few cases with success,</span>
<span class="sd">            this is quite new need to be validated !!!</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>

<span class="sd">                tx : ndarray</span>
<span class="sd">                    position of tx (2,)</span>

<span class="sd">            Return</span>
<span class="sd">            -------</span>

<span class="sd">                M : dictionnary</span>

<span class="sd">            dictionnary of intermediate coordinated :</span>
<span class="sd">            key = number_of_interactions</span>
<span class="sd">            value = nd array M with shape : (2,nb_signatures,nb_interactions)</span>
<span class="sd">            and 2 represent x and y coordinates</span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">nb_split</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="n">nsp</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">out</span><span class="o">=</span><span class="bp">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">res</span><span class="o">=</span><span class="n">a</span><span class="o">%</span><span class="n">nsp</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">nsp</span><span class="o">=</span><span class="n">nsp</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">return</span> <span class="n">nsp</span>

        <span class="n">dM</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">ninter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#get segment ids of signature with ninter interactions</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">nsig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
            <span class="c1"># determine positions of points limiting the semgments</span>
            <span class="c1">#1 get index in L.tahe</span>
            <span class="c1"># 2 get associated position in L.pt</span>

            <span class="c1">#utahe (2 pt indexes,nb_signatures,nb_interactions)</span>

            <span class="n">utahe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tahe</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">tgs</span><span class="p">[</span><span class="n">seg</span><span class="p">]]</span>



            <span class="c1"># pt : (xycoord (2),pt indexes (2),nb_signatures,nb_interactions)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">pt</span><span class="p">[:,</span><span class="n">utahe</span><span class="p">]</span>

            <span class="c1"># pt shape =</span>
            <span class="c1"># 0 : (x,y) coordinates x=0,y=1</span>
            <span class="c1"># 1 : 2 points (linking the semgnet) a=0,b=1</span>
            <span class="c1">#2 : nb of found signatures/segments</span>
            <span class="c1"># 3 : nb interaction</span>

            <span class="c1">############</span>
            <span class="c1">#formula 2.61 -&gt; 2.64 N.AMIOT thesis</span>
            <span class="c1">############</span>
            <span class="n">den</span> <span class="o">=</span> <span class="p">((</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">-</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">den</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">den</span><span class="p">[</span><span class="n">uz</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="n">b</span><span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span>

            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span>
                                <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:])</span> <span class="o">*</span>
                                <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,</span> <span class="p">:]))</span>
            <span class="c1"># den = ((pt[0,0,:,:]-pt[0,1,:,:])**2+(pt[1,0,:,:]-pt[1,1,:,:])**2)</span>

            <span class="c1"># a = ((pt[0,0,:,:]-pt[0,1,:,:])**2-(pt[1,0,:,:]-pt[1,1,:,:])**2)</span>
            <span class="c1"># a=a/(1.*den)</span>

            <span class="c1"># b = 2*(pt[0,1,:,:]-pt[0,0,:,:])*(pt[1,1,:,:]-pt[1,0,:,:])</span>
            <span class="c1"># b=b/(1.*den)</span>

            <span class="c1"># c= 2*(pt[0,0,:,:]*(pt[1,0,:,:]-pt[1,1,:,:])**2+pt[1,0,:,:]*(pt[0,1,:,:]-pt[0,0,:,:])*(pt[1,0,:,:]-pt[1,1,:,:]))</span>
            <span class="c1"># c = c/(1.*den)</span>

            <span class="c1"># d= 2*(pt[0,0,:,:]*(pt[1,0,:,:]-pt[1,1,:,:])*(pt[0,1,:,:]-pt[0,0,:,:])+pt[1,0,:,:]*(pt[0,1,:,:]-pt[0,0,:,:])**2)</span>
            <span class="c1"># d= d/(1.*den)</span>

            <span class="c1">#get segment ids of signature with ninter interactions</span>
            <span class="n">ityp</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">ninter</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">uT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">uR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uD</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#create matrix AM which is used to create marix A from eq. 2.65</span>
            <span class="n">AM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ninter</span><span class="p">)[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nsig</span><span class="p">)</span>

            <span class="c1"># Reflexion MAtrix K (2.59)</span>
            <span class="n">K</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">],[</span><span class="o">-</span><span class="n">b</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="p">]])</span>
            <span class="c1"># translation vector v (2.60)</span>
            <span class="n">v</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]))</span>

            <span class="c1">############</span>
            <span class="c1">#Create matrix A (2.66) which is fill by blocks</span>
            <span class="c1">############</span>



            <span class="n">blocks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nsig</span><span class="p">,</span><span class="n">ninter</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># Reflexion block</span>
            <span class="n">blocks</span><span class="p">[:,:,</span><span class="n">uR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uR</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=-</span><span class="n">K</span><span class="p">[:,:,</span><span class="n">uR</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uR</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Transmission block</span>
            <span class="n">blocks</span><span class="p">[:,:,</span><span class="n">uT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uT</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">uT</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="c1"># Diff block</span>
            <span class="n">blocks</span><span class="p">[:,:,</span><span class="n">uD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uD</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="mf">0.</span>

            <span class="c1"># fill the AM mda on the diagonal below the mda diagonal....</span>
            <span class="n">A</span><span class="o">=</span><span class="n">pyu</span><span class="o">.</span><span class="n">fill_block_diagMDA</span><span class="p">(</span><span class="n">AM</span><span class="p">,</span><span class="n">blocks</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># The 2nd member y is firslty completly fill, without taking into account that the 1st line differst from others.</span>
            <span class="c1"># 1. find which interaction and signature are R|T|D =&gt; create a masked array</span>
            <span class="c1"># 2. repeat is created because to each signature/interaction correspond a 2x1 column. Repeat allow to have the correct size to fill y</span>
            <span class="c1"># 3. fill the 1st line of y to take into consideration that difference.</span>

            <span class="c1">#y is the 2nd memeber from from (2.65) and will be filled following (2.67)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ninter</span><span class="p">,</span><span class="n">nsig</span><span class="p">))</span>

            <span class="c1">#######</span>
            <span class="c1"># Determine where y has to be filed with R|T|D</span>
            <span class="c1">#####</span>
            <span class="c1">#find the position where there is T|R|D. non continuous =&gt; need mask array</span>
            <span class="n">uTf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">uRf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uDf</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#postiion in signature &lt;=&gt; 2 lines in y . need to repeat to get the correct size</span>
            <span class="n">uRy2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">uRf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uRy1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">uRf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uRy1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">uRy1</span>
            <span class="n">uRy1</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">uRy1</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">uDy2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">uDf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uDy1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">uDf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">uDy1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">uDy1</span>
            <span class="n">uDy1</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">uDy1</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y</span><span class="p">[</span><span class="n">uRy1</span><span class="p">,</span><span class="n">uRy2</span><span class="p">]</span><span class="o">=</span><span class="n">v</span><span class="p">[:,</span><span class="n">uRf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uRf</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1">#print &#39;no R&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1">#uT1mr = np.repeat(uT1m.mask,2,axis=1).T</span>
                <span class="c1">#nothing to do. shoould be a zero vector , already initialized by y</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1">#print &#39;no T&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># NEVER TESTED !!!!!!!!!!!</span>
                <span class="n">y</span><span class="p">[</span><span class="n">uDy1</span><span class="p">,</span><span class="n">uDy2</span><span class="p">]</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">uDf</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;signatures.image diffraction line 3672 Not yet tested !&quot;</span>

                <span class="k">pass</span> <span class="c1">#print &#39;no D&#39;</span>

            <span class="c1">######</span>
            <span class="c1">#FIRST LINE specific processing of (2.67)</span>
            <span class="c1">######</span>
            <span class="n">uT0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uR0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">uD0</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ityp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">#reflexion 0 (2.67)</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,j-&gt;ik&#39;</span><span class="p">,</span><span class="n">K</span><span class="p">[:,:,</span><span class="n">uR0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">tx</span><span class="p">)</span><span class="o">+</span><span class="n">v</span><span class="p">[:,</span><span class="n">uR0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#trnasmission 0 (2.67)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uT0</span><span class="p">))</span>
            <span class="c1">#diff 0 (2.67)</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">uD0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#first line</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">uR0</span><span class="p">]</span><span class="o">=</span><span class="n">r0</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">uT0</span><span class="p">]</span><span class="o">=</span><span class="n">t0</span>
            <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">uD0</span><span class="p">]</span><span class="o">=</span><span class="n">d0</span>

            <span class="c1">#reshape for compliant size with linalg</span>
            <span class="n">A</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">leA</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">res</span><span class="o">=</span><span class="mi">0</span>
            <span class="c1">#trick for memory usage</span>
            <span class="k">if</span> <span class="n">leA</span> <span class="o">&gt;</span> <span class="mf">1e4</span><span class="p">:</span>
                <span class="n">nsp</span> <span class="o">=</span> <span class="n">nb_split</span><span class="p">(</span><span class="n">leA</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nsp</span> <span class="o">!=</span> <span class="n">leA</span><span class="p">:</span>
                    <span class="n">lA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">nsp</span><span class="p">)</span>
                    <span class="n">ly</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">nsp</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">A</span>
                    <span class="k">del</span> <span class="n">y</span>
                    <span class="k">print</span> <span class="n">nsp</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsp</span><span class="p">):</span>

                        <span class="n">lm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">lA</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">ly</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">lm</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">lm</span>
                    <span class="k">del</span> <span class="n">lm</span>
                    <span class="k">del</span> <span class="n">lA</span>
                    <span class="k">del</span> <span class="n">ly</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">M</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">m</span><span class="p">[:,</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span><span class="n">m</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>

            <span class="n">dM</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ninter</span><span class="p">:</span><span class="n">M</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">dM</span></div></div>


<div class="viewcode-block" id="Signature"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature">[docs]</a><span class="k">class</span> <span class="nc">Signature</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; class Signature</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    seq : list  of interaction point (edges (&gt;0)  or vertices (&lt;0) [int]</span>
<span class="sd">    typ : list of interaction type 1-R 2-T 3-D  [int]</span>
<span class="sd">    pa  : tail point of interaction segment (2xN) ndarray</span>
<span class="sd">    pb  : head point of interaction segment (2xN) ndarray</span>
<span class="sd">    pc  : center point of interaction segment (2xN) ndarray</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; object constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        sig : nd.array or list of interactions</span>

<span class="sd">        &gt;&gt;&gt; seq = np.array([[1,5,1],[1,1,1]])</span>
<span class="sd">        &gt;&gt;&gt; s = Signature(seq)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">typinter</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">seginter</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">seginter</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">typinter</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="Signature.info"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">print</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span></div>

<div class="viewcode-block" id="Signature.ev2"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.ev2">[docs]</a>    <span class="k">def</span> <span class="nf">ev2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  evaluation of Signature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This function converts the sequence of interactions into numpy arrays</span>
<span class="sd">        which contains coordinates of segments extremities involved in the</span>
<span class="sd">        signature. At that level the coordinates of extremities (tx and rx) is</span>
<span class="sd">        not known yet.</span>

<span class="sd">        members data</span>

<span class="sd">        pa  tail of segment  (2xN)</span>
<span class="sd">        pb  head of segment  (2xN)</span>
<span class="sd">        pc  the center of segment (2xN)</span>

<span class="sd">        norm normal to the segment if segment</span>
<span class="sd">        in case the interaction is a point the normal is undefined and then</span>
<span class="sd">        set to 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">seqpointa</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">ta</span><span class="p">,</span> <span class="n">he</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">he</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">nor1</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nor1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nor1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">pa</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">pa</span><span class="p">,</span><span class="n">pb</span><span class="p">,</span><span class="n">pc</span><span class="p">,</span><span class="n">norm</span><span class="p">)))</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">seqpointa</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:,:]</span></div>


<div class="viewcode-block" id="Signature.evf"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.evf">[docs]</a>    <span class="k">def</span> <span class="nf">evf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  evaluation of Signature (fast version)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This function converts the sequence of interactions into numpy arrays</span>
<span class="sd">        which contains coordinates of segments extremities involved in the</span>
<span class="sd">        signature.</span>

<span class="sd">        members data</span>

<span class="sd">        pa  tail of segment  (2xN)</span>
<span class="sd">        pb  head of segment  (2xN)</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># tail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># head</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># segment</span>
                <span class="n">ta</span><span class="p">,</span> <span class="n">he</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">he</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>      <span class="c1"># node</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Signature.ev"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.ev">[docs]</a>    <span class="k">def</span> <span class="nf">ev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  evaluation of Signature</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This function converts the sequence of interactions into numpy arrays</span>
<span class="sd">        which contains coordinates of segments extremities involved in the</span>
<span class="sd">        signature.</span>

<span class="sd">        At that stage coordinates of extremities (tx and rx) is</span>
<span class="sd">        not known yet</span>

<span class="sd">        members data</span>

<span class="sd">        pa  tail of segment  (2xN)</span>
<span class="sd">        pb  head of segment  (2xN)</span>
<span class="sd">        pc  the center of segment (2xN)</span>

<span class="sd">        norm normal to the segment if segment</span>
<span class="sd">        in case the interaction is a point the normal is undefined and then</span>
<span class="sd">        set to 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO : use map and filter instead of for loop</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># tail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>  <span class="c1"># center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># segment</span>
                <span class="n">ta</span><span class="p">,</span> <span class="n">he</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">norm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;norm&#39;</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">norm1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">he</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
            <span class="k">else</span><span class="p">:</span>      <span class="c1"># node</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluated</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="Signature.unfold"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.unfold">[docs]</a>    <span class="k">def</span> <span class="nf">unfold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; unfold a given signature</span>

<span class="sd">        returns 2 np.ndarray of pta and phe &quot;aligned&quot;</span>
<span class="sd">        reflexion interactions are mirrored</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pta : np.array</span>
<span class="sd">        phe : np.array</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lensi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">pta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">lensi</span><span class="p">))</span>
        <span class="n">phe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">lensi</span><span class="p">))</span>

        <span class="n">pta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phe</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mirror</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lensi</span><span class="p">):</span>

            <span class="n">pam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pbm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># R</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mirror</span><span class="p">:</span>
                    <span class="n">pam</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">pam</span><span class="p">,</span><span class="n">pta</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="n">m</span><span class="p">])</span>
                    <span class="n">pbm</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span><span class="n">pta</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="n">m</span><span class="p">])</span>
                <span class="n">pta</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pam</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">phe</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">mirror</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span> <span class="c1"># T</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mirror</span><span class="p">:</span>
                    <span class="n">pam</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">pam</span><span class="p">,</span><span class="n">pta</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="n">m</span><span class="p">])</span>
                    <span class="n">pbm</span> <span class="o">=</span> <span class="n">geu</span><span class="o">.</span><span class="n">mirror</span><span class="p">(</span><span class="n">pbm</span><span class="p">,</span><span class="n">pta</span><span class="p">[:,</span><span class="n">m</span><span class="p">],</span><span class="n">phe</span><span class="p">[:,</span><span class="n">m</span><span class="p">])</span>
                <span class="n">pta</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pam</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">phe</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> <span class="c1"># D</span>
                <span class="k">pass</span>
                <span class="c1"># TODO not implemented yet</span>

        <span class="k">return</span> <span class="n">pta</span><span class="p">,</span><span class="n">phe</span></div>

<div class="viewcode-block" id="Signature.evtx"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.evtx">[docs]</a>    <span class="k">def</span> <span class="nf">evtx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; evaluate transmitter</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L  : Layout</span>
<span class="sd">        tx : np.array (2xN)</span>
<span class="sd">        rx : np.array (2xM)</span>

<span class="sd">        DEPRECATED</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ta</span><span class="p">,</span> <span class="n">he</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">norm1</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">norm1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">he</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">,</span> <span class="n">pb</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">pc</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pb</span><span class="p">,</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">typ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])))</span>
        <span class="c1">#</span>
        <span class="c1">#  vecteur entre deux points adjascents de la signature</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">pc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">u1</span> <span class="o">*</span> <span class="n">u2</span><span class="p">)</span></div>
        <span class="c1">#return(vn)</span>
        <span class="c1">#return(typ)</span>


<div class="viewcode-block" id="Signature.image"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.image">[docs]</a>    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; compute the tx&#39;s images with respect to the signature segments</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tx : numpy.ndarray</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        M : numpy.ndarray</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span>
        <span class="n">pab</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">-</span> <span class="n">pa</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pab</span> <span class="o">*</span> <span class="n">pab</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">zalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">alpha</span><span class="p">[</span><span class="n">zalpha</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                            <span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span>
                            <span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                            <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span>
                            <span class="p">(</span><span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>

        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span>
        <span class="c1"># number of interactions</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pa</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">S</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>
        <span class="n">S</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">S</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">S</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># detect diffraction</span>
        <span class="n">usig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">blocks</span><span class="p">[</span><span class="n">usig</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># detect transmission</span>
        <span class="n">tsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tsig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#blocks[tsig, :, :] = np.zeros((2, 2))</span>
            <span class="n">blocks</span><span class="p">[</span><span class="n">tsig</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># detect reflexion</span>
        <span class="n">rsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rsig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">blocks</span><span class="p">[</span><span class="n">rsig</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="n">rsig</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">fill_block_diag</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">vc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">tx</span><span class="p">)</span> <span class="o">+</span> <span class="n">vc0</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">tx</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
            <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1">#y[2 * (i + 1):2 * (i + 1) + 2] = y[2*i:2*i+2]</span>
                <span class="n">y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">typ</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">M</span></div>

<div class="viewcode-block" id="Signature.show"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        L : Layout </span>
<span class="sd">        tx : </span>
<span class="sd">        rx : </span>
<span class="sd">        aw</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aw&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                     <span class="s1">&#39;axes&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                     <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                     <span class="s1">&#39;fig&#39;</span><span class="p">:[],</span>
                     <span class="s1">&#39;ax&#39;</span><span class="p">:[]</span>
                     <span class="p">}</span>
        
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span><span class="o">==</span><span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">==</span><span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>   

        <span class="bp">self</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">showG</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                             <span class="n">aw</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;aw&#39;</span><span class="p">],</span>
                             <span class="n">axes</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">]</span>
                             <span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="n">isvalid</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtrace</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;og&#39;</span><span class="p">)</span>
        <span class="n">l3</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="s1">&#39;ob&#39;</span><span class="p">)</span>
        <span class="n">l4</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
        <span class="n">ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Y</span><span class="p">)),</span><span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">isvalid</span><span class="p">:</span>
            <span class="n">l5</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l5</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ray</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">ray</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span>    </div>

<div class="viewcode-block" id="Signature.backtrace"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.backtrace">[docs]</a>    <span class="k">def</span> <span class="nf">backtrace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; backtrace given image, tx, and rx</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tx :  ndarray (2x1)</span>
<span class="sd">              transmitter</span>
<span class="sd">        rx :  ndarray (2x1)</span>
<span class="sd">              receiver</span>
<span class="sd">        M  :  ndarray (2xN)</span>
<span class="sd">              N image points obtained using self.image method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        isvalid : bool</span>
<span class="sd">            True if the backtrace ends successfully</span>

<span class="sd">        Y : ndarray (2 x (N+2))</span>
<span class="sd">            sequence of points corresponding to the seek ray</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; from pylayers.gis.layout import *</span>
<span class="sd">            &gt;&gt;&gt; from pylayers.antprop.signature import *</span>
<span class="sd">            &gt;&gt;&gt; L = Layout(&#39;defstr.ini&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s = Signature(seq)</span>
<span class="sd">            &gt;&gt;&gt; tx = np.array([760,1113])</span>
<span class="sd">            &gt;&gt;&gt; rx = np.array([762,1114])</span>
<span class="sd">            &gt;&gt;&gt; s.ev(L)</span>
<span class="sd">            &gt;&gt;&gt; M = s.image(tx)</span>
<span class="sd">            &gt;&gt;&gt; isvalid,Y = s.backtrace(tx,rx,M)</span>

<span class="sd">            &gt;&gt;&gt; fig,ax = L.showG(&#39;s&#39;,labels=1,aw=1,axes=1)</span>
<span class="sd">            &gt;&gt;&gt; l1 = ax.plot(tx[0],tx[1],&#39;or&#39;)</span>
<span class="sd">            &gt;&gt;&gt; l2 = ax.plot(rx[0],rx[1],&#39;og&#39;)</span>
<span class="sd">            &gt;&gt;&gt; l3 = ax.plot(M[0,:],M[1,:],&#39;ob&#39;)</span>
<span class="sd">            &gt;&gt;&gt; l4 = ax.plot(Y[0,:],Y[1,:],&#39;xk&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ray = np.hstack((np.hstack((tx.reshape(2,1),Y)),rx.reshape(2,1)))</span>
<span class="sd">            &gt;&gt;&gt; l5 = ax.plot(ray[0,:],ray[1,:],color=&#39;#999999&#39;,alpha=0.6,linewidth=0.6)</span>
<span class="sd">            &gt;&gt;&gt; </span>
<span class="sd">            &gt;&gt;&gt; plt.show()</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        For mathematical details see :</span>

<span class="sd">        @INPROCEEDINGS{6546704,</span>
<span class="sd">        author={Laaraiedh, Mohamed and Amiot, Nicolas and Uguen, Bernard},</span>
<span class="sd">        booktitle={Antennas and Propagation (EuCAP), 2013 7th European Conference on},</span>
<span class="sd">        title={Efficient ray tracing tool for UWB propagation and</span>
<span class="sd">               localization modeling},</span>
<span class="sd">        year={2013},</span>
<span class="sd">        pages={2307-2311},}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#import ipdb</span>
        <span class="c1">#pdb.set_trace()</span>
        <span class="c1">#import pdb</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pb</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typ</span>

        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pa</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">pkm1</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">pkm1</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># interaction counter</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>      <span class="c1"># to enter into the loop</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># signature is asumed being valid by default</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-12</span>
        <span class="c1"># if tuple(self.seq) == ( 42, -277,  135,   21,   46,  319):</span>
        <span class="c1">#     import ipdb</span>
        <span class="c1">#     ipdb.set_trace()</span>
        <span class="c1"># while (((beta &lt;= 1) &amp; (beta &gt;= 0)) &amp; (k &lt; N)):</span>
        <span class="k">while</span> <span class="p">(((</span><span class="n">beta</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">-</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&gt;=</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">)):</span>
            <span class="c1">#if int(typ[k]) != 1: # not a diffraction (surprisingly it works)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">typ</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># not a diffraction</span>
                <span class="c1"># Formula (25) of paper Eucap 2013</span>
                <span class="n">l0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">I2</span><span class="p">,</span> <span class="n">pkm1</span> <span class="o">-</span> <span class="n">M</span><span class="p">[:,</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">z0</span><span class="p">))</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">I2</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span>
                                <span class="n">pa</span><span class="p">[:,</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                                <span class="n">pb</span><span class="p">[:,</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">))</span>
                <span class="c1"># print pkm1</span>
                <span class="c1"># import ipdb</span>
                <span class="c1"># ipdb.set_trace()</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">l0</span><span class="p">,</span> <span class="n">l1</span><span class="p">))</span>
                <span class="n">yk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pkm1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">pa</span><span class="p">[:,</span> <span class="n">N</span> <span class="o">-</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

                <span class="n">deT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">deT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-15</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="bp">False</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
                <span class="n">xk</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">yk</span><span class="p">)</span>
                <span class="n">pkm1</span> <span class="o">=</span> <span class="n">xk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">gk</span> <span class="o">=</span> <span class="n">xk</span><span class="p">[</span><span class="mi">2</span><span class="p">::]</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Y</span><span class="p">,</span> <span class="n">pa</span><span class="p">[:,</span> <span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
                <span class="n">pkm1</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[:,</span> <span class="n">N</span><span class="o">-</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">==</span> <span class="n">N</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))):</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Y</span><span class="p">,</span> <span class="n">tx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">Y</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isvalid</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">Y</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span></div>


<div class="viewcode-block" id="Signature.sig2ray"><a class="viewcode-back" href="../../../api/pylayers.antprop.signature.Signature.html#pylayers.antprop.signature.Signature.sig2ray">[docs]</a>    <span class="k">def</span> <span class="nf">sig2ray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">pTx</span><span class="p">,</span> <span class="n">pRx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; convert a signature to a 2D ray</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : Layout</span>
<span class="sd">        pTx : ndarray</span>
<span class="sd">            2D transmitter position</span>
<span class="sd">        pRx : ndarray</span>
<span class="sd">            2D receiver position</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Y : ndarray (2x(N+2))</span>

<span class="sd">        See Also </span>
<span class="sd">        --------</span>

<span class="sd">        Signature.image</span>
<span class="sd">        Signature.backtrace</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ev transforms a sequence of segment into numpy arrays (points)</span>
        <span class="c1"># necessary for image calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="c1"># calculates images from pTx</span>
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">pTx</span><span class="p">)</span>

        <span class="c1">#print self</span>
        <span class="c1">#if np.array_equal(self.seq,np.array([5,7,4])):</span>
        <span class="c1">#    pdb.set_trace()</span>
        <span class="n">isvalid</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backtrace</span><span class="p">(</span><span class="n">pTx</span><span class="p">,</span> <span class="n">pRx</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="c1">#print isvalid,Y</span>
        <span class="c1"># </span>
        <span class="c1"># If incremental mode this function returns an alternative signature</span>
        <span class="c1"># in case the signature do not yield a valid ray.</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">isvalid</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">u</span></div></div>




<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;testing pylayers/antprop/signature.py&quot;</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;-------------------------------------&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, PyLayers developer team.
      Last updated on Nov 08, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>