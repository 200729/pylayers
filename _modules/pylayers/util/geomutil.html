

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pylayers.util.geomutil &mdash; Python 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../../../about.html"/>
    <link rel="top" title="Python 1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Python
          

          
            
            <img src="../../../_static/pylayers.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html">1&nbsp;&nbsp;&nbsp;Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#radio-propagation-simulation">2&nbsp;&nbsp;&nbsp;Radio Propagation Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#handling-agent-mobility">3&nbsp;&nbsp;&nbsp;Handling Agent Mobility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#wireless-body-area-network-related-classes">4&nbsp;&nbsp;&nbsp;Wireless Body Area Network Related Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#some-simulation-examples">5&nbsp;&nbsp;&nbsp;Some Simulation Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#algorithms-for-localization">6&nbsp;&nbsp;&nbsp;Algorithms for Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#measurements-tools">7&nbsp;&nbsp;&nbsp;Measurements Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#pylayers-tools">8&nbsp;&nbsp;&nbsp;PyLayers Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebook/TOC.html#references">9&nbsp;&nbsp;&nbsp;References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/pylayers.html">PyLayers Modules Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout1.html">Loading an outdoor layout from its address</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_antenna.html">Antenna Pattern for an H plane sectoral antenna &#64; 32GHz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLayout2.html">Building graphs of a Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_coverage.html">Indoor Radio Coverage with Motley Keenan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_layout.html">&#8220;</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_layout.html#some-layout">Some Layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exAbsGas.html">Attenuation due to atmospheric gases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exDLink.html">Evaluation of a radio link DLink</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_w1.html">Indoor Radio Coverage FP7 WHERE1 M1 setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_exLuebbers.html">UWB Ray tracing simulation  in outdoor scenario</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/plot_diffraction.html">Diffraction coefficient</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Python</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>pylayers.util.geomutil</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pylayers.util.geomutil</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding:Utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. currentmodule:: pylayers.util.geomutil</span>

<span class="sd">=================================================</span>
<span class="sd">Geometry Module (:mod:`pylayers.util.geomutil`)</span>
<span class="sd">================================================</span>

<span class="sd">Geomview Class</span>
<span class="sd">==============</span>

<span class="sd">.. autoclass:: Geomview</span>
<span class="sd">    :members:</span>

<span class="sd">Geomlist Class</span>
<span class="sd">==============</span>

<span class="sd">.. autoclass:: Geomview</span>
<span class="sd">    :members:</span>

<span class="sd">GeomVect Class</span>
<span class="sd">==============</span>

<span class="sd">.. autoclass:: GeomVect</span>
<span class="sd">    :members:</span>

<span class="sd">Geomoff Class</span>
<span class="sd">=============</span>

<span class="sd">.. autoclass:: Geomoff</span>
<span class="sd">    :members:</span>

<span class="sd">Plot_Shapely Class</span>
<span class="sd">==================</span>

<span class="sd">.. autoclass:: Plot_Shaplely</span>
<span class="sd">    :members:</span>

<span class="sd">LineString Class</span>
<span class="sd">==================</span>

<span class="sd">.. autoclass:: LineString</span>
<span class="sd">    :members:</span>

<span class="sd">PolyGon Class</span>
<span class="sd">=============</span>

<span class="sd">.. autoclass:: Polygon</span>
<span class="sd">    :members:</span>


<span class="sd">Utility Functions</span>
<span class="sd">=================</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">     angular</span>
<span class="sd">     vecang</span>
<span class="sd">     SignedArea</span>
<span class="sd">     Centroid</span>
<span class="sd">     Lr2n</span>
<span class="sd">     isBetween</span>
<span class="sd">     pvec</span>
<span class="sd">     pvecn</span>
<span class="sd">     onb</span>
<span class="sd">     vec_sph</span>
<span class="sd">     ellipse</span>
<span class="sd">     normalize</span>
<span class="sd">     ptonseg</span>
<span class="sd">     dptseg</span>
<span class="sd">     linet</span>
<span class="sd">     ccw</span>
<span class="sd">     are_points_inside_cone</span>
<span class="sd">     intersect_cone_seg</span>
<span class="sd">     intersect_halfline_seg</span>
<span class="sd">     intersect3</span>
<span class="sd">     intersect</span>
<span class="sd">     is_aligned3</span>
<span class="sd">     is_aligned4</span>
<span class="sd">     isleft</span>
<span class="sd">     isleftorequal</span>
<span class="sd">     affine</span>
<span class="sd">     cylmap</span>
<span class="sd">     MRot3</span>
<span class="sd">     MATP</span>
<span class="sd">     MEulerAngle</span>
<span class="sd">     SphericalBasis</span>
<span class="sd">     angledir</span>
<span class="sd">     Bthph</span>
<span class="sd">     BTB</span>

<span class="sd">     plot_coords</span>
<span class="sd">     plot_bounds</span>
<span class="sd">     plot_line</span>
<span class="sd">     v_color</span>

<span class="sd">     plotPolygon</span>
<span class="sd">     shrinkPolygon</span>
<span class="sd">     shrinkPolygon2</span>
<span class="sd">     simplifyPolygon</span>
<span class="sd">     wall_delta</span>
<span class="sd">     plot_coords2</span>
<span class="sd">     plot_bounds2</span>
<span class="sd">     plot_line2</span>
<span class="sd">     plot_coords3</span>
<span class="sd">     plot_bounds3</span>
<span class="sd">     plot_line3</span>
<span class="sd">     valid_wedge</span>
<span class="sd">     sector</span>
<span class="sd">     dist</span>
<span class="sd">     line_intersection</span>
<span class="sd">     linepoly_intersection</span>
<span class="sd">     mirror</span>
<span class="sd">     distseg</span>
<span class="sd">     dmin3d</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="kn">as</span> <span class="nn">sh</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="kn">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">toeplitz</span>
<span class="kn">import</span> <span class="nn">pylayers.util.project</span> <span class="kn">as</span> <span class="nn">pro</span>
<span class="kn">import</span> <span class="nn">pylayers.util.pyutil</span> <span class="kn">as</span> <span class="nn">pyu</span>
<span class="kn">import</span> <span class="nn">pylayers.util.graphutil</span> <span class="kn">as</span> <span class="nn">gru</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>

<span class="c1"># from antenna import *</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="kn">as</span> <span class="nn">shg</span>
<span class="kn">from</span> <span class="nn">descartes.patch</span> <span class="kn">import</span> <span class="n">PolygonPatch</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span><span class="n">product</span>


<span class="n">COLOR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="bp">True</span><span class="p">:</span> <span class="s1">&#39;#6699cc&#39;</span><span class="p">,</span>
    <span class="bp">False</span><span class="p">:</span> <span class="s1">&#39;#ff3333&#39;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">ispoint</span><span class="p">(</span><span class="n">tpts</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check if pt is a point in a tuple of points</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tpts : tuple (points (2xN) , index (1xN))</span>
<span class="sd">        pt  : point (2,1)</span>
<span class="sd">        tol : float</span>
<span class="sd">            default (0.05 meters)</span>

<span class="sd">        if True the point number (&lt;0) is returned</span>
<span class="sd">        else 0 is return</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        k : point index if point exists, 0 otherwise</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil.util import *</span>
<span class="sd">            &gt;&gt;&gt; tpts= (np.array([[1,2,3],[5,6,7]]),np.array([-1,-2,-3]))</span>
<span class="sd">            &gt;&gt;&gt; pt = np.array([[1],[5]])</span>
<span class="sd">            &gt;&gt;&gt; ispoint(tpts,pt)</span>
<span class="sd">            -1</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.util.geomutil.Polygon.setvnodes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print&quot;ispoint : pt &quot;, pt</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">tpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ke</span> <span class="o">=</span>  <span class="n">tpts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">u</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">-</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">nz</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if all points are different from pt</span>
            <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nz</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span><span class="p">(</span><span class="n">ke</span><span class="p">[</span><span class="n">nup</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">nup</span><span class="p">])</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="n">nup</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span><span class="p">(</span><span class="n">ke</span><span class="p">[</span><span class="n">nup</span><span class="p">[</span><span class="n">mi</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">isconvex</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Determine if a polygon is convex</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    tol : tolerence on aligned point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if convex</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    the algorithm tests all triplet of point and L.determine</span>
<span class="sd">    if the third point is left to the 2 first.</span>
<span class="sd">    a tolerance can be introduce in cases where the polygon is</span>
<span class="sd">    almost convex.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">isleft</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">isleft</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ptconvex</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Determine convex / concave points in the Polygon</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">        poly : shapely.Polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">signedarea</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">ipdb</span>
    <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="n">cvex</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">ccve</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="o">~</span><span class="n">cw</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">cvex</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ccve</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">ndarray</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get a ndarray from a Polygon</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        p : ndarray (2xNp)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; p1 = np.array([[0,1,1,0],[0,0,1,1]])</span>
<span class="sd">    &gt;&gt;&gt; P1 = Polygon(p1)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lring</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">exterior</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">signedarea</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get the signed area of the polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ndarray</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">/</span> <span class="mf">2.</span>


<span class="k">class</span> <span class="nc">Plot_shapely</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">PyLayers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;draw Shapely with matplotlib - pylab</span>
<span class="sd">     Plot_shapely.py</span>
<span class="sd">     Author : Martin Laloux 2010</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Plot_shapely.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Plot_shapely.__init__.html#pylayers.util.geomutil.Plot_shapely.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">coul</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alph</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; object constructor</span>

<span class="sd">         Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">         ax :</span>
<span class="sd">             pylab Axes</span>
<span class="sd">         obj  : geometric object</span>
<span class="sd">         coul : matplotlib color</span>
<span class="sd">         alph : transparency</span>

<span class="sd">         Examples</span>
<span class="sd">         --------</span>

<span class="sd">         &gt;&gt;&gt; from shapely.wkt import loads</span>
<span class="sd">         &gt;&gt;&gt; import matplotlib.pylab as plt</span>
<span class="sd">         &gt;&gt;&gt; ax = plt.gca()</span>
<span class="sd">         &gt;&gt;&gt; ligne = loads(&#39;LINESTRING (3 1, 4 4, 5 5, 5 6)&#39;)</span>
<span class="sd">         &gt;&gt;&gt; a  = Plot_shapely(ligne,ax,&#39;r&#39;, 0.5)</span>
<span class="sd">         &gt;&gt;&gt; a.plot</span>
<span class="sd">         &gt;&gt;&gt; Plot_shapely(ligne,ax,&#39;#FFEC00&#39;).plot</span>
<span class="sd">         &gt;&gt;&gt; plt.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">geom_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coul</span> <span class="o">=</span> <span class="n">coul</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alph</span> <span class="o">=</span> <span class="n">alph</span></div>

<div class="viewcode-block" id="Plot_shapely.plot_coords"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Plot_shapely.plot_coords.html#pylayers.util.geomutil.Plot_shapely.plot_coords">[docs]</a>    <span class="k">def</span> <span class="nf">plot_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coul</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plot_shapely.plot_ligne"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Plot_shapely.plot_ligne.html#pylayers.util.geomutil.Plot_shapely.plot_ligne">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ligne</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;lines&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coul</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alph</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plot_shapely.plot_polygon"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Plot_shapely.plot_polygon.html#pylayers.util.geomutil.Plot_shapely.plot_polygon">[docs]</a>    <span class="k">def</span> <span class="nf">plot_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;polygons&quot;&quot;&quot;</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coul</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plot_shapely.plot_multi"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Plot_shapely.plot_multi.html#pylayers.util.geomutil.Plot_shapely.plot_multi">[docs]</a>    <span class="k">def</span> <span class="nf">plot_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;multipoints, multilignes,multipolygones + GeometryCollection&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">:</span>
            <span class="n">Plot_shapely</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alph</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;draw w.r.t geometrical type&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Point&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_coords</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_polygon</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LineString&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_ligne</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s2">&quot;Multi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;ex. MultiPolygon&quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_multi</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;GeometryCollection&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_multi</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LinearRing&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_line</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>


<div class="viewcode-block" id="LineString"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.LineString">[docs]</a><span class="k">class</span> <span class="nc">LineString</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">PyLayers</span><span class="p">,</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Overloaded shapely LineString class</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LineString.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.LineString.__init__.html#pylayers.util.geomutil.LineString.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">shg</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">Polygon</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">shg</span><span class="o">.</span><span class="n">multipoint</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Np</span><span class="p">):</span>
                <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tu</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
            <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tu</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineString.plot"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.LineString.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot LineString</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        show : boolean</span>
<span class="sd">        fig : figure object</span>
<span class="sd">        ax  : axes object</span>
<span class="sd">        linewidth : int </span>
<span class="sd">        color :  string</span>
<span class="sd">            default #abcdef&quot;</span>
<span class="sd">        alpha :  float</span>
<span class="sd">            transparency   (default 0.8)</span>
<span class="sd">        figsize : tuple</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; l1 = np.array([[0,1,1,0],[0,0,1,1]])</span>
<span class="sd">            &gt;&gt;&gt; L1 = LineString(l1)</span>
<span class="sd">            &gt;&gt;&gt; l2 = [[3,4,4,3],[1,1,2,2]]</span>
<span class="sd">            &gt;&gt;&gt; L2 = LineString(l2)</span>
<span class="sd">            &gt;&gt;&gt; fig,ax = L1.plot(color=&#39;red&#39;,alpha=0.3,linewidth=3)</span>
<span class="sd">            &gt;&gt;&gt; fig,ax = L2.plot(fig=fig,ax=ax,color=&#39;blue&#39;,alpha=0.7,linewidth=2)</span>
<span class="sd">            &gt;&gt;&gt; title = plt.title(&#39;test plotting LineString&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#abcdef&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                    <span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="p">}</span>
        <span class="c1">#</span>
        <span class="c1"># update default values</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1">#</span>
        <span class="c1"># getting fig and ax</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div></div>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1">#   Functions used for calculation of visibility graph Gv</span>
<span class="c1"># -----------------------------------------------------------</span>


<div class="viewcode-block" id="Polygon"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon">[docs]</a><span class="k">class</span> <span class="nc">Polygon</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">PyLayers</span><span class="p">,</span> <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Overloaded shapely Polygon class</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    plot</span>
<span class="sd">    ptconvex</span>
<span class="sd">    buildGv</span>
<span class="sd">    ndarray :</span>
<span class="sd">        get a ndarray from a Polygon</span>
<span class="sd">    signedarea :</span>
<span class="sd">        get the signed area of the polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Polygon.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Polygon.__init__.html#pylayers.util.geomutil.Polygon.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">vnodes</span><span class="o">=</span><span class="p">[],</span> <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; object constructor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        p : list</span>
<span class="sd">            2xNp np.array</span>
<span class="sd">            shg.MultiPoint</span>
<span class="sd">            shg.Polygon</span>
<span class="sd">            tuple : self.ax</span>
<span class="sd">        vnodes : list of alternating points and segments numbers</span>
<span class="sd">            default = [] in this case a regular ordered sequence</span>
<span class="sd">            is generated.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Convention : a Polygon as an equal number of points and segments</span>
<span class="sd">        There is an implicit closure between first and last point</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sh</span><span class="o">.</span><span class="n">multipolygon</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;MultiPolygon are not allowed&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">shg</span><span class="o">.</span><span class="n">polygon</span><span class="o">.</span><span class="n">Polygon</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># shg.Polygon.__init__(self, pt)</span>
            <span class="c1">#</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">shg</span><span class="o">.</span><span class="n">multipoint</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Np</span><span class="p">):</span>
                <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tu</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
            <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tu</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">vnodes</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vnodes</span><span class="p">)</span>
            <span class="c1"># check if always True</span>
            <span class="c1"># very important fic for buildGv</span>
            <span class="c1"># now vnodes starts always with &lt;0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;WARNING : Polygon.vnodes == Polygon.ndarray() modulo -1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create sequence</span>
            <span class="c1">#</span>
            <span class="c1"># -1 1 -2 2 -3 3 ... -(Np-1) (Np-1)</span>
            <span class="c1">#</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Np</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
            <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the parent&#39;s __reduce__ tuple</span>
        <span class="n">pickled_state</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__reduce__</span><span class="p">()</span>
        <span class="c1"># Create our own tuple to pass to __setstate__</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">pickled_state</span><span class="p">[</span><span class="mi">2</span><span class="p">],)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">,)</span>
        <span class="c1"># Return a tuple that replaces the parent&#39;s __setstate__ tuple with our own</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pickled_state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pickled_state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Set the info attribute</span>
        <span class="n">staten</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Call the parent&#39;s __setstate__ with the other tuple elements.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">staten</span><span class="p">)</span>


<div class="viewcode-block" id="Polygon.__add__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Polygon.__add__.html#pylayers.util.geomutil.Polygon.__add__">[docs]</a>    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add 2 polygons</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        p : Polygon</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        pm : merged polygon or unchanged polygon</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># v0   = self.vnodes</span>
        <span class="c1"># v1   = p.vnodes</span>
        <span class="c1"># nseg0 = filter(lambda x:x&gt;0,v0)</span>
        <span class="c1"># nseg1 = filter(lambda x:x&gt;0,v1)</span>

        <span class="c1"># commseg = np.intersect1d(nseg0,nseg1)[0]</span>

        <span class="c1"># is0 = np.where(nseg0==commseg)[0][0]</span>
        <span class="c1"># is1 = np.where(nseg1==commseg)[0][0]</span>

        <span class="c1"># rs0 = np.roll(v0,2*is0-1)[1:]</span>
        <span class="c1"># rs1 = np.roll(v1,2*is1-1)[1:]</span>
        <span class="c1"># if rs1[0]==rs0[0]:</span>
        <span class="c1">#    rs1=rs1[::-1]</span>

        <span class="c1"># print rs0</span>
        <span class="c1"># print rs1</span>
        <span class="c1"># assert(rs0[0]==rs1[-1])</span>
        <span class="c1"># assert(rs0[-1]==rs1[0])</span>
        <span class="c1"># vnodes = np.hstack((rs0,rs1[1:-1]))</span>
        <span class="c1"># self.vnodes = vnodes</span>
        <span class="c1"># p2 = Polygon(pnew,vnodes=vnodes)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">pnew</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Not finished</span>
        <span class="c1">#</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span></div>

        <span class="c1"># p1 = np.vstack((pnew.exterior.xy[0],pnew.exterior.xy[1]))</span>
        <span class="c1"># p2 = Polygon(p1)</span>
        <span class="c1"># return(p2)</span>
        <span class="c1"># if isinstance(pnew,sh.polygon.Polygon):</span>
        <span class="c1">#    p1 = np.vstack((pnew.exterior.xy[0],pnew.exterior.xy[1]))</span>
        <span class="c1">#    return(p2)</span>
        <span class="c1"># else:</span>
        <span class="c1">#    pdb.set_trace()</span>
        <span class="c1">#    return(self)</span>

<div class="viewcode-block" id="Polygon.__repr__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Polygon.__repr__.html#pylayers.util.geomutil.Polygon.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndarray</span><span class="p">()</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="c1"># vnodes to link with external nodes numerotation</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">vnodes : (&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">st</span> <span class="o">+</span> <span class="s1">&#39;)</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">return</span><span class="p">(</span><span class="n">st</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xy</span>

    <span class="nd">@xy.setter</span>
    <span class="k">def</span> <span class="nf">xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xy</span> <span class="o">=</span> <span class="n">xy</span>

    <span class="nd">@xy.getter</span>
    <span class="k">def</span> <span class="nf">xy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xy</span>

<div class="viewcode-block" id="Polygon.setvnodes"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.setvnodes">[docs]</a>    <span class="k">def</span> <span class="nf">setvnodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update vnodes member from Layout</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        L : pylayers.layout.Layout</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.layout.Layout.ispoint</span>

<span class="sd">        vnodes is a list of points and segments of the polygon. </span>
<span class="sd">        If there are iso-segments the sequence of iso segments is repeated between the termination points. </span>
<span class="sd">        L.numseg has been adapted in order to return either the first segment (default)</span>
<span class="sd">        or the list of all segments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get coordinates of the exterior of the polygon </span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
        <span class="c1"># npts = map(lambda x :</span>
        <span class="c1">#            L.ispoint(np.array(x),tol=0.01),zip(x[0:-1],y[0:-1]))</span>
        <span class="c1">#</span>
        <span class="c1"># npts : list of point which are in the layout (with tolerance 1cm) 0 means not in the layout </span>
        <span class="c1">#</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="p">[</span><span class="n">L</span><span class="o">.</span><span class="n">ispoint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">npts</span><span class="p">),</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="c1"># seg list of tuple [(n1,n2),(n2,n3),....(,)]</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">vnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pseg</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">:</span>
            <span class="n">vnodes</span> <span class="o">=</span> <span class="n">vnodes</span> <span class="o">+</span> <span class="p">[</span><span class="n">pseg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">nseg</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">numseg</span><span class="p">(</span><span class="n">pseg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pseg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">first</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># if nseg==0:</span>
            <span class="c1">#     pdb.set_trace()</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">nseg</span> <span class="o">=</span> <span class="p">[</span><span class="n">nseg</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nseg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nseg</span><span class="p">)</span>
            <span class="n">vnodes</span> <span class="o">=</span> <span class="n">vnodes</span> <span class="o">+</span> <span class="n">nseg</span>

        <span class="c1"># pdb.set_trace()</span>
        <span class="c1"># try:</span>
        <span class="c1">#     nseg = map(lambda x : L.numseg(x[0],x[1],first=False),seg)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     import ipdb</span>
        <span class="c1">#     ipdb.set_trace()</span>
        <span class="c1"># vnodes = np.kron(npts,np.array([1,0]))+np.kron(nseg,np.array([0,1]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vnodes</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Polygon.setvnodes_new"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.setvnodes_new">[docs]</a>    <span class="k">def</span> <span class="nf">setvnodes_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tpts</span><span class="p">,</span><span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update vnodes member from Layout</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tpts : list of points </span>
<span class="sd">        L : pylayers.layout.Layout</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.layout.Layout.ispoint</span>

<span class="sd">        vnodes is a list of point and segments of the polygon. </span>
<span class="sd">        If there are isosegments the sequence of iso segments </span>
<span class="sd">        is repeated between the termination points. </span>
<span class="sd">        L.numseg has been adapted in order to return either the first segment (default)</span>
<span class="sd">        or the list of all segments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get coordinates of the exterior of the polygon </span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
        <span class="c1"># npts = map(lambda x :</span>
        <span class="c1">#            L.ispoint(np.array(x),tol=0.01),zip(x[0:-1],y[0:-1]))</span>
        <span class="c1">#</span>
        <span class="c1"># npts : list of points which are in the layout (with tolerance 1cm) </span>
        <span class="c1">#        0 means not in the layout </span>
        <span class="c1">#</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ispoint</span><span class="p">(</span><span class="n">tpts</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">npts</span><span class="p">),</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="c1"># seg list of tuple [(n1,n2),(n2,n3),....(,)]</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">vnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pseg</span> <span class="ow">in</span> <span class="n">seg</span><span class="p">:</span>
            <span class="n">vnodes</span> <span class="o">=</span> <span class="n">vnodes</span> <span class="o">+</span> <span class="p">[</span><span class="n">pseg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="c1"># get the list of associated segments</span>
            <span class="n">nseg</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">numseg</span><span class="p">(</span><span class="n">pseg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pseg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">first</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nseg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">nseg</span> <span class="o">=</span> <span class="p">[</span><span class="n">nseg</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nseg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nseg</span><span class="p">)</span>
            <span class="n">vnodes</span> <span class="o">=</span> <span class="n">vnodes</span> <span class="o">+</span> <span class="n">nseg</span>

        <span class="c1"># pdb.set_trace()</span>
        <span class="c1"># try:</span>
        <span class="c1">#     nseg = map(lambda x : L.numseg(x[0],x[1],first=False),seg)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     import ipdb</span>
        <span class="c1">#     ipdb.set_trace()</span>
        <span class="c1"># vnodes = np.kron(npts,np.array([1,0]))+np.kron(nseg,np.array([0,1]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vnodes</span><span class="p">)</span></div>
        <span class="c1"># self.</span>
<div class="viewcode-block" id="Polygon.ndarray"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.ndarray">[docs]</a>    <span class="k">def</span> <span class="nf">ndarray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get a ndarray from a Polygon</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            p : ndarray (2xNp)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; p1 = np.array([[0,1,1,0],[0,0,1,1]])</span>
<span class="sd">        &gt;&gt;&gt; P1 = Polygon(p1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.signedarea"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.signedarea">[docs]</a>    <span class="k">def</span> <span class="nf">signedarea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the signed area of the polygon</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndarray</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">/</span> <span class="mf">2.</span></div>

<div class="viewcode-block" id="Polygon.coorddeter"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.coorddeter">[docs]</a>    <span class="k">def</span> <span class="nf">coorddeter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine polygon coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span></div>

<div class="viewcode-block" id="Polygon.isconvex"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.isconvex">[docs]</a>    <span class="k">def</span> <span class="nf">isconvex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine if a polygon is convex</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tol : tolerance on aligned point</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        boolean : True if convex</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        the algorithm tests all triplet of points and determines </span>
<span class="sd">        if the third point is at the left to the 2 first.</span>
<span class="sd">        a tolerance can be introduce in cases the polygon is </span>
<span class="sd">        *almost* convex.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coorddeter</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">isleft</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">isleft</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.reverberation"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.reverberation">[docs]</a>    <span class="k">def</span> <span class="nf">reverberation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fGHz</span><span class="p">,</span> <span class="n">L</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate reverberation time of the polygon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fGHz : frequency GHz</span>
<span class="sd">        L : Layout</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        V    : float </span>
<span class="sd">            Volume</span>
<span class="sd">        A    : float </span>
<span class="sd">            Area</span>
<span class="sd">        eta  : float </span>
<span class="sd">            absorption coefficient</span>
<span class="sd">        tau_sab  : float </span>
<span class="sd">            Sabine delay</span>
<span class="sd">        tau_eyr  : float</span>
<span class="sd">            Eyring delay</span>


<span class="sd">        :math:`\tau_g = \frac{4V}{c\eta A}`</span>

<span class="sd">        Sabine&#39;s Model</span>
<span class="sd">        where :math:`\eta` is the absorbtion coefficient</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the sequence of segments</span>
        <span class="c1"># handle subsegments</span>
        <span class="n">lseg</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)</span>
        <span class="n">S1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">AS2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">AS1</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># S unsigned polygon area</span>
        <span class="c1"># P polygon Perimeter</span>
        <span class="c1"># A unsigned room area</span>
        <span class="c1"># V room Volume</span>
        <span class="c1"># H room Height</span>

        <span class="n">S</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lseg</span><span class="p">:</span>
            <span class="n">npt</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;connect&#39;</span><span class="p">]</span>
            <span class="n">slname</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sl</span><span class="p">[</span><span class="n">slname</span><span class="p">]</span>
            <span class="c1"># calculate Loss</span>
            <span class="n">Lo</span><span class="p">,</span> <span class="n">Lp</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">loss0</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
            <span class="n">Abs</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">Lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
            <span class="c1"># print slname,Abs</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">npt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">npt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">n1</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">n2</span><span class="p">]</span>
            <span class="n">Lseg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Lseg</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ss_z&#39;</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">SS</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ss_z&#39;</span><span class="p">]):</span>
                    <span class="n">ssname</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Gs</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ss_name&#39;</span><span class="p">][</span><span class="n">k2</span><span class="p">]</span>
                    <span class="n">sssl</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sl</span><span class="p">[</span><span class="n">ssname</span><span class="p">]</span>
                    <span class="n">Loss</span><span class="p">,</span> <span class="n">Lpss</span> <span class="o">=</span> <span class="n">sssl</span><span class="o">.</span><span class="n">loss0</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
                    <span class="n">Absss</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">Loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
                    <span class="c1"># print ssname,Absss</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">Lseg</span> <span class="o">*</span> <span class="p">(</span><span class="n">ss</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">SS</span> <span class="o">=</span> <span class="n">SS</span> <span class="o">+</span> <span class="n">val</span>
                    <span class="n">S1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">AS1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">Absss</span><span class="p">)</span>

                <span class="n">St</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="n">Lseg</span>
                <span class="n">S1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">St</span> <span class="o">-</span> <span class="n">SS</span><span class="p">)</span>
                <span class="n">AS1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">St</span> <span class="o">-</span> <span class="n">SS</span><span class="p">)</span> <span class="o">*</span> <span class="n">Abs</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">S2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">Lseg</span><span class="p">)</span>
                <span class="n">AS2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">Lseg</span> <span class="o">*</span> <span class="n">Abs</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="n">H</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">S</span>
        <span class="n">sfloor</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;FLOOR&#39;</span><span class="p">]</span>
        <span class="n">sceil</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">sl</span><span class="p">[</span><span class="s1">&#39;CEIL&#39;</span><span class="p">]</span>
        <span class="n">Lofloor</span><span class="p">,</span> <span class="n">Lpfloor</span> <span class="o">=</span> <span class="n">sfloor</span><span class="o">.</span><span class="n">loss0</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="n">Loceil</span><span class="p">,</span> <span class="n">Lpceil</span> <span class="o">=</span> <span class="n">sceil</span><span class="o">.</span><span class="n">loss0</span><span class="p">(</span><span class="n">fGHz</span><span class="p">)</span>
        <span class="n">etaFloor</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">Lofloor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">etaCeil</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">Loceil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">AS1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">AS2</span><span class="p">)</span> <span class="o">+</span> <span class="n">etaFloor</span> <span class="o">+</span> <span class="n">etaCeil</span><span class="p">)</span> <span class="o">/</span> <span class="n">A</span>
        <span class="n">tau_sab</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">V</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)</span>
        <span class="n">tau_eyr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">V</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.3</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eta</span><span class="p">))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">tau_sab</span><span class="p">,</span> <span class="n">tau_eyr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.plot"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        color :  string</span>
<span class="sd">            default #abcdef&quot;</span>
<span class="sd">        alpha :  float</span>
<span class="sd">            transparency   (default 0.8)</span>
<span class="sd">        vnodes : bool</span>
<span class="sd">            display vnodes</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; import numpy as np</span>
<span class="sd">            &gt;&gt;&gt; p1 = np.array([[0,1,1,0],[0,0,1,1]])</span>
<span class="sd">            &gt;&gt;&gt; P1 = Polygon(p1)</span>
<span class="sd">            &gt;&gt;&gt; p2 = [[3,4,4,3],[1,1,2,2]]</span>
<span class="sd">            &gt;&gt;&gt; P2 = Polygon(p2)</span>
<span class="sd">            &gt;&gt;&gt; p3 = [np.array([10,10]),np.array([11,10]),np.array([11,11]),np.array([10,11])]</span>
<span class="sd">            &gt;&gt;&gt; P3 = Polygon(p3)</span>
<span class="sd">            &gt;&gt;&gt; fig,ax = P1.plot(color=&#39;red&#39;,alpha=0.3)</span>
<span class="sd">            &gt;&gt;&gt; fig,ax = P2.plot(fig=fig,ax=ax,color=&#39;blue&#39;,alpha=0.7)</span>
<span class="sd">            &gt;&gt;&gt; fig,ax = P3.plot(fig=fig,ax=ax,color=&#39;green&#39;,alpha=1)</span>
<span class="sd">            &gt;&gt;&gt; title = plt.title(&#39;test plotting polygons&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;vnodes&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#abcdef&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                    <span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="p">}</span>
        <span class="c1">#</span>
        <span class="c1"># update default values</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1">#</span>
        <span class="c1"># getting fig and ax</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">numpt</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                <span class="n">ec</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vnodes&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numpt</span><span class="p">)):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">numpt</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Polygon.simplify"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.simplify">[docs]</a>    <span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; simplify polygon - suppress adjacent colinear segments</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            poly2 : simplified polygon</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Before</span>


<span class="sd">        After</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">v1n</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v1</span><span class="p">))</span>
            <span class="n">v2n</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1n</span><span class="p">,</span> <span class="n">v2n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="mf">0.98</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">vini</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">vin</span> <span class="o">=</span> <span class="n">vini</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vini</span><span class="p">,</span> <span class="n">vini</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2n</span><span class="p">,</span> <span class="n">vin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">asLineString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">poly2</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.buildGvc"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.buildGvc">[docs]</a>    <span class="k">def</span> <span class="nf">buildGvc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create visibility graph for a convex polygon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        display   : boolean</span>
<span class="sd">            default : False</span>
<span class="sd">        fig       : matplotlib.figure.pyplot</span>
<span class="sd">        ax        : axes</span>
<span class="sd">        udeg2     : np.array indexes of points of degree 2</span>
<span class="sd">            default = []</span>
<span class="sd">        eded   : boolean</span>
<span class="sd">            default True</span>
<span class="sd">        indoor : boolean</span>
<span class="sd">            default True</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import shapely.geometry as shg</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; points  = shg.MultiPoint([(0, 0), (0, 1), (2.5,1), (2.5, 2), \</span>
<span class="sd">                                          (2.8,2), (2.8, 1.1), (3.2, 1.1), \</span>
<span class="sd">                                          (3.2, 0.7), (0.4, 0.7), (0.4, 0)])</span>
<span class="sd">            &gt;&gt;&gt; polyg   = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; Gv      = polyg.buildGv(show=True)</span>
<span class="sd">            &gt;&gt;&gt; plt.axis(&#39;off&#39;)</span>
<span class="sd">            (-0.5, 4.0, -0.5, 2.5)</span>
<span class="sd">            &gt;&gt;&gt; title = plt.title(&#39;Testing buildGv&#39;)</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Segment k and (k+1)%N share segment (k+1)%N</span>
<span class="sd">        The degree of a point is dependent from other polygons around</span>

<span class="sd">        Topological error can be raised if the point coordinates accuracy</span>
<span class="sd">        is not limited.</span>

<span class="sd">        Nodes of polygon are numbered in the global graph in vnodes member.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.gis.layout.Layout.buildGv</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;udeg2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                    <span class="s1">&#39;eded&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;indoor&#39;</span><span class="p">:</span> <span class="bp">True</span>
                    <span class="p">}</span>

        <span class="c1"># initialize function attributes</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">Gv</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">lring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span>
        <span class="c1">#</span>
        <span class="c1"># Calculate interior normals</span>
        <span class="c1">#</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="c1">#</span>
        <span class="c1"># determine convex points</span>
        <span class="c1">#</span>
        <span class="c1"># pdb.set_trace()</span>
        <span class="n">tcc</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptconvex</span><span class="p">()</span>
        <span class="c1"># Np = self.Np</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#</span>
        <span class="c1"># retrieve</span>
        <span class="c1">#  npt points label sequence</span>
        <span class="c1">#  nseg segments label sequence</span>
        <span class="c1">#</span>
        <span class="c1"># vnodes do not necessarily start with a point</span>
        <span class="c1">#</span>

        <span class="n">npt</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)</span>
        <span class="n">nseg</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># in convex case all segments see all segments</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">nseg</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Update position of points in Gv</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">Gv</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
            <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nk</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nk</span><span class="p">])</span>

        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>

        <span class="c1">#</span>
        <span class="c1"># Determine diffraction points</span>
        <span class="c1">#</span>
        <span class="c1"># deg2 : if null:</span>
        <span class="c1">#           the point is kept</span>
        <span class="c1">#        if convex:</span>
        <span class="c1">#           the point is kept</span>
        <span class="c1">#        else:</span>
        <span class="c1">#           the point is not kept</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">indoor</span><span class="p">:</span>
            <span class="n">uconvex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># convex point position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uconvex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># convex point position</span>
        <span class="c1"># planar point (joining two parallel segment)</span>
        <span class="n">uzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># degree 2 paralell points are often doors and windows</span>
        <span class="n">udiffdoor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">uzero</span><span class="p">,</span> <span class="n">udeg2</span><span class="p">)</span>
        <span class="n">udiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">uconvex</span><span class="p">,</span> <span class="n">udiffdoor</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="s1">&#39;int&#39;</span><span class="p">)</span>  <span class="c1"># diffracting point</span>
        <span class="c1">#</span>
        <span class="c1"># 1) Calculate node-node visibility</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># Between all combinations of diffracting points</span>
        <span class="c1"># create a segment and check whether it is fully included in the</span>
        <span class="c1"># polygon.</span>
        <span class="c1"># If verified then there is a visibility between the 2 points.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">udiff</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
                <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1">#  2) Calculate edge-edge and node-edge visibility</span>
        <span class="c1">#</span>

        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>   <span class="c1"># loop on range of number of points</span>
            <span class="n">ptk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">]</span>     <span class="c1"># tail point</span>
            <span class="c1"># head point (%Np to get 0 as last point)</span>
            <span class="n">phk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]</span>

            <span class="c1"># lnk : unitary vector on segment nk</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="n">phk</span> <span class="o">-</span> <span class="n">ptk</span>
            <span class="n">nlk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">lk</span><span class="p">))</span>
            <span class="n">lnk</span> <span class="o">=</span> <span class="n">lk</span> <span class="o">/</span> <span class="n">nlk</span>

            <span class="c1"># the epsilon is (1/1000) of the segment length</span>
            <span class="n">epsilonk</span> <span class="o">=</span> <span class="n">nlk</span> <span class="o">/</span> \
                <span class="mf">1000.</span>  <span class="c1"># this can be dangerous (epsilon can be large)</span>

            <span class="c1"># x--o----------------------o--x</span>
            <span class="c1">#    +eps                  -eps</span>
            <span class="n">pcornert</span> <span class="o">=</span> <span class="n">ptk</span> <span class="o">+</span> <span class="n">lnk</span> <span class="o">*</span> <span class="n">epsilonk</span>  <span class="c1"># + n[:,nk]*epsilon</span>
            <span class="n">pcornerh</span> <span class="o">=</span> <span class="n">phk</span> <span class="o">-</span> <span class="n">lnk</span> <span class="o">*</span> <span class="n">epsilonk</span>  <span class="c1"># + n[:,nk]*epsilon</span>

        <span class="c1">#</span>
        <span class="c1"># in any case no ray towark nk</span>
        <span class="c1"># if nk is convex no ray toward (nk-1)%Np</span>
        <span class="c1">#</span>
        <span class="c1"># start from the two extremity of the segment</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pcorner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">pcornert</span><span class="p">,</span> <span class="n">pcornerh</span><span class="p">]):</span>
                <span class="c1">#</span>
                <span class="c1">#  if tail point</span>
                <span class="c1">#           remove nk segment</span>
                <span class="c1">#  and if the point is convex</span>
                <span class="c1">#          remove previous segment</span>
                <span class="c1">#</span>
                <span class="c1">#  si point head</span>
                <span class="c1">#</span>
                <span class="n">listpoint</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>
                <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>   <span class="c1"># remove current point</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first iteration pcornert</span>
                    <span class="k">if</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">uconvex</span><span class="p">:</span>  <span class="c1"># == 1</span>
                        <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">nk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># second iteration pcornerh</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span> <span class="ow">in</span> <span class="n">uconvex</span><span class="p">:</span>  <span class="c1"># ==1</span>
                        <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">listpoint</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">ns</span><span class="p">]</span>
                    <span class="n">phs</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="p">(</span><span class="n">ns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]</span>
                    <span class="c1"># Add B.Uguen 2/01/2014 no possible visibility relation</span>
                    <span class="c1"># between aligned segments</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">is_aligned3</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">phs</span><span class="p">,</span> <span class="n">ptk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_aligned3</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">phs</span><span class="p">,</span> <span class="n">phk</span><span class="p">))):</span>
                        <span class="n">ls</span> <span class="o">=</span> <span class="n">phs</span> <span class="o">-</span> <span class="n">pts</span>
                        <span class="n">nls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">ls</span><span class="p">))</span>
                        <span class="n">lns</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">/</span> <span class="n">nls</span>
                        <span class="n">epsilons</span> <span class="o">=</span> <span class="n">nls</span> <span class="o">/</span> <span class="mf">1000.</span>
                        <span class="n">pte</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">+</span> <span class="n">lns</span> <span class="o">*</span> <span class="n">epsilons</span>  <span class="c1"># + n[:,ns]*epsilon</span>
                        <span class="n">phe</span> <span class="o">=</span> <span class="n">phs</span> <span class="o">-</span> <span class="n">lns</span> <span class="o">*</span> <span class="n">epsilons</span>  <span class="c1"># + n[:,ns]*epsilon</span>
                        <span class="n">tbr</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">bitreverse</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.</span>
                        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">tbr</span><span class="p">:</span>
                            <span class="n">pa</span> <span class="o">=</span> <span class="n">pte</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">phe</span> <span class="o">-</span> <span class="n">pte</span><span class="p">)</span>
                            <span class="n">seg</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">pcorner</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                            <span class="c1"># print &quot;seg: &quot;,seg.xy</span>
                            <span class="c1"># if npt[nk] == -3:</span>
                            <span class="c1">#    plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),linewidth=0.2,color=&#39;k&#39;)</span>
                            <span class="c1">#    plt.draw()</span>
                            <span class="c1"># topological error can be raised here</span>
                            <span class="n">seg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
                            <span class="c1"># if self.contains(seg):</span>
                            <span class="k">if</span> <span class="n">seg2</span><span class="o">.</span><span class="n">almost_equals</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
                                <span class="c1"># print alpha,nk,ns</span>
                                <span class="c1"># plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),linewidth=2,color=&#39;r&#39;)</span>
                                <span class="c1"># Gv.add_edge(-(uconvex[nk]+1),ns+1,weight=10)</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">udiff</span><span class="p">:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="c1"># plt.plot(np.array([Gv.pos[npt[nk]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[npt[nk]][1],Gv.pos[nseg[ns]][1]]),&#39;r&#39;)</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span> <span class="ow">in</span> <span class="n">udiff</span><span class="p">:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">npt</span><span class="p">[(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="c1"># plt.plot(np.array([Gv.pos[npt[(nk+1)%Np]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[npt[(nk+1)%Np]][1],Gv.pos[nseg[ns]][1]]),&#39;g&#39;)</span>
                                    <span class="c1"># plt.draw()</span>
                                <span class="c1"># if i==1:</span>
                                <span class="c1"># if (((nseg[nk]==10) &amp; (nseg[ns]==7)) or</span>
                                <span class="c1">#    ((nseg[nk]==7) &amp; (nseg[ns]==10))):</span>
                                <span class="c1">#    pdb.set_trace()</span>
                                <span class="k">if</span> <span class="n">nseg</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;eded&#39;</span><span class="p">]:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">nseg</span><span class="p">[</span><span class="n">nk</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="c1"># else:</span>
                                    <span class="c1">#    print nseg[nk],nseg[ns]</span>
                                    <span class="c1">#    print pts,phs</span>
                                    <span class="c1">#    print ptk,phk</span>
                                    <span class="c1"># if (((nseg[nk]==10) &amp; (nseg[ns]==7)) or</span>
                                    <span class="c1">#    ((nseg[nk]==7) &amp; (nseg[ns]==10))):</span>
                                    <span class="c1">#    plt.plot(np.array([Gv.pos[nseg[nk]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[nseg[nk]][1],Gv.pos[nseg[ns]][1]]),&#39;b&#39;)</span>
                                    <span class="c1">#    plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),&#39;b&#39;)</span>
                                    <span class="c1">#    print &quot;seg: &quot;,seg.xy</span>
                                    <span class="c1">#    print &quot;seg2: &quot;,seg2.xy</span>
                                    <span class="c1">#    print nseg[nk],nseg[ns]</span>
                                    <span class="c1">#    print pcorner , ptk</span>
                                    <span class="c1">#    print  alpha , pa ,pte</span>
                                    <span class="c1">#    plt.draw()</span>
                                    <span class="c1">#    raw_input()</span>
                                <span class="k">break</span>
                    <span class="c1"># else:</span>
                        <span class="c1"># print p</span>
                        <span class="c1"># print ns</span>
                        <span class="c1"># print nk</span>
                        <span class="c1"># print &#39;nsegnk : &#39;,nseg[nk]</span>
                        <span class="c1"># print &#39;nsegns&#39;, nseg[ns]</span>
                        <span class="c1"># print &#39;ptk : &#39;,ptk</span>
                        <span class="c1"># print &#39;phk : &#39;,phk</span>
                        <span class="c1"># print &#39;pts : &#39;,pts</span>
                        <span class="c1"># print &#39;phs : &#39;,phs</span>
                        <span class="c1"># print &quot;aligne :&quot;,nseg[nk],nseg[ns]</span>
                        <span class="c1"># pdb.set_trace()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Gv</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
            <span class="n">uneg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">upos</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">uneg</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">ndnd</span><span class="p">,</span> <span class="n">nded</span><span class="p">,</span> <span class="n">eded</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">edgetype</span><span class="p">(</span><span class="n">Gv</span><span class="p">)</span>

            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">eded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">ndnd</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">nded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># label = {}</span>
            <span class="c1"># for (u,v) in Gv.edges():</span>
            <span class="c1">#    d = Gv.get_edge_data(u,v)</span>
            <span class="c1">#    label[(u,v)]=d[&#39;weight&#39;]</span>

            <span class="c1"># edge_label=nx.draw_networkx_edge_labels(Gv,Gv.pos,edge_labels=label)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">Gv</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.buildGv"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.buildGv">[docs]</a>    <span class="k">def</span> <span class="nf">buildGv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create  visibility graph for a polygon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        display   : boolean</span>
<span class="sd">            default : False</span>
<span class="sd">        fig       : matplotlib.figure.pyplot</span>
<span class="sd">        ax        : axes</span>
<span class="sd">        udeg2     : np.array indexes of points of degree 2</span>
<span class="sd">            default = []</span>
<span class="sd">        eded   : boolean</span>
<span class="sd">            default True</span>
<span class="sd">        indoor : boolean</span>
<span class="sd">            default True</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import shapely.geometry as shg</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; points  = shg.MultiPoint([(0, 0), (0, 1), (2.5,1), (2.5, 2), \</span>
<span class="sd">                                          (2.8,2), (2.8, 1.1), (3.2, 1.1), \</span>
<span class="sd">                                          (3.2, 0.7), (0.4, 0.7), (0.4, 0)])</span>
<span class="sd">            &gt;&gt;&gt; polyg   = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; Gv      = polyg.buildGv(show=True)</span>
<span class="sd">            &gt;&gt;&gt; plt.axis(&#39;off&#39;)</span>
<span class="sd">            (-0.5, 4.0, -0.5, 2.5)</span>
<span class="sd">            &gt;&gt;&gt; title = plt.title(&#39;Testing buildGv&#39;)</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Segment k and (k+1)%N share segment (k+1)%N</span>
<span class="sd">        The degree of a point is dependent from other polygons around</span>

<span class="sd">        Topological error can be raised if the point coordinates accuracy</span>
<span class="sd">        is not limited.</span>

<span class="sd">        Nodes of polygon are numbered in the global graph in vnodes member.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pylayers.gis.layout.Layout.buildGv</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;udeg2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                    <span class="s1">&#39;eded&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;indoor&#39;</span><span class="p">:</span> <span class="bp">True</span>
                    <span class="p">}</span>

<span class="c1"># initialize function attributes</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># self.args=args</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

        <span class="n">udeg2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;udeg2&#39;</span><span class="p">]</span>

        <span class="n">GRAY</span> <span class="o">=</span> <span class="s1">&#39;#999999&#39;</span>
        <span class="n">Gv</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># pdb.set_trace()</span>
        <span class="n">lring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span>
        <span class="c1">#</span>
        <span class="c1"># Calculate interior normals</span>
        <span class="c1">#</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="c1">#</span>
        <span class="c1"># determine convex points</span>
        <span class="c1">#</span>
        <span class="c1"># pdb.set_trace()</span>
        <span class="n">tcc</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptconvex</span><span class="p">()</span>
        <span class="c1"># Np = self.Np</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#</span>
        <span class="c1"># retrieve</span>
        <span class="c1">#  npt points label sequence</span>
        <span class="c1">#  nseg segments label sequence</span>
        <span class="c1">#</span>
        <span class="c1"># vnodes do not necessarily start with a point</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ipt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>
            <span class="n">iseg</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ipt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">iseg</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>

        <span class="n">npt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="n">ipt</span><span class="p">]</span>
        <span class="n">nseg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="n">iseg</span><span class="p">]</span>
        <span class="c1"># print &quot;npt : &quot;,npt</span>
        <span class="c1"># print &quot;nseg : &quot;,nseg</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">npt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;something wrong with points&quot;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nseg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;something wrong with segments&quot;</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># Create middle point on lring</span>
        <span class="c1">#</span>
        <span class="c1"># Warning lring recopy the node at the end of the sequence</span>
        <span class="c1">#</span>
        <span class="c1"># A problem arises from the fact that a vnodes sequence</span>
        <span class="c1"># do no necessarily starts with a point (negative node)</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="n">tpm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ik</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lring</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pm</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">+</span> <span class="n">pm1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg</span><span class="p">[</span><span class="n">ik</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">nseg</span><span class="p">[</span><span class="n">ik</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tpm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pm</span><span class="p">)</span>
                <span class="n">pm1</span> <span class="o">=</span> <span class="n">pt</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pm1</span> <span class="o">=</span> <span class="n">pt</span>
        <span class="c1">#</span>
        <span class="c1"># Update position of points in Gv</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>
            <span class="c1">#nnode = -(nk+1)</span>
            <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nk</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nk</span><span class="p">])</span>

        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>

        <span class="c1">#</span>
        <span class="c1"># Determine diffraction points</span>
        <span class="c1">#</span>
        <span class="c1"># deg2 : if null:</span>
        <span class="c1">#           the point is kept</span>
        <span class="c1">#        if convex:</span>
        <span class="c1">#           the point is kept</span>
        <span class="c1">#        else:</span>
        <span class="c1">#           the point is not kept</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;indoor&#39;</span><span class="p">]:</span>
            <span class="n">uconvex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># convex point position</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uconvex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># convex point position</span>
        <span class="c1"># planar point (joining two parallel segment)</span>
        <span class="n">uzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># degree 2 paralell points are often doors and windows</span>
        <span class="n">udiffdoor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">uzero</span><span class="p">,</span> <span class="n">udeg2</span><span class="p">)</span>
        <span class="n">udiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">uconvex</span><span class="p">,</span> <span class="n">udiffdoor</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="s1">&#39;int&#39;</span><span class="p">)</span>  <span class="c1"># diffracting point</span>
        <span class="c1"># print &quot;vnodes&quot;,self.vnodes</span>
        <span class="c1"># print &quot;tcc : &quot;,tcc</span>
        <span class="c1"># print &quot;uzero : &quot;,uzero</span>
        <span class="c1"># print &quot;udiffdoor : &quot;,udiffdoor</span>
        <span class="c1"># print &quot;udiff&quot;,udiff</span>
        <span class="c1"># print &quot;udeg2&quot;,udeg2</span>
        <span class="c1"># print &quot;npt&quot;,npt</span>
        <span class="c1"># if udiff!=[]:</span>
        <span class="c1">#    print &quot;diff : &quot;,npt[udiff]</span>
        <span class="c1"># if udeg2!=[]:</span>
        <span class="c1">#    print &quot;deg2 : &quot;,npt[udeg2]</span>
        <span class="c1"># if uzero!=[]:</span>
        <span class="c1">#    print &quot;zero :&quot;,npt[uzero]</span>
        <span class="c1">#</span>
        <span class="c1"># if show == True display points and polygon</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="n">points1</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">(</span><span class="n">lring</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">uconvex</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">udiffdoor</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">GRAY</span><span class="p">)</span>

            <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#6699cc&#39;</span><span class="p">,</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="c1"># pdb.set_trace()</span>
        <span class="c1">#</span>
        <span class="c1">#  1) Calculate node-node visibility</span>
        <span class="c1">#</span>
        <span class="c1"># The algorithm exploits definition of convexity.</span>
        <span class="c1">#</span>
        <span class="c1"># Between all combinations of diffracting points</span>
        <span class="c1"># create a segment and check whether it is fully included in the</span>
        <span class="c1"># polygon.</span>
        <span class="c1"># If verified then there is a visibility between the 2 points.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">udiff</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">seg</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">(((</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
                <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1">#  2) Calculate edge-edge and node-edge visibility</span>
        <span class="c1">#</span>

        <span class="k">for</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>   <span class="c1"># loop on range of number of points</span>
            <span class="n">ptk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">nk</span><span class="p">]</span>     <span class="c1"># tail point</span>
            <span class="c1"># head point (%Np to get 0 as last point)</span>
            <span class="n">phk</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]</span>

            <span class="c1"># lnk : unitary vector on segment nk</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="n">phk</span> <span class="o">-</span> <span class="n">ptk</span>
            <span class="n">nlk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">lk</span><span class="p">))</span>
            <span class="n">lnk</span> <span class="o">=</span> <span class="n">lk</span> <span class="o">/</span> <span class="n">nlk</span>

            <span class="c1"># the epsilon is (1/1000) of the segment length</span>
            <span class="n">epsilonk</span> <span class="o">=</span> <span class="n">nlk</span> <span class="o">/</span> \
                <span class="mf">1000.</span>  <span class="c1"># this can be dangerous (epsilon can be large)</span>

            <span class="c1"># x--o----------------------o--x</span>
            <span class="c1">#    +eps                  -eps</span>
            <span class="n">pcornert</span> <span class="o">=</span> <span class="n">ptk</span> <span class="o">+</span> <span class="n">lnk</span> <span class="o">*</span> <span class="n">epsilonk</span>  <span class="c1"># + n[:,nk]*epsilon</span>
            <span class="n">pcornerh</span> <span class="o">=</span> <span class="n">phk</span> <span class="o">-</span> <span class="n">lnk</span> <span class="o">*</span> <span class="n">epsilonk</span>  <span class="c1"># + n[:,nk]*epsilon</span>

        <span class="c1">#</span>
        <span class="c1"># in any case no ray towark nk</span>
        <span class="c1"># if nk is convex no ray toward (nk-1)%Np</span>
        <span class="c1">#</span>
        <span class="c1"># start from the two extremity of the segment</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pcorner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">pcornert</span><span class="p">,</span> <span class="n">pcornerh</span><span class="p">]):</span>
                <span class="c1">#</span>
                <span class="c1">#  if tail point</span>
                <span class="c1">#           remove nk segment</span>
                <span class="c1">#  and if the point is convex</span>
                <span class="c1">#          remove previous segment</span>
                <span class="c1">#</span>
                <span class="c1">#  si point head</span>
                <span class="c1">#</span>
                <span class="n">listpoint</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>
                <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>   <span class="c1"># remove current point</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first iteration pcornert</span>
                    <span class="k">if</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">uconvex</span><span class="p">:</span>  <span class="c1"># == 1</span>
                        <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">nk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># second iteration pcornerh</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span> <span class="ow">in</span> <span class="n">uconvex</span><span class="p">:</span>  <span class="c1"># ==1</span>
                        <span class="n">listpoint</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="n">listpoint</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">ns</span><span class="p">]</span>
                    <span class="n">phs</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="p">(</span><span class="n">ns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]</span>
                    <span class="c1"># Add B.Uguen 2/01/2014 no possible visibility relation</span>
                    <span class="c1"># between aligned segments</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">is_aligned3</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">phs</span><span class="p">,</span> <span class="n">ptk</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_aligned3</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">phs</span><span class="p">,</span> <span class="n">phk</span><span class="p">))):</span>
                        <span class="n">ls</span> <span class="o">=</span> <span class="n">phs</span> <span class="o">-</span> <span class="n">pts</span>
                        <span class="n">nls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">ls</span><span class="p">))</span>
                        <span class="n">lns</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">/</span> <span class="n">nls</span>
                        <span class="n">epsilons</span> <span class="o">=</span> <span class="n">nls</span> <span class="o">/</span> <span class="mf">1000.</span>
                        <span class="n">pte</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">+</span> <span class="n">lns</span> <span class="o">*</span> <span class="n">epsilons</span>  <span class="c1"># + n[:,ns]*epsilon</span>
                        <span class="n">phe</span> <span class="o">=</span> <span class="n">phs</span> <span class="o">-</span> <span class="n">lns</span> <span class="o">*</span> <span class="n">epsilons</span>  <span class="c1"># + n[:,ns]*epsilon</span>
                        <span class="n">tbr</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">bitreverse</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.</span>
                        <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">tbr</span><span class="p">:</span>
                            <span class="n">pa</span> <span class="o">=</span> <span class="n">pte</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">phe</span> <span class="o">-</span> <span class="n">pte</span><span class="p">)</span>
                            <span class="n">seg</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">pcorner</span><span class="p">,</span> <span class="n">pa</span><span class="p">))</span>
                            <span class="c1"># print &quot;seg: &quot;,seg.xy</span>
                            <span class="c1"># if npt[nk] == -3:</span>
                            <span class="c1">#    plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),linewidth=0.2,color=&#39;k&#39;)</span>
                            <span class="c1">#    plt.draw()</span>
                            <span class="c1"># topological error can be raised here</span>
                            <span class="n">seg2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>
                            <span class="c1"># if self.contains(seg):</span>
                            <span class="k">if</span> <span class="n">seg2</span><span class="o">.</span><span class="n">almost_equals</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
                                <span class="c1"># print alpha,nk,ns</span>
                                <span class="c1"># plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),linewidth=2,color=&#39;r&#39;)</span>
                                <span class="c1"># Gv.add_edge(-(uconvex[nk]+1),ns+1,weight=10)</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">nk</span> <span class="ow">in</span> <span class="n">udiff</span><span class="p">:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">npt</span><span class="p">[</span><span class="n">nk</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="c1"># plt.plot(np.array([Gv.pos[npt[nk]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[npt[nk]][1],Gv.pos[nseg[ns]][1]]),&#39;r&#39;)</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span> <span class="ow">in</span> <span class="n">udiff</span><span class="p">:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">npt</span><span class="p">[(</span><span class="n">nk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Np</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="c1"># plt.plot(np.array([Gv.pos[npt[(nk+1)%Np]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[npt[(nk+1)%Np]][1],Gv.pos[nseg[ns]][1]]),&#39;g&#39;)</span>
                                    <span class="c1"># plt.draw()</span>
                                <span class="c1"># if i==1:</span>
                                <span class="c1"># if (((nseg[nk]==10) &amp; (nseg[ns]==7)) or</span>
                                <span class="c1">#    ((nseg[nk]==7) &amp; (nseg[ns]==10))):</span>
                                <span class="c1">#    pdb.set_trace()</span>
                                <span class="k">if</span> <span class="n">nseg</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;eded&#39;</span><span class="p">]:</span>
                                        <span class="n">Gv</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                                            <span class="n">nseg</span><span class="p">[</span><span class="n">nk</span><span class="p">],</span> <span class="n">nseg</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="c1"># else:</span>
                                    <span class="c1">#    print nseg[nk],nseg[ns]</span>
                                    <span class="c1">#    print pts,phs</span>
                                    <span class="c1">#    print ptk,phk</span>
                                    <span class="c1"># if (((nseg[nk]==10) &amp; (nseg[ns]==7)) or</span>
                                    <span class="c1">#    ((nseg[nk]==7) &amp; (nseg[ns]==10))):</span>
                                    <span class="c1">#    plt.plot(np.array([Gv.pos[nseg[nk]][0],Gv.pos[nseg[ns]][0]]),np.array([Gv.pos[nseg[nk]][1],Gv.pos[nseg[ns]][1]]),&#39;b&#39;)</span>
                                    <span class="c1">#    plt.plot(np.array([pcorner[0],pa[0]]),np.array([pcorner[1],pa[1]]),&#39;b&#39;)</span>
                                    <span class="c1">#    print &quot;seg: &quot;,seg.xy</span>
                                    <span class="c1">#    print &quot;seg2: &quot;,seg2.xy</span>
                                    <span class="c1">#    print nseg[nk],nseg[ns]</span>
                                    <span class="c1">#    print pcorner , ptk</span>
                                    <span class="c1">#    print  alpha , pa ,pte</span>
                                    <span class="c1">#    plt.draw()</span>
                                    <span class="c1">#    raw_input()</span>
                                <span class="k">break</span>
                    <span class="c1"># else:</span>
                        <span class="c1"># print p</span>
                        <span class="c1"># print ns</span>
                        <span class="c1"># print nk</span>
                        <span class="c1"># print &#39;nsegnk : &#39;,nseg[nk]</span>
                        <span class="c1"># print &#39;nsegns&#39;, nseg[ns]</span>
                        <span class="c1"># print &#39;ptk : &#39;,ptk</span>
                        <span class="c1"># print &#39;phk : &#39;,phk</span>
                        <span class="c1"># print &#39;pts : &#39;,pts</span>
                        <span class="c1"># print &#39;phs : &#39;,phs</span>
                        <span class="c1"># print &quot;aligne :&quot;,nseg[nk],nseg[ns]</span>
                        <span class="c1"># pdb.set_trace()</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Gv</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>
            <span class="n">uneg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">upos</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">uneg</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">ndnd</span><span class="p">,</span> <span class="n">nded</span><span class="p">,</span> <span class="n">eded</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">edgetype</span><span class="p">(</span><span class="n">Gv</span><span class="p">)</span>

            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">eded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">ndnd</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">nded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1">#label = {}</span>
            <span class="c1"># for (u,v) in Gv.edges():</span>
            <span class="c1">#    d = Gv.get_edge_data(u,v)</span>
            <span class="c1">#    label[(u,v)]=d[&#39;weight&#39;]</span>

            <span class="c1"># edge_label=nx.draw_networkx_edge_labels(Gv,Gv.pos,edge_labels=label)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">Gv</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.showGv"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.showGv">[docs]</a>    <span class="k">def</span> <span class="nf">showGv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; show graph Gv</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        display</span>
<span class="sd">        fig</span>
<span class="sd">        ax</span>
<span class="sd">        ndnd    : boolean</span>
<span class="sd">            display node/node</span>
<span class="sd">        nded    : boolean</span>
<span class="sd">            display node/edge</span>
<span class="sd">        eded    : boolean</span>
<span class="sd">            display edge/edge</span>
<span class="sd">        linewidth: float</span>
<span class="sd">            default 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;ndnd&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s1">&#39;nded&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;ndnd&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span>
                    <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>

        <span class="n">lring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">MultiPoint</span><span class="p">(</span><span class="n">lring</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tcc</span><span class="p">[</span><span class="n">k</span> <span class="o">%</span> <span class="n">Np</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">GRAY</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;#6699cc&#39;</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;#6699cc&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Gv</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span>

        <span class="n">uneg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">upos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">upos</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">nodelist</span><span class="o">=</span><span class="n">uneg</span><span class="p">,</span>
                                   <span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">ndnd</span><span class="p">,</span> <span class="n">nded</span><span class="p">,</span> <span class="n">eded</span> <span class="o">=</span> <span class="n">gru</span><span class="o">.</span><span class="n">edgetype</span><span class="p">(</span><span class="n">Gv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;eded&#39;</span><span class="p">]:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">eded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ndnd&#39;</span><span class="p">]:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">ndnd</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;nded&#39;</span><span class="p">]:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">Gv</span><span class="p">,</span> <span class="n">Gv</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">edgelist</span><span class="o">=</span><span class="n">nded</span><span class="p">,</span>
                                   <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="Polygon.ptconvex2"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.ptconvex2">[docs]</a>    <span class="k">def</span> <span class="nf">ptconvex2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine convex / concave points in the Polygon</span>

<span class="sd">            !!! Warning !!! cvex and ccve can be switched</span>
<span class="sd">            depends on the Polygon direction of travel</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cvex : list of convex points</span>
<span class="sd">        ccve : list of concave points</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import shapely.geometry as shg</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; points  = shg.MultiPoint([(0, 0), (0, 1), (3.2, 1), (3.2, 0.7), (0.4, 0.7), (0.4, 0)])</span>
<span class="sd">            &gt;&gt;&gt; polyg1   = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; cvex,ccave   = polyg.ptconvex2() </span>
<span class="sd">            &gt;&gt;&gt; points  = shg.MultiPoint([(0, 0), (0, 1), (-3.2, 1), (-3.2, 0.7), (-0.4, 0.7), (-0.4, 0)])</span>
<span class="sd">            &gt;&gt;&gt; polyg1   = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; cvex,ccave   = polyg.ptconvex2() </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coorddeter</span><span class="p">()</span>

        <span class="n">pts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vnodes</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signedarea</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cw</span> <span class="o">=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cw</span> <span class="o">=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
        <span class="n">cvex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">ccve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="o">~</span><span class="n">cw</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">cvex</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ccve</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="Polygon.ptconvex"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Polygon.ptconvex">[docs]</a>    <span class="k">def</span> <span class="nf">ptconvex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of booleans indicating points convexity</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        display : boolean</span>
<span class="sd">            default False</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        tcc     : np.array (1x Nseg)</span>
<span class="sd">            1 if convex , -1 if concav , 0 if plane</span>
<span class="sd">        n       :  array(2xNseg)</span>
<span class="sd">            segments normals</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. plot::</span>
<span class="sd">            :include-source:</span>

<span class="sd">            &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">            &gt;&gt;&gt; import shapely.geometry as shg</span>
<span class="sd">            &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">            &gt;&gt;&gt; points  = shg.MultiPoint([(0, 0), (0, 1), (3.2, 1), (3.2, 0.7), (0.4, 0.7), (0.4, 0)])</span>
<span class="sd">            &gt;&gt;&gt; N = len(points)</span>
<span class="sd">            &gt;&gt;&gt; polyg   = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; tcc,n   = polyg.ptconvex()</span>
<span class="sd">            &gt;&gt;&gt; #k = 0</span>
<span class="sd">            &gt;&gt;&gt; #for p in points:</span>
<span class="sd">            &gt;&gt;&gt; #  if tcc[k] == 1 :</span>
<span class="sd">            &gt;&gt;&gt; #      plt.plot(p.x, p.y, &#39;o&#39;, color=&#39;red&#39;,alpha=1)</span>
<span class="sd">            &gt;&gt;&gt; #  else:</span>
<span class="sd">            &gt;&gt;&gt; #      plt.plot(p.x, p.y, &#39;o&#39;, color=&#39;blue&#39;,alpha=0.3)</span>
<span class="sd">            &gt;&gt;&gt; #  k = k+1</span>
<span class="sd">            &gt;&gt;&gt; #polyg.plot()</span>
<span class="sd">            &gt;&gt;&gt; #plt.figure()</span>
<span class="sd">            &gt;&gt;&gt; #points  = shg.MultiPoint([(0, 0), (1, 1), (2, 0), (1, 0)])</span>
<span class="sd">            &gt;&gt;&gt; #poly    = Polygon(points)</span>
<span class="sd">            &gt;&gt;&gt; #tcc,n   = polyg.ptconvex()</span>
<span class="sd">            &gt;&gt;&gt; #poly.plot()</span>


<span class="sd">        Notes</span>
<span class="sd">        ------</span>

<span class="sd">            This function determines the convex and concav points of a polygon.</span>
<span class="sd">            As there is no orientation convention for the polygon the sign of the cross</span>
<span class="sd">            product can&#39;t be directly interpreted. So we exploit the following</span>
<span class="sd">            property :</span>

<span class="sd">            Let N be the number of points of the Polygon. N  = Nx + Nc where</span>
<span class="sd">            Nx is the number of convex points and Nc the number of concav points</span>

<span class="sd">            We have Nx &gt;= Nc</span>

<span class="sd">            If a point is common to two parallel segments, the cross product is = 0</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        Lr2n</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exterior</span>

        <span class="c1">#</span>
        <span class="c1"># Calculate interior normals</span>
        <span class="c1">#</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lring</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">Nseg</span> <span class="o">=</span> <span class="n">Np</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">Lr2n</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">tcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># cross product between two adjascent normals</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nseg</span><span class="p">):</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:,</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">Nseg</span><span class="p">]</span>
            <span class="n">nkp1</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nk</span><span class="p">,</span> <span class="n">nkp1</span><span class="p">)</span>
            <span class="n">tcc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1">#</span>
        <span class="c1"># warning this test is fragile</span>
        <span class="c1">#</span>
        <span class="c1"># debug : print tcc</span>
        <span class="c1">#</span>
        <span class="c1"># The purpose here is to remove flat transition</span>
        <span class="c1">#</span>
        <span class="n">upos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">&gt;</span> <span class="mf">1e-2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">uneg</span><span class="p">):</span>
            <span class="n">nconvex</span> <span class="o">=</span> <span class="n">uneg</span>
            <span class="n">nconcav</span> <span class="o">=</span> <span class="n">upos</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">uneg</span><span class="p">):</span>
            <span class="n">nconvex</span> <span class="o">=</span> <span class="n">upos</span>
            <span class="n">nconcav</span> <span class="o">=</span> <span class="n">uneg</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upos</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">uneg</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;polygon is a star&quot;</span><span class="p">)</span>
            <span class="c1"># self.plot()</span>
            <span class="c1"># pdb.set_trace()</span>

        <span class="n">tcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Np</span><span class="p">)</span>
        <span class="n">tcc</span><span class="p">[</span><span class="n">nconvex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tcc</span><span class="p">[</span><span class="n">nconcav</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># print &quot;ptseg tcc &quot;,tcc</span>
        <span class="n">upos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tcc</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tcc</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Geomview"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomview">[docs]</a><span class="k">class</span> <span class="nc">Geomview</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">PyLayers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Geomview file class</span>

<span class="sd">    This class is parent of  GeomVect Geomlist Geomoff</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    show3</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span> <span class="s2">&quot;geom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Geomview.show3"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomview.show3">[docs]</a>    <span class="k">def</span> <span class="nf">show3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. todo:</span>
<span class="sd">             change  background</span>
<span class="sd">             look for other geomview options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chaine</span> <span class="o">=</span> <span class="s2">&quot;geomview  -b 1 1 1 &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot; 2&gt;/dev/null &amp;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Geomlist</span><span class="p">(</span><span class="n">Geomview</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Geomlist.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Geomlist.__init__.html#pylayers.util.geomutil.Geomlist.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">_filename</span> <span class="o">=</span> <span class="n">_filename</span> <span class="o">+</span> <span class="s1">&#39;.list&#39;</span>
        <span class="n">Geomview</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">)</span></div>

<div class="viewcode-block" id="Geomlist.append"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Geomlist.append.html#pylayers.util.geomutil.Geomlist.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           append a line in .list file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strg</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="GeomVect"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.GeomVect">[docs]</a><span class="k">class</span> <span class="nc">GeomVect</span><span class="p">(</span><span class="n">Geomview</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Geomview VECT file class</span>

<span class="sd">       + NPolylines  NVertices  NColors</span>
<span class="sd">       + Nv[0] ... Nv[NPolylines-1]     # number of vertices in each polyline</span>
<span class="sd">       + Nc[0] ... Nc[NPolylines-1]     # number of colors supplied in each polyline</span>
<span class="sd">       + Vert[0] ... Vert[NVertices-1]  # All the vertices (3*NVertices floats)</span>
<span class="sd">       + Color[0] ... Color[NColors-1]  # All the colors   (4*NColors floats, RGBA)</span>

<span class="sd">        VECT objects represent lists of polylines (strings of connected line segments, possibly closed).</span>

<span class="sd">       A degenerate polyline can be used to represent a point:</span>
<span class="sd">       A VECT file begins with the key word VECT or 4VECT and three integers:</span>

<span class="sd">       NLines, NVertices, and NColors.</span>
<span class="sd">           Here NLines is the number of polylines in the file,</span>
<span class="sd">           NVertices the total number of vertices, and NColors the number of</span>
<span class="sd">           colors as explained below.</span>
<span class="sd">           Next come NLines 16-bit integers</span>
<span class="sd">       Nv[0] Nv[1] Nv[2] ... Nv[NLines-1]</span>
<span class="sd">           giving the number of vertices in each polyline.</span>
<span class="sd">           A negative number indicates a closed polyline; 1 denotes a single-pixel point.</span>
<span class="sd">           The sum (of absolute values) of the Nv[i] must equal NVertices.</span>
<span class="sd">           Next come NLines more 16-bit integers</span>
<span class="sd">           Nc[i]: the number of colors in each polyline.</span>
<span class="sd">           Normally one of three values:</span>
<span class="sd">                0 : No color is specified for this polyline.</span>
<span class="sd">                    It&#39;s drawn in the same color as the previous polyline.</span>
<span class="sd">                1 : A single color is specified.</span>
<span class="sd">                    The entire polyline is drawn in that color.</span>
<span class="sd">                abs(Nv[i]) : Each vertex has a color.</span>
<span class="sd">                    Either each segment is drawn in the corresponding color,</span>
<span class="sd">                    or the colors are smoothly interpolated along the line segments,</span>
<span class="sd">                    depending on the implementation.</span>

<span class="sd">            Next come NVertices groups of 3 or 4 floating-point numbers:</span>
<span class="sd">                            the coordinates of all the vertices.</span>
<span class="sd">            If the keyword is 4VECT then there are 4 values per vertex.</span>
<span class="sd">            The first abs(Nv[0]) of them form the first polyline,</span>
<span class="sd">                    the next abs(Nv[1]) form the second and so on.</span>
<span class="sd">            Finally NColors groups of 4 floating-point numbers give red,</span>
<span class="sd">                    green, blue and alpha (opacity) values.</span>
<span class="sd">            The first Nc[0] of them apply to the first polyline, and so on.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>

<span class="sd">    geomBase</span>
<span class="sd">        display a frame</span>
<span class="sd">    ellipse</span>
<span class="sd">        display an ellipse</span>
<span class="sd">    points</span>
<span class="sd">        display a set of points</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GeomVect.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.GeomVect.__init__.html#pylayers.util.geomutil.GeomVect.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="o">=</span><span class="s1">&#39;geomdef&#39;</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">_filename</span> <span class="o">=</span> <span class="n">_filename</span> <span class="o">+</span> <span class="s1">&#39;.vect&#39;</span>
        <span class="n">Geomview</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeomVect.segments"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.GeomVect.segments">[docs]</a>    <span class="k">def</span> <span class="nf">segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">i2d</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; display segments</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        ds   : dictionnary</span>
<span class="sd">            len ds</span>
<span class="sd">        i2d  : boolean (defaut True)</span>
<span class="sd">            2d indicator</span>
<span class="sd">        linewidth : float</span>
<span class="sd">            default 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;appearance { linewidth </span><span class="si">%d</span><span class="s2"> }</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">linewidth</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VECT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">Ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Ns</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># 3 Lines 6 Vertices 3 colors</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;2 &quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ns</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0 &quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pta</span><span class="p">,</span> <span class="n">phe</span><span class="p">)</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i2d</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pta</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">phe</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeomVect.geomBase"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.GeomVect.geomBase">[docs]</a>    <span class="k">def</span> <span class="nf">geomBase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span> <span class="n">col</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a geomview vect file for vizualisation of a frame</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        by default the geomview filename is base0.vect</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        M     : ndarray (3 x 3 )</span>
<span class="sd">            [ v1, v2, v3 ]</span>
<span class="sd">        pt    : np.array</span>
<span class="sd">            origin point  (default (0,0,0))</span>
<span class="sd">        col   :</span>
<span class="sd">            color (3x3)</span>
<span class="sd">        linewidth :</span>
<span class="sd">            linewidth (default 3)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; v1 = np.array([1,0,0])</span>
<span class="sd">        &gt;&gt;&gt; v2 = np.array([0,1,0])</span>
<span class="sd">        &gt;&gt;&gt; v3 = np.array([0,0,1])</span>
<span class="sd">        &gt;&gt;&gt; M  = np.vstack((v1,v2,v3))</span>
<span class="sd">        &gt;&gt;&gt; #gv = GeomVect(&#39;test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #gv.geomBase(M)</span>
<span class="sd">        &gt;&gt;&gt; #gv.show3()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;appearance { linewidth </span><span class="si">%d</span><span class="s2"> }</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">linewidth</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VECT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;3 6 3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1"># 3 Lines 6 Vertices 3 colors</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;2 2 2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1"># 2 points per lines</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1 1 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>   <span class="c1"># 1 color per line</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                          <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                          <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                          <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2">  0.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2">  0.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2">  0.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
        <span class="c1"># fo.write(&quot;{&lt;}\n&quot;)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeomVect.points"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.GeomVect.points">[docs]</a>    <span class="k">def</span> <span class="nf">points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">colorname</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Geomview display a set of points with color</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pt</span>
<span class="sd">           sequence of points np.ndarray or dictionnary whose value is a tuple (x,y,z)</span>
<span class="sd">        colorname</span>
<span class="sd">            a colorname from coldict keys</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; import scipy as sp</span>
<span class="sd">        &gt;&gt;&gt; pt1 = sp.rand(3,10)</span>
<span class="sd">        &gt;&gt;&gt; pt2 = { 1:(0,0,0),2:(10,10,10),3:(0,10,0),4:(10,0,0)}</span>
<span class="sd">        &gt;&gt;&gt; gv1 = GeomVect(&#39;test1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gv1.points(pt1)</span>
<span class="sd">        &gt;&gt;&gt; #gv1.show3()</span>
<span class="sd">        &gt;&gt;&gt; gv2 = GeomVect(&#39;test2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; gv2.points(pt2)</span>
<span class="sd">        &gt;&gt;&gt; #gv2.show3()</span>

<span class="sd">        .. todo::</span>
<span class="sd">            colorbar depending of a value associated with point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">npt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">snpt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">npt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">snpt2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">npt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npt</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">npt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;appearance{</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;linewidth 8}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VECT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">snpt2</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1 &quot;</span> <span class="o">*</span> <span class="n">npt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1 &quot;</span> <span class="o">*</span> <span class="n">npt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ESPHERE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npt</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">i</span><span class="p">]][</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">chaine</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">z</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npt</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">chaine</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">z</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>

        <span class="n">coldic</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">coldict</span><span class="p">()</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">rgb</span><span class="p">(</span><span class="n">coldic</span><span class="p">[</span><span class="n">colorname</span><span class="p">],</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npt</span><span class="p">):</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> 1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Geomoff"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff">[docs]</a><span class="k">class</span> <span class="nc">Geomoff</span><span class="p">(</span><span class="n">Geomview</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Class Geomview OFF File (Object File Format)</span>
<span class="sd">    [ST][C][N][4][n]OFF  #header keyword</span>
<span class="sd">    [Ndim] # spac dimension of vertices, present only if nOFF</span>
<span class="sd">    NVertices NFaces NEdges</span>

<span class="sd">    x[0],y[0] z[0]</span>

<span class="sd">    # Vertices,possibly with normals</span>
<span class="sd">    #colors, and/or texture coordinates, in that order, if the</span>
<span class="sd">    # prefixes N , C , ST are present</span>
<span class="sd">    # If 4OFF , each vertex has 4 components</span>
<span class="sd">    # including a final homogeneous component</span>
<span class="sd">    # If nOFF, each vertex has Ndim components</span>
<span class="sd">    # If 4nOFF , each vertex has Ndim+1 components</span>
<span class="sd">    ....</span>
<span class="sd">    x[NVertices-1],y[NVertices-1],z[NVertices-1]</span>

<span class="sd">    # Faces</span>
<span class="sd">    # Nv = # vertices on this face</span>
<span class="sd">    # v[0] ... v[Nv-1] : vertex indices</span>
<span class="sd">    # in range 0... NVertices -1</span>

<span class="sd">    Nv v[0] v[1] ....v[Nv-1] colorspec</span>

<span class="sd">    # colorspec continues past v[Nv-1]</span>
<span class="sd">    # to end-of-line may be 0 to 4 numbers</span>
<span class="sd">    # nothing default</span>
<span class="sd">    # integer : colormap index (read from the file cmap.fmap)</span>
<span class="sd">    # 3 or 4 integers RGB[A] values 0..255</span>
<span class="sd">    #</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Geomoff.__init__"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Geomoff.__init__.html#pylayers.util.geomutil.Geomoff.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="o">=</span><span class="s1">&#39;geomoff&#39;</span><span class="p">):</span>
        <span class="n">_filename</span> <span class="o">=</span> <span class="n">_filename</span> <span class="o">+</span> <span class="s1">&#39;.off&#39;</span>
        <span class="n">Geomview</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Geomoff.loadpt"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.loadpt">[docs]</a>    <span class="k">def</span> <span class="nf">loadpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load points</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lis</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s1">&#39;OFF&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;not an off file&#39;</span><span class="p">)</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">nf</span><span class="p">)</span>
        <span class="n">ne</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nv</span><span class="p">):</span>
            <span class="c1">#x,y,z = lis[k+1].split(&#39; &#39;)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">lis</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">pt</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span>
        <span class="k">return</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>

<div class="viewcode-block" id="Geomoff.savept"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.savept">[docs]</a>    <span class="k">def</span> <span class="nf">savept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptnew</span><span class="p">,</span> <span class="n">_fileoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lis</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">typ</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">ne</span> <span class="o">=</span> <span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">!=</span> <span class="s1">&#39;OFF&#39;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;not an off file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nv</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">nv</span><span class="p">)</span>
                <span class="n">nf</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">nf</span><span class="p">)</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;load off wrong number of values&#39;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">fileoff</span> <span class="o">=</span> <span class="n">pyu</span><span class="o">.</span><span class="n">getlong</span><span class="p">(</span><span class="n">_fileoff</span><span class="p">,</span> <span class="s2">&quot;geom&quot;</span><span class="p">)</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileoff</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nv</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ptnew</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptnew</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                                                  <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptnew</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="n">lis</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Geomoff.polygon"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.polygon">[docs]</a>    <span class="k">def</span> <span class="nf">polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  create geomview off for polygon</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p    : nparray</span>
<span class="sd">               sequence of points</span>
<span class="sd">        poly : list</span>
<span class="sd">               point numbers (index starting in 0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">npt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">npoly</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OFF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> 1 </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.000 0.000 0.000 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npt</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npoly</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">poly</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># fo.write(%6.3f %6.3f %6.3f 0.4\n&quot; % (col[0],col[1],col[2]))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0 1.0 1.0 0.4</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Geomoff.polygons"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.polygons">[docs]</a>    <span class="k">def</span> <span class="nf">polygons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">polys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create a gemoff file for a list of polygons</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p    : nparray</span>
<span class="sd">               sequence of points</span>
<span class="sd">        poly : list</span>
<span class="sd">               point numbers (index starting in 0)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">npt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">npoly</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OFF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npoly</span><span class="p">))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.000 0.000 0.000 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npt</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nv</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">poly</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># fo.write(%6.3f %6.3f %6.3f 0.4\n&quot; % (col[0],col[1],col[2]))</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0 0.0 1.0 0.4</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Geomoff.cylinder"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.cylinder">[docs]</a>    <span class="k">def</span> <span class="nf">cylinder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">nphi</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create a cylinder</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        r : radius</span>
<span class="sd">        l : length</span>
<span class="sd">        nphi : number of phi</span>
<span class="sd">        nl : number of l</span>
<span class="sd">        col : list [r,g,b]</span>
<span class="sd">        alpha : transparency</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">l</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">l</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">nl</span><span class="p">)</span>
        <span class="n">npoly</span> <span class="o">=</span> <span class="n">nphi</span> <span class="o">*</span> <span class="p">(</span><span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nedges</span> <span class="o">=</span> <span class="n">nphi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># fo.write(&quot;OFF\n&quot;)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OFF </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nphi</span> <span class="o">*</span> <span class="n">nl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npoly</span><span class="p">,</span> <span class="n">nedges</span><span class="p">))</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;0.000 0.000 0.000 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">tz</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">tphi</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly</span><span class="p">):</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">nphi</span>
            <span class="n">iphi</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="n">nphi</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">il</span> <span class="o">*</span> <span class="n">nphi</span> <span class="o">+</span> <span class="n">iphi</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">il</span> <span class="o">*</span> <span class="n">nphi</span> <span class="o">+</span> <span class="p">(</span><span class="n">iphi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nphi</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">il</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nphi</span> <span class="o">+</span> <span class="n">iphi</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">il</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nphi</span> <span class="o">+</span> <span class="p">(</span><span class="n">iphi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nphi</span>

            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 </span><span class="si">%i</span><span class="s2"> </span><span class="si">%i</span><span class="s2"> </span><span class="si">%i</span><span class="s2"> </span><span class="si">%i</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">str1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Geomoff.box"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.box">[docs]</a>    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extrem</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])):</span>
        <span class="sd">&quot;&quot;&quot; create a box</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        extrem : ndarray</span>
<span class="sd">                 (1x6) [xmin,xmax,ymin,ymax,zmin,zmax]</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; geo = Geomoff(&#39;test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo.box()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">zmin</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">zmax</span> <span class="o">=</span> <span class="n">extrem</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmin</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>
        <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span><span class="p">])</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;OFF</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;8 6 12</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>

        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 0 1 2 3 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 7 4 0 3 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 4 5 1 0 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 5 6 2 1 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 3 2 6 7 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;4 6 5 4 7 1 0 0 0.3</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Geomoff.pattern"><a class="viewcode-back" href="../../../modules/pylayers.util.geomutil.html#pylayers.util.geomutil.Geomoff.pattern">[docs]</a>    <span class="k">def</span> <span class="nf">pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; export antenna pattern in a geomview format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        theta : np.array (,Nt)</span>
<span class="sd">        phi   : np.array (,Np)</span>
<span class="sd">        E     : np.array complex  (Nt,Np)</span>
<span class="sd">        po    : origin (1x3)</span>
<span class="sd">        T     : rotation matrix (3x3)</span>
<span class="sd">        minr  : radius of minimum</span>
<span class="sd">        maxr  : radius of maximum</span>
<span class="sd">        ilog  : True (log) False (linear)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">           &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">           &gt;&gt;&gt; import numpy as np</span>
<span class="sd">           &gt;&gt;&gt; th = np.arange(0,np.pi,0.05)</span>
<span class="sd">           &gt;&gt;&gt; ph = np.arange(0,2*np.pi,0.05)</span>
<span class="sd">           &gt;&gt;&gt; E = 1.5*np.sin(th[:,np.newaxis])*np.cos(0*ph[np.newaxis,:])</span>
<span class="sd">           &gt;&gt;&gt; g = Geomoff(&#39;dipole&#39;)</span>
<span class="sd">           &gt;&gt;&gt; g.pattern(th,ph,E)</span>
<span class="sd">           &gt;&gt;&gt; g.show3()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;po&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                    <span class="s1">&#39;minr&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">&#39;maxr&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;Pat&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ilog&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">minr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;minr&#39;</span><span class="p">]</span>
        <span class="n">maxr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;maxr&#39;</span><span class="p">]</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span>
        <span class="n">ilog</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ilog&#39;</span><span class="p">]</span>
        <span class="n">po</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;po&#39;</span><span class="p">]</span>
        <span class="c1"># T is an unitary matrix</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">T</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">)</span>
        <span class="c1"># retrieving dimensions</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>  <span class="c1"># np.shape(theta)[0]</span>
        <span class="n">Np</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>  <span class="c1"># np.shape(phi)[1]</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="n">ilog</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="c1">#Th = np.outer(theta, np.ones(Np))</span>
        <span class="c1">#Ph = np.outer(np.ones(Nt), phi)</span>

        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">!=</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">Ry</span> <span class="o">=</span> <span class="n">minr</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxr</span> <span class="o">-</span> <span class="n">minr</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ry</span> <span class="o">=</span> <span class="n">maxr</span>
        <span class="c1"># x (Nt,Np)</span>
        <span class="c1"># y (Nt,Np)</span>
        <span class="c1"># z (Nt,Np)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">Ry</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Ry</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">Ry</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">phi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># p : Nt x Np x 3</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># antenna cs -&gt; glogal cs</span>
        <span class="c1"># q : Nt x Np x 3</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,klj-&gt;kli&#39;</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># translation</span>
        <span class="c1">#</span>
        <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">po</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">po</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">po</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">Npoints</span> <span class="o">=</span> <span class="n">Nt</span> <span class="o">*</span> <span class="n">Np</span>
        <span class="n">Nfaces</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Np</span>
        <span class="n">Nedge</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#</span>
        <span class="c1"># Colormap</span>
        <span class="c1">#</span>
        <span class="n">colmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span>
        <span class="n">Ncol</span> <span class="o">=</span> <span class="n">colmap</span><span class="o">.</span><span class="n">N</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">colmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Ncol</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">!=</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nt</span><span class="p">,</span> <span class="n">Np</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;COFF</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">chaine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Npoints</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Nfaces</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Nedge</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>
                <span class="n">cpos</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">cpos</span> <span class="o">=</span> <span class="n">cpos</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">ik</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span>

                <span class="n">ccol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="n">ik</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">ccol</span> <span class="o">=</span> <span class="n">ccol</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cpos</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">ccol</span> <span class="o">+</span> <span class="s1">&#39; 0.2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Np</span><span class="p">):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">*</span> <span class="n">Np</span> <span class="o">+</span> <span class="n">jj</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">*</span> <span class="n">Np</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Np</span><span class="p">)</span>
                <span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Np</span> <span class="o">+</span> <span class="n">jj</span>
                <span class="n">p4</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Np</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Np</span><span class="p">)</span>
                <span class="n">chaine</span> <span class="o">=</span> <span class="s1">&#39;4 &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">p4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; 0.5</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chaine</span><span class="p">)</span>

        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="angular"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.angular.html#pylayers.util.geomutil.angular">[docs]</a><span class="k">def</span> <span class="nf">angular</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; determine angle between p1 and p2 in inerval [0 2pi]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p1</span>
<span class="sd">        point p1</span>
<span class="sd">    p2</span>
<span class="sd">        point p2 origin</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    weird the origin is p2</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; p1 = np.array([0,0])</span>
<span class="sd">    &gt;&gt;&gt; p21 = np.array([1,0])</span>
<span class="sd">    &gt;&gt;&gt; p22 = np.array([1,1])</span>
<span class="sd">    &gt;&gt;&gt; p23 = np.array([0,1])</span>
<span class="sd">    &gt;&gt;&gt; p24 = np.array([-1,1])</span>
<span class="sd">    &gt;&gt;&gt; p25 = np.array([-1,0])</span>
<span class="sd">    &gt;&gt;&gt; p26 = np.array([-1,-1])</span>
<span class="sd">    &gt;&gt;&gt; p27 = np.array([0,-1])</span>
<span class="sd">    &gt;&gt;&gt; p28 = np.array([1,-1])</span>
<span class="sd">    &gt;&gt;&gt; a1  = angular(p21,p1)</span>
<span class="sd">    &gt;&gt;&gt; a2  = angular(p22,p1)</span>
<span class="sd">    &gt;&gt;&gt; a3  = angular(p23,p1)</span>
<span class="sd">    &gt;&gt;&gt; a4  = angular(p24,p1)</span>
<span class="sd">    &gt;&gt;&gt; a5  = angular(p25,p1)</span>
<span class="sd">    &gt;&gt;&gt; a6  = angular(p26,p1)</span>
<span class="sd">    &gt;&gt;&gt; a7  = angular(p27,p1)</span>
<span class="sd">    &gt;&gt;&gt; a8  = angular(p28,p1)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    vecang</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print DeprecationWarning(&#39;DEPRECATION WARNING : geomutil.angular going</span>
    <span class="c1">#                         deprecated  because wrong&#39;)</span>
    <span class="k">if</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">((</span><span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">return</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span></div>


<div class="viewcode-block" id="vecang"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.vecang.html#pylayers.util.geomutil.vecang">[docs]</a><span class="k">def</span> <span class="nf">vecang</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angle between v1 and v2 , result in [0,2*pi]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v1 : np.array (3 x Np)</span>
<span class="sd">        vector</span>
<span class="sd">    v2 : np.array (3 x Np)</span>
<span class="sd">        vector</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    alpha : np.array (3 x Np)</span>
<span class="sd">        radians</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">uneg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ang</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ang</span><span class="p">[</span><span class="n">uneg</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">ang</span><span class="p">[</span><span class="n">uneg</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ang</span></div>
    <span class="c1"># if ang &lt;0 :</span>
    <span class="c1">#     return (2*np.pi+ang)</span>
    <span class="c1"># else :</span>
    <span class="c1">#     return ang</span>


<div class="viewcode-block" id="SignedArea"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.SignedArea.html#pylayers.util.geomutil.SignedArea">[docs]</a><span class="k">def</span> <span class="nf">SignedArea</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]])):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the signed area of a sequence of points in a  plane</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p : array 2 x Np</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : float</span>
<span class="sd">        signed area of the sequence of points </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; p = np.array([[0,10,10,0],[0,0,-2,-2]])</span>
<span class="sd">    &gt;&gt;&gt; A = SignedArea(p)</span>
<span class="sd">    &gt;&gt;&gt; assert(A+20&lt;1e-15)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">/</span> <span class="mf">2.</span></div>


<div class="viewcode-block" id="Centroid"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Centroid.html#pylayers.util.geomutil.Centroid">[docs]</a><span class="k">def</span> <span class="nf">Centroid</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]])):</span>
    <span class="sd">&quot;&quot;&quot; Determine the centroid of the polygon defined by a sequence of points in a plane</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://en.wikipedia.org/wiki/Centroid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    p : np array </span>
<span class="sd">        polygon (2xNp)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    pc = Centroid()</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; p  = np.array([[0,10,10,0],[0,0,-2,-2]])</span>
<span class="sd">    &gt;&gt;&gt; pc = Centroid(p)</span>
<span class="sd">    &gt;&gt;&gt; d  = pc-np.array([5.,-1])</span>
<span class="sd">    &gt;&gt;&gt; md = np.dot(d,d)</span>
<span class="sd">    &gt;&gt;&gt; assert(md&lt;1e-15)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">SignedArea</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> \
        <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Cx</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">Cy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">::],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Cx</span><span class="p">,</span> <span class="n">Cy</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lr2n"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Lr2n.html#pylayers.util.geomutil.Lr2n">[docs]</a><span class="k">def</span> <span class="nf">Lr2n</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]]),</span> <span class="n">closed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Linear ring to normal</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p      : np.array (2xN)</span>
<span class="sd">        closed : boolean</span>
<span class="sd">            default True</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        n   : np.array (2xN)</span>
<span class="sd">              normal</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            This function returns the internal normals to the LinearString of a Polygon</span>

<span class="sd">            The algoritm exploits the algebraic relation which exists</span>
<span class="sd">            between points coordinates and normal coordinates which involves</span>
<span class="sd">            the quasi toeplitz matrix M</span>

<span class="sd">            [-1  1  0 0 0  ...]</span>
<span class="sd">            [0  -1  1 0 0  ...]</span>
<span class="sd">            [</span>
<span class="sd">            [</span>
<span class="sd">            [           0 -1 1]  (truncate here if LineRing is open)</span>
<span class="sd">            -------------------</span>
<span class="sd">            [1          0 0 -1]  (add this line if LineRing is closed)</span>

<span class="sd">            p0                   p1</span>
<span class="sd">            x------------------x</span>
<span class="sd">            |        |         |</span>
<span class="sd">            |        v  l       |</span>
<span class="sd">            |                  |</span>
<span class="sd">            |-&gt;              &lt;-|</span>
<span class="sd">            |        ^         |</span>
<span class="sd">            |        |         |</span>
<span class="sd">         p3 x------------------x p2</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import shapely.geometry as shg</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; points1 = shg.MultiPoint([(0, 0), (0, 1), (1, 1), (1,0 )])</span>
<span class="sd">    &gt;&gt;&gt; points2 = shg.MultiPoint([(0, 0), (1, 0), (1, 1), (0,1 )])</span>
<span class="sd">    &gt;&gt;&gt; poly1   = shg.Polygon(points1)</span>
<span class="sd">    &gt;&gt;&gt; poly2   = shg.Polygon(points2)</span>
<span class="sd">    &gt;&gt;&gt; lring1  = poly1.exterior</span>
<span class="sd">    &gt;&gt;&gt; lring2  = poly2.exterior</span>
<span class="sd">    &gt;&gt;&gt; x1,y1    = lring1.xy</span>
<span class="sd">    &gt;&gt;&gt; x2,y2    = lring2.xy</span>
<span class="sd">    &gt;&gt;&gt; p1 = np.array([x1[0:-1],y1[0:-1]])</span>
<span class="sd">    &gt;&gt;&gt; p2 = np.array([x2[0:-1],y2[0:-1]])</span>
<span class="sd">    &gt;&gt;&gt; n1 = Lr2n(p1)</span>
<span class="sd">    &gt;&gt;&gt; n2 = Lr2n(p2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Np</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">toeplitz</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">closed</span><span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">Np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Np</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">n</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="c1"># normalize normal</span>
    <span class="c1">#</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">T</span>
    <span class="n">modn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">modn</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">modn</span>
    <span class="c1">#</span>
    <span class="c1"># enforce inwards normal whatever the linear ring orientation</span>
    <span class="c1">#</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">SignedArea</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="o">-</span><span class="n">nn</span>
    <span class="k">return</span> <span class="n">nn</span></div>


<div class="viewcode-block" id="isBetween"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.isBetween.html#pylayers.util.geomutil.isBetween">[docs]</a><span class="k">def</span> <span class="nf">isBetween</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; test if p is between p1 and p2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    p1 : np.array</span>
<span class="sd">    p2 : np.array</span>
<span class="sd">    p  : np.array</span>
<span class="sd">    epsilon : float</span>
<span class="sd">        tolerance default 1e-5</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; p1 = np.array([0,0])</span>
<span class="sd">    &gt;&gt;&gt; p2 = np.array([2,0])</span>
<span class="sd">    &gt;&gt;&gt; p  = np.array([1,0])</span>
<span class="sd">    &gt;&gt;&gt; assert(isBetween(p1,p2,p)),&#39;error&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crossproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">crossproduct</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">epsilon</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">dotproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dotproduct</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">squaredlengthba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dotproduct</span> <span class="o">&gt;</span> <span class="n">squaredlengthba</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="pvec"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.pvec.html#pylayers.util.geomutil.pvec">[docs]</a><span class="k">def</span> <span class="nf">pvec</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; cross product between v1 and v2</span>

<span class="sd">     Parameters</span>
<span class="sd">     ----------</span>
<span class="sd">     v1 : numpy array</span>
<span class="sd">     v2 : numpy array</span>
<span class="sd">     Returns</span>
<span class="sd">     -------</span>
<span class="sd">     v3 = v1 x v2</span>

<span class="sd">     See Also</span>
<span class="sd">     --------</span>
<span class="sd">     np.cross</span>

<span class="sd">     Examples</span>
<span class="sd">     --------</span>
<span class="sd">     &gt;&gt;&gt; v1 = np.array([1,0,0])</span>
<span class="sd">     &gt;&gt;&gt; v2 = np.array([0,1,0])</span>
<span class="sd">     &gt;&gt;&gt; v3 = pvec(v1,v2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="o">-</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]])</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span></div>


<div class="viewcode-block" id="pvecn"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.pvecn.html#pylayers.util.geomutil.pvecn">[docs]</a><span class="k">def</span> <span class="nf">pvecn</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; cross product and normalization</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">     v1 : numpy array</span>
<span class="sd">     v2 : numpy array</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">     v3 = v1 x v2 / | v1 x v2 |</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; v1 = np.array([2,0,0])</span>
<span class="sd">    &gt;&gt;&gt; v2 = np.array([0,2,0])</span>
<span class="sd">    &gt;&gt;&gt; v3 = pvecn(v1,v2)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">        numpy.cross</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v4</span> <span class="o">=</span> <span class="n">v3</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="n">v3</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;error divide by zero in pvecn&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span></div>


<div class="viewcode-block" id="onb"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.onb.html#pylayers.util.geomutil.onb">[docs]</a><span class="k">def</span> <span class="nf">onb</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; orthonormal basis from 2 points defining an axe and a vector</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    A : np.array</span>
<span class="sd">        3 x n</span>
<span class="sd">    B : np.array</span>
<span class="sd">        3 x n</span>
<span class="sd">    v : np.array</span>
<span class="sd">        3 x n</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>


<span class="sd">    T basis (un,vn,wn)</span>
<span class="sd">        3 x n x 3</span>
<span class="sd">    (un,vn) is a basis in the plane transverse to the axis vn</span>
<span class="sd">    wn is the unitary vector along vector AB</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; A = np.array([[0,0,0,0],[1,2,3,4],[0,0,0,0]])</span>
<span class="sd">    &gt;&gt;&gt; B = np.array([[0,0,0,0],[1,2,3,4],[10,10,10,10]])</span>
<span class="sd">    &gt;&gt;&gt; v = np.array([[1,1,1,1],[0,0,0,0],[0,0,0,0]])</span>
<span class="sd">    &gt;&gt;&gt; onb(A,B,v)</span>
<span class="sd">    array([[[ 1.,  0.,  0.],</span>
<span class="sd">            [ 0.,  1.,  0.],</span>
<span class="sd">            [ 0.,  0.,  1.]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">           [[ 1.,  0.,  0.],</span>
<span class="sd">            [ 0.,  1.,  0.],</span>
<span class="sd">            [ 0.,  0.,  1.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">           [[ 1.,  0.,  0.],</span>
<span class="sd">            [ 0.,  1.,  0.],</span>
<span class="sd">            [ 0.,  0.,  1.]],</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">           [[ 1.,  0.,  0.],</span>
<span class="sd">            [ 0.,  1.,  0.],</span>
<span class="sd">            [ 0.,  0.,  1.]]])</span>


<span class="sd">    see also</span>
<span class="sd">    --------</span>

<span class="sd">    pylayers.util.geomutil.Geomvect.geomBase</span>
<span class="sd">    pylayers.util.mobility.body</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># np.random.seed(0)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># modab 1xN</span>
    <span class="n">modab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># wn 3xN</span>
    <span class="n">wn</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="n">modab</span>
    <span class="c1">#random_vector = np.random.rand(3,N)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">wn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">wn</span>
    <span class="n">modu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># un : 3xN</span>
    <span class="n">un</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">modu</span>
    <span class="c1"># vn : 3xN</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">wn</span><span class="p">,</span> <span class="n">un</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># pdb.set_trace()</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">un</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">wn</span><span class="p">))</span>
    <span class="c1"># reshape dimension for having index of cylinder axe first</span>
    <span class="c1"># N x 3 x 3</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">T</span></div>


<div class="viewcode-block" id="vec_sph"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.vec_sph.html#pylayers.util.geomutil.vec_sph">[docs]</a><span class="k">def</span> <span class="nf">vec_sph</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">ph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    vec_sph(th,ph)</span>

<span class="sd">    return Spherical orthonormal frame</span>

<span class="sd">    [ [ eth]</span>
<span class="sd">      [ eph]    (theta,phi)</span>
<span class="sd">      [ er ] ]</span>

<span class="sd">    See Also </span>
<span class="sd">    --------</span>

<span class="sd">    SphericalBasis</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">e_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)))</span>
    <span class="n">e_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">e_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)))</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">e_th</span><span class="p">,</span> <span class="n">e_ph</span><span class="p">,</span> <span class="n">e_r</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">B</span><span class="p">)</span></div>


<div class="viewcode-block" id="ellipse"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.ellipse.html#pylayers.util.geomutil.ellipse">[docs]</a><span class="k">def</span> <span class="nf">ellipse</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">vth</span><span class="p">,</span> <span class="n">vph</span><span class="p">,</span> <span class="n">Eth</span><span class="p">,</span> <span class="n">Eph</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; build a geomview file of an ellipse</span>

<span class="sd">     Parameters</span>
<span class="sd">     ----------</span>

<span class="sd">     fd    : file descriptor</span>
<span class="sd">     p     : ellipse center</span>
<span class="sd">     vth   : unitary vector along theta</span>
<span class="sd">     vph   : unitary vector along phi</span>
<span class="sd">     Eth   : complex</span>
<span class="sd">     Eph   : complex</span>
<span class="sd">     N     : descretization step</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pas</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">N</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">pas</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="n">Rth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Eth</span><span class="p">)</span>
    <span class="n">Rph</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Eph</span><span class="p">)</span>
    <span class="n">delta_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Eth</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Eth</span><span class="p">))</span>
    <span class="n">delta_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Eph</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Eph</span><span class="p">))</span>

    <span class="n">pu1</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">Rth</span> <span class="o">*</span> <span class="n">vth</span>
    <span class="n">pu2</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">Rph</span> <span class="o">*</span> <span class="n">vph</span>

    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">uN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">Al_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">delta_th</span><span class="p">)</span>
    <span class="n">Al_ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">delta_ph</span><span class="p">)</span>

    <span class="n">U1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vth</span><span class="p">,</span> <span class="n">uN</span><span class="p">)</span>
    <span class="n">U2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vph</span><span class="p">,</span> <span class="n">uN</span><span class="p">)</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">uN</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Un point de l&#39;ellipse</span>
    <span class="c1">#</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="p">(</span><span class="n">Rth</span> <span class="o">*</span> <span class="n">U1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Al_th</span><span class="p">)</span> <span class="o">+</span> <span class="n">Rph</span> <span class="o">*</span> <span class="n">U2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Al_ph</span><span class="p">))</span>

    <span class="n">vEre</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Eth</span><span class="p">)</span> <span class="o">*</span> <span class="n">vth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Eph</span><span class="p">)</span> <span class="o">*</span> <span class="n">vph</span><span class="p">)</span>
    <span class="n">vEim</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Eth</span><span class="p">)</span> <span class="o">*</span> <span class="n">vth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Eph</span><span class="p">)</span> <span class="o">*</span> <span class="n">vph</span><span class="p">)</span>

    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;appearance { linewidth 3 }</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VECT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]))</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="s2"> </span><span class="si">%6.3f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="s2"> </span><span class="si">%g</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.normalize.html#pylayers.util.geomutil.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; normalize an array of N ndim vectors</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    vec : ndarray (N x ndim)</span>
<span class="sd">        N ndim vectors</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vecn : ndarray (N x ndim)</span>
<span class="sd">        N normalized ndim vectors</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; vec = np.array([[1,1,0],[1,1,0],[1,0,1],[1,1,1]])</span>
<span class="sd">    &gt;&gt;&gt; normalize(vec)</span>
<span class="sd">    array([[ 0.70710678,  0.70710678,  0.        ],</span>
<span class="sd">           [ 0.70710678,  0.70710678,  0.        ],</span>
<span class="sd">           [ 0.70710678,  0.        ,  0.70710678],</span>
<span class="sd">           [ 0.57735027,  0.57735027,  0.57735027]])</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vec</span> <span class="o">*</span> <span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vecn</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">/</span> <span class="n">m</span>

    <span class="k">return</span><span class="p">(</span><span class="n">vecn</span><span class="p">)</span></div>


<div class="viewcode-block" id="ptonseg"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.ptonseg.html#pylayers.util.geomutil.ptonseg">[docs]</a><span class="k">def</span> <span class="nf">ptonseg</span><span class="p">(</span><span class="n">pta</span><span class="p">,</span> <span class="n">phe</span><span class="p">,</span> <span class="n">pt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return a point on the segment (pta,pte)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pta : ndarray</span>
<span class="sd">    phe : ndarray</span>
<span class="sd">    pt  : ndarray</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p   : ndarray</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">phe</span> <span class="o">-</span> <span class="n">pta</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">-</span> <span class="n">pta</span>
    <span class="n">Lv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">Lu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">Lv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">Lu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">Lv</span>
    <span class="n">un</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">Lu</span>
    <span class="n">ctheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">un</span><span class="p">,</span> <span class="n">vn</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">ctheta</span> <span class="o">*</span> <span class="n">Lu</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;</span> <span class="n">Lv</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pta</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">vn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="dptseg"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.dptseg.html#pylayers.util.geomutil.dptseg">[docs]</a><span class="k">def</span> <span class="nf">dptseg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">ph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; distance between a set of points and a segment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ps  : ndim x Np</span>
<span class="sd">          array of Np points</span>
<span class="sd">    pt  : ndim x 1</span>
<span class="sd">          tail coordinates of segment</span>
<span class="sd">    ph  : ndim x 1</span>
<span class="sd">          head coordinates of segment</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    d1 : 1 x Np</span>
<span class="sd">        distance between pt and ortho projection of ps</span>
<span class="sd">    d2 : 1 x Np</span>
<span class="sd">        distance between ph and ortho projection of ps</span>
<span class="sd">    h  : distance between ps and ortho projection of ps</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; pt = np.array([0,0])</span>
<span class="sd">        &gt;&gt;&gt; ph = np.array([10,0])</span>
<span class="sd">        &gt;&gt;&gt; p  = np.array([[-1,1 ,3,4,11],[8,1,2,3,3]])</span>
<span class="sd">        &gt;&gt;&gt; d1,d2,h = dptseg(p,pt,ph)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">norml</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">norml</span>

    <span class="n">ptp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ln</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ptp</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">norml</span> <span class="o">-</span> <span class="n">d1</span>
    <span class="n">ptpl</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">*</span> <span class="n">ln</span>
    <span class="n">ptpo</span> <span class="o">=</span> <span class="n">ptp</span> <span class="o">-</span> <span class="n">ptpl</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptpo</span> <span class="o">*</span> <span class="n">ptpo</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span></div>


<div class="viewcode-block" id="linet"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.linet.html#pylayers.util.geomutil.linet">[docs]</a><span class="k">def</span> <span class="nf">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">al</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  draw a short line segment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    ax : axes</span>
<span class="sd">    p1 : np.array</span>
<span class="sd">        start point</span>
<span class="sd">    p2 : np.array</span>
<span class="sd">        end point</span>
<span class="sd">    al : float</span>
<span class="sd">        0 &lt; al &lt; 1   percentage of drawing  default 0.9</span>
<span class="sd">    color :  string</span>
<span class="sd">        color default &#39;blue&#39;</span>
<span class="sd">    linewidth : float</span>
<span class="sd">        line width default 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    ax  : Axes instance</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; fig = plt.figure()</span>
<span class="sd">        &gt;&gt;&gt; ax  = fig.gca()</span>
<span class="sd">        &gt;&gt;&gt; p1 = np.array([0,0])</span>
<span class="sd">        &gt;&gt;&gt; p2 = np.array([1,0])</span>
<span class="sd">        &gt;&gt;&gt; p3 = np.array([0,1])</span>
<span class="sd">        &gt;&gt;&gt; p4 = np.array([1,1])</span>
<span class="sd">        &gt;&gt;&gt; ax = linet(ax,p1,p2,al=0.7,color=&#39;red&#39;,linewidth=3)</span>
<span class="sd">        &gt;&gt;&gt; ax = linet(ax,p2,p3,al=0.8,color=&#39;blue&#39;,linewidth=2)</span>
<span class="sd">        &gt;&gt;&gt; ax = linet(ax,p3,p4,al=0.9,color=&#39;green&#39;,linewidth=1)</span>
<span class="sd">        &gt;&gt;&gt; ax = linet(ax,p4,p1,al=1,color=&#39;cyan&#39;,linewidth=0.2)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">vn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">al</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">vn</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">al</span><span class="p">)</span> <span class="o">*</span> <span class="n">L</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pf</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pf</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span></div>


<div class="viewcode-block" id="ccw"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.ccw.html#pylayers.util.geomutil.ccw">[docs]</a><span class="k">def</span> <span class="nf">ccw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; counter clock wise order</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : ndarray (2,N)</span>
<span class="sd">    b : ndarray (2,N)</span>
<span class="sd">    c : ndarray (2,N)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    array of booleans</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    `Line Segment Intersection &lt;http://www.bryceboe.com/2006/10/23/line-segment-intersection-algorithm/&gt;`_</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import scipy as sp</span>
<span class="sd">    &gt;&gt;&gt; a = sp.rand(2,100)</span>
<span class="sd">    &gt;&gt;&gt; b = sp.rand(2,100)</span>
<span class="sd">    &gt;&gt;&gt; c = sp.rand(2,100)</span>
<span class="sd">    &gt;&gt;&gt; u = ccw(a,b,c)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="c1"># return((c[1, :] - a[1, :]) * (b[0, :] - a[0, :]) &gt; (b[1, :] - a[1, :]) *</span>
    <span class="c1"># (c[0, :] - a[0, :]))</span>
    <span class="k">return</span><span class="p">((</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">&gt;</span>
           <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span></div>

<span class="k">def</span> <span class="nf">are_points_inside_cone_old</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">apex</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; determine if a set of points are inside a cone </span>

<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>

<span class="sd">    points : np.array (Noints x Ndim ) </span>
<span class="sd">    apex : (Ndim x 1)</span>
<span class="sd">    v    : (Ndim x Nvec)</span>
<span class="sd">    radius : float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># points (N,2) </span>
    <span class="c1"># apex   (,2)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">apex</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span>  
    <span class="n">Nvec</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># vcone  : cone axis </span>
    <span class="n">vcone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># cliping half space </span>
    <span class="n">bhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">vcone</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="c1"># cliping distance </span>
    <span class="n">brad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span>

    <span class="n">Npoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">brad</span><span class="p">)</span>
    <span class="n">Ndim</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">Ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nvec</span><span class="p">,</span><span class="n">Npoints</span><span class="p">,</span><span class="n">Ndim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nvec</span><span class="p">):</span>
            <span class="n">cw</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:][</span><span class="n">brad</span><span class="p">,:],</span><span class="n">v</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">pcw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bcone</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pcw</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nvec</span><span class="p">,</span><span class="n">Npoints</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nvec</span><span class="p">):</span>
            <span class="n">cw</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:][</span><span class="n">brad</span><span class="p">,:],</span><span class="n">v</span><span class="p">[:,</span><span class="n">k</span><span class="p">])</span>
        <span class="n">pcw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#bcone = (cw[0,:]&lt;0) &amp; (cw[1,:]&gt;0) </span>
    <span class="c1">#cwv = np.cross(w,v)</span>
    <span class="c1">#bb  = (cwu&lt;0) &amp; (cwv&gt;0) &amp; (rad&lt;radius)</span>
    <span class="c1">#&quot;brad_ = np.zeros(len(bhs),dtype=bool)</span>
    <span class="c1">#brad_[bhs] = brad </span>
    <span class="c1">#</span>
    <span class="c1"># be careful the unbitable part is below (avoid np.where) </span>
    <span class="c1">#</span>
    <span class="n">bcone_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">brad</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone__</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bhs</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone_</span><span class="p">[</span><span class="n">brad</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone</span>
    <span class="n">bcone__</span><span class="p">[</span><span class="n">bhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone_</span>
    <span class="k">return</span> <span class="n">bcone__</span> 


<span class="k">def</span> <span class="nf">are_points_inside_cone1</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">apex</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; determine if a set of points are inside a cone </span>

<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>

<span class="sd">    points : np.array (Noints x Ndim ) </span>
<span class="sd">    apex : (Ndim x 1)</span>
<span class="sd">    v    : (Ndim x Nvec)</span>
<span class="sd">    radius : float</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># points (N,2) </span>
    <span class="c1"># apex   (,2)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">apex</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span>  
    <span class="n">Nvec</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># vcone  : cone axis </span>
    <span class="n">v_n</span>   <span class="o">=</span> <span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vcone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_n</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># cliping half space </span>
    <span class="n">bhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">vcone</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="c1">#return(bhs)</span>
    <span class="c1"># cliping distance </span>
    <span class="n">brad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span>

    <span class="n">Npoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">brad</span><span class="p">)</span>
    <span class="n">Ndim</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># desactivate clipping (to be commented)</span>
    <span class="c1">#bhs  = np.ones(len(bhs),dtype=bool)</span>
    <span class="c1">#brad = np.ones(len(brad),dtype=bool)</span>

    <span class="n">tk</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nvec</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span> <span class="p">]</span> 
    <span class="n">bcw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tk</span><span class="p">),</span><span class="n">Npoints</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="c1">#print &quot;w : &quot;,w </span>
    <span class="c1">#print &quot;v :&quot;,v</span>
    <span class="n">w_vec</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:][</span><span class="n">brad</span><span class="p">,:]</span> 
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="n">k2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tk</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">zk1k2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_n</span><span class="p">[:,</span><span class="n">k1</span><span class="p">],</span><span class="n">v_n</span><span class="p">[:,</span><span class="n">k2</span><span class="p">])</span>
            <span class="n">zk1k2_n</span> <span class="o">=</span> <span class="n">zk1k2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">zk1k2</span><span class="p">)</span>
            <span class="n">w_proj</span> <span class="o">=</span> <span class="n">w_vec</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w_vec</span><span class="p">,</span><span class="n">zk1k2_n</span><span class="p">)[:,</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="n">zk1k2_n</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span> 
            <span class="c1">#w_proj = w_proj/np.linalg.norm(w_proj,axis=1)[:,None]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w_proj</span> <span class="o">=</span> <span class="n">w_vec</span>
        <span class="n">pvec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w_proj</span><span class="p">,</span><span class="n">v_n</span><span class="p">[:,</span><span class="n">k1</span><span class="p">])</span>
        <span class="n">pvec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">w_proj</span><span class="p">,</span><span class="n">v_n</span><span class="p">[:,</span><span class="n">k2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvec1</span><span class="o">*</span><span class="n">zk1k2_n</span><span class="p">[</span><span class="bp">None</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvec2</span><span class="o">*</span><span class="n">zk1k2_n</span><span class="p">[</span><span class="bp">None</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dp1p2</span> <span class="o">=</span> <span class="n">u1</span><span class="o">*</span><span class="n">u2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dp1p2</span> <span class="o">=</span>  <span class="n">pvec1</span><span class="o">*</span><span class="n">pvec2</span>
        <span class="n">bcw</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">dp1p2</span> <span class="o">&lt;</span> <span class="mi">0</span> 
    <span class="c1">#</span>
    <span class="c1"># be careful the unbitable part is below (avoid np.where) </span>
    <span class="c1">#</span>
    <span class="n">bcone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bcw</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bcone_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">brad</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone__</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bhs</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone_</span><span class="p">[</span><span class="n">brad</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone</span>
    <span class="n">bcone__</span><span class="p">[</span><span class="n">bhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone_</span>
    <span class="k">return</span> <span class="n">bcone__</span> 

<div class="viewcode-block" id="are_points_inside_cone"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.are_points_inside_cone.html#pylayers.util.geomutil.are_points_inside_cone">[docs]</a><span class="k">def</span> <span class="nf">are_points_inside_cone</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">apex</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; determine if a set of points are inside a cone </span>

<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>

<span class="sd">    points : np.array (Noints x Ndim ) </span>
<span class="sd">    apex : (Ndim x 1)</span>
<span class="sd">    v    : (Ndim x Nvec)</span>
<span class="sd">    radius : float</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="n">apex</span><span class="p">[</span><span class="bp">None</span><span class="p">,:]</span>  
    <span class="n">Nvec</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># vcone  : cone axis </span>
    <span class="n">v_n</span>  <span class="o">=</span> <span class="n">v</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vcone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v_n</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># cliping half space </span>
    <span class="n">bhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">vcone</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="c1"># cliping distance </span>
    <span class="n">brad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">radius</span>

    <span class="n">w_vec</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">bhs</span><span class="p">,:][</span><span class="n">brad</span><span class="p">,:]</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">v_n</span><span class="p">,</span><span class="n">w_vec</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span>

    <span class="n">bcone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bcone_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">brad</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone__</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bhs</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">bcone_</span><span class="p">[</span><span class="n">brad</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone</span>
    <span class="n">bcone__</span><span class="p">[</span><span class="n">bhs</span><span class="p">]</span> <span class="o">=</span> <span class="n">bcone_</span>
    <span class="k">return</span> <span class="n">bcone__</span> </div>

<div class="viewcode-block" id="intersect_cone_seg"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.intersect_cone_seg.html#pylayers.util.geomutil.intersect_cone_seg">[docs]</a><span class="k">def</span> <span class="nf">intersect_cone_seg</span><span class="p">(</span><span class="n">line0</span><span class="p">,</span><span class="n">line1</span><span class="p">,</span><span class="n">seg</span><span class="p">,</span><span class="n">bvis</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bbool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    line0</span>
<span class="sd">    line1</span>
<span class="sd">    seg</span>
<span class="sd">    bvis </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tahe</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">apex</span> <span class="o">=</span> <span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">line1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span>
         <span class="p">(</span><span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">line1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>   <span class="p">):</span>
         <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span> 
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">line1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">bb</span> <span class="o">=</span> <span class="n">are_points_inside_cone</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span><span class="n">apex</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span><span class="n">p0</span> <span class="o">=</span> <span class="n">intersect_halfline_seg</span><span class="p">(</span><span class="n">line0</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">p1</span> <span class="o">=</span> <span class="n">intersect_halfline_seg</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># termination of segment fully inside the cone</span>
        <span class="n">tahe</span> <span class="o">=</span> <span class="n">seg</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># termination segment fully outside the cone </span>
        <span class="k">if</span> <span class="p">((</span> <span class="p">(</span> <span class="p">(</span><span class="n">x1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x1</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> <span class="ow">and</span> 
            <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">x0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x0</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> <span class="p">):</span>
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">]</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[]</span> 
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># seg0 inside seg1 outside </span>
        <span class="k">if</span> <span class="p">((</span> <span class="p">(</span><span class="n">x1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x1</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">):</span> 
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">((</span> <span class="p">(</span><span class="n">x0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x0</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">):</span> 
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p0</span><span class="p">]</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tahe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tahe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="o">~</span><span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># seg0 outside seg1 inside </span>
        <span class="k">if</span> <span class="p">((</span> <span class="p">(</span><span class="n">x0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x0</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">):</span>
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">((</span> <span class="p">(</span><span class="n">x1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">x1</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">):</span> 
            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p1</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="p">):</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">tahe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tahe</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">bvis</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">line1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">line1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">line1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#if bdp0i:</span>
        <span class="c1">#    ax.scatter(seg[0][0],seg[0][1],s=100,color=&#39;green&#39;)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    ax.scatter(seg[0][0],seg[0][1],s=100,color=&#39;red&#39;)</span>
        <span class="c1">#if bdp1i:</span>
        <span class="c1">#    ax.scatter(seg[1][0],seg[1][1],s=100,color=&#39;green&#39;)</span>
        <span class="c1">#else:</span>
        <span class="c1">#    ax.scatter(seg[1][0],seg[1][1],s=100,color=&#39;red&#39;)</span>
        <span class="c1">#if len(tahe)==2:</span>
        <span class="c1">#    linet(ax,tahe[0],tahe[1],color=&#39;green&#39;,al=1,linewidth=2)</span>
        <span class="c1">#plt.show()    </span>

    <span class="k">return</span><span class="p">(</span><span class="n">tahe</span><span class="p">,</span><span class="n">ratio</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">intersect_cone_seg_old</span><span class="p">(</span><span class="n">line0</span><span class="p">,</span><span class="n">line1</span><span class="p">,</span><span class="n">seg</span><span class="p">,</span><span class="n">bvis</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bbool</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    line0</span>
<span class="sd">    line1</span>
<span class="sd">    seg</span>
<span class="sd">    bvis </span>

<span class="sd">    &quot;&quot;&quot;</span>

     
    <span class="n">x0</span><span class="p">,</span><span class="n">p0</span> <span class="o">=</span> <span class="n">intersect_halfline_seg</span><span class="p">(</span><span class="n">line0</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">p1</span> <span class="o">=</span> <span class="n">intersect_halfline_seg</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">seg</span><span class="p">)</span>
    <span class="n">tahe</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># non degenerated case</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p1</span><span class="o">-</span><span class="n">p0</span>
        <span class="n">nv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">nv2</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="c1"># a above</span>
            <span class="c1"># b below </span>
            <span class="c1"># i in</span>
            <span class="n">bx0a</span> <span class="o">=</span> <span class="n">x0</span><span class="o">&gt;</span><span class="mi">1</span>
            <span class="n">bx0b</span> <span class="o">=</span> <span class="n">x0</span><span class="o">&lt;</span><span class="mi">0</span>
            <span class="n">bx0i</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bx0a</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bx0b</span><span class="p">)</span> 
            <span class="n">bx1a</span> <span class="o">=</span> <span class="n">x1</span><span class="o">&gt;</span><span class="mi">1</span>
            <span class="n">bx1b</span> <span class="o">=</span> <span class="n">x1</span><span class="o">&lt;</span><span class="mi">0</span>
            <span class="n">bx1i</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bx1a</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">bx1b</span><span class="p">)</span>

            <span class="n">baa</span> <span class="o">=</span> <span class="n">bx0a</span> <span class="ow">and</span> <span class="n">bx1a</span> <span class="c1"># </span>
            <span class="n">bab</span> <span class="o">=</span> <span class="n">bx0a</span> <span class="ow">and</span> <span class="n">bx1b</span> <span class="c1">#</span>
            <span class="n">bai</span> <span class="o">=</span> <span class="n">bx0a</span> <span class="ow">and</span> <span class="n">bx1i</span> 
            <span class="n">bba</span> <span class="o">=</span> <span class="n">bx0b</span> <span class="ow">and</span> <span class="n">bx1a</span> <span class="c1">#</span>
            <span class="n">bbb</span> <span class="o">=</span> <span class="n">bx0b</span> <span class="ow">and</span> <span class="n">bx1b</span> <span class="c1"># </span>
            <span class="n">bbi</span> <span class="o">=</span> <span class="n">bx0b</span> <span class="ow">and</span> <span class="n">bx1i</span> 
            <span class="n">bia</span> <span class="o">=</span> <span class="n">bx0i</span> <span class="ow">and</span> <span class="n">bx1a</span> 
            <span class="n">bib</span> <span class="o">=</span> <span class="n">bx0i</span> <span class="ow">and</span> <span class="n">bx1b</span> 
            <span class="n">bii</span> <span class="o">=</span> <span class="n">bx0i</span> <span class="ow">and</span> <span class="n">bx1i</span> <span class="c1">#</span>
            
            <span class="k">if</span> <span class="n">bbool</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;baa &quot;</span><span class="p">,</span><span class="n">baa</span>
                <span class="k">print</span> <span class="s2">&quot;bab &quot;</span><span class="p">,</span><span class="n">bab</span>
                <span class="k">print</span> <span class="s2">&quot;bai &quot;</span><span class="p">,</span><span class="n">bai</span>
                <span class="k">print</span> <span class="s2">&quot;bba &quot;</span><span class="p">,</span><span class="n">bba</span>
                <span class="k">print</span> <span class="s2">&quot;bbb &quot;</span><span class="p">,</span><span class="n">bbb</span>
                <span class="k">print</span> <span class="s2">&quot;bbi &quot;</span><span class="p">,</span><span class="n">bbi</span>
                <span class="k">print</span> <span class="s2">&quot;bia &quot;</span><span class="p">,</span><span class="n">bia</span>
                <span class="k">print</span> <span class="s2">&quot;bib &quot;</span><span class="p">,</span><span class="n">bib</span>
                <span class="k">print</span> <span class="s2">&quot;bii &quot;</span><span class="p">,</span><span class="n">bii</span>
            <span class="k">if</span> <span class="n">baa</span> <span class="ow">or</span> <span class="n">bbb</span><span class="p">:</span>  <span class="c1"># above and above or below and below -&gt;segment is out </span>
                <span class="n">tahe</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">bdp0i</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">bdp1i</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c1">#print &quot;baa or bbb&quot; </span>
            <span class="k">elif</span> <span class="n">bab</span> <span class="ow">or</span> <span class="n">bba</span><span class="p">:</span>  <span class="c1"># segment is fully inside the cone take seg        </span>
                <span class="n">tahe</span> <span class="o">=</span> <span class="n">seg</span>
                <span class="n">bdp0i</span> <span class="o">=</span> <span class="bp">True</span> 
                <span class="n">bdp1i</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c1">#print &quot;bab or bba&quot; </span>
            <span class="k">elif</span> <span class="n">bii</span><span class="p">:</span>
                <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">]</span> 
                <span class="n">bdp0i</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">bdp1i</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c1">#print &quot;bii&quot; </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reference point is chosen</span>
                <span class="c1"># as the point p0 or p1 which is</span>
                <span class="c1"># the farest from both segment termination </span>
                <span class="c1"># this is to avoid having null vector </span>
                <span class="n">d0seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p0</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p0</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">d1seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">d0seg</span><span class="o">&gt;</span><span class="n">d1seg</span><span class="p">:</span>
                    <span class="n">pref</span> <span class="o">=</span> <span class="n">p0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span> 
                    <span class="n">pref</span> <span class="o">=</span> <span class="n">p1</span>

                <span class="n">pseg0</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pref</span>
                <span class="n">dp0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">pseg0</span><span class="p">)</span><span class="o">/</span><span class="n">nv2</span>
                <span class="c1"># seg0 is out cone</span>
                <span class="n">bdp0o</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp0</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dp0</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># seg0 is in cone </span>
                <span class="n">bdp0i</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bdp0o</span>
                <span class="n">pseg1</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pref</span>
                <span class="n">dp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">pseg1</span><span class="p">)</span><span class="o">/</span><span class="n">nv2</span>
                <span class="c1"># seg0 is out </span>
                <span class="n">bdp1o</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp1</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dp1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># seg0 is in  </span>
                <span class="n">bdp1i</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bdp1o</span>
                <span class="k">if</span> <span class="n">bbool</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s2">&quot;bdp0i :&quot;</span><span class="p">,</span><span class="n">bdp0i</span>
                    <span class="k">print</span> <span class="s2">&quot;bdp1i :&quot;</span><span class="p">,</span><span class="n">bdp1i</span>
                
                <span class="k">if</span> <span class="n">bai</span> <span class="ow">or</span> <span class="n">bbi</span> <span class="p">:</span>
                    <span class="c1">#print &quot;bai or bbi&quot;</span>
                    <span class="k">if</span> <span class="n">bdp0i</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="n">bdp1i</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                           <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">):</span>
                           <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">bia</span> <span class="ow">or</span> <span class="n">bib</span><span class="p">:</span>   
                    <span class="c1">#print &quot;bia or bib&quot;</span>
                    <span class="k">if</span> <span class="n">bdp0i</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p0</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">bdp1i</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p0</span><span class="o">-</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">,</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">):</span>
                            <span class="n">tahe</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">tahe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tahe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">nw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">nw</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nv2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tahe</span> <span class="o">=</span> <span class="n">seg</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>   
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">ph</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>
        <span class="n">tahe</span> <span class="o">=</span> <span class="n">seg</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.</span>
    
    <span class="k">if</span> <span class="n">bvis</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">line0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">line0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">line1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">line1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">line1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bdp0i</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bdp1i</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">seg</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tahe</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">linet</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">tahe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">tahe</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>    



    <span class="k">return</span><span class="p">(</span><span class="n">tahe</span><span class="p">,</span><span class="n">ratio</span><span class="p">)</span>

<div class="viewcode-block" id="intersect_halfline_seg"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.intersect_halfline_seg.html#pylayers.util.geomutil.intersect_halfline_seg">[docs]</a><span class="k">def</span> <span class="nf">intersect_halfline_seg</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">seg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; intersect a half line and a segment</span>

<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>

<span class="sd">    line : (point,vec)</span>
<span class="sd">    seg :  (pta,phe)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    k : intersection parameter (0&lt;k&lt;1 if intersection)</span>
<span class="sd">    P : intersection point P = pta + k vseg</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ptO</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">line</span>
    <span class="n">pta</span><span class="p">,</span> <span class="n">phe</span> <span class="o">=</span> <span class="n">seg</span>
    <span class="n">v</span>  <span class="o">=</span> <span class="n">phe</span><span class="o">-</span><span class="n">pta</span>

    <span class="n">u</span>  <span class="o">=</span> <span class="n">u</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                   <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">b</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">ptO</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                  <span class="p">[</span><span class="n">pta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ptO</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">detA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">detA</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">P</span>  <span class="o">=</span> <span class="n">pta</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">None</span><span class="p">],[</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">None</span><span class="p">],[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="c1"># xht = phe[0] - pta[0]-v[]</span>
    <span class="c1"># yth = pta[1] - phe[1]</span>
    <span class="c1"># num = -(v[1] * (pta[0] - pt[0]) + v[0] * (pt[1] - pta[1]))</span>
    <span class="c1"># den = (v[1] * xht + v[0] * yth)</span>

    <span class="c1"># if (abs(den) &gt; 0):</span>
    <span class="c1">#     k = num / den::</span>
    <span class="c1">#     M = pta + k * vseg</span>
    <span class="c1"># else:</span>
    <span class="c1">#     si = np.sign(np.dot(v, vseg))</span>
    <span class="c1">#     k = np.inf * si</span>
    <span class="c1">#     M = pta + 2 * vseg</span>

    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">)</span></div>


<div class="viewcode-block" id="intersect3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.intersect3.html#pylayers.util.geomutil.intersect3">[docs]</a><span class="k">def</span> <span class="nf">intersect3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pg</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span><span class="n">binter</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Intersection of a line and a 3D rectangle screen</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a  : np.array (3,Nseg) of floats  </span>
<span class="sd">        transmiter coordinates </span>
<span class="sd">    b  : np.array (3,Nseg) of floats  </span>
<span class="sd">        receiver coordinates </span>
<span class="sd">    pg  : np.array (3,Nscreen) of floats </span>
<span class="sd">        center of gravity of the screen </span>
<span class="sd">    u1  : np.array (3,Nscreen) of floats </span>
<span class="sd">        unitary vector along first dimension</span>
<span class="sd">    u2  : np.array (3,Nscreen) of floats </span>
<span class="sd">        unitary vector along second dimension</span>
<span class="sd">    l1   : np.array (,Nscreen)</span>
<span class="sd">        length along first dimension in meters</span>
<span class="sd">    l2   : np.array (,Nscreen)</span>
<span class="sd">        length along second dimension in meters </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    bool : True   =&gt; intersection (occultation)</span>
<span class="sd">           False </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; a = np.array([[1,0,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; b = np.array([[10,0,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; pg = np.array([[5,0,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; u1 = np.array([[0,1,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; u2 = np.array([[0,0,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; l1 = np.array([3]).T</span>
<span class="sd">    &gt;&gt;&gt; l2 = np.array([3]).T</span>
<span class="sd">    &gt;&gt;&gt; bo = intersect3(a,b,pg,u1,u2,l1,l2)</span>
<span class="sd">    &gt;&gt;&gt; assert bo </span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pylayers.gis.layout.Layout.angleonlink3</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Nseg</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Nscreen</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ba</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>  <span class="c1"># (3,Nseg) LOS distance</span>

    <span class="c1"># A : (Nseg,Nscreen,3,3)</span>
    <span class="c1"># c : (Nseg,Nscreen,3)</span>
    <span class="c1"># ba.T (Nseg,3)</span>
    <span class="c1"># u1.T (Nscreen, 3)</span>
    <span class="c1"># u2.T (Nscreen, 3)</span>

    <span class="c1"># U  : Nseg,1,3,1</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Nseg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># U1 : 1,Nscreen,3,1</span>
    <span class="n">U1</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nscreen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">U1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nscreen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># U1 : 1,Nscreen,3,1</span>
    <span class="n">U2</span> <span class="o">=</span> <span class="n">u2</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nscreen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">U2</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nscreen</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># U1e : Nseg,Nscreen,3,1</span>
    <span class="n">U1e</span> <span class="o">=</span> <span class="n">U1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># U2e : Nseg,Nscreen,3,1</span>
    <span class="n">U2e</span> <span class="o">=</span> <span class="n">U2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># Ue  : Nseg,Nscreen,3,1</span>
    <span class="n">Ue</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">U2e</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ue</span><span class="p">,</span> <span class="o">-</span><span class="n">U1e</span><span class="p">,</span> <span class="o">-</span><span class="n">U2e</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># visi : Nseg,Nscreen</span>
    <span class="n">visi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">pinter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nseg</span><span class="p">,</span><span class="n">Nscreen</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="c1"># check non singularity </span>
    <span class="c1"># detA (Nseg,Nscreen) </span>
    <span class="n">detA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># matrix A (Nseg,Nscreen,3,3) is valid if not singular </span>
    <span class="n">boolvalid</span> <span class="o">=</span> <span class="o">~</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">detA</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1"># ba (3,Nseg) </span>
    <span class="c1"># ba.T (Nseg,3) </span>
    <span class="c1"># ba.T[:,None,:] (Nseg,1,3)</span>
    <span class="c1"># x (Nseg,Nscreen,3)</span>
    <span class="c1"># pinter (Nseg,Nscreen,3)</span>
    <span class="k">if</span> <span class="n">boolvalid</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">x</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="c1"># calculate intersection points</span>
        <span class="n">pinter</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:]</span> 

        <span class="n">condseg</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">cond1</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">l1</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">l1</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="n">cond2</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">l2</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>

        <span class="n">visi</span> <span class="o">=</span> <span class="o">~</span><span class="p">(((</span><span class="n">condseg</span> <span class="o">+</span> <span class="n">cond1</span> <span class="o">+</span> <span class="n">cond2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>

        <span class="c1">#i0 = np.kron(np.arange(A.shape[0],dtype=int),np.ones(A.shape[1],dtype=int))</span>
        <span class="c1">#i1 = np.kron(np.ones(A.shape[0],dtype=int),np.arange(A.shape[1],dtype=int))</span>
        <span class="c1">#ui = (i0,i1)</span>
        <span class="c1">#boolvalid = (np.ones(A.shape[0],dtype=bool),np.ones(A.shape[1],dtype=bool))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">boolvalid</span><span class="p">)</span>
        <span class="c1">#pdb.set_trace()</span>
        <span class="n">Am</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ui</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">],:,:]</span>
        <span class="c1">#Am = A[boolvalid,:,:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Am</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">Am</span><span class="o">=</span><span class="n">Am</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        

        <span class="n">cm</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">ui</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span>
        <span class="c1"># test if loosing one axis</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
    <span class="c1">#</span>
    <span class="c1"># Warning scipy.linalg do not handle MDA</span>
    <span class="c1">#</span>
    <span class="c1"># x : Nseg x Nscreen</span>
        <span class="k">if</span> <span class="n">Am</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Am</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span>
            <span class="n">pinter</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ui</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">ui</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">None</span><span class="p">,:]</span>
        <span class="c1"># condition of occultation</span>

            <span class="n">condseg</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">cond1</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">l1</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">l1</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
            <span class="n">cond2</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">l2</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">+</span>
                 <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">l2</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>

            <span class="n">visi</span><span class="p">[</span><span class="n">ui</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ui</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="o">~</span><span class="p">(((</span><span class="n">condseg</span> <span class="o">+</span> <span class="n">cond1</span> <span class="o">+</span> <span class="n">cond2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
            <span class="c1">#print boolvalid</span>
            <span class="c1">#visi[boolvalid] = ~(((condseg + cond1 + cond2) % 2).astype(bool))</span>

    <span class="k">if</span> <span class="n">binter</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">visi</span><span class="p">,</span><span class="n">pinter</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">visi</span></div>


<div class="viewcode-block" id="intersect"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.intersect.html#pylayers.util.geomutil.intersect">[docs]</a><span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if segment AB intersects segment CD in 2D </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : np.array (2xN)</span>
<span class="sd">    b : np.array (2xN)</span>
<span class="sd">    c : np.array (2xN)</span>
<span class="sd">    d : np.array (2xN)</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; import scipy as sp</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.plotutil import *</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pylab as plt</span>
<span class="sd">        &gt;&gt;&gt; N = 10</span>
<span class="sd">        &gt;&gt;&gt; A = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; B = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; C = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; D = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; b1 = intersect(A,B,C,D)</span>
<span class="sd">        &gt;&gt;&gt; pt1 = A[:,b1]</span>
<span class="sd">        &gt;&gt;&gt; ph1 = B[:,b1]</span>
<span class="sd">        &gt;&gt;&gt; pt2 = C[:,b1]</span>
<span class="sd">        &gt;&gt;&gt; ph2 = D[:,b1]</span>
<span class="sd">        &gt;&gt;&gt; f1,a1 = displot(pt1,ph1,&#39;r&#39;)</span>
<span class="sd">        &gt;&gt;&gt; f2,a2 = displot(pt2,ph2,&#39;b&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ti = plt.title(&#39;test intersect&#39;)</span>
<span class="sd">        &gt;&gt;&gt; A = np.array([[0],[0]])</span>
<span class="sd">        &gt;&gt;&gt; B = np.array([[1],[1]])</span>
<span class="sd">        &gt;&gt;&gt; C = np.array([[1],[0]])</span>
<span class="sd">        &gt;&gt;&gt; D = np.array([[0],[1]])</span>
<span class="sd">        &gt;&gt;&gt; intersect(A,B,C,D)</span>
<span class="sd">        array([ True], dtype=bool)</span>
<span class="sd">        &gt;&gt;&gt; intersect(A,B,C,D)[0]</span>
<span class="sd">        True</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    ccw : counter clock wise detection</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">ccw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ccw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ccw</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span></div>


<div class="viewcode-block" id="is_aligned4"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.is_aligned4.html#pylayers.util.geomutil.is_aligned4">[docs]</a><span class="k">def</span> <span class="nf">is_aligned4</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; test aligment of 4 points </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : np.array</span>
<span class="sd">    b : np.array </span>
<span class="sd">    c : np.array </span>
<span class="sd">    d : np.array </span>
<span class="sd">    tol : float </span>
<span class="sd">        default 1e-2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">is_aligned3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">is_aligned3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cond</span></div>


<div class="viewcode-block" id="is_aligned3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.is_aligned3.html#pylayers.util.geomutil.is_aligned3">[docs]</a><span class="k">def</span> <span class="nf">is_aligned3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; test aligment of 3 points </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : np.array</span>
<span class="sd">    b : np.array </span>
<span class="sd">    c : np.array </span>

<span class="sd">    tol : float </span>
<span class="sd">        default 1e-2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># return abs(((b[0,:]-a[0,:])*(c[1,:]-a[1,:]) -</span>
    <span class="c1"># (b[1,:]-a[1,:])*(c[0,:]-a[0,:])))&lt;1e-8</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">tol</span>
    <span class="c1"># print val</span>
    <span class="k">return</span> <span class="n">cond</span></div>


<div class="viewcode-block" id="isleft"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.isleft.html#pylayers.util.geomutil.isleft">[docs]</a><span class="k">def</span> <span class="nf">isleft</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Test point c is at left of the vector a--&gt;b</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : np.array (2xN)</span>
<span class="sd">    b : np.array (2xN)</span>
<span class="sd">    c : np.array (2xN)</span>
<span class="sd">    tol : tolerance</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    boolean array (1xN)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; from pylayers.util.plotutil import *</span>
<span class="sd">        &gt;&gt;&gt; import scipy as sp</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">        &gt;&gt;&gt; from pylayers.util.plotutil import *</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pylab as plot</span>
<span class="sd">        &gt;&gt;&gt; N = 20</span>
<span class="sd">        &gt;&gt;&gt; A = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; B = sp.rand(2,N)</span>
<span class="sd">        &gt;&gt;&gt; C = np.array(([0.5,0.5])).reshape(2,1)</span>
<span class="sd">        &gt;&gt;&gt; left=isleft(A,B,C)</span>
<span class="sd">        &gt;&gt;&gt; il = np.where(left)[0]</span>
<span class="sd">        &gt;&gt;&gt; inl = np.where(~left)[0]</span>
<span class="sd">        &gt;&gt;&gt; plt.scatter(C[0],C[1],color=&#39;b&#39;,s=10)</span>
<span class="sd">        &gt;&gt;&gt; displot(A[:,il],B[:,il],arrow=True,color=&#39;g&#39;)</span>
<span class="sd">        &gt;&gt;&gt; displot(A[:,inl],B[:,inl],arrow=True,color=&#39;r&#39;)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pylayers.antprop.signature</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">-</span> <span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">&gt;</span> <span class="n">tol</span></div>


<div class="viewcode-block" id="isleftorequal"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.isleftorequal.html#pylayers.util.geomutil.isleftorequal">[docs]</a><span class="k">def</span> <span class="nf">isleftorequal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">-</span> <span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">&gt;=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="affine"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.affine.html#pylayers.util.geomutil.affine">[docs]</a><span class="k">def</span> <span class="nf">affine</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find affine transformation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    X  : np.array</span>
<span class="sd">        3xN</span>
<span class="sd">    Y</span>
<span class="sd">        3xN</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    A : np.array</span>
<span class="sd">        3x3</span>
<span class="sd">    B : np.array</span>
<span class="sd">        3x1</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Given X and Y find the affine transformation</span>

<span class="sd">    Y = A X + B</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Yc</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">B</span>
    <span class="n">pX</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Yc</span><span class="p">,</span> <span class="n">pX</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span></div>


<div class="viewcode-block" id="cylmap"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.cylmap.html#pylayers.util.geomutil.cylmap">[docs]</a><span class="k">def</span> <span class="nf">cylmap</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.0625</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find affine transformation for a specific cylinder</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Y</span>
<span class="sd">        3xN</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    A : np.array</span>
<span class="sd">        3x3</span>
<span class="sd">    B : np.array</span>
<span class="sd">        3x1</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Y = A X + B</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#X = np.array([[0,0,0],[0,0,-0.25],[0,0,0.25],[0.0625,0,0],[0,0.0625,0],[0.0625,0,0.25]]).T</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">l</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">Yc</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">B</span>
    <span class="n">pX</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Yc</span><span class="p">,</span> <span class="n">pX</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span></div>

<div class="viewcode-block" id="MRot3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.MRot3.html#pylayers.util.geomutil.MRot3">[docs]</a><span class="k">def</span> <span class="nf">MRot3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a 3D rotation matrix along axe 0|1|2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a   :  angle (radians)</span>
<span class="sd">    axe :  0:x 1:y 2:z</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">))))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">axe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">M3</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">axe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">M3</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">axe</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">M3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span>
    <span class="k">return</span><span class="p">(</span><span class="n">M3</span><span class="p">)</span></div>


<div class="viewcode-block" id="MATP"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.MATP.html#pylayers.util.geomutil.MATP">[docs]</a><span class="k">def</span> <span class="nf">MATP</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span><span class="n">el</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">tilt</span><span class="p">,</span><span class="n">pol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate a rotation matrix for antenna pointing and orientation control</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    sl : np.array (,3) unitary </span>
<span class="sd">        main radiation direction in antenna local frame</span>
<span class="sd">    el : np.array(,3) unitary </span>
<span class="sd">        main direction in the E field plane </span>
<span class="sd">    phi : float 0&lt;phi&lt;2*pi</span>
<span class="sd">    tilt : float -pi/2&lt;tilt&lt;pi/2</span>
<span class="sd">    pol : string &#39;H&#39; (Horizontal) or &#39;V&#39; (Vertical)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span><span class="n">sl</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">el</span><span class="p">,</span><span class="n">el</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span><span class="n">el</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">atol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
    
    <span class="c1">#</span>
    <span class="c1"># local frame completion (vl,pl,ql) direct frame </span>
    <span class="c1">#</span>
    <span class="n">hl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span><span class="n">el</span><span class="p">)</span>
    <span class="n">Tl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sl</span><span class="p">,</span><span class="n">el</span><span class="p">,</span><span class="n">hl</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># global frame construction</span>
    <span class="c1">#</span>
    <span class="c1">#   (vg,pV,pH) direct   V case</span>
    <span class="c1">#   (vg,-pH,pV) direct  H case </span>
    <span class="c1">#</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">vg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tilt</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tilt</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tilt</span><span class="p">)])</span>
    <span class="n">pH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="n">pH</span> <span class="o">=</span> <span class="n">pH</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pH</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pH</span><span class="p">,</span><span class="n">pH</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">pH</span><span class="p">,</span><span class="n">vg</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pV</span><span class="p">,</span><span class="n">pV</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;V&#39;</span><span class="p">:</span>
        <span class="n">Tg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vg</span><span class="p">,</span><span class="n">pV</span><span class="p">,</span><span class="n">pH</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;H&#39;</span><span class="p">:</span>
        <span class="n">Tg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">vg</span><span class="p">,</span><span class="o">-</span><span class="n">pH</span><span class="p">,</span><span class="n">pV</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        
    <span class="c1"># Tg = R Tl </span>
    <span class="c1"># R = Tg.Tl.T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Tg</span><span class="p">,</span><span class="n">Tl</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">M</span><span class="p">)</span></div>

<div class="viewcode-block" id="MEulerAngle"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.MEulerAngle.html#pylayers.util.geomutil.MEulerAngle">[docs]</a><span class="k">def</span> <span class="nf">MEulerAngle</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate a rotation matrix from 3 Euler angles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    alpha  : float</span>
<span class="sd">        rotation along axis z</span>
<span class="sd">    beta : float</span>
<span class="sd">        rotation along axis x</span>
<span class="sd">    gamma : float</span>
<span class="sd">        rotation along axis y</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    T    : np.array (3x3)</span>
<span class="sd">        rotation matrix</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; T=MEulerAngle(np.pi/2,np.pi/2,np.pi/2)</span>

<span class="sd">    Warnings</span>
<span class="sd">    --------</span>

<span class="sd">    Bizarre I was expected</span>

<span class="sd">    -1  0  0</span>
<span class="sd">     0  0  1</span>
<span class="sd">     0  1  0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ra</span> <span class="o">=</span> <span class="n">MRot3</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">Rb</span> <span class="o">=</span> <span class="n">MRot3</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Rg</span> <span class="o">=</span> <span class="n">MRot3</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ra</span><span class="p">,</span> <span class="n">Rb</span><span class="p">),</span> <span class="n">Rg</span><span class="p">)</span>
    <span class="c1">#T  = np.dot(np.dot(Rg,Rb),Ra)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="SphericalBasis"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.SphericalBasis.html#pylayers.util.geomutil.SphericalBasis">[docs]</a><span class="k">def</span> <span class="nf">SphericalBasis</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; construct a spherical basis from a direction theta,phi</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : N x 2 </span>
<span class="sd">        a[:,0] : N theta angle</span>
<span class="sd">        a[:,1] : N phi angle</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    M : np.array</span>
<span class="sd">        N x [th,ph,s]  : 3 x 3 x N</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The unit vector uth,uph,us are places along the lines of the </span>
<span class="sd">    3 x 3 matrices</span>

<span class="sd">    uth</span>
<span class="sd">    uph</span>
<span class="sd">    us </span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; a = np.array([[0,0]])</span>
<span class="sd">    &gt;&gt;&gt; SphericalBasis(a)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    angledir</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">tha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> \
                     <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">pha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
                      <span class="mi">0</span> <span class="o">*</span> <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">tha</span><span class="p">,</span> <span class="n">pha</span><span class="p">,</span> <span class="n">sa</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="angledir"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.angledir.html#pylayers.util.geomutil.angledir">[docs]</a><span class="k">def</span> <span class="nf">angledir</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; evaluate (theta,phi) from direction vector</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    s  : ndarray N x 3</span>
<span class="sd">         N direction vector</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">      a  : ndarray 2xN</span>
<span class="sd">           N angle (theta,phi)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\theta = \\arccos{(\\frac{\\mathbf{s}}{\\hat{\mathbf{z}})}}</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; s = np.array([[2,0,0],[0,2,0],[0,0,1],[1,1,1]])</span>
<span class="sd">        &gt;&gt;&gt; angledir(s)*180/np.pi</span>
<span class="sd">        array([[ 90.        ,   0.        ],</span>
<span class="sd">               [ 90.        ,  90.        ],</span>
<span class="sd">               [  0.        ,   0.        ],</span>
<span class="sd">               [ 54.73561032,  45.        ]])</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    BTB (Base to base)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">z</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">inull</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span><span class="p">[</span><span class="n">inull</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">vnx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">vny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vny</span><span class="p">,</span> <span class="n">vnx</span><span class="p">)</span>
    <span class="n">a_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">))</span>
    <span class="n">a_new</span><span class="p">[</span><span class="n">inull</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">a_new</span><span class="p">[</span><span class="n">inull</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">a_new</span><span class="p">)</span></div>



<div class="viewcode-block" id="Bthph"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.Bthph.html#pylayers.util.geomutil.Bthph">[docs]</a><span class="k">def</span> <span class="nf">Bthph</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="n">ph</span><span class="p">,</span><span class="n">M</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return theta and phi tranformed from a rotation matrix M</span>


<span class="sd">        th (N)</span>
<span class="sd">        ph (N)</span>
<span class="sd">        M (3,3)</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        theta,phi </span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        This function is convenient for Antennas in addition of </span>
<span class="sd">        MATP.</span>
<span class="sd">        MATP returns a rotation matrix M which allow the</span>
<span class="sd">        transformation  from a local basis to a global basis.</span>

<span class="sd">        Using Bthph with MATP allows to evaluate the Antenna</span>
<span class="sd">        for given theta phi in a global basis and determine </span>
<span class="sd">        associated gain values in the Antenna local basis </span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="n">th</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">([</span><span class="n">ph</span><span class="p">])</span>
    <span class="c1"># spherical to cartesian </span>
    <span class="n">sp2cart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)])</span>
    <span class="c1"># apply rotation matrix</span>
    <span class="n">Cloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ik-&gt;kj&#39;</span><span class="p">,</span><span class="n">sp2cart</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
    <span class="c1"># return in psherical coodinates    </span>
    <span class="n">cart2sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Cloc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Cloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Cloc</span><span class="p">[</span><span class="mi">2</span><span class="p">])])</span>

    <span class="k">return</span> <span class="n">cart2sp</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">cart2sp</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span></div>


<div class="viewcode-block" id="BTB"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.BTB.html#pylayers.util.geomutil.BTB">[docs]</a><span class="k">def</span> <span class="nf">BTB</span><span class="p">(</span><span class="n">a_g</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Produce a set of rotation matrices for passage between global and local frame</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a_g  : angle in global reference frame  Nx2  :  (theta,phi) in columns</span>
<span class="sd">    T    : Tx rotation matrix     3 x 3</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    R : np.array (2x2xN) </span>
<span class="sd">        Rotation matrix in the wave plane   </span>
<span class="sd">    a_l : np.array (Nx2) </span>
<span class="sd">        angle in local frame</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    SphericalBasis</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 3 x 3 x r </span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">SphericalBasis</span><span class="p">(</span><span class="n">a_g</span><span class="p">)</span>
    <span class="c1"># old version of SphericalBasis</span>
    <span class="c1">#th_g = G[0, :, :]</span>
    <span class="c1">#ph_g = G[1, :, :]</span>
    <span class="n">th_g</span> <span class="o">=</span> <span class="n">G</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ph_g</span> <span class="o">=</span> <span class="n">G</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1">#</span>
    <span class="c1"># 2 x 3 x r </span>
    <span class="c1"># </span>
    <span class="n">B_gT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">th_g</span><span class="p">,</span> <span class="n">ph_g</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># express s in the local frame (after rotation T) </span>
    <span class="c1"># s = G[2,:,:]   3 x N </span>
    <span class="c1"># s_l : N x 3 </span>
    <span class="c1">#</span>
    <span class="c1">#s_l = np.dot(T.T, G[2, :, :]).T</span>
    <span class="n">s_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">G</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># get the N couples of angles in local frame </span>

    <span class="c1"># a_l : r x 2 </span>
    <span class="n">a_l</span> <span class="o">=</span> <span class="n">angledir</span><span class="p">(</span><span class="n">s_l</span><span class="p">)</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">SphericalBasis</span><span class="p">(</span><span class="n">a_l</span><span class="p">)</span>
    <span class="c1"># old version of SphericalBasis</span>
    <span class="c1">#th_l = L[0, :, :]</span>
    <span class="c1">#ph_l = L[1, :, :]</span>
    <span class="n">th_l</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">ph_l</span> <span class="o">=</span> <span class="n">L</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1">#</span>
    <span class="c1"># B_l : 3 x 2 x r </span>
    <span class="c1">#</span>
    <span class="n">B_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">th_l</span><span class="p">,</span> <span class="n">ph_l</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="c1">#  R : (2 x 3 x r ) (3 x 3 x r ) ( 3 x 2 x r ) </span>
    <span class="c1">#  R : 2 x 2 x r </span>
    <span class="c1">#</span>
    <span class="c1"># U : 2 x 3 x r </span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,jlk-&gt;ilk&#39;</span><span class="p">,</span><span class="n">B_gT</span><span class="p">,</span><span class="n">T</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">])</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk,jlk-&gt;ilk&#39;</span><span class="p">,</span><span class="n">U</span><span class="p">,</span><span class="n">B_l</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a_l</span><span class="p">,</span><span class="n">R</span></div>


<div class="viewcode-block" id="plot_coords"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_coords.html#pylayers.util.geomutil.plot_coords">[docs]</a><span class="k">def</span> <span class="nf">plot_coords</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#999999&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plotting coord of a `shapely` object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : matplotlib axes</span>
<span class="sd">    ob : shapely object</span>
<span class="sd">    color : string</span>
<span class="sd">        default &#39;#999999&#39;</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `Shapely &lt;http://pypi.python.org/pypi/Shapely&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># color=&#39;#999999&#39;</span></div>


<div class="viewcode-block" id="plot_bounds"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_bounds.html#pylayers.util.geomutil.plot_bounds">[docs]</a><span class="k">def</span> <span class="nf">plot_bounds</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#000000&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot bounds</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    ax : matplotlib axes</span>
<span class="sd">    ob : shapely object</span>
<span class="sd">    color : string</span>
<span class="sd">        default &#39;#999999&#39;</span>


<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    `Shapely &lt;http://pypi.python.org/pypi/Shapely&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ob</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># &#39;#000000&#39;</span></div>
    <span class="c1"># ax.plot(x, y, &#39;o&#39;, color=&#39;#000000&#39;, zorder=0.1)   #&#39;#000000&#39;</span>


<div class="viewcode-block" id="plot_line"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_line.html#pylayers.util.geomutil.plot_line">[docs]</a><span class="k">def</span> <span class="nf">plot_line</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#999999&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot line</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax : matplotlib axes</span>
<span class="sd">    ob : shapely object</span>
<span class="sd">    color : string</span>
<span class="sd">        default &#39;#999999&#39;</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    `Shapely &lt;http://pypi.python.org/pypi/Shapely&gt;`_</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    color = v_color(ob)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. plot:</span>
<span class="sd">        :include-source:</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; seg = shg.LineString([(0,0),(1,1)])</span>
<span class="sd">    &gt;&gt;&gt; fig = plt.figure()</span>
<span class="sd">    &gt;&gt;&gt; ax  = fig.gca()</span>
<span class="sd">    &gt;&gt;&gt; plot_line(ax,seg)</span>
<span class="sd">    &gt;&gt;&gt; plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="v_color"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.v_color.html#pylayers.util.geomutil.v_color">[docs]</a><span class="k">def</span> <span class="nf">v_color</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return color</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    ob :</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://pypi.python.org/pypi/Shapely</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">COLOR</span><span class="p">[</span><span class="n">ob</span><span class="o">.</span><span class="n">is_simple</span><span class="p">]</span></div>


<span class="c1"># def createPolygons(</span>
<div class="viewcode-block" id="plotPolygon"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plotPolygon.html#pylayers.util.geomutil.plotPolygon">[docs]</a><span class="k">def</span> <span class="nf">plotPolygon</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#abcdef&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot a shapely Polygon</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    poly  : shapely polygon</span>
<span class="sd">    color : default &quot;#abcdef&quot;</span>
<span class="sd">    alpha : float</span>
<span class="sd">           transparency   (default 0.8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">gax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gax</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">gax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">PolygonPatch</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="shrinkPolygon"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.shrinkPolygon.html#pylayers.util.geomutil.shrinkPolygon">[docs]</a><span class="k">def</span> <span class="nf">shrinkPolygon</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; shrink polygon</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    poly  : shapely polygon</span>
<span class="sd">    d     : float</span>
<span class="sd">        0.1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    poly</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poly1</span> <span class="o">=</span> <span class="n">simplifyPolygon</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">poly1</span><span class="o">.</span><span class="n">area</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="c1"># enleve le dernier point</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">Lr2n</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">nrm</span> <span class="o">=</span> <span class="n">n1</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">nrm</span>
        <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">nrm</span>
    <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">nrm</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">asLineString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">poly2</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">poly2</span><span class="o">.</span><span class="n">area</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">A2</span> <span class="o">&gt;</span> <span class="n">A1</span><span class="p">):</span>
        <span class="n">poly2</span> <span class="o">=</span> <span class="n">shrinkPolygon</span><span class="p">(</span><span class="n">poly1</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span></div>


<div class="viewcode-block" id="shrinkPolygon2"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.shrinkPolygon2.html#pylayers.util.geomutil.shrinkPolygon2">[docs]</a><span class="k">def</span> <span class="nf">shrinkPolygon2</span><span class="p">(</span><span class="n">poly1</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; shrink Polygon</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    poly1 Polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">poly1</span> <span class="o">=</span> <span class="n">simplifyPolygon</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="c1"># enleve le dernier point</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">Lr2n</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">n1</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">normold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">norm1</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>       <span class="c1"># changement de direction</span>
            <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">norm</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">norm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>           <span class="c1"># meme direction</span>
            <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">normold</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">norm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">norm1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="n">norm</span>

        <span class="n">normold</span> <span class="o">=</span> <span class="n">norm</span>
    <span class="c1">#n2  = np.hstack((n1[:,-1].reshape(2,1),n1[:,0:-1]))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">asLineString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">poly2</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span></div>


<div class="viewcode-block" id="simplifyPolygon"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.simplifyPolygon.html#pylayers.util.geomutil.simplifyPolygon">[docs]</a><span class="k">def</span> <span class="nf">simplifyPolygon</span><span class="p">(</span><span class="n">poly1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simplify polygon : suppress adjacent colinear segments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    poly1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly1</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">v1n</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v1</span><span class="p">))</span>
        <span class="n">v2n</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1n</span><span class="p">,</span> <span class="n">v2n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="mf">0.98</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">vini</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">vin</span> <span class="o">=</span> <span class="n">vini</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vini</span><span class="p">,</span> <span class="n">vini</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2n</span><span class="p">,</span> <span class="n">vin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">asLineString</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">poly2</span> <span class="o">=</span> <span class="n">shg</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span></div>

<span class="c1">#----------------------</span>
<span class="c1"># Taguhi</span>
<span class="c1">#----------------------</span>


<div class="viewcode-block" id="wall_delta"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.wall_delta.html#pylayers.util.geomutil.wall_delta">[docs]</a><span class="k">def</span> <span class="nf">wall_delta</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Identification of new points</span>

<span class="sd">    After defining a tolerance length those points which are situated in</span>
<span class="sd">    the extremities of the walls at a distance equivalent to the</span>
<span class="sd">    tolerance length are identified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x1 :  float</span>
<span class="sd">        The x component of the point of the first extremity</span>
<span class="sd">    y1 :  float</span>
<span class="sd">        The x component of the point of the first extremity</span>
<span class="sd">    x2 :  float</span>
<span class="sd">        The x component of the point of the second extremity</span>
<span class="sd">    y2 :  float</span>
<span class="sd">        The x component of the point of the second extremity.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bx  :  float</span>
<span class="sd">        The x component of the new point of the first extremity</span>
<span class="sd">    by  :  float</span>
<span class="sd">        The y component of the new point of the first extremity</span>
<span class="sd">    cx  :  float</span>
<span class="sd">        The x component of the new point of the second extremity</span>
<span class="sd">    cy  :  float</span>
<span class="sd">        The y component of the new point of the second extremity.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math:: bx=x1+(x2-x1) \\frac{\\delta}{mod(a)}.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; x1=-2.</span>
<span class="sd">    &gt;&gt;&gt; y1=2.</span>
<span class="sd">    &gt;&gt;&gt; x2=-1.</span>
<span class="sd">    &gt;&gt;&gt; y2=1.</span>
<span class="sd">    &gt;&gt;&gt; bx,by,cx,cy = wall_delta(x1,y1,x2,y2,delta=0.0001)</span>
<span class="sd">    &gt;&gt;&gt; assert bx==-1.9999292893218814,&#39;Mistake&#39;</span>
<span class="sd">    &gt;&gt;&gt; assert by==1.9999292893218814,&#39;Mistake&#39;</span>
<span class="sd">    &gt;&gt;&gt; assert cx==-1.0000707106781186,&#39;Mistake&#39;</span>
<span class="sd">    &gt;&gt;&gt; assert cy==1.0000707106781186,&#39;Mistake&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span>
    <span class="n">ay</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span>
    <span class="n">a_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ax</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ay</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">a_ch_x</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">/</span> <span class="n">a_mod</span>
    <span class="n">a_ch_y</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">/</span> <span class="n">a_mod</span>

    <span class="n">bx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">a_mod</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">a_mod</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">a_mod</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">a_mod</span>

    <span class="k">return</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_coords2"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_coords2.html#pylayers.util.geomutil.plot_coords2">[docs]</a><span class="k">def</span> <span class="nf">plot_coords2</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  plot point from coordinates</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://pypi.python.org/pypi/Shapely</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_bounds2"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_bounds2.html#pylayers.util.geomutil.plot_bounds2">[docs]</a><span class="k">def</span> <span class="nf">plot_bounds2</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot bounds v2</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://pypi.python.org/pypi/Shapely</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ob</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_line2"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_line2.html#pylayers.util.geomutil.plot_line2">[docs]</a><span class="k">def</span> <span class="nf">plot_line2</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot line v2</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    http://pypi.python.org/pypi/Shapely</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">v_color</span><span class="p">(</span>
        <span class="n">ob</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_coords3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_coords3.html#pylayers.util.geomutil.plot_coords3">[docs]</a><span class="k">def</span> <span class="nf">plot_coords3</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot coors v3</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://pypi.python.org/pypi/Shapely</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_bounds3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_bounds3.html#pylayers.util.geomutil.plot_bounds3">[docs]</a><span class="k">def</span> <span class="nf">plot_bounds3</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot bounds v3</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    http://pypi.python.org/pypi/Shapely</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ob</span><span class="o">.</span><span class="n">boundary</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_line3"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.plot_line3.html#pylayers.util.geomutil.plot_line3">[docs]</a><span class="k">def</span> <span class="nf">plot_line3</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ob</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot lines v3</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    http://pypi.python.org/pypi/Shapely</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ob</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">solid_capstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>
<span class="c1">#</span>
<span class="c1"># wedge functions</span>
<span class="c1">##</span>


<div class="viewcode-block" id="valid_wedge"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.valid_wedge.html#pylayers.util.geomutil.valid_wedge">[docs]</a><span class="k">def</span> <span class="nf">valid_wedge</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">grazing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check set of N wedge sector validity for point ps</span>

<span class="sd">     Parameters</span>
<span class="sd">     ----------</span>

<span class="sd">     ps       : source point</span>
<span class="sd">     pw       : np.array (Nx2) wedge apex point</span>
<span class="sd">     p1       : np.array (Nx2) point 1 of wedge</span>
<span class="sd">     p2       : np.array (Nx2) point 2 of wedge</span>
<span class="sd">     grazing  : 0 (without grazing)</span>
<span class="sd">                1 (authorize grazing)</span>

<span class="sd">                         xps</span>

<span class="sd">            x pw</span>
<span class="sd">           / \</span>
<span class="sd">          /   \</span>
<span class="sd">         /     \</span>
<span class="sd">        x p1    x p2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    valid : np.array (Nx1)</span>
<span class="sd">            valid = 1 if ps is in the convex sector</span>
<span class="sd">            valid = 0 if ps is in the concav sector</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; p1 = np.array([-2,-2]).reshape(1,2)</span>
<span class="sd">    &gt;&gt;&gt; p2 = np.array([2,-2]).reshape(1,2)</span>
<span class="sd">    &gt;&gt;&gt; pw = np.array([0,0]).reshape(1,2)</span>
<span class="sd">    &gt;&gt;&gt; ps1 = np.array([3,3]).reshape(1,2)</span>
<span class="sd">    &gt;&gt;&gt; ps2 = np.array([0,-3]).reshape(1,2)</span>
<span class="sd">    &gt;&gt;&gt; valid_wedge(ps1,pw,p1,p2,0)[0][0]</span>
<span class="sd">    1.0</span>
<span class="sd">    &gt;&gt;&gt; valid_wedge(ps2,pw,p1,p2,0)[0][0]</span>
<span class="sd">    1.0</span>


<span class="sd">    Author</span>
<span class="sd">    -------</span>
<span class="sd">    Bernard.uguen@univ-rennes1.fr</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>

    <span class="n">x2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">ps</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">aas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)))</span>

    <span class="n">b1_I2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">a2</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="n">b2_I2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">a2</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="n">mu_I2</span> <span class="o">=</span> <span class="n">b2_I2</span> <span class="o">-</span> <span class="n">b1_I2</span>
    <span class="c1">#</span>
    <span class="c1"># un &gt;= ou &lt;= permet de valider les points qui sont sur une tangente au diedre</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">grazing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">in_I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="p">(</span><span class="n">aas</span> <span class="o">&gt;</span> <span class="n">b1_I2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">aas</span> <span class="o">&lt;</span> <span class="n">b2_I2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mu_I2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid</span><span class="p">[</span><span class="n">in_I2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out_I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="p">((</span><span class="n">aas</span> <span class="o">&lt;</span> <span class="n">b1_I2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aas</span> <span class="o">&gt;</span> <span class="n">b2_I2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mu_I2</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid</span><span class="p">[</span><span class="n">out_I2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">grazing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">in_I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="p">(</span><span class="n">aas</span> <span class="o">&gt;=</span> <span class="n">b1_I2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">aas</span> <span class="o">&lt;=</span> <span class="n">b2_I2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mu_I2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid</span><span class="p">[</span><span class="n">in_I2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out_I2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="p">((</span><span class="n">aas</span> <span class="o">&lt;=</span> <span class="n">b1_I2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aas</span> <span class="o">&gt;=</span> <span class="n">b2_I2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mu_I2</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid</span><span class="p">[</span><span class="n">out_I2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">agwed_old</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">lwe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    lwe : np.array</span>
<span class="sd">        3x1 wedge vector</span>
<span class="sd">    v   : np.array(3x4)</span>
<span class="sd">        3x4 ( 4 stacked vectors)</span>

<span class="sd">        first vector of v is on face 0 perp to lwe</span>
<span class="sd">        second vector of v is on face n perp to lwe</span>
<span class="sd">        third vector is on the direction of incident ray  (-si)</span>
<span class="sd">        fourth vector is on the direction of diffracted ray (sd)</span>

<span class="sd">    all vectors of v are defined outgoing from the diffracting point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        np.array([N*pi,phi0,phi])</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pylayers.util.geomutil as geu</span>
<span class="sd">    &gt;&gt;&gt; lwe = np.array([0,0,1])</span>
<span class="sd">    &gt;&gt;&gt; u = np.array([1,0,0])</span>
<span class="sd">    &gt;&gt;&gt; v1 = np.array([1,1,0])</span>
<span class="sd">    &gt;&gt;&gt; si = np.array([-1,-1,0])</span>
<span class="sd">    &gt;&gt;&gt; sd = np.array([-1,1,0])</span>
<span class="sd">    &gt;&gt;&gt; v  = np.vstack([u,v1,si,sd]).T</span>
<span class="sd">    &gt;&gt;&gt; M = geu.agwed(v,lwe)</span>
<span class="sd">    &gt;&gt;&gt; print(M*180/np.pi)</span>
<span class="sd">    [ 315.  135.  225.]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span><span class="s1">&#39;Please use vectorized version : agwed&#39;</span><span class="p">))</span>
    <span class="c1"># lwe : (,3)</span>
    <span class="n">lwe</span> <span class="o">=</span> <span class="n">lwe</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lwe</span> <span class="o">*</span> <span class="n">lwe</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># v : (3,4)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># ps (,4)</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lwe</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">vp1</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v</span> <span class="o">*</span> <span class="n">ps</span>
    <span class="n">vpn</span> <span class="o">=</span> <span class="n">vp1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vp1</span> <span class="o">*</span> <span class="n">vp1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">vpt</span> <span class="o">=</span> <span class="n">vpn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">vpt</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">vpt</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vpt</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vpt</span><span class="p">,</span> <span class="n">vpt</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vpt</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vpt</span><span class="p">,</span> <span class="n">vpt</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">M</span>


<span class="k">def</span> <span class="nf">agwed</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">lwe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    lwe : np.array</span>
<span class="sd">        3xNp wedge vector</span>
<span class="sd">    v   : np.array(3x4xNp)</span>
<span class="sd">        3x4xNp ( 4 stacked vectors)</span>

<span class="sd">        first vector of v is on face 0 perp to lwe</span>
<span class="sd">        second vector of v is on face n perp to lwe</span>
<span class="sd">        third vector is on the direction of incident ray  (-si)</span>
<span class="sd">        fourth vector is on the direction of diffracted ray (sd)</span>

<span class="sd">    all vectors of v are defined outgoing from the diffracting point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        np.array([[N*pi,phi0,phi],...xNp])</span>
<span class="sd">                (3xNp)</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import pylayers.util.geomutil as geu</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; lwe = np.array([[0,0,1],[0,0,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; u = np.array([[1,0,0],[1,0,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; v1 = np.array([[1,1,0],[1,1,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; si = np.array([[-1,-1,0],[-1,1,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; sd = np.array([[-1,1,0],[1,-1,0]]).T</span>
<span class="sd">    &gt;&gt;&gt; v  = np.hstack((u[:,None,:],v1[:,None,:],si[:,None,:],sd[:,None,:]))</span>
<span class="sd">    &gt;&gt;&gt; M = geu.agwed(v,lwe)</span>
<span class="sd">    &gt;&gt;&gt; print(M*180/np.pi)</span>
<span class="sd">    array([[ 315.,  315.],</span>
<span class="sd">       [ 135.,  225.],</span>
<span class="sd">       [ 225.,   45.]])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ipdb</span>
    <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="c1"># lwe : (3,N)</span>
    <span class="n">lwe</span> <span class="o">=</span> <span class="n">lwe</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lwe</span> <span class="o">*</span> <span class="n">lwe</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># v : (3,4,N)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># ps (4,N)</span>
    <span class="c1">#ps  = np.dot(lwe,v)</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ik,ijk-&gt;jk&#39;</span><span class="p">,</span> <span class="n">lwe</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">vp1</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">v</span> <span class="o">*</span> <span class="n">ps</span>
    <span class="n">vpn</span> <span class="o">=</span> <span class="n">vp1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vp1</span> <span class="o">*</span> <span class="n">vp1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># vpt = (N,4,2)</span>
    <span class="n">vpt</span> <span class="o">=</span> <span class="n">vpn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="c1"># w(4,N,2)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">vpt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="n">vpt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># C = np.dot(vpt,w)</span>
    <span class="c1"># D = np.dot(vpt,vpt.T)</span>

    <span class="c1"># vpt(2,4,N) x w(2,4,N) =&gt; C(4,4,N)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kil,kjl-&gt;ijl&#39;</span><span class="p">,</span> <span class="n">vpt</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="c1"># D(4,4,N)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kil,kjl-&gt;ijl&#39;</span><span class="p">,</span> <span class="n">vpt</span><span class="p">,</span> <span class="n">vpt</span><span class="p">)</span>

    <span class="c1">#M = np.mod(2*np.pi-np.arctan2(np.dot(vpt,w),np.dot(vpt,vpt.T)),2*np.pi)[0,1:]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">M</span>


<div class="viewcode-block" id="sector"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.sector.html#pylayers.util.geomutil.sector">[docs]</a><span class="k">def</span> <span class="nf">sector</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">pt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; non signed angular sector  between</span>
<span class="sd">        (p1,pt) and (p2,pt)</span>

<span class="sd">    p1 x-----------x pt</span>
<span class="sd">               |  /</span>
<span class="sd">          alpha \/</span>
<span class="sd">                /</span>
<span class="sd">               x p2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p1 : np.array (3 x Np)</span>
<span class="sd">        point</span>
<span class="sd">    p2 : np.array (3 x Np)</span>
<span class="sd">        point</span>
<span class="sd">    pt : np.array (3 x Np)</span>
<span class="sd">        point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    alpha : np.array (3 x Np)</span>
<span class="sd">        degree</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Useful for AAS calculation</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">p1pt</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">pt</span>
    <span class="n">p2pt</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">pt</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">p1pt</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p1pt</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1pt</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">p2pt</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p2pt</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p2pt</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="c1"># sum(a[i,j,:] * b[k,:,m])</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">um0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">&lt;</span> <span class="n">v1</span>
    <span class="n">um1</span> <span class="o">=</span> <span class="o">~</span><span class="n">um0</span>
    <span class="n">sector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">sector</span><span class="p">[</span><span class="n">um0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="n">um0</span><span class="p">]</span>
    <span class="n">sector</span><span class="p">[</span><span class="n">um1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="n">um1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sector</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span></div>
    <span class="c1"># if (abs(alpha + sector - sp.mod(beta, 2 * np.pi)) &lt; 1e-3):</span>
    <span class="c1">#    return(np.array([alpha, beta]) * 180 / np.pi)</span>
    <span class="c1"># else:</span>
    <span class="c1">#    return(np.array([beta, alpha]) * 180 / np.pi)</span>


<span class="k">def</span> <span class="nf">sectorold</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">pt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angular sector  p1 pt p2</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p1 : np.array</span>
<span class="sd">        point</span>
<span class="sd">    p2 : np.array</span>
<span class="sd">        point</span>
<span class="sd">    pt : np.array</span>
<span class="sd">        point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    alpha : np.array</span>
<span class="sd">        degree</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Useful for AAS calculation</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">,</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">pt</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">pt</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">pt</span><span class="p">,</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">pt</span><span class="p">))</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sector</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">beta</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">beta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sector</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>


<div class="viewcode-block" id="dist"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.dist.html#pylayers.util.geomutil.dist">[docs]</a><span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; calculates distance between two arrays along a given axis</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        x : numpy.ndarray</span>
<span class="sd">        y : numpy.ndarray</span>
<span class="sd">        ax : integer (0,1)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        d : numpy.ndarray</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; x = np.array([[0., 0., 10., 10.],[0., 10., 10., 0.]])</span>
<span class="sd">        &gt;&gt;&gt; y = np.array([[5.],[5.]])</span>
<span class="sd">        &gt;&gt;&gt; ax = 0</span>
<span class="sd">        &gt;&gt;&gt; d = dist(x,y,ax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">d</span></div>

<span class="k">def</span> <span class="nf">angle_intersection</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inters</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">ags</span><span class="p">,</span><span class="n">age</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ags</span><span class="o">&gt;</span><span class="n">age</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;=</span><span class="n">ags</span> <span class="ow">or</span> <span class="n">b</span><span class="o">&lt;=</span><span class="n">age</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">&gt;</span><span class="n">ags</span> <span class="ow">and</span> <span class="n">b</span><span class="o">&lt;=</span><span class="n">age</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">bol</span> <span class="o">=</span> <span class="n">inters</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span> <span class="o">|</span> <span class="n">inters</span> <span class="p">(</span><span class="n">b2</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span> <span class="o">|</span> <span class="n">inters</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span> <span class="o">|</span> <span class="n">inters</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>     
    <span class="k">return</span> <span class="n">bol</span>

<span class="k">def</span> <span class="nf">angle_intersection2</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; angle intersection2 </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a1 : angle in [0,2*pi] first angular sector</span>
<span class="sd">    a2 : angle in [0,2*pi] first angular sector</span>
<span class="sd">    b1 : angle in [0,2*pi] first angular sector</span>
<span class="sd">    b2 : angle in [0,2*pi] first angular sector</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    intersect_angle : float </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Given 2 angular sectors (a1,a2) and (b1,b2), this function returns the intersection of the 2 </span>
<span class="sd">    sector if it exists</span>

<span class="sd">    See Also </span>
<span class="sd">    --------</span>

<span class="sd">    Signature.run</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; a1 = 0. </span>
<span class="sd">    &gt;&gt;&gt; a2 = np.pi/4.</span>
<span class="sd">    &gt;&gt;&gt; b1 = np.pi/3.</span>
<span class="sd">    &gt;&gt;&gt; b2 = np.pi/2.</span>
<span class="sd">    &gt;&gt;&gt; angle_intersection2(a1,a2,b1,b2)</span>
<span class="sd">    0 </span>
<span class="sd">    &gt;&gt;&gt; a1 = 0. </span>
<span class="sd">    &gt;&gt;&gt; a2 = np.pi/3.</span>
<span class="sd">    &gt;&gt;&gt; b1 = np.pi/4.</span>
<span class="sd">    &gt;&gt;&gt; b2 = np.pi/2.</span>
<span class="sd">    &gt;&gt;&gt; angle_intersection2(a1,a2,b1,b2)</span>
<span class="sd">    0.26179938779914935</span>
<span class="sd">    &gt;&gt;&gt; a1 = 0. </span>
<span class="sd">    &gt;&gt;&gt; a2 = np.pi-np.pi/3.</span>
<span class="sd">    &gt;&gt;&gt; b1 = np.pi/2.</span>
<span class="sd">    &gt;&gt;&gt; b2 = 3*np.pi/2.</span>
<span class="sd">    &gt;&gt;&gt; angle_intersection2(a1,a2,b1,b2)</span>
<span class="sd">    0.5235987755982991</span>


<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> 
    <span class="k">if</span> <span class="n">r1</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> 
        <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">r1</span> 
        <span class="n">ainf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">asup</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ainf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">asup</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>

    <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span> 
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">r2</span>
        <span class="n">binf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>
        <span class="n">bsup</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">binf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>
        <span class="n">bsup</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">)</span>

    <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ainf</span><span class="o">+</span><span class="n">asup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c1</span><span class="o">&lt;</span><span class="n">ainf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c1</span><span class="o">&gt;</span><span class="n">asup</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">binf</span><span class="o">+</span><span class="n">bsup</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">c2</span><span class="o">&lt;</span><span class="n">binf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c2</span><span class="o">&gt;</span><span class="n">bsup</span><span class="p">):</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    
    <span class="n">dc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span><span class="n">c1</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span><span class="n">c1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dc</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="n">dc</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">dc</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span><span class="p">((</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">dc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="line_intersection"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.line_intersection.html#pylayers.util.geomutil.line_intersection">[docs]</a><span class="k">def</span> <span class="nf">line_intersection</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; intersection between two 2D lines using shapely</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    l1: numpy.ndarray</span>
<span class="sd">        coordinates of l1 points</span>
<span class="sd">    l2: numpy.ndarray</span>
<span class="sd">        coordinates of l2 points</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    p: numpy.ndarray</span>
<span class="sd">        coordinates of intersection point</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shl1</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">l1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">l1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">shl2</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">l2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">l2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">shl1</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">shl2</span><span class="p">):</span>
        <span class="n">psh</span> <span class="o">=</span> <span class="n">shl1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">shl2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">psh</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">psh</span><span class="o">.</span><span class="n">y</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span></div>


<div class="viewcode-block" id="linepoly_intersection"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.linepoly_intersection.html#pylayers.util.geomutil.linepoly_intersection">[docs]</a><span class="k">def</span> <span class="nf">linepoly_intersection</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; intersection between a 2D line and a 2D polygon using shapely</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    l: numpy.ndarray</span>
<span class="sd">        coordinates of l points</span>
<span class="sd">    poly: numpy.ndarray</span>
<span class="sd">        coordinates of poly points</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    p: numpy.ndarray</span>
<span class="sd">        coordinates of intersection point</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shl</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">LineString</span><span class="p">((</span><span class="n">l</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">shpoly</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">polygon</span><span class="p">((</span><span class="n">poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">poly</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">poly</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="n">psh</span> <span class="o">=</span> <span class="n">shl</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">shpoly</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">psh</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">psh</span><span class="o">.</span><span class="n">y</span><span class="p">]])</span></div>


<span class="k">def</span> <span class="nf">mirror3b</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">aplane</span><span class="p">,</span> <span class="n">pplane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute recursively the image of p wrt the list of facet </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    tp     : numpy.ndarray (3 x Ns x Npt)</span>
<span class="sd">        Ns : number of screen </span>
<span class="sd">        Npt : number of points</span>
<span class="sd">    aplane : numpy.ndarray</span>
<span class="sd">        array of planes (3xNplanex2))</span>
<span class="sd">    pplane : numpy.ndarray</span>
<span class="sd">        array of points (3xNplane)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    tp : np.array </span>
<span class="sd">        sequence of images </span>
<span class="sd">            tp[:,-1] is the final image</span>
<span class="sd">            tp[:,0] is the original point </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; tp = np.array([[1,1,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; p1 = np.array([[0,0] ,[1,0],[0,1]])  #yz</span>
<span class="sd">    &gt;&gt;&gt; p2 = np.array([[1,0] ,[0,0],[0,1]])  #yz</span>
<span class="sd">    &gt;&gt;&gt; p3 = np.array([[1,0] ,[0,1],[0,0]])  #xy</span>
<span class="sd">    &gt;&gt;&gt; aplane = np.hstack((p1,p2,p3))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># take last points of the sequence </span>
    <span class="c1"># p : 3 x 1 x n</span>
    <span class="c1">#</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span>
    <span class="n">Nplane</span> <span class="o">=</span> <span class="n">aplane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1"># vector plane normalisation</span>
    <span class="c1"># norm : 3 x Nplane </span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># T change basis matrix</span>
    <span class="c1"># T (3 x Nplane,3)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">aplane</span><span class="p">,</span><span class="n">norm</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]))</span>
    <span class="c1"># take last transformation matrix </span>
    <span class="n">T_</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="c1"># v : 3 x 1 x n </span>
    <span class="n">v</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][:,:,</span><span class="bp">None</span><span class="p">]</span>
    <span class="c1"># go to frame attached to reflection plane</span>
    <span class="c1">#Tpmp = np.dot(T_.T,v)</span>
    <span class="c1"># Tpmp : 3 x 1 x n </span>
    <span class="n">Tpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sv,vln-&gt;sln&#39;</span><span class="p">,</span><span class="n">T_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># apply symmetry </span>
    <span class="n">R</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
    <span class="c1">#RTpmp = np.dot(R,Tpmp)</span>
    <span class="n">RTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sv,vln-&gt;sln&#39;</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Tpmp</span><span class="p">)</span>
    <span class="c1">#go back to global frame </span>
    <span class="c1">#TTRTpmp = np.dot(T_,RTpmp)</span>
    <span class="n">TTRTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;sv,vln-&gt;sln&#39;</span><span class="p">,</span><span class="n">T_</span><span class="p">,</span><span class="n">RTpmp</span><span class="p">)</span>
    <span class="c1"># append image to list of points </span>
    <span class="n">pim</span> <span class="o">=</span> <span class="n">TTRTpmp</span> <span class="o">+</span> <span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][:,:,</span><span class="bp">None</span><span class="p">]</span>  
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tp</span><span class="p">,</span><span class="n">pim</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if there are other plane enter recursion </span>
    <span class="k">if</span> <span class="n">Nplane</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">mirror3b</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">aplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="n">pplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">tp</span>

<span class="k">def</span> <span class="nf">mirror3c</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">aplane</span><span class="p">,</span> <span class="n">pplane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute recursively the image of p wrt the list of facet </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    tp     : MDA </span>
<span class="sd">        Collection of images points from screen in 3D space from set of points  </span>
<span class="sd">        (3 x Nf x Npt x Nc)</span>
<span class="sd">        Ns : number of screen </span>
<span class="sd">        Npt : number of points</span>
<span class="sd">        (s x f x p x c ) </span>
<span class="sd">    aplane : numpy.ndarray</span>
<span class="sd">        MDarray of (c)ollection of ()vector (f)aces n 3D ((s)pace </span>
<span class="sd">        (3xNfacesx2xNc)</span>
<span class="sd">        (sxfxvxc) </span>
<span class="sd">    pplane : numpy.ndarray</span>
<span class="sd">        array of points (3xNplanexNsig)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    tp : np.array </span>
<span class="sd">        sequence of images </span>
<span class="sd">            tp[:,-1] is the final image</span>
<span class="sd">            tp[:,0] is the original point </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># take last points of the sequence tp </span>
    <span class="c1"># tp :  (s x f x p x c ) </span>
    <span class="c1"># p : s x 1 x p x c </span>
    <span class="c1">#</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,:]</span>
    <span class="n">Nplane</span> <span class="o">=</span> <span class="n">aplane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1"># vector plane normalisation</span>
    <span class="c1"># norm : 3 x Nplane </span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># T change basis matrix</span>
    <span class="c1"># s x f x v x c </span>
    <span class="c1"># T (3 x Nplane,3)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aplane</span><span class="p">,</span><span class="n">norm</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">,:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># take last transformation matrix </span>
    <span class="c1"># T_ : s x v x c </span>
    <span class="n">T_</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="c1"># pplane            : s x f x c </span>
    <span class="c1"># pplane[:,[-1],:]  : s x 1 x c </span>
    <span class="c1"># p                 : s x 1 x p x c </span>
    <span class="c1"># v                 : s x 1 x p x c </span>
    <span class="n">v</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:][:,:,</span><span class="bp">None</span><span class="p">,:]</span>
    <span class="c1"># go to frame attached to reflection plane</span>
    <span class="c1"># TT : v x s x c </span>
    <span class="c1">#TT = np.swapaxes(T_,0,1)</span>
    <span class="c1"># TT  </span>
    <span class="c1"># Tpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,TT,v)</span>
    <span class="c1">#Tpmp = np.einsum(&#39;vsc,sfpc-&gt;vfpc&#39;,TT,v)</span>
    <span class="n">Tpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;svc,sfpc-&gt;vfpc&#39;</span><span class="p">,</span><span class="n">T_</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># apply symmetry </span>
    <span class="n">R</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
    <span class="n">R</span>  <span class="o">=</span> <span class="n">R</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]</span> 
    <span class="c1">#RTpmp = np.dot(R,Tpmp)</span>
    <span class="c1">#RTpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,R,Tpmp)</span>
    <span class="n">RTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;svc,vfpc-&gt;sfpc&#39;</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Tpmp</span><span class="p">)</span>
    <span class="c1">#go back to global frame </span>
    <span class="c1">#TTRTpmp = np.dot(T_,RTpmp)</span>
    <span class="c1">#TTRTpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,T_,RTpmp)</span>
    <span class="n">TTRTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;vsc,sfpc-&gt;vfpc&#39;</span><span class="p">,</span><span class="n">T_</span><span class="p">,</span><span class="n">RTpmp</span><span class="p">)</span>
    <span class="c1"># append image to list of points </span>
    <span class="n">pim</span> <span class="o">=</span> <span class="n">TTRTpmp</span> <span class="o">+</span> <span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][:,:,</span><span class="bp">None</span><span class="p">,:]</span>  
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tp</span><span class="p">,</span><span class="n">pim</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if there are other plane enter recursion </span>
    <span class="k">if</span> <span class="n">Nplane</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">mirror3c</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">aplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:],</span><span class="n">pplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">tp</span>

<span class="k">def</span> <span class="nf">intersect3c</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ti</span><span class="p">,</span> <span class="n">aplane</span><span class="p">,</span> <span class="n">pplane</span><span class="p">):</span>
    <span class="c1"># take last points of the sequence tp </span>
    <span class="c1"># tp :  (s x f x p x c ) </span>
    <span class="c1"># p : s x 1 x p x c </span>
    <span class="c1">#</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,:]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,:]</span>
    <span class="n">Nplane</span> <span class="o">=</span> <span class="n">aplane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1"># vector plane normalisation</span>
    <span class="c1"># norm : 3 x Nplane </span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,:],</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># T change basis matrix</span>
    <span class="c1"># s x f x v x c </span>
    <span class="c1"># T (3 x Nplane,3)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aplane</span><span class="p">,</span><span class="n">norm</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">,:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># take last transformation matrix </span>
    <span class="c1"># T_ : s x v x c </span>
    <span class="n">T_</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
    <span class="c1"># pplane            : s x f x c </span>
    <span class="c1"># pplane[:,[-1],:]  : s x 1 x c </span>
    <span class="c1"># p                 : s x 1 x p x c </span>
    <span class="c1"># v                 : s x 1 x p x c </span>
    <span class="n">v</span>  <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:][:,:,</span><span class="bp">None</span><span class="p">,:]</span>
    <span class="c1"># go to frame attached to reflection plane</span>
    <span class="c1"># TT : v x s x c </span>
    <span class="c1">#TT = np.swapaxes(T_,0,1)</span>
    <span class="c1"># TT  </span>
    <span class="c1"># Tpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,TT,v)</span>
    <span class="c1">#Tpmp = np.einsum(&#39;vsc,sfpc-&gt;vfpc&#39;,TT,v)</span>
    <span class="n">Tpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;svc,sfpc-&gt;vfpc&#39;</span><span class="p">,</span><span class="n">T_</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># apply symmetry </span>
    <span class="n">R</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
    <span class="n">R</span>  <span class="o">=</span> <span class="n">R</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]</span> 
    <span class="c1">#RTpmp = np.dot(R,Tpmp)</span>
    <span class="c1">#RTpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,R,Tpmp)</span>
    <span class="n">RTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;svc,vfpc-&gt;sfpc&#39;</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Tpmp</span><span class="p">)</span>
    <span class="c1">#go back to global frame </span>
    <span class="c1">#TTRTpmp = np.dot(T_,RTpmp)</span>
    <span class="c1">#TTRTpmp = np.einsum(&#39;svm,vlnm-&gt;slnm&#39;,T_,RTpmp)</span>
    <span class="n">TTRTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;vsc,sfpc-&gt;vfpc&#39;</span><span class="p">,</span><span class="n">T_</span><span class="p">,</span><span class="n">RTpmp</span><span class="p">)</span>
    <span class="c1"># append image to list of points </span>
    <span class="n">pim</span> <span class="o">=</span> <span class="n">TTRTpmp</span> <span class="o">+</span> <span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][:,:,</span><span class="bp">None</span><span class="p">,:]</span>  
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tp</span><span class="p">,</span><span class="n">pim</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if there are other plane enter recursion </span>
    <span class="k">if</span> <span class="n">Nplane</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">intersect3c</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">aplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:],</span><span class="n">pplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

    <span class="k">return</span> <span class="n">tp</span>


<span class="k">def</span> <span class="nf">mirror3</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">aplane</span><span class="p">,</span> <span class="n">pplane</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute recursively the image of p wrt the list of facet </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    tp     : numpy.ndarray (3 x Ns )</span>
<span class="sd">        Ns : number of screen </span>
<span class="sd">        Npt : number of points</span>
<span class="sd">    aplane : numpy.ndarray</span>
<span class="sd">        array of planes (3xNplanex2))</span>
<span class="sd">    pplane : numpy.ndarray</span>
<span class="sd">        array of points (3xNplane)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    tp : np.array </span>
<span class="sd">        sequence of images </span>
<span class="sd">            tp[:,-1] is the final image</span>
<span class="sd">            tp[:,0] is the original point </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; tp = np.array([[1,1,1]]).T</span>
<span class="sd">    &gt;&gt;&gt; p1 = np.array([[0,0] ,[1,0],[0,1]])  #yz</span>
<span class="sd">    &gt;&gt;&gt; p2 = np.array([[1,0] ,[0,0],[0,1]])  #yz</span>
<span class="sd">    &gt;&gt;&gt; p3 = np.array([[1,0] ,[0,1],[0,0]])  #xy</span>
<span class="sd">    &gt;&gt;&gt; aplane = np.hstack((p1,p2,p3))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># take last point of the sequence </span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">Nplane</span> <span class="o">=</span> <span class="n">aplane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1"># vector plane normalisation</span>
    <span class="c1"># norm : 3 x Nplane </span>
    <span class="n">norm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="n">aplane</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># T change basis matrix</span>
    <span class="c1"># T (3 x Nplane,3)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">aplane</span><span class="p">,</span><span class="n">norm</span><span class="p">[:,:,</span><span class="bp">None</span><span class="p">]))</span>
    <span class="c1"># take last transformation matrix </span>
    <span class="n">T_</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
    <span class="c1"># go to frame attached to reflection plane</span>
    <span class="n">Tpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">p</span><span class="o">-</span><span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="c1"># apply symmetry </span>
    <span class="n">R</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> 
    <span class="n">RTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Tpmp</span><span class="p">)</span>
    <span class="c1">#go back to global frame </span>
    <span class="n">TTRTpmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T_</span><span class="p">,</span><span class="n">RTpmp</span><span class="p">)</span>
    <span class="c1"># append image to list of points </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">tp</span><span class="p">,</span><span class="n">TTRTpmp</span> <span class="o">+</span> <span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">TTRTpmp</span> <span class="o">+</span> <span class="n">pplane</span><span class="p">[:,[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="c1"># if there are other plane enter recursion </span>
    <span class="k">if</span> <span class="n">Nplane</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">mirror3</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">aplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="n">pplane</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">tp</span>


<div class="viewcode-block" id="mirror"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.mirror.html#pylayers.util.geomutil.mirror">[docs]</a><span class="k">def</span> <span class="nf">mirror</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; compute the image of p wrt the segment (pa,pb)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    p : numpy.ndarray</span>
<span class="sd">        point to image</span>
<span class="sd">    pa : numpy.ndarray</span>
<span class="sd">        segment tail</span>
<span class="sd">    pb : numpy.ndarray</span>
<span class="sd">        segment head</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    M : numpy.ndarray</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; from pylayers.util.plotutil import *</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; p = np.random.randint(-2,2,(2,3))</span>
<span class="sd">    &gt;&gt;&gt; pa  = np.array([-0.5,1])</span>
<span class="sd">    &gt;&gt;&gt; pb  = np.array([0,0])</span>
<span class="sd">    &gt;&gt;&gt; M = mirror(p,pa,pb)</span>
<span class="sd">    &gt;&gt;&gt; print(M)</span>
<span class="sd">    [[ 2.8 -1.4 -0.2]</span>
<span class="sd">     [ 0.4 -0.2  1.4]]</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(p[0,:],p[1,:],&#39;or&#39;,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(M[0,:],M[1,:],&#39;ob&#39;,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; displot(p,M,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; axis = np.vstack((pa,pb))</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(axis[:,0],axis[:,1])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">pab</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">-</span> <span class="n">pa</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pab</span> <span class="o">*</span> <span class="n">pab</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">zalpha</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
   
    <span class="n">dsa</span>  <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">alpha</span>
    <span class="n">pab0</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">pab1</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1">#a = 1 - (2. / alpha) * (pa[1, :] - pb[1, :]) ** 2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dsa</span> <span class="o">*</span> <span class="p">(</span><span class="n">pab1</span><span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1">#b = (2. / alpha) * (pb[0, :] - pa[0, :]) * (pa[1, :] - pb[1, :])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">dsa</span> <span class="o">*</span> <span class="n">pab0</span> <span class="o">*</span> <span class="n">pab1</span>
    <span class="c1">#c = (2. / alpha) * (pa[0, :] * (pa[1, :] - pb[1, :]) ** 2 +</span>
    <span class="c1">#                    pa[1, :] * (pa[1, :] - pb[1, :]) *</span>
    <span class="c1">#                    (pb[0, :] - pa[0, :]))</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">dsa</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">pab1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">pab1</span><span class="o">*</span><span class="n">pab0</span><span class="p">)</span>
    <span class="c1">#d = (2. / alpha) * (pa[1, :] * (pb[0, :] - pa[0, :]) ** 2 +</span>
    <span class="c1">#                    pa[0, :] * (pa[1, :] - pb[1, :]) *</span>
    <span class="c1">#                    (pb[0, :] - pa[0, :]))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">dsa</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">pab0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">pab1</span><span class="o">*</span><span class="n">pab0</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">vc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="o">-</span><span class="n">S</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">vc0</span>
    <span class="k">return</span> <span class="n">v0</span></div>


<span class="k">def</span> <span class="nf">axmat</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute the image of p wrt the segment pa pb</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>


<span class="sd">    pa : numpy.ndarray</span>
<span class="sd">        segment tail</span>
<span class="sd">    pb : numpy.ndarray</span>
<span class="sd">        segment head</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    S : numpy.ndarray</span>
<span class="sd">        symmetry matrix</span>
<span class="sd">    v : numpy.ndarray</span>
<span class="sd">        translatrion vector</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    fir x is corrdiante of the point to mirror, </span>
<span class="sd">    the mirrored point x&#39; from pa and pb  can be obtain with :</span>

<span class="sd">    x&#39; = np.dot(x,S) + v</span>



<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :include-source:</span>

<span class="sd">    &gt;&gt;&gt; from pylayers.util.geomutil import *</span>
<span class="sd">    &gt;&gt;&gt; from pylayers.util.plotutil import *</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; p = np.random.randn(2,10)</span>
<span class="sd">    &gt;&gt;&gt; pa  = np.array([-0.5,1])</span>
<span class="sd">    &gt;&gt;&gt; pb  = np.array([0,0])</span>
<span class="sd">    &gt;&gt;&gt; S,v = axmat(pa,pb)</span>
<span class="sd">    &gt;&gt;&gt; M = np.dot(p,S) + v</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(p[0,:],p[1,:],&#39;or&#39;,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(M[0,:],M[1,:],&#39;ob&#39;,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; displot(p,M,alpha=0.2)</span>
<span class="sd">    &gt;&gt;&gt; axis = np.vstack((pa,pb))</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(axis[:,0],axis[:,1])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,):</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">pab</span> <span class="o">=</span> <span class="n">pb</span> <span class="o">-</span> <span class="n">pa</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pab</span> <span class="o">*</span> <span class="n">pab</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">zalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">zalpha</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">dsal</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="n">pampby</span> <span class="o">=</span> <span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pb</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">pbmpax</span> <span class="o">=</span> <span class="n">pb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="n">pbmpax</span> <span class="o">*</span> <span class="n">pampby</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dsal</span> <span class="o">*</span> <span class="p">(</span><span class="n">pampby</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">dsal</span> <span class="o">*</span> <span class="n">prod</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">dsal</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pampby</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">prod</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">dsal</span> <span class="o">*</span> <span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pbmpax</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">prod</span><span class="p">)</span>

    <span class="c1"># a = 1 - (2. / alpha) * (pa[1, :] - pb[1, :]) ** 2</span>
    <span class="c1"># b = (2. / alpha) * (pb[0, :] - pa[0, :]) * (pa[1, :] - pb[1, :])</span>
    <span class="c1"># c = (2. / alpha) * (pa[0, :] * (pa[1, :] - pb[1, :]) ** 2 +</span>
    <span class="c1">#                     pa[1, :] * (pa[1, :] - pb[1, :]) *</span>
    <span class="c1">#                     (pb[0, :] - pa[0, :]))</span>
    <span class="c1"># d = (2. / alpha) * (pa[1, :] * (pb[0, :] - pa[0, :]) ** 2 +</span>
    <span class="c1">#                     pa[0, :] * (pa[1, :] - pb[1, :]) *</span>
    <span class="c1">#                     (pb[0, :] - pa[0, :]))</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">vc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="c1"># v0 = np.dot(-S, p) + vc0</span>
    <span class="k">return</span> <span class="n">S</span><span class="p">,</span> <span class="n">vc0</span>


<div class="viewcode-block" id="distseg"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.distseg.html#pylayers.util.geomutil.distseg">[docs]</a><span class="k">def</span> <span class="nf">distseg</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; distance to segments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : (3xN) initial point segment 1</span>
<span class="sd">    b : (3xN) end point segment 1</span>
<span class="sd">    c : (3xN) starting point segment 2</span>
<span class="sd">    d : (3xN) end point segment 2</span>

<span class="sd">    alpha :</span>
<span class="sd">    beta  :</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    f : square of the distance to the segment</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; a = np.random.rand(3,10)</span>
<span class="sd">    &gt;&gt;&gt; b = np.random.rand(3,10)</span>
<span class="sd">    &gt;&gt;&gt; c = np.random.rand(3,10)</span>
<span class="sd">    &gt;&gt;&gt; d = np.random.rand(3,10)</span>
<span class="sd">    &gt;&gt;&gt; alpha,beta,dmin = dmin3d(a,b,c,d)</span>
<span class="sd">    &gt;&gt;&gt; alpha[alpha&lt;0]=0</span>
<span class="sd">    &gt;&gt;&gt; alpha[alpha&gt;1]=1</span>
<span class="sd">    &gt;&gt;&gt; beta[beta&lt;0]=0</span>
<span class="sd">    &gt;&gt;&gt; beta[beta&gt;1]=1</span>
<span class="sd">    &gt;&gt;&gt; f = distseg(a,b,c,d,alpha,beta)</span>
<span class="sd">    &gt;&gt;&gt; p1 = a - alpha*(a-b)</span>
<span class="sd">    &gt;&gt;&gt; p2 = c + beta*(d-c)</span>
<span class="sd">    &gt;&gt;&gt; v = p1-p2</span>
<span class="sd">    &gt;&gt;&gt; g = np.sum(v*v,axis=0)</span>
<span class="sd">    &gt;&gt;&gt; diff = np.sum(f-g,axis=0)</span>
<span class="sd">    &gt;&gt;&gt; np.testing.assert_almost_equal(diff,0)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ac</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>

    <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ac</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ba</span> <span class="o">*</span> <span class="n">ba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">cd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ba</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">ba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">u0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">u1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u2</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u3</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">alpha</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">u4</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u5</span>

    <span class="c1"># m = a - alpha*ba</span>
    <span class="c1"># n = c + beta*cd</span>
    <span class="c1"># g = np.dot(m-n,m-n)</span>

    <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="dmin3d"><a class="viewcode-back" href="../../../modules/generated/pylayers.util.geomutil.dmin3d.html#pylayers.util.geomutil.dmin3d">[docs]</a><span class="k">def</span> <span class="nf">dmin3d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; evaluate the minimal distance between 2 set of segments</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    a : (3xN) initial point segment 1</span>
<span class="sd">    b : (3xN) end point segment 1</span>
<span class="sd">    c : (3xN) starting point segment 2</span>
<span class="sd">    d : (3xN) end point segment 2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    alpha : segment parameterization</span>
<span class="sd">    beta  : segment parameterization</span>
<span class="sd">    dmin  : minimal distance between 2 segments</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ac</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">c</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>

    <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ac</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ba</span> <span class="o">*</span> <span class="n">ba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">cd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ba</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">ac</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cd</span> <span class="o">*</span> <span class="n">ba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">den</span> <span class="o">=</span> <span class="n">u4</span> <span class="o">*</span> <span class="n">u5</span> <span class="o">-</span> <span class="n">u3</span> <span class="o">*</span> <span class="n">u3</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">u2</span> <span class="o">*</span> <span class="n">u3</span> <span class="o">-</span> <span class="n">u1</span> <span class="o">*</span> <span class="n">u5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">den</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1</span> <span class="o">*</span> <span class="n">u3</span> <span class="o">-</span> <span class="n">u2</span> <span class="o">*</span> <span class="n">u4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">den</span><span class="p">)</span>
    <span class="n">dmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">u1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u2</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span>
                             <span class="n">beta</span> <span class="o">*</span> <span class="n">u3</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">u4</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">u5</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">dmin</span><span class="p">)</span></div>

<span class="c1"># def gram_schmid(V):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Gram-Schmid orthonormalization of a set of `M` vectors, in-place.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     V : array, shape (N, M)</span>

<span class="c1">#     Notes</span>
<span class="c1">#     -----</span>

<span class="c1"># from</span>
<span class="c1"># http://numpy-discussion.10968.n7.nabble.com/Efficient-orthogonalisation-with-scipy-numpy-td23635.html</span>

<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     # XXX: speed can be improved by using routines from scipy.lib.blas</span>
<span class="c1">#     # XXX: maybe there&#39;s an orthonormalization routine in LAPACK, too,</span>
<span class="c1">#     #      apart from QR. too lazy to check...</span>
<span class="c1">#     n = V.shape[1]</span>
<span class="c1">#     for k in xrange(n):</span>
<span class="c1">#         V[:,k] /= np.linalg.norm(V[:,k])</span>
<span class="c1">#         for j in xrange(k+1, n):</span>
<span class="c1">#             V[:,j] -= np.vdot(V[:,j], V[:,k]) * V[:,k]</span>
<span class="c1">#     return V</span>


<span class="k">def</span> <span class="nf">gram_schmidt</span><span class="p">(</span><span class="n">Vini</span><span class="p">,</span> <span class="n">force_direct</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gram-Schmidt orthonormalization of a set of `M` vectors, in-place. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">     Vini : array,</span>
<span class="sd">        shape (3,Nv,nf)  where number of vectors Nv = 3 and nf is an integer</span>
<span class="sd">    force_direct : boolean</span>
<span class="sd">        force basis to be direct (det&gt;0)</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import pylayers.util.geomutil as geu</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; Nv = 3</span>
<span class="sd">    &gt;&gt;&gt; Nframes = 10</span>
<span class="sd">    &gt;&gt;&gt; V = np.random.rand(3,Nv,Nframes)</span>
<span class="sd">    &gt;&gt;&gt; VG = geu.gram_schmid(V)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check direct basis</span>
    <span class="k">if</span> <span class="n">force_direct</span><span class="p">:</span>
        <span class="n">per</span> <span class="o">=</span> <span class="n">permutations</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">per</span><span class="p">:</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Vini</span><span class="p">[:,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Vini</span> <span class="o">=</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="n">p</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">break</span>

    <span class="n">v0</span> <span class="o">=</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">Vini</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vn0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">/</span> <span class="n">n0</span>

    <span class="n">pv10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;j&#39;</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">vn0</span><span class="p">)</span>
    <span class="n">v1p</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">-</span> <span class="n">pv10</span> <span class="o">*</span> <span class="n">vn0</span>
    <span class="n">nv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vn1</span> <span class="o">=</span> <span class="n">v1p</span> <span class="o">/</span> <span class="n">nv1</span>

    <span class="n">pv20</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;j&#39;</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">vn0</span><span class="p">)</span>
    <span class="n">pv21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;j&#39;</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">vn1</span><span class="p">)</span>

    <span class="n">v2p</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">pv20</span> <span class="o">*</span> <span class="n">vn0</span> <span class="o">-</span> <span class="n">pv21</span> <span class="o">*</span> <span class="n">vn1</span>
    <span class="n">nv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">vn2</span> <span class="o">=</span> <span class="n">v2p</span> <span class="o">/</span> <span class="n">nv2</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">vn0</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vn1</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vn2</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]))</span>

    <span class="k">if</span> <span class="n">force_direct</span><span class="p">:</span>
        <span class="c1"># assert det &gt;0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># assert det != 0</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">qrdecomp</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gram-Schmid orthonormalization of a set of `Nv` vectors, in-place.</span>
<span class="sd">    using qr decomp</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    V : array,</span>
<span class="sd">        shape (3,Nv,nf)  where number of vectors Nv = 3 and nf is an integer</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    V : array,</span>


<span class="sd">    References</span>
<span class="sd">    ----------</span>

<span class="sd">    from http://numpy-discussion.10968.n7.nabble.com/Efficient-orthogonalisation-with-scipy-numpy-td23635.html</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import pylayers.util.geomutil as geu</span>
<span class="sd">    &gt;&gt;&gt; u=np.random.rand(3,1,10)</span>
<span class="sd">    &gt;&gt;&gt; v=np.random.rand(3,1,10)</span>
<span class="sd">    &gt;&gt;&gt; w=np.random.rand(3,1,10)</span>
<span class="sd">    &gt;&gt;&gt; V = np.hstack((u,v,w))</span>
<span class="sd">    &gt;&gt;&gt; W = geu.qrdecomp(V)</span>
<span class="sd">    &gt;&gt;&gt; assert np.allclose(abs(np.linalg.det(W[:,:,0])),1.0)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  speed can be improved by using routines from scipy.lib.blas</span>
    <span class="c1">#  maybe there&#39;s an orthonormalization routine in LAPACK, too,</span>
    <span class="c1">#      apart from QR. too lazy to check...</span>

    <span class="kn">import</span> <span class="nn">copy</span>
    <span class="c1"># nn = np.linalg.norm(V,axis=(0))</span>

    <span class="c1"># # for i in range(3):</span>
    <span class="c1"># #     V[i,:,:]=V[i,:,:]/nn</span>

    <span class="c1"># V=V/nn</span>
    <span class="n">lv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">V</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">V2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">lv</span><span class="p">):</span>
        <span class="n">V</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">],</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">])</span>
    <span class="c1"># check where the vector along cylinder axis is colinear with the 1st basis axis</span>
    <span class="c1"># col = np.einsum(&#39;ij,ij-&gt;j&#39;,V[:,0,:],V2[:,0,:])</span>
    <span class="c1"># ucol = np.where(col &lt; 0)</span>
    <span class="c1"># import ipdb</span>
    <span class="c1"># ipdb.set_trace()</span>
    <span class="c1"># V[:,:,ucol]=-V[:,:,ucol]</span>
    <span class="kn">import</span> <span class="nn">ipdb</span>
    <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">V</span>


<span class="k">def</span> <span class="nf">check_point_unicity</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if all rows of an array are unique</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">        A : np.ndarray (Npt, 2|3)</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">        similar : list</span>
<span class="sd">        list of index of similar points</span>
<span class="sd">        if void list, all poitns are differents</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; a = np.arange(10)</span>
<span class="sd">    &gt;&gt;&gt; a = np.np.vstack((a,a))</span>
<span class="sd">    &gt;&gt;&gt; check_point_unicity(a.T)</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; b=np.array([4,4])</span>
<span class="sd">    &gt;&gt;&gt; aa=np.concatenate((a,b[:,None]),axis=1)</span>
<span class="sd">    &gt;&gt;&gt; check_point_unicity(aa.T)</span>
<span class="sd">    [4, 10]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">similar</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ua</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="n">rA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="n">ua</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># print rA</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">A</span><span class="p">[</span><span class="n">ua</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rA</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">similar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">similar</span>


<span class="k">def</span> <span class="nf">get_pol_angles</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">inside</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find angles of a single Gt cycle of the layout. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    poly : polygon</span>

<span class="sd">    unit : str</span>
<span class="sd">        &#39;deg&#39; : degree values</span>
<span class="sd">        &#39;rad&#39; : radian values</span>
<span class="sd">    inside : bollean</span>
<span class="sd">        True :  compute the inside angles of the cycle.</span>
<span class="sd">                (a.k.a. in regard of the interior of the polygon) </span>
<span class="sd">        False : compute the outside angles of the cycle.</span>
<span class="sd">                (a.k.a.  in regard of the exterior of the polygon)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    (u,a)</span>
<span class="sd">    u : int (Np)</span>
<span class="sd">        point number</span>
<span class="sd">    a : float (Np)</span>
<span class="sd">        associated angle to the point</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    http://www.mathopenref.com/polygonexteriorangles.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="s1">&#39;vnodes&#39;</span><span class="p">):</span>
        <span class="n">upt</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">vnodes</span><span class="p">[</span><span class="n">poly</span><span class="o">.</span><span class="n">vnodes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upt</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># flip orientation in case of negative area</span>
    <span class="k">if</span> <span class="n">SignedArea</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">upt</span> <span class="o">=</span> <span class="n">upt</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ptroll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">-</span> <span class="n">ptroll</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="bp">None</span><span class="p">]))</span>
    <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">vn</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">vn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span> <span class="o">*</span> <span class="n">v1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">cross</span><span class="p">,</span> <span class="n">dot</span><span class="p">)</span>
    <span class="n">uneg</span> <span class="o">=</span> <span class="n">ang</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">ang</span><span class="p">[</span><span class="n">uneg</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ang</span><span class="p">[</span><span class="n">uneg</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">ang</span><span class="p">[</span><span class="o">~</span><span class="n">uneg</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">ang</span><span class="p">[</span><span class="o">~</span><span class="n">uneg</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inside</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">ang</span>

    <span class="k">if</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;deg&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">ang</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s1">&#39;rad&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">ang</span>


<span class="k">def</span> <span class="nf">reflection_matrix</span><span class="p">(</span><span class="n">U</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    https://en.wikipedia.org/wiki/Transformation_matrix#Reflection</span>
<span class="sd">    u = np.ndarray (2,Nvec)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">     M : nd array</span>
<span class="sd">        (2,2,Nvec)</span>


<span class="sd">    u = np.array([2,2])</span>
<span class="sd">    U=np.vstack((u,u/2.,2*u)).T</span>
<span class="sd">    </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">diag_term</span>  <span class="o">=</span> <span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">anti_diag</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>


    <span class="n">M</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([[</span><span class="n">diag_term</span><span class="p">,</span> <span class="n">anti_diag</span><span class="p">],[</span><span class="n">anti_diag</span><span class="p">,</span> <span class="o">-</span><span class="n">diag_term</span><span class="p">]]))</span>

    <span class="k">return</span> <span class="n">M</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, PyLayers developer team.
      Last updated on Nov 07, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>